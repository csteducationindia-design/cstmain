<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal</title>
    <link rel="manifest" href="/static/manifest.json">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#1173d4" }, fontFamily: { "display": ["Inter"] } } } }</script>
</head>
<body class="bg-slate-50 font-display">
<div class="flex min-h-screen">
    <aside class="w-64 bg-white border-r p-4">
        <h1 class="text-2xl font-bold mb-6">Parent Portal</h1>
        <nav>
            <a href="#dashboard" class="block py-2 px-4 rounded hover:bg-gray-100">Dashboard</a>
            <a href="#messages" class="block py-2 px-4 rounded hover:bg-gray-100">Messages</a>
            <a href="#announcements" class="block py-2 px-4 rounded hover:bg-gray-100">Announcements</a>
            <button id="install-app-btn" class="hidden w-full text-left py-2 px-4 text-green-600 font-bold mt-4">Install App</button>
        </nav>
        <button id="logout-btn" class="w-full mt-8 bg-red-600 text-white py-2 rounded">Logout</button>
    </aside>
    <main class="flex-1 p-8">
        <h2 id="welcome-msg" class="text-3xl font-bold mb-6">Welcome</h2>
        <div class="mb-6"><label>Select Child: </label><select id="child-select" class="border p-2 rounded"><option value="">Loading...</option></select></div>
        
        <div id="dashboard-view">
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded shadow"><h3>Fees Due</h3><p class="text-2xl font-bold" id="fee-due">...</p></div>
                <div class="bg-white p-4 rounded shadow"><h3>Attendance</h3><div id="att-list"></div></div>
                <div class="bg-white p-4 rounded shadow"><h3>Results</h3><div id="grade-list"></div></div>
            </div>
        </div>
        <div id="announcements-view" class="hidden">
            <h3 class="text-xl font-bold mb-4">Announcements</h3>
            <div id="ann-list" class="bg-white p-4 rounded shadow"></div>
        </div>
    </main>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script>
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    
    // PWA
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
    installBtn.addEventListener('click', async () => { if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt = null; } });

    // Logic
    document.addEventListener('DOMContentLoaded', async () => {
        const res = await fetch(`${API_BASE_URL}/check_session`, {credentials:'include'});
        const session = await res.json();
        if(!session.logged_in || session.user.role !== 'parent') window.location.href='/';
        
        document.getElementById('welcome-msg').innerText = `Welcome, ${session.user.name}`;
        
        // Load Children
        const childRes = await fetch(`${API_BASE_URL}/parent/children`, {credentials:'include'});
        const children = await childRes.json();
        const select = document.getElementById('child-select');
        select.innerHTML = '';
        
        if(children.length === 0) {
            alert("No child linked. Please ask Admin to link your account.");
        } else {
            children.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.innerText = c.name;
                select.appendChild(opt);
            });
            loadChildData(children[0].id);
            select.addEventListener('change', (e) => loadChildData(e.target.value));
        }
        
        // Load Announcements
        const annRes = await fetch(`${API_BASE_URL}/announcements`, {credentials:'include'});
        const anns = await annRes.json();
        const annList = document.getElementById('ann-list');
        anns.filter(a => a.target_group === 'parents' || a.target_group === 'all').forEach(a => {
            annList.innerHTML += `<div class="border-b p-2"><strong>${a.title}</strong><p>${a.content}</p></div>`;
        });
        
        // Firebase
        setTimeout(initFirebase, 1000);
    });
    
    async function loadChildData(id) {
        const res = await fetch(`${API_BASE_URL}/parent/child_data/${id}`, {credentials:'include'});
        const data = await res.json();
        document.getElementById('fee-due').innerText = `Rs. ${data.fees.balance}`;
        
        const attList = document.getElementById('att-list');
        attList.innerHTML = data.attendance.map(a => `<p>${a.date}: ${a.status}</p>`).join('');
        
        const gradeList = document.getElementById('grade-list');
        gradeList.innerHTML = data.grades.map(g => `<p>${g.course_name}: ${g.marks_obtained}/${g.total_marks}</p>`).join('');
    }

    document.getElementById('logout-btn').onclick = async () => {
        await fetch(`${API_BASE_URL}/logout`, {method:'POST', credentials:'include'});
        window.location.href = '/';
    };

    function initFirebase() {
        try {
             const firebaseConfig = {
                apiKey: "AIzaSyBkZEHM9fXRoCYSgEW-hk_lN7sL_nSLDfU",
                authDomain: "cst-institute-app.firebaseapp.com",
                projectId: "cst-institute-app",
                storageBucket: "cst-institute-app.firebasestorage.app",
                messagingSenderId: "485166460200",
                appId: "1:485166460200:web:4eae20e2010ab92baeb41d"
            };
            firebase.initializeApp(firebaseConfig);
            const messaging = firebase.messaging();
            if('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/firebase-messaging-sw.js').then(reg => {
                    Notification.requestPermission().then(perm => {
                        if(perm==='granted') messaging.getToken({vapidKey: "BBOMxvKvbEs_t9ykKBa2zIewzCzD6FCbm9rxc8a9eWl2kjjH5vyTSH6TeQMksZ_OGl5jZyQpU2wBcf-KsZN1uko", serviceWorkerRegistration: reg}).then(token => {
                            fetch('/api/save_fcm_token', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token}), credentials:'include'});
                        });
                    });
                });
            }
        } catch(e) {}
    }
</script>
</body>
</html>
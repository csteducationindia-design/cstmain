<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="{{ url_for('static', filename='tailwind.js') }}"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .table-auto-layout {
            table-layout: auto;
        }
        .overdue {
            color: #ef4444;
            font-weight: 600;
        }
        .pending {
            color: #f59e0b;
            font-weight: 600;
        }
        .paid {
            color: #10b981;
            font-weight: 600;
        }

        /* PRINT STYLES MOVED INSIDE HERE */
        @media print {
            aside, header, .no-print, button, .content-section.hidden { 
                display: none !important; 
            }
            /* Ensure the currently active section is visible */
            .content-section:not(.hidden) {
                display: block !important;
            }
            main { margin: 0; padding: 0; width: 100%; }
            body { background: white; color: black; }
            table { border: 1px solid #ccc; width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ccc; padding: 8px; font-size: 12px; }
            
            /* Hide URL footprint in some browsers */
            @page { margin: 20px; }
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Admin</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Admin Portal</p>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-1">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="text-sm font-medium">Dashboard</span>
            </a>
            <a href="#teachers" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">person</span>
                <span class="text-sm font-medium">Teachers</span>
            </a>
            <a href="#students" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">school</span>
                <span class="text-sm font-medium">Students</span>
            </a>
            <a href="#parents" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">groups</span>
                <span class="text-sm font-medium">Parents</span>
            </a>
            <a href="#courses" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">book</span>
                <span class="text-sm font-medium">Courses</span>
            </a>
            <a href="#sessions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-sm font-medium">Sessions</span>
            </a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">campaign</span>
                <span class="text-sm font-medium">Announcements</span>
            </a>
            <a href="#fees" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">payments</span>
                <span class="text-sm font-medium">Fees & Payments</span>
            </a>
            <a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">receipt_long</span>
                <span class="text-sm font-medium">Fee Pending Report</span>
            </a>
            <a href="#admin-message" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">message</span>
                <span class="text-sm font-medium">Bulk Message</span>
            </a>
            <a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">analytics</span>
                <span class="text-sm font-medium">Reports</span>
            </a>
            <a href="#bulk-upload" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">upload_file</span>
                <span class="text-sm font-medium">Bulk Upload</span>
            </a>
        </nav>
        <div class="p-6 border-t border-slate-200 dark:border-slate-800">
            <button id="logout-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-red-700 transition duration-150">
                Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-900 dark:text-white">Admin Dashboard</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2">Welcome back, Admin! Here's an overview of your institute.</p>
            </header>

            

<div id="content-dashboard" class="content-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Teachers</p>
                        <p id="total-teachers" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Students</p>
                        <p id="total-students" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Parents</p>
                        <p id="total-parents" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Courses</p>
                        <p id="total-courses" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Quick Actions</h2>
                    <div class="flex gap-4">
                        <a href="#teachers" class="bg-primary text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Manage Teachers</a>
                        <a href="#students" class="bg-primary text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Manage Students</a>
                        

</div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Recent Announcements</h2>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target Group</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-announcements-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-teachers" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Teachers</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
	<h3 id="teacher-form-title" class="text-xl font-bold mb-4">Add/Edit Teacher</h3>
                    <form id="teacher-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="teacher-id" name="id">
                        <input type="hidden" id="teacher-role" name="role" value="teacher">
                        <div class="form-group"><label for="teacher-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="teacher-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="teacher-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="teacher-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="teacher-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="teacher-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="teacher-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="teacher-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="md:col-span-2">
                            <button type="submit" id="teacher-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Teacher</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Teachers</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-students" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Students</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 id="student-form-title" class="text-xl font-bold mb-4">Add/Edit Student</h3>
                    <form id="student-form" class="space-y-6" enctype="multipart/form-data">
                        <input type="hidden" id="student-id" name="id">
                        <input type="hidden" id="student-role" name="role" value="student">
                       <div class="form-group">
        <label for="student-admission-input" class="block text-sm font-medium mb-1">
            Admission Number (Manual)
        </label>
        <input type="text" id="student-admission-input" name="admission_number" class="w-full border-slate-300 rounded-lg bg-slate-50 p-2 border">
        <p class="text-xs text-slate-500 mt-1">This will be used for the QR code filename (qr_107.png).</p>
    </div>

    <div class="form-group">
        <label for="student-session-select" class="block text-sm font-medium mb-1">
            Academic Session (Batch) *
        </label>
        <select id="student-session-select" name="session_id" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 p-2">
            <option value="">-- Select Session --</option>
        </select>
    </div>
    <fieldset>
        <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Basic Details</legend>
        

                           <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group"><label for="student-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="student-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="student-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="student-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-dob-input" class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" id="student-dob-input" name="dob" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-gender-select" class="block text-sm font-medium mb-1">Gender</label>
                                    <select id="student-gender-select" name="gender" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                 <div class="form-group"><label for="student-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="student-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Parent/Guardian Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group"><label for="student-father-name-input" class="block text-sm font-medium mb-1">Father's Name</label><input type="text" id="student-father-name-input" name="father_name" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-mother-name-input" class="block text-sm font-medium mb-1">Mother's Name</label><input type="text" id="student-mother-name-input" name="mother_name" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-parent-select" class="block text-sm font-medium mb-1">Link Parent Account (Optional)</label><select id="student-parent-select" name="parent_id" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Address Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group md:col-span-3"><label for="student-address-input" class="block text-sm font-medium mb-1">Address Line 1</label><input type="text" id="student-address-input" name="address_line1" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-city-input" class="block text-sm font-medium mb-1">City</label><input type="text" id="student-city-input" name="city" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-state-input" class="block text-sm font-medium mb-1">State</label><input type="text" id="student-state-input" name="state" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-pincode-input" class="block text-sm font-medium mb-1">Pincode</label><input type="text" id="student-pincode-input" name="pincode" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            </div>
                        </fieldset>
                        

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Profile Photo</legend>
                            <div class="flex items-center gap-4">
                                <img id="student-photo-preview" src="https://placehold.co/100x100/f6f7f8/666?text=Preview" alt="Photo Preview" class="w-24 h-24 rounded-lg object-cover border border-slate-300 dark:border-slate-700">
                                <div class="form-group">
                                    <label for="student-photo-file-input" class="block text-sm font-medium mb-1">Upload Photo (Optional)</label>
                                    <input type="file" id="student-photo-file-input" name="profile_photo_file" accept="image/png, image/jpeg, image/gif" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary dark:file:bg-primary/20 dark:file:text-primary hover:file:bg-primary/20 dark:hover:file:bg-primary/30">
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Select a file to update. Leave blank to keep existing photo (if editing).</p>
                                </div>
                            </div>
                        </fieldset>

                        <div class="pt-4">
                            <button type="submit" id="student-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Student</button>
                        </div>
                    </form>
                </div>
                <div>
                    <div class="bg-white p-4 rounded shadow mb-4 flex gap-4 items-end">
    <div class="flex-1">
        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Filter by Session (Batch)</label>
        <select id="filterSession" onchange="loadUsers()" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
            <option value="">All Sessions</option>
        </select>
    </div>

    <div class="flex-1">
        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Search Name/Email</label>
        <input type="text" id="userSearch" onkeyup="loadUsers()" placeholder="Search..." class="block w-full border-gray-300 rounded-md shadow-sm p-2 border">
    </div>

    <div>
        <button onclick="downloadReport('fee_pending')" class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700">
            Export Fee Pending
        </button>
        <button onclick="downloadReport('students')" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 ml-2">
            Export Student Data
        </button>
    </div>
</div>

                    <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-bold">Existing Students</h3>
    
    <button onclick="window.open(window.location.origin + '/admin/id_cards/bulk', '_blank')" 
            class="bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-indigo-700 transition flex items-center gap-2 shadow-sm">
        <span class="material-symbols-outlined text-sm">print</span> Print All ID Cards
    </button>
</div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
        <thead>
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Admission No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Batch/Session</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
    </table>
</div>
                </div>
            </div>

            <div id="content-parents" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Parents</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 id="parent-form-title" class="text-xl font-bold mb-4">Add/Edit Parent</h3>
                    <form id="parent-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="parent-id" name="id">
                        <input type="hidden" id="parent-role" name="role" value="parent">
                        <div class="form-group"><label for="parent-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="parent-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="parent-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="parent-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="parent-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="parent-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="parent-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="parent-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="md:col-span-2">
                            <button type="submit" id="parent-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Parent</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Parents</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="parent-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-courses" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Courses</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Add New Course</h3>
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="hidden" id="course-id" name="id">
                        <div class="form-group"><label for="course-name" class="block text-sm font-medium mb-1">Course Name</label><input type="text" id="course-name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="course-subjects" class="block text-sm font-medium mb-1">Subjects (comma-separated)</label><input type="text" id="course-subjects" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="course-teacher" class="block text-sm font-medium mb-1">Assign Teacher</label><select id="course-teacher" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                        <div class="md:col-span-2">
	      <button type="submit" id="save-course-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Course</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Courses</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Course Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjects</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Teacher</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="course-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-sessions" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Academic Sessions</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Add New Session</h3>
                    <form id="session-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="hidden" id="session-id" name="id">
                        <div class="form-group"><label for="session-name" class="block text-sm font-medium mb-1">Session Name</label><input type="text" id="session-name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="session-start-date" class="block text-sm font-medium mb-1">Start Date</label><input type="date" id="session-start-date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="session-end-date" class="block text-sm font-medium mb-1">End Date</label><input type="date" id="session-end-date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="session-status" class="block text-sm font-medium mb-1">Status</label><select id="session-status" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
                        <div class="md:col-span-2">
                            <button type="submit" id="save-session-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Session</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Sessions</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Start Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">End Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="session-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-announcements" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Announcements</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Create New Announcement</h3>
                    <form id="announcement-form">
                        <div class="mb-4"><label for="announcement-title" class="block text-sm font-medium mb-1">Title</label><input type="text" id="announcement-title" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="mb-4"><label for="announcement-content" class="block text-sm font-medium mb-1">Content</label><textarea id="announcement-content" rows="5" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea></div>
                        <div class="mb-4"><label for="announcement-target-group" class="block text-sm font-medium mb-1">Target Group</label><select id="announcement-target-group" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="all">All Users</option><option value="teachers">Teachers</option><option value="students">Students</option><option value="parents">Parents</option><option value="admin">Admin</option></select></div>
                        <button type="submit" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Publish Announcement</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Announcements</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
        <thead>
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Content</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target Group</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody id="management-announcements-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
    </table>
</div>
                </div>
            </div>

            

<div id="content-fees" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Fees & Payments</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Manage Fee Structures</h3>
                        <form id="fee-structure-form" class="space-y-4">
                            <input type="hidden" id="fee-structure-id" name="id">
                            <div class="form-group"><label for="fee-structure-name" class="block text-sm font-medium mb-1">Structure Name</label><input type="text" id="fee-structure-name" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="fee-session-select" class="block text-sm font-medium mb-1">Academic Session</label><select id="fee-session-select" name="academic_session_id" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            <div class="form-group"><label for="fee-total-amount" class="block text-sm font-medium mb-1">Total Amount</label><input type="number" step="0.01" id="fee-total-amount" name="total_amount" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="fee-due-date" class="block text-sm font-medium mb-1">Due Date</label><input type="date" id="fee-due-date" name="due_date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <button type="submit" id="save-fee-structure-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Fee Structure</button>
                        </form>
                        <h4 class="text-lg font-bold mt-8 mb-4">Existing Fee Structures</h4>
                        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Date</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                            <tbody id="fee-structure-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Record Payment</h3>
                        <form id="payment-form" class="space-y-4">
                            <div class="form-group"><label for="payment-student-select" class="block text-sm font-medium mb-1">Student</label><select id="payment-student-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            <div class="form-group"><label for="payment-fee-structure-select" class="block text-sm font-medium mb-1">Fee Structure</label><select id="payment-fee-structure-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            <div class="form-group"><label for="payment-amount" class="block text-sm font-medium mb-1">Amount Paid</label><input type="number" step="0.01" id="payment-amount" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="payment-method" class="block text-sm font-medium mb-1">Payment Method</label><select id="payment-method" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="Cash">Cash</option><option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option></select></div>
                            <button type="submit" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Record Payment & Print Receipt</button>
                        </form>
                        <h4 class="text-lg font-bold mt-8 mb-4">Fee Status Overview</h4>
                        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Balance</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Days</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Alerts</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Receipt</th>
                                    </tr>
                                </thead>
                            <tbody id="fee-status-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
    <div id="content-fee-pending-report" class="content-section hidden">
    <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Student Fee Pending Report</h2>
    
    <div class="bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-end">
        <div class="w-full md:w-1/3">
            <label class="block text-sm font-medium mb-1">Filter by Course</label>
            <select id="report-course-filter" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800" onchange="fetchFeePendingReport()">
                <option value="">All Courses</option>
            </select>
        </div>
        
        <div class="flex gap-2">
            <button onclick="downloadReport('fee_pending')" class="bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">table_view</span> Excel
            </button>
            <button onclick="printReportPDF()" class="bg-red-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-red-700 transition flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">picture_as_pdf</span> PDF
            </button>
        </div>

        <div class="w-full md:w-auto ml-auto">
             <button onclick="sendBulkFeeReminder()" class="bg-slate-800 text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-slate-700 transition">
                <span class="material-symbols-outlined align-middle text-lg mr-1">send</span>
                Send Bulk Reminder
            </button>
        </div>
    </div>

    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Pending Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Days Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="fee-pending-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
        </table>
    </div>
</div>
            <div id="content-admin-message" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Send Bulk Notifications (SMS/WhatsApp Mock)</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <form id="admin-bulk-message-form">
                        <div class="mb-4">
                            <label for="message-target-role" class="block text-sm font-medium mb-1">Target Group</label>
                            <select id="message-target-role" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                <option value="all">All Users (Teachers, Students, Parents)</option>
                                <option value="teachers">Teachers Only</option>
                                <option value="students">Students Only</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="message-subject" class="block text-sm font-medium mb-1">Subject / Header</label><input type="text" id="message-subject" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="mb-4">
                            <label for="message-body" class="block text-sm font-medium mb-1">Message Content (Max 160 Chars for SMS Mock)</label><textarea id="message-body" rows="4" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button type="button" data-type="sms" class="send-bulk-btn w-full bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-yellow-700 transition duration-150">
                                Send Bulk SMS
                            </button>
                            <button type="button" data-type="whatsapp" class="send-bulk-btn w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                                Send Bulk WhatsApp (Mock)
                            </button>
                        </div>
                    </form>
                    <p id="admin-message-status" class="mt-4 text-sm font-medium text-center text-slate-500 dark:text-slate-400 hidden"></p>
                </div>
            </div>
            <div id="content-reports" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">General Reports</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Recent Admissions Report (Last 30 Days)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Admission Date</th>
                                    </tr>
                                </thead>
                                <tbody id="admissions-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Student Attendance Report</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Classes</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Present</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Absent</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Student Performance Report</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Assessments Taken</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Score</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Overall Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="performance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-bulk-upload" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Bulk Data Upload</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Upload Users (Students, Teachers, Parents)</h3>
                    <p class="text-sm text-red-500 dark:text-red-400 mb-4">NOTE: File must be a **CSV** with columns: **name, email, password, role** (required), **phone_number, parent_email, dob, gender, father_name, mother_name, address_line1, city, state, pincode** (optional).</p>
                    
                    <form id="bulk-upload-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="bulk-file-input" class="block text-sm font-medium mb-1">Select CSV File</label>
                            <input type="file" id="bulk-file-input" name="file" accept=".csv" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 p-2">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                            Process Bulk Upload
                        </button>
                    </form>

                    <div id="bulk-upload-results" class="mt-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg hidden">
                        <h4 class="text-lg font-bold mb-2">Results:</h4>
                        <p id="bulk-upload-message" class="font-medium mb-2"></p>
                        <div id="bulk-upload-details"></div>
                    </div>
                </div>
            </div>
            </div>
    </main>
</div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script>

    // --- GLOBAL CONFIG ---
    const API_BASE_URL = '/api';
    let allUsersCache = [];
    let allSessionsCache = [];

    // --- 1. CORE NAVIGATION (Must be Global) ---
    function showSection(hash) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-primary/10', 'text-primary'));
        
        // Clean hash
        let targetId = (hash && hash.length > 1) ? hash.substring(1) : 'dashboard';
        
        // Handle dropdown filter persistence
        if(targetId === 'dashboard') fetchDashboardSummary();
        
        const target = document.getElementById('content-' + targetId);
        if (target) {
            target.classList.remove('hidden');
            // Highlight sidebar
            const link = document.querySelector(`.nav-link[href="#${targetId}"]`);
            if(link) link.classList.add('bg-primary/10', 'text-primary');
            
            // PROBLEM 4 FIX: Load data specific to the section
            if(targetId === 'courses') {
                fetchAllUsers().then(() => fetchTeachersForCourseDropdown());
                fetchCourses();
            }
            if(targetId === 'students') {
                loadSessionsFilter(); // PROBLEM 1 & 2 FIX
                loadUsers();
            }
            if(targetId === 'fees') {
                fetchFeeStructures();
                loadSessionsFilter(); // Populate fee session dropdown
            }
            if(targetId === 'announcements') fetchAnnouncements(true);
            if(targetId === 'sessions') fetchSessions();
        }
    }

    // --- 2. DATA LOADERS ---

    // PROBLEM 1 & 2 FIX: Load Sessions and Populate ALL Dropdowns
    async function loadSessionsFilter() {
        try {
            const res = await fetch(`${API_BASE_URL}/sessions`);
            const sessions = await res.json();
            allSessionsCache = sessions;

            // Helper to populate a specific select ID
            const populate = (id, defaultText) => {
                const el = document.getElementById(id);
                if (el) {
                    const oldVal = el.value;
                    el.innerHTML = `<option value="">${defaultText}</option>` + 
                        sessions.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    if(oldVal) el.value = oldVal;
                }
            };

            // Populate Student List Filter
            populate('filterSession', 'All Sessions');
            // Populate Student Add Form (PROBLEM 2 FIX)
            populate('student-session-select', '-- Select Batch * --');
            // Populate Fee Form
            populate('fee-session-select', 'Select Academic Session');

        } catch (e) { console.error("Session load error", e); }
    }

    // PROBLEM 4 FIX: Fetch Teachers
    async function fetchTeachersForCourseDropdown() {
        // Ensure we have users
        if (allUsersCache.length === 0) await fetchAllUsers();
        
        const teachers = allUsersCache.filter(u => u.role === 'teacher');
        const sel = document.getElementById('course-teacher');
        if (sel) {
            sel.innerHTML = '<option value="">Select Teacher</option>' + 
                teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }
    }

    async function fetchAllUsers() {
        try {
            const res = await fetch(`${API_BASE_URL}/users`);
            const users = await res.json();
            allUsersCache = users;
            return users;
        } catch (e) { return []; }
    }

    // --- 3. STUDENTS & USERS ---
    async function loadUsers() {
        const sessId = document.getElementById('filterSession')?.value || '';
        const search = document.getElementById('userSearch')?.value || '';
        
        const res = await fetch(`${API_BASE_URL}/users?session_id=${sessId}&search=${search}`);
        const users = await res.json();
        
        const tbody = document.getElementById('usersTableBody');
        if(tbody) {
            tbody.innerHTML = users.filter(u => u.role === 'student').map(u => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">${u.admission_number || '-'}</td>
                    <td class="p-4 font-bold">${u.name}</td>
                    <td class="p-4">${u.email}</td>
                    <td class="p-4 text-blue-600">${u.session_name || 'Unassigned'}</td>
                    <td class="p-4 text-right">
                        <a href="/admin/id_card/${u.id}" target="_blank" class="text-indigo-600 mr-2">ID Card</a>
                        <button onclick="editStudent(${u.id})" class="text-blue-600">Edit</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="p-4 text-center">No students found</td></tr>';
        }
    }

    window.editStudent = async function(id) {
        const res = await fetch(`${API_BASE_URL}/admin/student/${id}`);
        const u = await res.json();
        
        // Switch to tab
        showSection('#students');
        
        // Populate Form
        document.getElementById('student-id').value = u.id;
        document.getElementById('student-name-input').value = u.name;
        document.getElementById('student-email-input').value = u.email;
        document.getElementById('student-phone-input').value = u.phone_number || '';
        document.getElementById('student-admission-input').value = u.admission_number || '';
        
        // PROBLEM 2 FIX: Select correct session
        if(u.session_id) document.getElementById('student-session-select').value = u.session_id;
        
        document.getElementById('student-form-btn').textContent = "Update Student";
        document.getElementById('student-form-title').textContent = "Edit Student";
        window.scrollTo(0,0);
    };

    // --- 4. FEES & COURSES (PROBLEM 6 FIX) ---
    async function fetchFeeStructures() {
        const res = await fetch(`${API_BASE_URL}/fee_structures`);
        const fees = await res.json();
        const tbody = document.getElementById('fee-structure-table-body');
        if(tbody) {
            tbody.innerHTML = fees.map(f => `
                <tr class="border-b">
                    <td class="p-4">${f.name}</td>
                    <td class="p-4">${f.total_amount}</td>
                    <td class="p-4">${f.due_date}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteFeeStructure(${f.id})" class="text-red-600">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
    }

    // --- 5. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial Load
        loadSessionsFilter(); // Critical for Dropdowns
        fetchAllUsers();      // Critical for Teachers/Students
        
        // Handle Hash
        showSection(window.location.hash || '#dashboard');
        window.addEventListener('hashchange', () => showSection(window.location.hash));

        // Form Listeners
        document.getElementById('student-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            // Fix: Add role if missing
            if(!fd.get('role')) fd.append('role', 'student');
            
            await fetch(`${API_BASE_URL}/users`, { method: 'POST', body: fd }); // Use POST for both add/edit logic in backend
            alert('Saved!');
            document.getElementById('student-form').reset();
            loadUsers();
        });
        
        document.getElementById('course-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = document.getElementById('course-id').value;
            // Convert FormData to JSON for this endpoint
            const data = Object.fromEntries(fd.entries());
            if(id) data.id = id;
            
            await fetch(`${API_BASE_URL}/courses`, { 
                method: id ? 'PUT' : 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data) 
            });
            alert('Course Saved');
            fetchCourses();
        });
    });
    
    // Stub functions for other entities
    async function fetchCourses() {
        const res = await fetch(`${API_BASE_URL}/courses`);
        const data = await res.json();
        document.getElementById('course-table-body').innerHTML = data.map(c => `
            <tr class="border-b"><td class="p-4">${c.name}</td><td class="p-4">${c.teacher_name}</td>
            <td class="p-4 text-right"><button onclick="deleteCourse(${c.id})" class="text-red-600">Delete</button></td></tr>
        `).join('');
    }
    
    // ... Add other delete/fetch functions as needed ...
    window.deleteFeeStructure = async (id) => { 
        if(confirm('Delete?')) await fetch(`${API_BASE_URL}/fee_structures?id=${id}`, {method:'DELETE'}); 
        fetchFeeStructures(); 
    };

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - CST Institute</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700;800&display=swap" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { primary: "#1173d4", secondary: "#0f172a" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .table-auto-layout { table-layout: auto; }
        .btn-action { @apply px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-display h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-xl z-20 shrink-0">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold">A</div>
            <div>
                <h1 class="text-lg font-bold text-slate-900 leading-tight">Admin Portal</h1>
                <p class="text-xs text-slate-500">CST Institute</p>
            </div>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl bg-primary/10 text-primary font-bold">
                <span class="material-symbols-outlined">dashboard</span> Dashboard
            </a>
            
            <div class="mt-6 mb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider">People</div>
            <a href="#students" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">school</span> Students
            </a>
            <a href="#teachers" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">person</span> Teachers
            </a>
            <a href="#parents" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">groups</span> Parents
            </a>

            <div class="mt-6 mb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider">Academic</div>
            <a href="#courses" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">book</span> Courses
            </a>
            <a href="#sessions" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">event</span> Sessions
            </a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">campaign</span> Announcements
            </a>

            <div class="mt-6 mb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider">Finance & Data</div>
            <a href="#fees" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">payments</span> Fees & Payments
            </a>
            <a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">receipt_long</span> Fee Reports
            </a>
            <a href="#reports" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">analytics</span> Analytics
            </a>
            <a href="#bulk-upload" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-xl text-slate-600 hover:bg-gray-50 transition">
                <span class="material-symbols-outlined">upload_file</span> Bulk Upload
            </a>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <button id="logout-btn" class="w-full flex items-center justify-center gap-2 bg-red-50 text-red-600 font-bold py-2.5 rounded-xl hover:bg-red-100 transition">
                <span class="material-symbols-outlined text-sm">logout</span> Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 lg:p-10 scroll-smooth">
        <div class="max-w-7xl mx-auto space-y-10 pb-20">

            <div id="content-dashboard" class="content-section">
                <header class="flex justify-between items-end mb-8 border-b border-gray-200 pb-6">
                    <div>
                        <h1 class="text-3xl font-extrabold text-slate-900">Admin Dashboard</h1>
                        <p class="text-slate-500 mt-1">Overview of your institute's performance.</p>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Teachers</p>
                        <p id="total-teachers" class="text-3xl font-bold text-slate-800 mt-2">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Students</p>
                        <p id="total-students" class="text-3xl font-bold text-slate-800 mt-2">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Parents</p>
                        <p id="total-parents" class="text-3xl font-bold text-slate-800 mt-2">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Courses</p>
                        <p id="total-courses" class="text-3xl font-bold text-slate-800 mt-2">-</p>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-slate-900 mb-4">Recent Announcements</h2>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="w-full text-left">
                            <tbody id="recent-announcements-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-students" class="content-section hidden">
                <h2 class="text-2xl font-bold text-slate-900 mb-6">Manage Students</h2>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 mb-8">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-100 pb-4">
                        <span class="material-symbols-outlined text-blue-600 bg-blue-50 p-2 rounded-lg">person_add</span>
                        <h3 id="student-form-title" class="font-bold text-lg text-slate-800">Add New Student</h3>
                    </div>

                    <form id="student-form" class="space-y-8" enctype="multipart/form-data">
                        <input type="hidden" id="student-id" name="id"><input type="hidden" name="role" value="student">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Enrolled Course *</label><select id="student-course-select" name="course_ids" required class="w-full rounded-xl border-gray-300 bg-blue-50/30 focus:border-primary focus:ring-primary"></select></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Link Parent (Optional)</label><select id="student-parent-select" name="parent_id" class="w-full rounded-xl border-gray-300 focus:border-primary focus:ring-primary"></select></div>
                        </div>

                        <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">Personal Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Full Name *</label><input type="text" id="student-name-input" name="name" required class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Email *</label><input type="email" id="student-email-input" name="email" required class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Phone</label><input type="tel" id="student-phone-input" name="phone_number" class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Date of Birth</label><input type="date" id="student-dob-input" name="dob" class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Gender</label><select id="student-gender-select" name="gender" class="w-full rounded-xl border-gray-300"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Login Password</label><input type="password" id="student-password-input" name="password" placeholder="New password" class="w-full rounded-xl border-gray-300"></div>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">Family & Address</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Father's Name</label><input type="text" id="student-father-name-input" name="father_name" class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Mother's Name</label><input type="text" id="student-mother-name-input" name="mother_name" class="w-full rounded-xl border-gray-300"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                                <div class="md:col-span-4"><label class="block text-xs font-bold text-gray-500 mb-1">Address Line 1</label><input type="text" id="student-address-input" name="address_line1" class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">City</label><input type="text" id="student-city-input" name="city" class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">State</label><input type="text" id="student-state-input" name="state" class="w-full rounded-xl border-gray-300"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Pincode</label><input type="text" id="student-pincode-input" name="pincode" class="w-full rounded-xl border-gray-300"></div>
                            </div>
                        </div>

                        <div class="flex items-center gap-6 pt-2">
                            <img id="student-photo-preview" src="https://placehold.co/100" class="w-16 h-16 rounded-xl object-cover shadow-sm border">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Profile Photo</label>
                                <input type="file" id="student-photo-file-input" name="profile_photo_file" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                        </div>

                        <button type="submit" id="student-form-btn" class="w-full bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 hover:shadow-none transition-all">Save Student Profile</button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <input type="text" id="student-search-input" placeholder="Search students..." class="w-full border-gray-300 rounded-xl p-2.5">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase"><tr><th class="px-6 py-4">Name</th><th class="px-6 py-4">Contact</th><th class="px-6 py-4">Parent</th><th class="px-6 py-4 text-right">Actions</th></tr></thead>
                            <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-teachers" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Manage Teachers</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8 border border-gray-100">
                    <form id="teacher-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <input type="hidden" id="teacher-id" name="id"><input type="hidden" name="role" value="teacher">
                        <input type="text" id="teacher-name-input" name="name" required placeholder="Full Name" class="w-full rounded-xl border-gray-300">
                        <input type="email" id="teacher-email-input" name="email" required placeholder="Email" class="w-full rounded-xl border-gray-300">
                        <input type="tel" id="teacher-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-xl border-gray-300">
                        <input type="password" id="teacher-password-input" name="password" placeholder="Password" class="w-full rounded-xl border-gray-300">
                        <button type="submit" id="teacher-form-btn" class="w-full bg-primary text-white font-bold py-3 rounded-xl md:col-span-2">Save Teacher</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100"><table class="w-full text-left"><tbody id="teacher-table-body"></tbody></table></div>
            </div>

            <div id="content-parents" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Manage Parents</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8 border border-gray-100">
                    <form id="parent-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <input type="hidden" id="parent-id" name="id"><input type="hidden" name="role" value="parent">
                        <input type="text" id="parent-name-input" name="name" required placeholder="Full Name" class="w-full rounded-xl border-gray-300">
                        <input type="email" id="parent-email-input" name="email" required placeholder="Email" class="w-full rounded-xl border-gray-300">
                        <input type="tel" id="parent-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-xl border-gray-300">
                        <input type="password" id="parent-password-input" name="password" placeholder="Password" class="w-full rounded-xl border-gray-300">
                        <button type="submit" id="parent-form-btn" class="w-full bg-primary text-white font-bold py-3 rounded-xl md:col-span-2">Save Parent</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100"><table class="w-full text-left"><tbody id="parent-table-body"></tbody></table></div>
            </div>

            <div id="content-courses" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Manage Courses</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8 border border-gray-100">
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <input type="hidden" id="course-id" name="id">
                        <input type="text" id="course-name" required placeholder="Course Name" class="w-full rounded-xl border-gray-300">
                        <input type="text" id="course-subjects" required placeholder="Subjects (comma separated)" class="w-full rounded-xl border-gray-300">
                        <select id="course-teacher" class="w-full rounded-xl border-gray-300 md:col-span-2"></select>
                        <button type="submit" id="save-course-btn" class="w-full bg-primary text-white font-bold py-3 rounded-xl md:col-span-2">Save Course</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100"><table class="w-full text-left"><tbody id="course-table-body"></tbody></table></div>
            </div>

            <div id="content-sessions" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Academic Sessions</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8 border border-gray-100">
                    <form id="session-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <input type="hidden" id="session-id" name="id">
                        <input type="text" id="session-name" required placeholder="Session Name (e.g. 2025-26)" class="w-full rounded-xl border-gray-300">
                        <select id="session-status" class="w-full rounded-xl border-gray-300"><option>Active</option><option>Inactive</option></select>
                        <input type="date" id="session-start-date" required class="w-full rounded-xl border-gray-300">
                        <input type="date" id="session-end-date" required class="w-full rounded-xl border-gray-300">
                        <button type="submit" id="save-session-btn" class="w-full bg-primary text-white font-bold py-3 rounded-xl md:col-span-2">Save Session</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100"><table class="w-full text-left"><tbody id="session-table-body"></tbody></table></div>
            </div>

            <div id="content-announcements" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Manage Announcements</h2>
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8 border border-gray-100">
                    <form id="announcement-form" class="space-y-4">
                        <input type="text" id="announcement-title" required placeholder="Announcement Title" class="w-full rounded-xl border-gray-300">
                        <textarea id="announcement-content" rows="4" required placeholder="Write your message..." class="w-full rounded-xl border-gray-300"></textarea>
                        <select id="announcement-target-group" class="w-full rounded-xl border-gray-300"><option value="all">All Users</option><option value="students">Students</option><option value="teachers">Teachers</option></select>
                        <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-xl">Publish Now</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase"><tr><th class="px-6 py-4">Title</th><th class="px-6 py-4">Content</th><th class="px-6 py-4">Group</th><th class="px-6 py-4 text-right">Actions</th></tr></thead>
                        <tbody id="management-announcements-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-fees" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Fees & Payments</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h3 class="font-bold mb-4 text-primary">Fee Structure</h3>
                        <form id="fee-structure-form" class="space-y-4">
                            <input type="hidden" id="fee-structure-id">
                            <input type="text" id="fee-structure-name" required placeholder="Fee Name" class="w-full rounded-xl border-gray-300">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="fee-session-select" required class="w-full rounded-xl border-gray-300"></select>
                                <select id="fee-course-select" class="w-full rounded-xl border-gray-300"></select>
                            </div>
                            <input type="number" id="fee-total-amount" required placeholder="Total Amount" class="w-full rounded-xl border-gray-300">
                            <input type="date" id="fee-due-date" required class="w-full rounded-xl border-gray-300">
                            <button type="submit" id="save-fee-structure-btn" class="w-full bg-primary text-white font-bold py-3 rounded-xl">Save Fee</button>
                        </form>
                        <div class="mt-6 pt-4 border-t border-gray-100"><table class="w-full text-sm"><tbody id="fee-structure-table-body"></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                        <h3 class="font-bold mb-4 text-green-700">Record Payment</h3>
                        <form id="payment-form" class="space-y-4">
                            <select id="payment-course-filter" class="w-full rounded-xl border-blue-200 bg-blue-50 text-blue-700 font-bold"><option value="">Filter by Course</option></select>
                            <select id="payment-student-select" required class="w-full rounded-xl border-gray-300"></select>
                            <select id="payment-fee-structure-select" required class="w-full rounded-xl border-gray-300"></select>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="payment-amount" required placeholder="Amount" class="w-full rounded-xl border-gray-300">
                                <select id="payment-method" class="w-full rounded-xl border-gray-300"><option>Cash</option><option>Online</option></select>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700">Record & Print Receipt</button>
                        </form>
                        <div class="mt-6 pt-4 border-t border-gray-100"><table class="w-full text-sm"><tbody id="fee-status-table-body"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="content-fee-pending-report" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Fee Pending Report</h2>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 font-bold text-gray-500"><tr><th class="px-6 py-4">Student</th><th class="px-6 py-4">Balance</th><th class="px-6 py-4">Due Date</th><th class="px-6 py-4">Status</th><th class="px-6 py-4 text-center">Alerts</th></tr></thead>
                        <tbody id="fee-pending-report-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-reports" class="content-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Analytics</h2>
                </div>
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-xl mb-6 w-fit">
                    <button onclick="switchReportTab('admissions')" id="tab-admissions" class="report-tab px-6 py-2 rounded-lg font-bold text-sm">Admissions</button>
                    <button onclick="switchReportTab('attendance')" id="tab-attendance" class="report-tab px-6 py-2 rounded-lg font-bold text-sm">Attendance</button>
                    <button onclick="switchReportTab('performance')" id="tab-performance" class="report-tab px-6 py-2 rounded-lg font-bold text-sm">Performance</button>
                </div>
                <div id="report-view-admissions" class="report-view"><div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100"><table class="w-full text-left"><tbody id="admissions-report-body"></tbody></table></div></div>
                <div id="report-view-attendance" class="report-view hidden"><div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100"><table class="w-full text-left"><tbody id="attendance-report-body"></tbody></table></div></div>
                <div id="report-view-performance" class="report-view hidden"><div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100"><table class="w-full text-left"><tbody id="performance-report-body"></tbody></table></div></div>
            </div>

            <div id="content-bulk-upload" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-6">Bulk Upload</h2>
                <div class="bg-white rounded-2xl shadow-sm p-8 border border-gray-100 max-w-xl">
                    <form id="bulk-upload-form" class="space-y-6">
                        <div class="border-2 border-dashed border-gray-300 rounded-2xl p-10 text-center hover:bg-gray-50 transition">
                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">cloud_upload</span>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Select CSV File</label>
                            <input type="file" id="bulk-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition">Start Import</button>
                    </form>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    // 1. CONFIGURATION
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    let allUsersCache = [], allCoursesCache = [], allSessionsCache = [];

    // 2. GLOBAL HELPERS
    function switchReportTab(tabName) {
        document.querySelectorAll('.report-view').forEach(el => el.classList.add('hidden'));
        document.getElementById(`report-view-${tabName}`).classList.remove('hidden');
        document.querySelectorAll('.report-tab').forEach(btn => {
            btn.classList.remove('bg-white', 'shadow-sm', 'text-primary');
            btn.classList.add('text-slate-500');
        });
        document.getElementById(`tab-${tabName}`).classList.add('bg-white', 'shadow-sm', 'text-primary');
    }

    // 3. ANNOUNCEMENT LOGIC (DUAL TABLE FIX)
    async function fetchAnnouncements(isManagementPage) {
        try {
            const res = await fetch(`${API_BASE_URL}/announcements`, { credentials: 'include' });
            const list = await res.json();
            const targetId = isManagementPage ? 'management-announcements-body' : 'recent-announcements-body';
            const tbody = document.getElementById(targetId);
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const displayList = isManagementPage ? list : list.slice(0, 5);
            if(displayList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-400">No announcements.</td></tr>'; return; }

            displayList.forEach(a => {
                const actions = isManagementPage ? `<div class="flex justify-end gap-2"><button onclick="deleteAnnouncement(${a.id})" class="btn-action bg-red-50 text-red-600 border-red-100 hover:bg-red-100">Delete</button></div>` : '';
                tbody.innerHTML += `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-bold text-slate-800">${a.title}</td>
                        <td class="px-6 py-4 text-slate-500 truncate max-w-xs">${a.content}</td>
                        <td class="px-6 py-4 text-slate-500 text-sm">${a.target_group}</td>
                        <td class="px-6 py-4 text-right">${actions}</td>
                    </tr>`;
            });
        } catch(e) { console.error(e); }
    }
    
    async function deleteAnnouncement(id) { if(confirm('Delete?')) { await fetch(`${API_BASE_URL}/announcements/${id}`, {method:'DELETE', credentials:'include'}); fetchAnnouncements(true); } }

    // 4. MAIN INIT
    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');

        function showSection(hash) {
            sections.forEach(s => s.classList.add('hidden'));
            const id = hash.substring(1) || 'dashboard';
            document.getElementById(`content-${id}`)?.classList.remove('hidden');
            
            navLinks.forEach(l => { l.classList.remove('bg-primary/10', 'text-primary'); l.classList.add('text-slate-600'); });
            const active = document.querySelector(`.nav-link[href="#${id}"]`);
            if(active) { active.classList.add('bg-primary/10', 'text-primary'); active.classList.remove('text-slate-600'); }
            
            loadContent(id);
        }

        async function loadContent(id) {
            if(id==='dashboard') fetchDashboard();
            if(id==='students') { fetchStudents(); populateDropdowns(); resetForm('student'); }
            if(id==='teachers') { fetchTeachers(); resetForm('teacher'); }
            if(id==='parents') { fetchParents(); resetForm('parent'); }
            if(id==='courses') { fetchCourses(); fetchTeachers(); resetForm('course'); }
            if(id==='sessions') { fetchSessions(); resetForm('session'); }
            if(id==='announcements') fetchAnnouncements(true);
            if(id==='fees') { fetchFees(); fetchFeeStatus(); fetchSessions(); fetchCourses(); }
            if(id==='fee-pending-report') fetchFeePending();
            if(id==='reports') { fetchAdmissions(); fetchAttendance(); fetchPerformance(); }
        }

        window.addEventListener('hashchange', () => showSection(window.location.hash));

        // AUTH
        async function checkAuth() {
            try {
                const res = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: 'include'});
                const data = await res.json();
                if(!data.logged_in || data.user.role !== 'admin') window.location.href = '/';
                else showSection(window.location.hash);
            } catch { window.location.href = '/'; }
        }
        document.getElementById('logout-btn').addEventListener('click', async () => { await fetch(`${API_BASE_URL}/logout`, {method:'POST', credentials:'include'}); window.location.href='/'; });

        // FETCHERS
        async function getUsers(role) {
            if(!allUsersCache.length) { const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'}); allUsersCache = await res.json(); }
            return role ? allUsersCache.filter(u => u.role === role) : allUsersCache;
        }

        async function fetchDashboard() {
            await getUsers();
            const courses = await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json();
            document.getElementById('total-teachers').textContent = (await getUsers('teacher')).length;
            document.getElementById('total-students').textContent = (await getUsers('student')).length;
            document.getElementById('total-parents').textContent = (await getUsers('parent')).length;
            document.getElementById('total-courses').textContent = courses.length;
            fetchAnnouncements(false);
        }

        async function fetchStudents(term='') {
            const list = await getUsers('student');
            const filtered = term ? list.filter(s => s.name.toLowerCase().includes(term.toLowerCase())) : list;
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = filtered.map(s => `
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="px-6 py-4 font-bold text-slate-800">${s.name}<br><span class="text-xs font-normal text-slate-400">${s.email}</span></td>
                    <td class="px-6 py-4 text-sm text-slate-500">${s.phone_number||'-'}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${s.parent_id ? 'Linked' : '-'}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editUser(${s.id}, 'student')" class="btn-action text-primary border-blue-100 hover:bg-blue-50 mr-2">Edit</button>
                        <button onclick="deleteUser(${s.id})" class="btn-action text-red-500 border-red-100 hover:bg-red-50">Delete</button>
                    </td>
                </tr>`).join('');
        }
        document.getElementById('student-search-input')?.addEventListener('input', (e) => fetchStudents(e.target.value));

        async function fetchTeachers() {
            const list = await getUsers('teacher');
            document.getElementById('teacher-table-body').innerHTML = list.map(t => `<tr class="border-b border-gray-50 hover:bg-gray-50"><td class="px-6 py-4 font-bold">${t.name}</td><td class="px-6 py-4 text-sm">${t.email}</td><td class="px-6 py-4 text-sm">${t.phone_number||'-'}</td><td class="px-6 py-4 text-right"><button onclick="editUser(${t.id}, 'teacher')" class="btn-action text-primary border-blue-100 hover:bg-blue-50 mr-2">Edit</button><button onclick="deleteUser(${t.id})" class="btn-action text-red-500 border-red-100 hover:bg-red-50">Delete</button></td></tr>`).join('');
        }
        async function fetchParents() {
            const list = await getUsers('parent');
            document.getElementById('parent-table-body').innerHTML = list.map(p => `<tr class="border-b border-gray-50 hover:bg-gray-50"><td class="px-6 py-4 font-bold">${p.name}</td><td class="px-6 py-4 text-sm">${p.email}</td><td class="px-6 py-4 text-sm">${p.phone_number||'-'}</td><td class="px-6 py-4 text-right"><button onclick="editUser(${p.id}, 'parent')" class="btn-action text-primary border-blue-100 hover:bg-blue-50 mr-2">Edit</button><button onclick="deleteUser(${p.id})" class="btn-action text-red-500 border-red-100 hover:bg-red-50">Delete</button></td></tr>`).join('');
        }

        async function fetchCourses() {
            const res = await fetch(`${API_BASE_URL}/courses`, {credentials:'include'});
            allCoursesCache = await res.json();
            document.getElementById('course-table-body').innerHTML = allCoursesCache.map(c => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${c.name}</td><td class="px-6 py-4 text-sm">${c.subjects}</td><td class="px-6 py-4 text-right"><button onclick="deleteData('courses', ${c.id})" class="btn-action text-red-500 border-red-100 hover:bg-red-50">Delete</button></td></tr>`).join('');
        }
        async function fetchSessions() {
            const res = await fetch(`${API_BASE_URL}/sessions`, {credentials:'include'});
            const list = await res.json();
            allSessionsCache = list;
            document.getElementById('session-table-body').innerHTML = list.map(s => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${s.name}</td><td class="px-6 py-4 text-sm">${s.status}</td><td class="px-6 py-4 text-right"><button onclick="editSession(${s.id})" class="btn-action text-primary border-blue-100 hover:bg-blue-50 mr-2">Edit</button><button onclick="deleteData('sessions', ${s.id})" class="btn-action text-red-500 border-red-100 hover:bg-red-50">Delete</button></td></tr>`).join('');
        }

        // --- FORM LOGIC ---
        const forms = { 'student-form': '/users', 'teacher-form': '/users', 'parent-form': '/users', 'course-form': '/courses', 'session-form': '/sessions', 'announcement-form': '/announcements', 'fee-structure-form': '/fee_structures', 'payment-form': '/payments' };
        
        Object.keys(forms).forEach(id => {
            document.getElementById(id)?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const isFile = document.getElementById('student-photo-file-input')?.files?.length > 0;
                
                // Special handling for photo upload on EDIT
                if(id === 'student-form' && formData.get('id')) {
                    if(isFile) {
                       const photoData = new FormData();
                       photoData.append('profile_photo_file', formData.get('profile_photo_file'));
                       await fetch(`${API_BASE_URL}/user/upload_photo/${formData.get('id')}`, { method: 'POST', credentials: 'include', body: photoData });
                       formData.delete('profile_photo_file'); // Don't send file in main update
                    }
                }

                // Check password
                if(formData.get('password') === '') formData.delete('password');

                // Course fix: Convert formData to JSON correctly for courses
                let body, headers = {};
                if(id === 'course-form' || id === 'session-form' || id === 'announcement-form' || id === 'fee-structure-form' || id === 'payment-form') {
                    body = JSON.stringify(Object.fromEntries(formData));
                    headers = {'Content-Type': 'application/json'};
                } else {
                    body = isFile && !formData.get('id') ? formData : JSON.stringify(Object.fromEntries(formData));
                    headers = isFile && !formData.get('id') ? {} : {'Content-Type': 'application/json'};
                }

                const method = formData.get('id') ? 'PUT' : 'POST';

                try {
                    const res = await fetch(`${API_BASE_URL}${forms[id]}`, { method, headers, credentials: 'include', body });
                    if(res.ok) { 
                        alert('Saved successfully!'); 
                        form.reset(); 
                        allUsersCache=[]; 
                        loadContent(window.location.hash.substring(1));
                        if(id === 'payment-form') { const d = await res.json(); if(d.payment_id) window.open(`${API_BASE_URL}/receipt/${d.payment_id}`, '_blank'); }
                    } else { 
                        const err = await res.json(); alert('Failed: ' + err.message); 
                    }
                } catch(err) { alert('Error: ' + err); }
            });
        });

        // EDIT POPULATE
        window.editUser = async (id, role) => {
            const user = (await getUsers(role)).find(u => u.id === id);
            if(!user) return;
            const form = document.getElementById(`${role}-form`);
            form.querySelector('[name="id"]').value = user.id;
            form.querySelector('[name="name"]').value = user.name;
            form.querySelector('[name="email"]').value = user.email;
            if(role === 'student') {
                form.querySelector('[name="phone_number"]').value = user.phone_number || '';
                form.querySelector('[name="dob"]').value = user.dob || '';
                form.querySelector('[name="gender"]').value = user.gender || '';
                form.querySelector('[name="father_name"]').value = user.father_name || '';
                form.querySelector('[name="mother_name"]').value = user.mother_name || '';
                form.querySelector('[name="address_line1"]').value = user.address_line1 || '';
                form.querySelector('[name="city"]').value = user.city || '';
                form.querySelector('[name="state"]').value = user.state || '';
                form.querySelector('[name="pincode"]').value = user.pincode || '';
                if(user.course_ids?.length) document.getElementById('student-course-select').value = user.course_ids[0];
                if(user.parent_id) document.getElementById('student-parent-select').value = user.parent_id;
                document.getElementById('student-photo-preview').src = user.profile_photo_url ? `${API_ORIGIN}${user.profile_photo_url}` : 'https://placehold.co/100';
            }
            window.location.hash = role + 's';
        };
        
        window.editSession = (id) => {
            const session = allSessionsCache.find(s => s.id == id);
            if(session) {
                const form = document.getElementById('session-form');
                form.querySelector('[name="id"]').value = session.id;
                form.querySelector('[name="name"]').value = session.name;
                form.querySelector('[name="start_date"]').value = session.start_date;
                form.querySelector('[name="end_date"]').value = session.end_date;
                form.querySelector('[name="status"]').value = session.status;
                window.location.hash = 'sessions';
            }
        };
        
        window.editFeeStructure = async (id) => {
            const res = await fetch(`${API_BASE_URL}/fee_structures`, {credentials:'include'});
            const list = await res.json();
            const s = list.find(x => x.id == id);
            if(s) {
                const form = document.getElementById('fee-structure-form');
                form.querySelector('[name="id"]').value = s.id;
                form.querySelector('[name="name"]').value = s.name;
                form.querySelector('[name="total_amount"]').value = s.total_amount;
                form.querySelector('[name="due_date"]').value = s.due_date;
                form.querySelector('[name="academic_session_id"]').value = s.academic_session_id;
                form.querySelector('[name="course_id"]').value = s.course_id || '';
                window.location.hash = 'fees';
            }
        }

        window.deleteUser = async (id) => { if(confirm('Delete?')) { await fetch(`${API_BASE_URL}/users/${id}`, {method:'DELETE', credentials:'include'}); allUsersCache=[]; loadContent(window.location.hash.substring(1)); } };
        window.deleteData = async (type, id) => { if(confirm('Delete?')) { await fetch(`${API_BASE_URL}/${type}/${id}`, {method:'DELETE', credentials:'include'}); loadContent(window.location.hash.substring(1)); } };
        window.resetForm = (type) => document.getElementById(`${type}-form`)?.reset();

        // HELPERS
        async function populateDropdowns() {
            const courses = allCoursesCache.length ? allCoursesCache : await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json();
            const parents = await getUsers('parent');
            
            document.getElementById('student-course-select').innerHTML = '<option value="">Select Course</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('student-parent-select').innerHTML = '<option value="">Link Parent</option>' + parents.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            // Fee/Payment dropdowns
            document.getElementById('fee-course-select').innerHTML = '<option value="">Global</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('payment-course-filter').innerHTML = '<option value="">Show All</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('fee-session-select').innerHTML = '<option value="">Select Session</option>' + allSessionsCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        // FEES & REPORTS (Keep simple for brevity as logic is same as before)
        async function fetchFees() {
            const res = await fetch(`${API_BASE_URL}/fee_structures`, {credentials:'include'});
            const list = await res.json();
            document.getElementById('fee-structure-table-body').innerHTML = list.map(f => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${f.name}</td><td class="px-6 py-4">₹${f.total_amount}</td><td class="px-6 py-4">${f.due_date}</td><td class="px-6 py-4 text-right"><button onclick="editFeeStructure(${f.id})" class="btn-action text-primary border-blue-100 hover:bg-blue-50 mr-2">Edit</button><button onclick="deleteData('fee_structures', ${f.id})" class="btn-action text-red-500 border-red-100 hover:bg-red-50">Delete</button></td></tr>`).join('');
            document.getElementById('payment-fee-structure-select').innerHTML = '<option value="">Select Fee</option>' + list.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        }
        async function fetchFeeStatus() {
            const res = await fetch(`${API_BASE_URL}/fee_status`, {credentials:'include'});
            const list = await res.json();
            document.getElementById('fee-status-table-body').innerHTML = list.map(s => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${s.student_name}</td><td class="px-6 py-4 font-bold ${s.balance>0?'text-red-500':'text-green-500'}">₹${s.balance}</td><td class="px-6 py-4 text-sm text-slate-500">${s.pending_days} days</td><td class="px-6 py-4 text-center text-xs font-bold text-amber-500">PENDING</td><td class="px-6 py-4 text-right"><button onclick="window.open('${API_BASE_URL}/receipt/${s.latest_payment_id}')" class="btn-action text-blue-600 border-blue-100 hover:bg-blue-50">Print</button></td></tr>`).join('');
            document.getElementById('payment-student-select').innerHTML = '<option value="">Select Student</option>' + list.map(s => `<option value="${s.student_id}">${s.student_name}</option>`).join('');
        }
        async function fetchFeePending() {
            const res = await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials:'include'});
            const list = await res.json();
            document.getElementById('fee-pending-report-body').innerHTML = list.map(s => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${s.student_name}</td><td class="px-6 py-4 text-red-600 font-bold">₹${s.balance}</td><td class="px-6 py-4">${s.due_date}</td><td class="px-6 py-4 text-slate-500">${s.pending_days} days overdue</td><td class="text-center"><span class="material-symbols-outlined text-amber-500">sms</span></td></tr>`).join('');
        }
        async function fetchAdmissions() {
            const res = await fetch(`${API_BASE_URL}/reports/admissions`, {credentials:'include'});
            document.getElementById('admissions-report-body').innerHTML = (await res.json()).map(d => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${d.name}</td><td class="px-6 py-4">${d.email}</td><td class="px-6 py-4">${d.created_at}</td></tr>`).join('');
        }
        async function fetchAttendance() {
            const res = await fetch(`${API_BASE_URL}/reports/attendance`, {credentials:'include'});
            document.getElementById('attendance-report-body').innerHTML = (await res.json()).map(d => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${d.student_name}</td><td class="px-6 py-4">${d.total_classes}</td><td class="px-6 py-4 text-green-600">${d.present}</td><td class="px-6 py-4 text-red-600">${d.absent}</td><td class="px-6 py-4 font-bold">${d.percentage}%</td></tr>`).join('');
        }
        async function fetchPerformance() {
            const res = await fetch(`${API_BASE_URL}/reports/performance`, {credentials:'include'});
            document.getElementById('performance-report-body').innerHTML = (await res.json()).map(d => `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold">${d.student_name}</td><td class="px-6 py-4">${d.assessments_taken}</td><td class="px-6 py-4">${d.total_score}</td><td class="px-6 py-4 font-bold">${d.overall_percentage}%</td></tr>`).join('');
        }

        // Bulk Upload
        document.getElementById('bulk-upload-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('bulk-upload-form'));
            const res = await fetch(`${API_BASE_URL}/bulk_upload/users`, { method: 'POST', credentials: 'include', body: formData });
            const data = await res.json();
            alert(data.message || 'Done');
        });

        checkAuth();
    });
</script>
</body>
</html>
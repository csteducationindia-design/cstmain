<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Portal</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
tailwind.config = {
darkMode: "class",
theme: {
extend: {
colors: {
"primary": "#1173d4",
"background-light": "#f6f7f8",
"background-dark": "#101922",
},
fontFamily: {
"display": ["Inter"]
},
borderRadius: {
"DEFAULT": "0.25rem",
"lg": "0.5rem",
"xl": "0.75rem",
"full": "9999px"
},
},
},
}
</script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
.table-auto-layout {
table-layout: auto;
}
.overdue {
color: #ef4444; /* text-red-500 /
font-weight: 600;
}
.pending {
color: #f59e0b; / text-amber-500 /
font-weight: 600;
}
.paid {
color: #10b981; / text-emerald-500 */
font-weight: 600;
}
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
<aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
<div class="p-6">
<h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Admin</h1>
<p class="text-sm text-slate-500 dark:text-slate-400">Admin Portal</p>
</div>
<nav class="flex-1 px-4 py-2 space-y-1">
<a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary">
<span class="material-symbols-outlined">dashboard</span>
<span class="text-sm font-medium">Dashboard</span>
</a>
<a href="#teachers" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">person</span>
<span class="text-sm font-medium">Teachers</span>
</a>
<a href="#students" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">school</span>
<span class="text-sm font-medium">Students</span>
</a>
<a href="#parents" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">groups</span>
<span class="text-sm font-medium">Parents</span>
</a>
<a href="#courses" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">book</span>
<span class="text-sm font-medium">Courses</span>
</a>
<a href="#sessions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">calendar_month</span>
<span class="text-sm font-medium">Sessions</span>
</a>
<a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">campaign</span>
<span class="text-sm font-medium">Announcements</span>
</a>
<a href="#fees" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">payments</span>
<span class="text-sm font-medium">Fees & Payments</span>
</a>
<a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">receipt_long</span>
<span class="text-sm font-medium">Fee Pending Report</span>
</a>
<a href="#admin-message" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">message</span>
<span class="text-sm font-medium">Bulk Message</span>
</a>
<a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">analytics</span>
<span class="text-sm font-medium">Reports</span>
</a>
<a href="#bulk-upload" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">upload_file</span>
<span class="text-sm font-medium">Bulk Upload</span>
</a>
</nav>
<div class="p-6 border-t border-slate-200 dark:border-slate-800">
<button id="logout-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-red-700 transition duration-150">
Logout
</button>
</div>
</aside>

<main class="flex-1 p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-slate-900 dark:text-white">Admin Dashboard</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Welcome back, Admin! Here's an overview of your institute.</p>
        </header>


<div id="content-dashboard" class="content-section">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
<p class="text-slate-500 dark:text-slate-400 text-sm">Total Teachers</p>
<p id="total-teachers" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
</div>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
<p class="text-slate-500 dark:text-slate-400 text-sm">Total Students</p>
<p id="total-students" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
</div>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
<p class="text-slate-500 dark:text-slate-400 text-sm">Total Parents</p>
<p id="total-parents" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
</div>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
<p class="text-slate-500 dark:text-slate-400 text-sm">Total Courses</p>
<p id="total-courses" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
</div>
</div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Quick Actions</h2>
                <div class="flex gap-4">
                    <a href="#teachers" class="bg-primary text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Manage Teachers</a>
                    <a href="#students" class="bg-primary text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Manage Students</a>


</div>
</div>

            <div>
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Recent Announcements</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target Group</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-announcements-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>


<div id="content-teachers" class="content-section hidden">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Teachers</h2>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
<h3 id="teacher-form-title" class="text-xl font-bold mb-4">Add/Edit Teacher</h3>
<form id="teacher-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<input type="hidden" id="teacher-id" name="id">
<input type="hidden" id="teacher-role" name="role" value="teacher">
<div class="form-group"><label for="teacher-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="teacher-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="teacher-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="teacher-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="teacher-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="teacher-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="teacher-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="teacher-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="md:col-span-2">
<button type="submit" id="teacher-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Teacher</button>
</div>
</form>
</div>
<div>
<h3 class="text-xl font-bold mb-4">Existing Teachers</h3>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
<thead>
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
<th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="teacher-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
</table>
</div>
</div>
</div>

        <div id="content-students" class="content-section hidden">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Students</h2>
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                <h3 id="student-form-title" class="text-xl font-bold mb-4">Add/Edit Student</h3>
                <form id="student-form" class="space-y-6" enctype="multipart/form-data">
                    <input type="hidden" id="student-id" name="id">
                    <input type="hidden" id="student-role" name="role" value="student">
                    
                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Enrollment Details</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group md:col-span-1">
                                <label for="student-course-select" class="block text-sm font-medium mb-1">Course Enrollment *</label>
                                <select id="student-course-select" name="course_ids" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                    <option value="">Select Course</option>
                                </select>
                                <p class="text-xs text-red-500 mt-1">Required for Attendance/Reports</p>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Basic Details</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group"><label for="student-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="student-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="student-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="student-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-dob-input" class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" id="student-dob-input" name="dob" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-gender-select" class="block text-sm font-medium mb-1">Gender</label>
                                <select id="student-gender-select" name="gender" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                             <div class="form-group"><label for="student-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="student-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Parent/Guardian Details</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group"><label for="student-father-name-input" class="block text-sm font-medium mb-1">Father's Name</label><input type="text" id="student-father-name-input" name="father_name" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-mother-name-input" class="block text-sm font-medium mb-1">Mother's Name</label><input type="text" id="student-mother-name-input" name="mother_name" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-parent-select" class="block text-sm font-medium mb-1">Link Parent Account (Optional)</label><select id="student-parent-select" name="parent_id" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Address Details</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group md:col-span-3"><label for="student-address-input" class="block text-sm font-medium mb-1">Address Line 1</label><input type="text" id="student-address-input" name="address_line1" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-city-input" class="block text-sm font-medium mb-1">City</label><input type="text" id="student-city-input" name="city" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-state-input" class="block text-sm font-medium mb-1">State</label><input type="text" id="student-state-input" name="state" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="student-pincode-input" class="block text-sm font-medium mb-1">Pincode</label><input type="text" id="student-pincode-input" name="pincode" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        </div>
                    </fieldset>
                    

                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Profile Photo</legend>
                        <div class="flex items-center gap-4">
                            <img id="student-photo-preview" src="https://placehold.co/100x100/f6f7f8/666?text=Preview" alt="Photo Preview" class="w-24 h-24 rounded-lg object-cover border border-slate-300 dark:border-slate-700">
                            <div class="form-group">
                                <label for="student-photo-file-input" class="block text-sm font-medium mb-1">Upload Photo (Optional)</label>
                                <input type="file" id="student-photo-file-input" name="profile_photo_file" accept="image/png, image/jpeg, image/gif" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary dark:file:bg-primary/20 dark:file:text-primary hover:file:bg-primary/20 dark:hover:file:bg-primary/30">
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Select a file to update. Leave blank to keep existing photo (if editing).</p>
                            </div>
                        </div>
                    </fieldset>

                    <div class="pt-4">
                        <button type="submit" id="student-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Student</button>
                    </div>
                </form>
            </div>
            <div>
                <div class="mb-4">
                    <label for="student-search-input" class="block text-sm font-medium mb-1">Search Students (by Name, Email, or Phone)</label>
                    <input type="text" id="student-search-input" placeholder="Start typing to search..." class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                </div>

                <h3 class="text-xl font-bold mb-4">Existing Students</h3>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Parent</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">SMS</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">WhatsApp</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="content-parents" class="content-section hidden">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Parents</h2>
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                <h3 id="parent-form-title" class="text-xl font-bold mb-4">Add/Edit Parent</h3>
                <form id="parent-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="parent-id" name="id">
                    <input type="hidden" id="parent-role" name="role" value="parent">
                    <div class="form-group"><label for="parent-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="parent-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                    <div class="form-group"><label for="parent-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="parent-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                    <div class="form-group"><label for="parent-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="parent-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                    <div class="form-group"><label for="parent-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="parent-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                    <div class="md:col-span-2">
                        <button type="submit" id="parent-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Parent</button>
                    </div>
                </form>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Existing Parents</h3>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="parent-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>


<div id="content-courses" class="content-section hidden">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Courses</h2>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
<h3 class="text-xl font-bold mb-4">Add New Course</h3>
<form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<input type="hidden" id="course-id" name="id">
<div class="form-group"><label for="course-name" class="block text-sm font-medium mb-1">Course Name</label><input type="text" id="course-name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="course-subjects" class="block text-sm font-medium mb-1">Subjects (comma-separated)</label><input type="text" id="course-subjects" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="course-teacher" class="block text-sm font-medium mb-1">Assign Teacher</label><select id="course-teacher" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
<div class="md:col-span-2">
<button type="submit" id="save-course-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Course</button>
</div>
</form>
</div>
<div>
<h3 class="text-xl font-bold mb-4">Existing Courses</h3>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
<thead>
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Course Name</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjects</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Teacher</th>
<th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="course-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
</table>
</div>
</div>
</div>

<div id="content-sessions" class="content-section hidden">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Academic Sessions</h2>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
<h3 class="text-xl font-bold mb-4">Add New Session</h3>
<form id="session-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<input type="hidden" id="session-id" name="id">
<div class="form-group"><label for="session-name" class="block text-sm font-medium mb-1">Session Name</label><input type="text" id="session-name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="session-start-date" class="block text-sm font-medium mb-1">Start Date</label><input type="date" id="session-start-date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="session-end-date" class="block text-sm font-medium mb-1">End Date</label><input type="date" id="session-end-date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="session-status" class="block text-sm font-medium mb-1">Status</label><select id="session-status" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
<div class="md:col-span-2">
<button type="submit" id="save-session-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Session</button>
</div>
</form>
</div>
<div>
<h3 class="text-xl font-bold mb-4">Existing Sessions</h3>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
<thead>
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Start Date</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">End Date</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
<th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="session-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
</table>
</div>
</div>
</div>

<div id="content-announcements" class="content-section hidden">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Announcements</h2>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
<h3 class="text-xl font-bold mb-4">Create New Announcement</h3>
<form id="announcement-form">
<div class="mb-4"><label for="announcement-title" class="block text-sm font-medium mb-1">Title</label><input type="text" id="announcement-title" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="mb-4"><label for="announcement-content" class="block text-sm font-medium mb-1">Content</label><textarea id="announcement-content" rows="5" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea></div>
<div class="mb-4"><label for="announcement-target-group" class="block text-sm font-medium mb-1">Target Group</label><select id="announcement-target-group" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="all">All Users</option><option value="teachers">Teachers</option><option value="students">Students</option><option value="parents">Parents</option><option value="admin">Admin</option></select></div>
<button type="submit" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Publish Announcement</button>
</form>
</div>
<div>
<h3 class="text-xl font-bold mb-4">Existing Announcements</h3>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
<thead>
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Content</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target Group</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
<th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="recent-announcements-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
</table>
</div>
</div>
</div>

<div id="content-fees" class="content-section hidden">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Fees & Payments</h2>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
<h3 class="text-xl font-bold mb-4">Manage Fee Structures</h3>
<form id="fee-structure-form" class="space-y-4">
<input type="hidden" id="fee-structure-id" name="id">
<div class="form-group"><label for="fee-structure-name" class="block text-sm font-medium mb-1">Structure Name</label><input type="text" id="fee-structure-name" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="fee-session-select" class="block text-sm font-medium mb-1">Academic Session</label><select id="fee-session-select" name="academic_session_id" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
<div class="form-group"><label for="fee-total-amount" class="block text-sm font-medium mb-1">Total Amount</label><input type="number" step="0.01" id="fee-total-amount" name="total_amount" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<div class="form-group"><label for="fee-due-date" class="block text-sm font-medium mb-1">Due Date</label><input type="date" id="fee-due-date" name="due_date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
<button type="submit" id="save-fee-structure-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Fee Structure</button>
</form>
<h4 class="text-lg font-bold mt-8 mb-4">Existing Fee Structures</h4>
<div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
<thead>
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Date</th>
<th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="fee-structure-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
</table>
</div>
</div>

                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-bold mb-4">Record Payment</h3>
                    <form id="payment-form" class="space-y-4">
                        <div class="form-group"><label for="payment-student-select" class="block text-sm font-medium mb-1">Student</label><select id="payment-student-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                        <div class="form-group"><label for="payment-fee-structure-select" class="block text-sm font-medium mb-1">Fee Structure</label><select id="payment-fee-structure-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                        <div class="form-group"><label for="payment-amount" class="block text-sm font-medium mb-1">Amount Paid</label><input type="number" step="0.01" id="payment-amount" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="payment-method" class="block text-sm font-medium mb-1">Payment Method</label><select id="payment-method" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="Cash">Cash</option><option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option></select></div>
                        <button type="submit" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Record Payment & Print Receipt</button>
                    </form>
                    <h4 class="text-lg font-bold mt-8 mb-4">Fee Status Overview</h4>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Balance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Days</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Alerts</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Receipt</th>
                                </tr>
                            </thead>
                        <tbody id="fee-status-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
         <div id="content-fee-pending-report" class="content-section hidden">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Student Fee Pending Report</h2>
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Pending Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Days Status</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">SMS</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">WhatsApp</th>
                        </tr>
                    </thead>
                    <tbody id="fee-pending-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                </table>
            </div>
        </div>
        <div id="content-admin-message" class="content-section hidden">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Send Bulk Notifications (SMS/WhatsApp Mock)</h2>
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                <form id="admin-bulk-message-form">
                    <div class="mb-4">
                        <label for="message-target-role" class="block text-sm font-medium mb-1">Target Group</label>
                        <select id="message-target-role" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                            <option value="all">All Users (Teachers, Students, Parents)</option>
                            <option value="teachers">Teachers Only</option>
                            <option value="students">Students Only</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="message-subject" class="block text-sm font-medium mb-1">Subject / Header</label><input type="text" id="message-subject" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                    <div class="mb-4">
                        <label for="message-body" class="block text-sm font-medium mb-1">Message Content (Max 160 Chars for SMS Mock)</label><textarea id="message-body" rows="4" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" data-type="sms" class="send-bulk-btn w-full bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-yellow-700 transition duration-150">
                            Send Bulk SMS
                        </button>
                        <button type="button" data-type="whatsapp" class="send-bulk-btn w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                            Send Bulk WhatsApp (Mock)
                        </button>
                    </div>
                </form>
                <p id="admin-message-status" class="mt-4 text-sm font-medium text-center text-slate-500 dark:text-slate-400 hidden"></p>
            </div>
        </div>
        <div id="content-reports" class="content-section hidden">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">General Reports</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-bold mb-4">Recent Admissions Report (Last 30 Days)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Admission Date</th>
                                </tr>
                            </thead>
                            <tbody id="admissions-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-bold mb-4">Student Attendance Report</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Classes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Present</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Absent</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                    <h3 class="text-xl font-bold mb-4">Student Performance Report</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Assessments Taken</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Overall Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="performance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-bulk-upload" class="content-section hidden">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Bulk Data Upload</h2>
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                <h3 class="text-xl font-bold mb-4">Upload Users (Students, Teachers, Parents)</h3>
                <p class="text-sm text-red-500 dark:text-red-400 mb-4">NOTE: File must be a **CSV** with columns: **name, email, password, role** (required), **phone_number, parent_email, dob, gender, father_name, mother_name, address_line1, city, state, pincode** (optional).</p>
                
                <form id="bulk-upload-form" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="bulk-file-input" class="block text-sm font-medium mb-1">Select CSV File</label>
                        <input type="file" id="bulk-file-input" name="file" accept=".csv" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 p-2">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                        Process Bulk Upload
                    </button>
                </form>

                <div id="bulk-upload-results" class="mt-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg hidden">
                    <h4 class="text-lg font-bold mb-2">Results:</h4>
                    <p id="bulk-upload-message" class="font-medium mb-2"></p>
                    <div id="bulk-upload-details"></div>
                </div>
            </div>
        </div>
        </div>
</main>


</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
// DEFINE: Define the base URL explicitly using the current location origin
const API_ORIGIN = window.location.origin;
const API_BASE_URL = API_ORIGIN + '/api';

// Store all users in memory for searching
let allUsersCache = [];
let allCoursesCache = []; // Cache courses globally
let allSessionsCache = []; // Cache sessions globally

document.addEventListener(&#39;DOMContentLoaded&#39;, () =&gt; {
    
    // --- GLOBAL UI &amp; NAVIGATION ---
    const logoutBtn = document.getElementById(&#39;logout-btn&#39;);
    const contentSections = document.querySelectorAll(&#39;.content-section&#39;);
    const navLinks = document.querySelectorAll(&#39;.nav-link&#39;);
    const sessionForm = document.getElementById(&#39;session-form&#39;);
    const courseForm = document.getElementById(&#39;course-form&#39;);
    const courseTeacherSelect = document.getElementById(&#39;course-teacher&#39;);
    const feeStructureForm = document.getElementById(&#39;fee-structure-form&#39;);
    const paymentForm = document.getElementById(&#39;payment-form&#39;);
    const announcementForm = document.getElementById(&#39;announcement-form&#39;); 
    const searchInput = document.getElementById(&#39;student-search-input&#39;); 
    const bulkUploadForm = document.getElementById(&#39;bulk-upload-form&#39;);
    const adminBulkMessageForm = document.getElementById(&#39;admin-bulk-message-form&#39;);

    let searchTimeout;

    function updateNavLink(hash) {
        navLinks.forEach(link =&gt; {
            link.classList.remove(&#39;bg-primary/10&#39;, &#39;dark:bg-primary/20&#39;, &#39;text-primary&#39;);
            link.classList.add(&#39;text-slate-700&#39;, &#39;dark:text-slate-300&#39;, &#39;hover:bg-primary/10&#39;, &#39;dark:hover:bg-primary/20&#39;);
        });
        const targetLink = document.querySelector(`.nav-link[href=&quot;${hash}&quot;]`);
        if (targetLink) { 
            targetLink.classList.add(&#39;bg-primary/10&#39;, &#39;dark:bg-primary/20&#39;, &#39;text-primary&#39;);
            targetLink.classList.remove(&#39;text-slate-700&#39;, &#39;dark:text-slate-300&#39;, &#39;hover:bg-primary/10&#39;, &#39;dark:hover:bg-primary/20&#39;);
        }
    }

    function showSection(hash) {
        contentSections.forEach(section =&gt; {
            section.classList.add(&#39;hidden&#39;);
        });

        let targetId = hash.substring(1) || &#39;dashboard&#39;; // Default to dashboard
        let targetSection = document.getElementById(`content-${targetId}`);
        
        updateNavLink(hash); 

        if (targetSection) {
            targetSection.classList.remove(&#39;hidden&#39;);
        }
    }
    
    function loadContentByHash() {
        const currentHash = window.location.hash.substring(1) || &#39;dashboard&#39;;
        
        try { 
            switch (currentHash) {
                case &#39;dashboard&#39;: 
                    fetchDashboardSummary(); 
                    break;
                case &#39;teachers&#39;: 
                    fetchTeachers(); 
                    resetUserForm(&#39;teacher&#39;); 
                    break; 
                case &#39;students&#39;: 
                    fetchStudents(); 
                    populateParentDropdowns(); 
                    resetUserForm(&#39;student&#39;); 
                    fetchCoursesForEnrollment(); 
                    break; 
                case &#39;parents&#39;: 
                    fetchParents(); 
                    resetUserForm(&#39;parent&#39;); 
                    break;
                case &#39;courses&#39;: 
                    fetchCourses(); 
                    fetchTeachersForCourseDropdown(); 
                    resetCourseForm(null); 
                    break; 
                case &#39;sessions&#39;: 
                    fetchSessions(); 
                    resetSessionForm(null); 
                    break;
                case &#39;announcements&#39;: 
                    fetchAnnouncements(true); 
                    break;
                case &#39;fees&#39;: 
                    fetchFeeStructures(); 
                    fetchStudentsForPaymentDropdown(); 
                    fetchFeeSessionDropdowns(); 
                    fetchFeeStatus(); 
                    resetFeeStructureForm(null);
                    break;
                case &#39;fee-pending-report&#39;: 
                    fetchFeePendingReport(); 
                    break; 
                case &#39;reports&#39;: 
                    fetchAdmissionsReport(); 
                    fetchAttendanceReport(); 
                    fetchPerformanceReport(); 
                    break;
                case &#39;admin-message&#39;: 
                    break;
                case &#39;bulk-upload&#39;: 
                    break;
                default: 
                    console.warn(`Unknown hash: ${currentHash}`); 
                    break;
            }
        } catch(e) {
            console.error(&quot;Content Loading Error:&quot;, e);
            alert(&quot;An error occurred loading content. Please check the console.&quot;);
        }
    }

    window.addEventListener(&#39;hashchange&#39;, () =&gt; {
         try { 
            showSection(window.location.hash); 
            loadContentByHash();
         } catch(e) {
             console.error(&quot;Navigation Error:&quot;, e);
             alert(&quot;A critical navigation error occurred. See console for details.&quot;);
         }
    });

    // Initial load based on hash or default to dashboard
    showSection(window.location.hash);

    // --- AUTHENTICATION ---
    async function checkAdminSession() {
        try {
            const response = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: &#39;include&#39;});
            if (!response.ok) throw new Error(&#39;Session check failed&#39;);
            const result = await response.json();
            if (!result.logged_in || result.user.role !== &#39;admin&#39;) { 
                window.location.href = API_ORIGIN + &#39;/&#39;; 
            } else {
                // Start pre-fetching global data immediately after login check succeeds
                fetchAllUsers().then(() =&gt; {
                    loadContentByHash(); // Call after initial data load
                });
            }
        } catch (error) {
            console.error(&quot;Could not verify session. Redirecting to login.&quot;, error);
            window.location.href = API_ORIGIN + &#39;/&#39;;
        }
    }
    logoutBtn.addEventListener(&#39;click&#39;, async () =&gt; {
        try { 
            await fetch(`${API_BASE_URL}/logout`, { method: &#39;POST&#39;, credentials: &#39;include&#39; });
            window.location.href = API_ORIGIN + &#39;/&#39;;
        } catch (error) {
            console.error(&quot;Logout Error:&quot;, error);
            alert(&quot;Logout failed. Please try refreshing the page.&quot;);
        }
    });

    // --- DASHBOARD SUMMARY ---
    async function fetchDashboardSummary() {
         try {
             // Reuse cached data where possible
             const teachersCount = allUsersCache.filter(u =&gt; u.role === &#39;teacher&#39;).length;
             const studentsCount = allUsersCache.filter(u =&gt; u.role === &#39;student&#39;).length;
             const parentsCount = allUsersCache.filter(u =&gt; u.role === &#39;parent&#39;).length;
             
             const coursesResponse = await fetch(`${API_BASE_URL}/courses`, {credentials: &#39;include&#39;});
             allCoursesCache = await coursesResponse.json(); 

             const sessionsResponse = await fetch(`${API_BASE_URL}/sessions`, {credentials: &#39;include&#39;});
             allSessionsCache = await sessionsResponse.json(); 

             document.getElementById(&#39;total-teachers&#39;).textContent = teachersCount;
             document.getElementById(&#39;total-students&#39;).textContent = studentsCount;
             document.getElementById(&#39;total-parents&#39;).textContent = parentsCount;
             document.getElementById(&#39;total-courses&#39;).textContent = allCoursesCache.length;
             
             fetchAnnouncements(false); 
         } catch(error) {
              console.error(&quot;Error loading dashboard summary:&quot;, error);
              document.getElementById(&#39;total-teachers&#39;).textContent = &#39;Error&#39;;
              document.getElementById(&#39;total-students&#39;).textContent = &#39;Error&#39;;
              document.getElementById(&#39;total-parents&#39;).textContent = &#39;Error&#39;;
              document.getElementById(&#39;total-courses&#39;).textContent = &#39;Error&#39;;
         }
    }

    // --- USER MANAGEMENT UTILITIES ---

    async function fetchAllUsers(searchTerm = &#39;&#39;) {
        try {
            let endpoint = `${API_BASE_URL}/users`;
            if (searchTerm) {
                endpoint += `?search=${encodeURIComponent(searchTerm)}`;
            }
            const response = await fetch(endpoint, { credentials: &#39;include&#39; });
            if (!response.ok) throw new Error(&#39;Failed to fetch users&#39;);
            
            const users = await response.json();
            if (!searchTerm) { allUsersCache = users; }
            return users;
        } catch (error) {
            console.error(&quot;Error fetching all users:&quot;, error);
            return [];
        }
    }

    function populateUserForm(user, role) {
        const form = document.getElementById(`${role}-form`);
        if (!form) return;

        form.querySelector(&#39;input[id$=&quot;-id&quot;]&#39;).value = user.id;
        form.querySelector(&#39;input[id$=&quot;-name-input&quot;]&#39;).value = user.name;
        form.querySelector(&#39;input[id$=&quot;-email-input&quot;]&#39;).value = user.email;
        
        const phoneInput = form.querySelector(&#39;input[id$=&quot;-phone-input&quot;]&#39;);
        if (phoneInput) phoneInput.value = user.phone_number || &#39;&#39;;

        const passwordInput = form.querySelector(&#39;input[id$=&quot;-password-input&quot;]&#39;);
        if (passwordInput) {
            passwordInput.value = &#39;&#39;;
            passwordInput.placeholder = &#39;Leave blank to keep current password&#39;;
        }
        
        if (role === &#39;student&#39;) {
            document.getElementById(&#39;student-parent-select&#39;).value = user.parent_id || &#39;&#39;;
            document.getElementById(&#39;student-dob-input&#39;).value = user.dob || &#39;&#39;;
            document.getElementById(&#39;student-gender-select&#39;).value = user.gender || &#39;&#39;;
            document.getElementById(&#39;student-father-name-input&#39;).value = user.father_name || &#39;&#39;;
            document.getElementById(&#39;student-mother-name-input&#39;).value = user.mother_name || &#39;&#39;;
            document.getElementById(&#39;student-address-input&#39;).value = user.address_line1 || &#39;&#39;;
            document.getElementById(&#39;student-city-input&#39;).value = user.city || &#39;&#39;;
            document.getElementById(&#39;student-state-input&#39;).value = user.state || &#39;&#39;;
            document.getElementById(&#39;student-pincode-input&#39;).value = user.pincode || &#39;&#39;;
            
            const courseSelect = document.getElementById(&#39;student-course-select&#39;);
            if (courseSelect) courseSelect.value = user.course_ids &amp;&amp; user.course_ids.length &gt; 0 ? user.course_ids[0] : &#39;&#39;; 

            const preview = document.getElementById(&#39;student-photo-preview&#39;);
            const defaultAvatar = `https://placehold.co/100x100/f6f7f8/666?text=${user.name.charAt(0) || &#39;?&#39;}`;
            const photoUrl = user.profile_photo_url ? `${API_ORIGIN}${user.profile_photo_url}?t=${new Date().getTime()}` : defaultAvatar;
            preview.src = photoUrl;
            preview.onerror = () =&gt; { preview.src = defaultAvatar; }; 
            document.getElementById(&#39;student-photo-file-input&#39;).value = &#39;&#39;; 
        }
        
        form.querySelector(&#39;button[type=&quot;submit&quot;]&#39;).textContent = `Update ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        document.querySelector(`#content-${role} h3`).textContent = `Edit Existing ${role.charAt(0).toUpperCase() + role.slice(1)}`;
    }

    function resetUserForm(role) {
        const form = document.getElementById(`${role}-form`);
        if (form) {
            form.reset();
            form.querySelector(&#39;input[id$=&quot;-id&quot;]&#39;).value = &#39;&#39;;
            const passwordInput = form.querySelector(&#39;input[id$=&quot;-password-input&quot;]&#39;);
            if(passwordInput) passwordInput.placeholder = &#39;Required for new users, leave blank to keep old&#39;;

            if (role === &#39;student&#39;) {
                document.getElementById(&#39;student-form-title&#39;).textContent = &#39;Add/Edit Student&#39;;
                document.getElementById(&#39;student-form-btn&#39;).textContent = &#39;Save Student&#39;;
                document.getElementById(&#39;student-photo-preview&#39;).src = &#39;https://placehold.co/100x100/f6f7f8/666?text=Preview&#39;;
                document.getElementById(&#39;student-photo-file-input&#39;).value = &#39;&#39;; 
            } else {
                const btn = document.getElementById(`${role}-form-btn`);
                const title = document.getElementById(`${role}-form-title`);
                if (btn) btn.textContent = `Save ${role.charAt(0).toUpperCase() + role.slice(1)}`;
                if (title) title.textContent = `Add/Edit ${role.charAt(0).toUpperCase() + role.slice(1)}`;
            }
        }
    }

    // Universal form handler (relies on FormData for file uploads, JSON not used here)
    async function manageUser(formId, role, specificFetchCallback = null) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        form.addEventListener(&#39;submit&#39;, async (event) =&gt; {
            event.preventDefault();
            
            const idInput = form.querySelector(&#39;input[id$=&quot;-id&quot;]&#39;);
            const userId = idInput.value;
            const method = userId ? &#39;PUT&#39; : &#39;POST&#39;;
            let endpoint = `${API_BASE_URL}/users`;
            
            const formData = new FormData(form);
            
            // --- Validation Logic ---
            if (role === &#39;student&#39;) {
                const courseId = formData.get(&#39;course_ids&#39;);
                if (!courseId) {
                    alert(&quot;Course Enrollment is mandatory for students.&quot;);
                    return;
                }
            }
            
            const passwordInput = form.querySelector(&#39;input[id$=&quot;-password-input&quot;]&#39;);
            if (method === &#39;PUT&#39; &amp;&amp; !passwordInput.value) {
                formData.delete(&#39;password&#39;); 
            } else if (method === &#39;POST&#39; &amp;&amp; !passwordInput.value) {
                alert(&quot;Password is required for new users.&quot;);
                return;
            }
            // --- End Validation Logic ---
            
            let photoUploadPromise = null;
            if (role === &#39;student&#39; &amp;&amp; method === &#39;PUT&#39;) {
                const photoFile = document.getElementById(&#39;student-photo-file-input&#39;).files[0];
                if (photoFile) {
                    formData.delete(&#39;profile_photo_file&#39;);
                    const photoFormData = new FormData();
                    photoFormData.append(&#39;profile_photo_file&#39;, photoFile);
                    photoUploadPromise = fetch(`${API_BASE_URL}/user/upload_photo/${userId}`, {
                        method: &#39;POST&#39;,
                        credentials: &#39;include&#39;,
                        body: photoFormData
                    });
                } else {
                    formData.delete(&#39;profile_photo_file&#39;);
                }
            } else if (role === &#39;student&#39; &amp;&amp; method === &#39;POST&#39;) {
                // Ensure profile_photo_file is included if present, otherwise it&#39;s just FormData
            }
            
            try {
                const userDataResponse = await fetch(endpoint, {
                    method: method,
                    credentials: &#39;include&#39;,
                    body: formData 
                });

                const userDataResult = await userDataResponse.json();
                
                if (!userDataResponse.ok) {
                    throw new Error(userDataResult.message || &#39;Failed to save details.&#39;);
                }
                
                if (photoUploadPromise) {
                    const photoResponse = await photoUploadPromise;
                    if (!photoResponse.ok) {
                        throw new Error(&#39;Student details saved, but photo upload failed.&#39;);
                    }
                    const photoResult = await photoResponse.json();
                    populateUserForm(photoResult.user, &#39;student&#39;);
                }
                
                alert(`User ${method === &#39;POST&#39; ? &#39;added&#39; : &#39;updated&#39;} successfully!`);
                resetUserForm(role);
                
                // Refresh data globally
                await fetchAllUsers();
                if (specificFetchCallback) specificFetchCallback();
                fetchDashboardSummary();
                if (role === &#39;parent&#39;) populateParentDropdowns(); 
                if (role === &#39;teacher&#39;) fetchTeachersForCourseDropdown(); 
                if (role === &#39;student&#39;) fetchStudentsForPaymentDropdown();
                
            } catch (error) {
                alert(`An error occurred: ${error.message}.`);
                console.error(&#39;Error saving user:&#39;, error);
            }
        });
    }
    
    // Initialize user form handlers
    manageUser(&#39;teacher-form&#39;, &#39;teacher&#39;, fetchTeachers);
    manageUser(&#39;parent-form&#39;, &#39;parent&#39;, fetchParents);
    manageUser(&#39;student-form&#39;, &#39;student&#39;, fetchStudents); 

    
    // --- UNIVERSAL EDIT/DELETE FUNCTIONS ---
    window.editStudent = async function(id) {
        try { 
            let user = allUsersCache.find(u =&gt; u.id === id);
            if (user) {
                populateUserForm(user, &#39;student&#39;);
                window.location.hash = &#39;students&#39;; 
            } else {
                alert(&#39;Could not find user data. Refreshing...&#39;);
                await fetchAllUsers();
                user = allUsersCache.find(u =&gt; u.id === id);
                if (user) populateUserForm(user, &#39;student&#39;);
            }
        } catch (error) {
             console.error(&#39;Error during editStudent:&#39;, error);
             alert(&#39;A critical error occurred during edit.&#39;);
        }
    };
    window.editTeacher = async function(id) {
        try { 
            let user = allUsersCache.find(u =&gt; u.id === id);
            if (user) {
                populateUserForm(user, &#39;teacher&#39;);
                window.location.hash = &#39;teachers&#39;;
            } else {
                alert(&#39;Could not find user data. Refreshing...&#39;);
                await fetchAllUsers();
                user = allUsersCache.find(u =&gt; u.id === id);
                if (user) populateUserForm(user, &#39;teacher&#39;);
            }
        } catch (error) {
             console.error(&#39;Error during editTeacher:&#39;, error);
             alert(&#39;A critical error occurred during edit.&#39;);
        }
    };
    window.editParent = async function(id) {
        try { 
            let user = allUsersCache.find(u =&gt; u.id === id);
            if (user) {
                populateUserForm(user, &#39;parent&#39;);
                window.location.hash = &#39;parents&#39;;
            } else {
                alert(&#39;Could not find user data. Refreshing...&#39;);
                await fetchAllUsers();
                user = allUsersCache.find(u =&gt; u.id === id);
                if (user) populateUserForm(user, &#39;parent&#39;);
            }
        } catch (error) {
             console.error(&#39;Error during editParent:&#39;, error);
             alert(&#39;A critical error occurred during edit.&#39;);
        }
    };

    window.deleteTeacher = async function(id) {
        if (!id) return alert(&#39;Invalid Teacher ID.&#39;);
        if (confirm(`Are you sure you want to delete Teacher ID ${id}?`)) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                const result = await response.json();
                if (response.ok) {
                    alert(`Teacher deleted: ${result.message}`);
                    await fetchAllUsers(); 
                    fetchTeachers(); 
                } else {
                    alert(`Delete failed: ${result.message || &#39;Server error&#39;}`);
                    console.error(&#39;Delete User Failed:&#39;, result);
                }
            } catch (error) {
                console.error(&#39;Error deleting user:&#39;, error);
                alert(&#39;Network error during deletion.&#39;);
            }
        }
    };

    window.deleteStudent = async function(id) {
        if (!id) return alert(&#39;Invalid Student ID.&#39;);
        if (confirm(`Are you sure you want to delete Student ID ${id}?`)) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                const result = await response.json();
                if (response.ok) {
                    alert(`Student deleted: ${result.message}`);
                    await fetchAllUsers(); 
                    fetchStudents(); 
                } else {
                    alert(`Delete failed: ${result.message || &#39;Server error&#39;}`);
                    console.error(&#39;Delete User Failed:&#39;, result);
                }
            } catch (error) {
                console.error(&#39;Error deleting user:&#39;, error);
                alert(&#39;Network error during deletion.&#39;);
            }
        }
    };

    window.deleteParent = async function(id) {
        if (!id) return alert(&#39;Invalid Parent ID.&#39;);
        if (confirm(`Are you sure you want to delete Parent ID ${id}?`)) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                const result = await response.json();
                if (response.ok) {
                    alert(`Parent deleted: ${result.message}`);
                    await fetchAllUsers(); 
                    fetchParents(); 
                } else {
                    alert(`Delete failed: ${result.message || &#39;Server error&#39;}`);
                    console.error(&#39;Delete User Failed:&#39;, result);
                }
            } catch (error) {
                console.error(&#39;Error deleting user:&#39;, error);
                alert(&#39;Network error during deletion.&#39;);
            }
        }
    };


    // --- COURSE MANAGEMENT ---

    function resetCourseForm(course = null) {
        document.getElementById(&#39;course-id&#39;).value = course ? course.id : &#39;&#39;;
        document.getElementById(&#39;course-name&#39;).value = course ? course.name : &#39;&#39;;
        document.getElementById(&#39;course-subjects&#39;).value = course &amp;&amp; course.subjects ? course.subjects.join(&#39;, &#39;) : &#39;&#39;;
        document.getElementById(&#39;course-teacher&#39;).value = course ? course.teacher_id : &#39;&#39;;
        document.getElementById(&#39;save-course-btn&#39;).textContent = course ? &#39;Update Course&#39; : &#39;Save Course&#39;;
        document.querySelector(&#39;#content-courses h3&#39;).textContent = course ? &#39;Edit Existing Course&#39; : &#39;Add New Course&#39;;
    }

    courseForm.addEventListener(&#39;submit&#39;, async (event) =&gt; {
        event.preventDefault();
        
        const courseId = document.getElementById(&#39;course-id&#39;).value;
        const method = courseId ? &#39;PUT&#39; : &#39;POST&#39;;
        const endpoint = `${API_BASE_URL}/courses`;

        const courseData = { 
            id: courseId || undefined,
            name: document.getElementById(&#39;course-name&#39;).value, 
            subjects: document.getElementById(&#39;course-subjects&#39;).value, // Sent as comma-separated string
            teacher_id: courseTeacherSelect.value ? parseInt(courseTeacherSelect.value) : null 
        };
        
        try {
            // MUST SEND JSON for Course management
            const response = await fetch(endpoint, { 
                method: method, 
                headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, 
                credentials: &#39;include&#39;, 
                body: JSON.stringify(courseData) 
            });
            const result = await response.json();

            if (response.ok) {
                alert(`Course ${method === &#39;POST&#39; ? &#39;added&#39; : &#39;updated&#39;} successfully!`);
                resetCourseForm(null);
                fetchCourses();
                fetchCoursesForEnrollment(); 
            } else {
                alert(`Save failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
                console.error(&quot;Course Save Error:&quot;, result.message);
            }
        } catch (error) {
            alert(`Network error saving course: ${error.message}`);
            console.error(&#39;Error saving course:&#39;, error);
        }
    });
    
    window.editCourse = async function(id) {
        if (!id) return alert(&#39;Invalid Course ID.&#39;);
        try { 
            const course = allCoursesCache.find(c =&gt; c.id == id);
            if (course) {
                resetCourseForm(course);
                window.location.hash = &#39;courses&#39;; 
            } else {
                alert(&#39;Course not found in cache. Refreshing...&#39;);
                await fetchCourses();
                window.location.hash = &#39;courses&#39;;
            }
        } catch (error) {
            console.error(&#39;Error during editCourse:&#39;, error);
            alert(&#39;A critical error occurred during edit.&#39;);
        }
    }

    window.deleteCourse = async function(id) {
        if (!id) return alert(&#39;Invalid Course ID.&#39;);
        if (confirm(&#39;Are you sure you want to delete this course?&#39;)) {
            try {
                const response = await fetch(`${API_BASE_URL}/courses/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                const result = await response.json();
                if (response.ok) {
                    alert(&#39;Course deleted successfully!&#39;);
                    fetchCourses();
                    fetchCoursesForEnrollment(); 
                } else {
                    alert(`Delete failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
                    console.error(&#39;Delete Course Failed:&#39;, result);
                }
            } catch (error) {
                alert(`Network error deleting course.`);
                console.error(&#39;Error deleting course:&#39;, error);
            }
        }
    }


    // --- ACADEMIC SESSIONS ---

    function resetSessionForm(session = null) {
        const sessionForm = document.getElementById(&#39;session-form&#39;);
        if (sessionForm) sessionForm.reset();
        
        document.getElementById(&#39;session-id&#39;).value = session ? session.id : &#39;&#39;;
        document.getElementById(&#39;session-name&#39;).value = session ? session.name : &#39;&#39;;
        document.getElementById(&#39;session-start-date&#39;).value = session ? session.start_date : &#39;&#39;;
        document.getElementById(&#39;session-end-date&#39;).value = session ? session.end_date : &#39;&#39;;
        document.getElementById(&#39;session-status&#39;).value = session ? session.status : &#39;Active&#39;;
        document.getElementById(&#39;save-session-btn&#39;).textContent = session ? &#39;Update Session&#39; : &#39;Save Session&#39;;
        document.querySelector(&#39;#content-sessions h3&#39;).textContent = session ? &#39;Edit Existing Academic Session&#39; : &#39;Add New Session&#39;;
    }

    sessionForm.addEventListener(&#39;submit&#39;, async (event) =&gt; {
        event.preventDefault();
        
        const sessionId = document.getElementById(&#39;session-id&#39;).value;
        const method = sessionId ? &#39;PUT&#39; : &#39;POST&#39;;
        const endpoint = `${API_BASE_URL}/sessions`;
        
        const sessionData = { 
            id: sessionId || undefined,
            name: document.getElementById(&#39;session-name&#39;).value, 
            start_date: document.getElementById(&#39;session-start-date&#39;).value,
            end_date: document.getElementById(&#39;session-end-date&#39;).value,
            status: document.getElementById(&#39;session-status&#39;).value
        };
        
        try {
            // MUST SEND JSON for Session management
            const response = await fetch(endpoint, { 
                method: method, 
                headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, 
                credentials: &#39;include&#39;, 
                body: JSON.stringify(sessionData) 
            });
            const result = await response.json();

            if (response.ok) {
                alert(`Academic session ${method === &#39;POST&#39; ? &#39;added&#39; : &#39;updated&#39;} successfully!`);
                resetSessionForm(null);
                fetchSessions();
                fetchFeeSessionDropdowns();
            } else {
                alert(`Save failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
                console.error(&quot;Session Save Error:&quot;, result.message);
            }
        } catch (error) {
            alert(`Network error saving session: ${error.message}`);
            console.error(&#39;Error saving session:&#39;, error);
        }
    });
    
    window.editSession = async function(id) {
        if (!id) return alert(&#39;Invalid Session ID.&#39;);
        try { 
            const session = allSessionsCache.find(s =&gt; s.id == id);
            if (session) {
                if (session.start_date &amp;&amp; session.end_date) {
                    resetSessionForm(session);
                    window.location.hash = &#39;sessions&#39;; 
                } else {
                    alert(&quot;Session dates are invalid in the database. Cannot edit.&quot;);
                }
            } else {
                alert(&#39;Session not found in cache. Refreshing...&#39;);
                await fetchSessions();
                window.location.hash = &#39;sessions&#39;;
            }
        } catch (error) {
            console.error(&#39;Error during editSession:&#39;, error);
            alert(&#39;A critical error occurred during edit.&#39;);
        }
    }

    window.deleteSession = async function(id) {
        if (!id) return alert(&#39;Invalid Session ID.&#39;);
        if (confirm(&#39;Are you sure you want to delete this academic session?&#39;)) {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                const result = await response.json();
                if (response.ok) {
                    alert(&#39;Academic session deleted successfully!&#39;);
                    fetchSessions();
                    fetchFeeSessionDropdowns();
                } else {
                    alert(`Delete failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
                    console.error(&#39;Delete Session Failed:&#39;, result);
                }
            } catch (error) {
                alert(`Network error deleting session.`);
                console.error(&#39;Error deleting session:&#39;, error);
            }
        }
    }


    // --- ANNOUNCEMENT LOGIC ---
    
    async function fetchAnnouncements(isManagementPage) {
        try {
            const response = await fetch(`${API_BASE_URL}/announcements`, {credentials: &#39;include&#39;});
            const announcements = await response.json();
            const mainAnnouncementsBody = document.getElementById(&#39;recent-announcements-body&#39;); 
            
            if (mainAnnouncementsBody) mainAnnouncementsBody.innerHTML = &#39;&#39;;
            
            // Filter announcements shown in the dashboard view (last 5, only &#39;all&#39; or &#39;admin&#39;)
            const dashboardAnnouncements = announcements.filter(a =&gt; a.target_group === &#39;all&#39; || a.target_group === &#39;admin&#39;).slice(0, 5);

            const announcementsToShow = isManagementPage ? announcements : dashboardAnnouncements;

            if (announcementsToShow.length === 0) {
                if (mainAnnouncementsBody) mainAnnouncementsBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No announcements found.&lt;/td&gt;&lt;/tr&gt;`;
                return;
            }

            announcementsToShow.forEach((announcement) =&gt; {
                const contentDisplay = isManagementPage ? announcement.content : announcement.content.substring(0, 50) + (announcement.content.length &gt; 50 ? &#39;...&#39; : &#39;&#39;);
                
                const actionsHtml = isManagementPage ? `
                    &lt;button onclick=&quot;deleteAnnouncement(${announcement.id})&quot; class=&quot;text-red-600 hover:text-red-900 ml-4&quot;&gt;Delete&lt;/button&gt;
                ` : &#39;&#39;;


                const row = `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${announcement.title}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 text-sm text-slate-500 dark:text-slate-400 max-w-xs truncate&quot;&gt;${contentDisplay}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${announcement.target_group.charAt(0).toUpperCase() + announcement.target_group.slice(1)}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${announcement.created_at.split(&#39; &#39;)[0]}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;${actionsHtml}&lt;/td&gt;
                    &lt;/tr&gt;`;
                
                if (mainAnnouncementsBody) {
                    mainAnnouncementsBody.innerHTML += row;
                }
            });
        } catch (error) {
            console.error(&quot;Error fetching announcements:&quot;, error);
            const tableBody = document.getElementById(&#39;recent-announcements-body&#39;);
            if (tableBody) tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }
    
    window.deleteAnnouncement = async function(id) {
        if (confirm(&#39;Are you sure you want to delete this announcement?&#39;)) {
            try {
                const response = await fetch(`${API_BASE_URL}/announcements/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                if (response.ok) {
                    alert(&#39;Announcement deleted successfully!&#39;);
                    fetchAnnouncements(true); // Refresh table
                } else {
                    const error = await response.json();
                    alert(`Delete failed: ${error.message || &#39;An unknown error occurred.&#39;}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
                console.error(&#39;Error deleting announcement:&#39;, error);
            }
        }
    }

    announcementForm.addEventListener(&#39;submit&#39;, async (event) =&gt; {
        event.preventDefault();
        const announcementData = { 
            title: document.getElementById(&#39;announcement-title&#39;).value, 
            content: document.getElementById(&#39;announcement-content&#39;).value,
            target_group: document.getElementById(&#39;announcement-target-group&#39;).value
        };
        try {
            const response = await fetch(API_BASE_URL + &#39;/announcements&#39;, { method: &#39;POST&#39;, headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, credentials: &#39;include&#39;, body: JSON.stringify(announcementData) });
            const result = await response.json();

            if (response.ok) {
                announcementForm.reset();
                alert(&#39;Announcement published successfully!&#39;);
                fetchAnnouncements(true);
                fetchDashboardSummary(); // Refresh dashboard announcements
            } else {
                alert(`Save failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
            }
        } catch (error) {
            alert(`An error occurred: ${error.message}`);
            console.error(&#39;Error saving announcement:&#39;, error);
        }
    });


    // --- FEE &amp; REPORT LOGIC ---

    async function fetchFeeSessionDropdowns() {
        try {
            // Uses cached sessions
            const feeSessionSelect = document.getElementById(&#39;fee-session-select&#39;);
            feeSessionSelect.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Select a session...&lt;/option&gt;&#39;;
            allSessionsCache.forEach(session =&gt; { feeSessionSelect.innerHTML += `&lt;option value=&quot;${session.id}&quot;&gt;${session.name}&lt;/option&gt;`; });
        } catch (error) {
             console.error(&quot;Error fetching sessions for fee dropdown:&quot;, error);
             document.getElementById(&#39;fee-session-select&#39;).innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Error loading sessions&lt;/option&gt;&#39;;
        }
    }
    
    async function fetchFeeStructures() {
        try {
            const response = await fetch(`${API_BASE_URL}/fee_structures`, {credentials: &#39;include&#39;});
            const structures = await response.json();
            const tableBody = document.getElementById(&#39;fee-structure-table-body&#39;);
            const paymentFeeStructureSelect = document.getElementById(&#39;payment-fee-structure-select&#39;);
            
            tableBody.innerHTML = &#39;&#39;;

            if (structures.length === 0) {
                tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No fee structures found.&lt;/td&gt;&lt;/tr&gt;`;
                paymentFeeStructureSelect.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;No fee structures available&lt;/option&gt;&#39;;
                return;
            }

            paymentFeeStructureSelect.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Select a fee structure...&lt;/option&gt;&#39;;
            structures.forEach(s =&gt; {
                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${s.name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${s.total_amount.toFixed(2)}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${s.due_date}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;editFeeStructure(${s.id})&quot; class=&quot;text-primary hover:text-blue-700 mr-2&quot;&gt;Edit&lt;/button&gt;
                            &lt;button onclick=&quot;deleteFeeStructure(${s.id})&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Delete&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
                paymentFeeStructureSelect.innerHTML += `&lt;option value=&quot;${s.id}&quot;&gt;${s.name} (Due: ${s.due_date})&lt;/option&gt;`;
            });
        } catch (error) {
            console.error(&quot;Error fetching fee structures:&quot;, error);
            document.getElementById(&#39;fee-structure-table-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }

    // --- NEW: Fee structure delete/edit handlers ---
    function resetFeeStructureForm(structure = null) {
         const feeStructureForm = document.getElementById(&#39;fee-structure-form&#39;);
         if (feeStructureForm) feeStructureForm.reset();
         
         document.getElementById(&#39;fee-structure-id&#39;).value = structure ? structure.id : &#39;&#39;;
         document.getElementById(&#39;save-fee-structure-btn&#39;).textContent = structure ? &#39;Update Fee Structure&#39; : &#39;Save Fee Structure&#39;;
         
         if (structure) {
             document.getElementById(&#39;fee-structure-name&#39;).value = structure.name;
             document.getElementById(&#39;fee-session-select&#39;).value = structure.academic_session_id;
             document.getElementById(&#39;fee-total-amount&#39;).value = structure.total_amount;
             document.getElementById(&#39;fee-due-date&#39;).value = structure.due_date;
         }
     }

    window.editFeeStructure = async function(id) {
        if (!id) return alert(&#39;Invalid Fee Structure ID.&#39;);
        try {
            const response = await fetch(`${API_BASE_URL}/fee_structures`, { credentials: &#39;include&#39; });
            const structures = await response.json();
            const structure = structures.find(s =&gt; s.id == id);
            if (structure) {
                resetFeeStructureForm(structure);
                window.location.hash = &#39;fees&#39;; 
            }
        } catch (error) {
            console.error(&#39;Error fetching fee structure for edit:&#39;, error);
            alert(&#39;Failed to load fee structure details for edit.&#39;);
        }
    }
    
    window.deleteFeeStructure = async function(id) {
        if (!id) return alert(&#39;Invalid Fee Structure ID.&#39;);
        if (confirm(&#39;Are you sure you want to delete this fee structure?&#39;)) {
            try {
                const response = await fetch(`${API_BASE_URL}/fee_structures/${id}`, { method: &#39;DELETE&#39;, credentials: &#39;include&#39; });
                const result = await response.json();
                if (response.ok) {
                    alert(&#39;Fee structure deleted successfully!&#39;);
                    fetchFeeStructures();
                    fetchFeeStatus();
                } else {
                    alert(`Delete failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
                    console.error(&#39;Delete Fee Structure Failed:&#39;, result);
                }
            } catch (error) {
                alert(`Network error deleting fee structure.`);
                console.error(&#39;Error deleting fee structure:&#39;, error);
            }
        }
    }
    // --- End Fee Structure Handlers ---


    async function fetchFeeStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/fee_status`, {credentials: &#39;include&#39;});
            const statusList = await response.json();
            const tableBody = document.getElementById(&#39;fee-status-table-body&#39;);
            tableBody.innerHTML = &#39;&#39;;

            if (statusList.length === 0) {
                tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No student fee status found.&lt;/td&gt;&lt;/tr&gt;`;
                return;
            }

            statusList.forEach(status =&gt; {
                const isOverdue = status.pending_days &lt; 0;
                const isPaid = status.balance &lt;= 0;
                const balanceClass = isPaid ? &#39;paid&#39; : (isOverdue ? &#39;overdue&#39; : &#39;pending&#39;);
                const balanceText = status.balance.toFixed(2);
                
                let dueText;
                if (isPaid) {
                    dueText = &#39;PAID&#39;;
                } else if (isOverdue) {
                    dueText = `${Math.abs(status.pending_days)} Days OVERDUE`;
                } else {
                    dueText = `${status.pending_days} Days Left`;
                }

                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${status.student_name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-bold ${balanceClass}&quot;&gt;${balanceText}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? &#39;text-red-600&#39; : &#39;text-slate-500&#39;}&quot;&gt;${dueText}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-center text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;sendFeeAlert(${status.student_id})&quot; class=&quot;text-amber-500 hover:text-amber-700 disabled:text-slate-400&quot; ${status.balance &gt; 0 ? &#39;&#39; : &#39;disabled&#39;}&gt;
                                &lt;span class=&quot;material-symbols-outlined align-middle text-lg&quot;&gt;sms&lt;/span&gt;
                            &lt;/button&gt;
                        &lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;printReceipt(${status.latest_payment_id})&quot; class=&quot;text-primary hover:text-blue-700 disabled:text-slate-400&quot; ${status.latest_payment_id ? &#39;&#39; : &#39;disabled&#39;}&gt;
                                &lt;span class=&quot;material-symbols-outlined align-middle text-lg&quot;&gt;print&lt;/span&gt;
                            &lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });
        } catch (error) {
            console.error(&quot;Error fetching fee status:&quot;, error);
            document.getElementById(&#39;fee-status-table-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }
    
    async function fetchFeePendingReport() {
        const feePendingReportBody = document.getElementById(&#39;fee-pending-report-body&#39;);
        if (!feePendingReportBody) return; 

        feePendingReportBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;6&quot; class=&quot;px-6 py-4 text-center&quot;&gt;Loading pending fees...&lt;/td&gt;&lt;/tr&gt;`;
        try {
            const response = await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials: &#39;include&#39;});
            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.message || `Server error: ${response.status}`);
            }
            const pendingList = await response.json();

            feePendingReportBody.innerHTML = &#39;&#39;; 

            if (pendingList.length === 0) {
                feePendingReportBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;6&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No students with pending fees found.&lt;/td&gt;&lt;/tr&gt;`;
                return;
            }

            pendingList.forEach(status =&gt; {
                const isOverdue = status.pending_days &lt; 0;
                const balanceClass = isOverdue ? &#39;overdue&#39; : &#39;pending&#39;;
                const balanceText = status.balance.toFixed(2);
                const isPhoneAvailable = !!status.phone_number;
                
                let dueText;
                if (isOverdue) {
                    dueText = `${Math.abs(status.pending_days)} Days OVERDUE`;
                } else {
                    dueText = `${status.pending_days} Days Left`;
                }

                feePendingReportBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${status.student_name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-bold ${balanceClass}&quot;&gt;${balanceText}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500&quot;&gt;${status.due_date}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? &#39;text-red-600&#39; : &#39;text-slate-500&#39;}&quot;&gt;${dueText}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-center text-sm&quot;&gt;
                            &lt;button onclick=&quot;sendFeeReminderSms(${status.student_id}, &#39;${status.student_name}&#39;, ${status.balance}, &#39;${status.due_date}&#39;)&quot; class=&quot;text-yellow-600 hover:text-yellow-700 disabled:text-slate-400&quot; ${isPhoneAvailable ? &#39;&#39; : &#39;disabled&#39;} title=&quot;Send Fee Reminder SMS&quot;&gt;
                                &lt;span class=&quot;material-symbols-outlined align-middle text-lg&quot;&gt;sms&lt;/span&gt;
                            &lt;/button&gt;
                        &lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-center text-sm&quot;&gt;
                            &lt;button onclick=&quot;sendFeeReminderWhatsapp(${status.student_id}, &#39;${status.student_name}&#39;, ${status.balance}, &#39;${status.due_date}&#39;)&quot; class=&quot;text-green-600 hover:text-green-700 disabled:text-slate-400&quot; ${isPhoneAvailable ? &#39;&#39; : &#39;disabled&#39;} title=&quot;Send Fee Reminder WhatsApp&quot;&gt;
                                &lt;span class=&quot;material-symbols-outlined align-middle text-lg&quot;&gt;call&lt;/span&gt;
                            &lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });

        } catch (error) {
            console.error(&quot;Error fetching fee pending report:&quot;, error);
            feePendingReportBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;6&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading report data: ${error.message}&lt;/td&gt;&lt;/tr&gt;`;
        }
    }
    
    window.sendFeeReminderSms = async function(studentId, studentName, balance, dueDate) {
        if (confirm(`Send SMS fee reminder to ${studentName}?`)) {
            try { // CRITICAL: Added try...catch for stability
                const response = await fetch(`${API_BASE_URL}/send_sms_alert`, {
                    method: &#39;POST&#39;,
                    headers: {&#39;Content-Type&#39;: &#39;application/json&#39;},
                    credentials: &#39;include&#39;,
                    body: JSON.stringify({ student_id: studentId })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                } else {
                    alert(`Failed: ${result.message}`);
                }
            } catch(error) {
                console.error(&#39;SMS Alert Error:&#39;, error);
                alert(&#39;Failed to send alert due to a server error.&#39;);
            }
        }
    }

    window.sendFeeReminderWhatsapp = function(studentId, studentName, balance, dueDate) {
        const subject = &quot;Fee Reminder&quot;;
        const body = `Dear ${studentName}, your fee payment of INR ${balance.toFixed(2)} is pending. The due date is ${dueDate}. Please pay soon.`;
         if (confirm(`Send WhatsApp fee reminder to ${studentName}? (Mock)`)) {
             // CRITICAL: Ensure sendQuickNotification function exists or use a mock logic.
            alert(`[MOCK] WhatsApp sent to ${studentName}: ${body}`);
        }
    }
    
    window.sendFeeAlert = async function(studentId) {
        if (confirm(&#39;Send fee pending alert via SMS? (Uses configured API)&#39;)) {
            try { // CRITICAL: Added try...catch for stability
                const response = await fetch(`${API_BASE_URL}/send_sms_alert`, {
                    method: &#39;POST&#39;,
                    headers: {&#39;Content-Type&#39;: &#39;application/json&#39;},
                    credentials: &#39;include&#39;,
                    body: JSON.stringify({ student_id: studentId })
                });
                const result = await response.json();
                alert(result.message);
            } catch(error) {
                console.error(&#39;SMS Alert Error:&#39;, error);
                alert(&#39;Failed to send alert due to a server error.&#39;);
            }
        }
    }
    
    window.printReceipt = function(paymentId) {
        if (paymentId &amp;&amp; paymentId !== &#39;N/A&#39; &amp;&amp; paymentId !== &#39;null&#39; &amp;&amp; paymentId !== null) {
            // FIX: Ensure API_ORIGIN is used correctly
            window.open(`${API_ORIGIN}/api/receipt/${paymentId}`, &#39;_blank&#39;, &#39;width=700,height=600&#39;);
        } else {
            alert(&#39;No recent payment ID available to print.&#39;);
        }
    }

    feeStructureForm.addEventListener(&#39;submit&#39;, async (event) =&gt; {
        event.preventDefault();
        
        const feeId = document.getElementById(&#39;fee-structure-id&#39;).value;
        const method = feeId ? &#39;PUT&#39; : &#39;POST&#39;;
        const endpoint = `${API_BASE_URL}/fee_structures`;

        const feeData = { 
            id: feeId || undefined,
            name: document.getElementById(&#39;fee-structure-name&#39;).value, 
            academic_session_id: parseInt(document.getElementById(&#39;fee-session-select&#39;).value),
            total_amount: parseFloat(document.getElementById(&#39;fee-total-amount&#39;).value),
            due_date: document.getElementById(&#39;fee-due-date&#39;).value
        };
        
        try {
            const response = await fetch(endpoint, { 
                method: method, 
                headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, 
                credentials: &#39;include&#39;, 
                body: JSON.stringify(feeData) 
            });
            const result = await response.json();

            if (response.ok) {
                alert(`Fee structure ${method === &#39;POST&#39; ? &#39;added&#39; : &#39;updated&#39;} successfully!`);
                resetFeeStructureForm(null);
                fetchFeeStructures();
                fetchFeeStatus();
            } else {
                alert(`Save failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
            }
        } catch (error) {
            alert(`An error occurred: ${error.message}`);
            console.error(&#39;Error saving fee structure:&#39;, error);
        }
    });

    paymentForm.addEventListener(&#39;submit&#39;, async (event) =&gt; {
        event.preventDefault();
        const paymentData = {
            student_id: parseInt(document.getElementById(&#39;payment-student-select&#39;).value),
            fee_structure_id: parseInt(document.getElementById(&#39;payment-fee-structure-select&#39;).value),
            amount_paid: parseFloat(document.getElementById(&#39;payment-amount&#39;).value),
            payment_method: document.getElementById(&#39;payment-method&#39;).value
        };
        try {
            const response = await fetch(API_BASE_URL + &#39;/payments&#39;, { method: &#39;POST&#39;, headers: {&#39;Content-Type&#39;: &#39;application/json&#39;}, credentials: &#39;include&#39;, body: JSON.stringify(paymentData) });
            const result = await response.json();

            if (response.ok) {
                paymentForm.reset();
                alert(result.message);
                fetchFeeStatus(); // Refresh status table
                fetchFeePendingReport(); // Refresh pending report table
                
                const paymentId = result.payment_id;
                if (paymentId) {
                    window.open(`${API_ORIGIN}/api/receipt/${paymentId}`, &#39;_blank&#39;, &#39;width=700,height=600&#39;);
                }

            } else {
                alert(`Record failed: ${result.message || &#39;An unknown error occurred.&#39;}`);
            }
        } catch (error) {
            alert(`An error occurred: ${error.message}`);
            console.error(&#39;Error recording payment:&#39;, error);
        }
    });
    
    // --- End Fee Fetch/Save Logic ---


    // --- USER MANAGEMENT FETCHING FUNCTIONS (Fixes the Data Loading Error) ---

    async function fetchTeachers() {
        const tableBody = document.getElementById(&#39;teacher-table-body&#39;);
        tableBody.innerHTML = &#39;&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;Loading teachers...&lt;/td&gt;&lt;/tr&gt;&#39;;

        try {
            const users = await fetchAllUsers(); 
            const teachers = users.filter(u =&gt; u.role === &#39;teacher&#39;);
            
            tableBody.innerHTML = &#39;&#39;;
            if (teachers.length === 0) {
                tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No teachers found.&lt;/td&gt;&lt;/tr&gt;`;
                return;
            }

            teachers.forEach(teacher =&gt; {
                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${teacher.name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${teacher.email}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${teacher.phone_number || &#39;N/A&#39;}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;editTeacher(${teacher.id})&quot; class=&quot;text-primary hover:text-blue-700 mr-2&quot;&gt;Edit&lt;/button&gt;
                            &lt;button onclick=&quot;deleteTeacher(${teacher.id})&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Delete&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });
        } catch (error) {
            console.error(&quot;Error fetching teachers:&quot;, error);
            tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }
    
    async function fetchStudents(searchTerm = &#39;&#39;) {
        const tableBody = document.getElementById(&#39;student-table-body&#39;);
        tableBody.innerHTML = &#39;&lt;tr&gt;&lt;td colspan=&quot;7&quot; class=&quot;px-6 py-4 text-center&quot;&gt;Loading students...&lt;/td&gt;&lt;/tr&gt;&#39;;
        
        try {
            const users = await fetchAllUsers(searchTerm); 
            const students = users.filter(u =&gt; u.role === &#39;student&#39;);
            
            tableBody.innerHTML = &#39;&#39;;
            if (students.length === 0) {
                tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;7&quot; class=&quot;px-6 py-4 text-center&quot;&gt;${searchTerm ? &#39;No students match your search.&#39; : &#39;No students found.&#39;}&lt;/td&gt;&lt;/tr&gt;`;
                return;
            }
            
            const parents = users.filter(u =&gt; u.role === &#39;parent&#39;);
            const parentMap = new Map(parents.map(p =&gt; [p.id, p.name]));
            
            students.forEach(student =&gt; {
                const parentName = parentMap.get(student.parent_id) || &#39;Unlinked&#39;;
                const isPhoneAvailable = !!student.phone_number;
                
                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${student.name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${student.email}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${parentName}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${student.phone_number || &#39;N/A&#39;}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-center text-sm&quot;&gt;
                            &lt;button onclick=&quot;sendQuickSms(${student.id}, &#39;${student.name}&#39;)&quot; class=&quot;text-yellow-600 hover:text-yellow-700 disabled:text-slate-400&quot; ${isPhoneAvailable ? &#39;&#39; : &#39;disabled&#39;}&gt;SMS&lt;/button&gt;
                        &lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-center text-sm&quot;&gt;
                            &lt;button onclick=&quot;sendQuickWhatsapp(${student.id}, &#39;${student.name}&#39;)&quot; class=&quot;text-green-600 hover:text-green-700 disabled:text-slate-400&quot; ${isPhoneAvailable ? &#39;&#39; : &#39;disabled&#39;}&gt;WA&lt;/button&gt;
                        &lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;editStudent(${student.id})&quot; class=&quot;text-primary hover:text-blue-700 mr-2&quot;&gt;Edit&lt;/button&gt;
                            &lt;button onclick=&quot;deleteStudent(${student.id})&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Delete&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });
        } catch (error) {
            console.error(&quot;Error fetching students:&quot;, error);
            tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;7&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }
    
    // --- Student Search Event Listener (Add this if missing) ---
    if (searchInput) {
        searchInput.addEventListener(&#39;input&#39;, () =&gt; {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() =&gt; {
                fetchStudents(searchInput.value.trim());
            }, 300); // Debounce search
        });
    }
    
    async function fetchParents() {
        const tableBody = document.getElementById(&#39;parent-table-body&#39;);
        tableBody.innerHTML = &#39;&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;Loading parents...&lt;/td&gt;&lt;/tr&gt;&#39;;

        try {
            const users = await fetchAllUsers(); 
            const parents = users.filter(u =&gt; u.role === &#39;parent&#39;);
            
            tableBody.innerHTML = &#39;&#39;;
            if (parents.length === 0) {
                tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No parents found.&lt;/td&gt;&lt;/tr&gt;`;
                return;
            }

            parents.forEach(parent =&gt; {
                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${parent.name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${parent.email}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${parent.phone_number || &#39;N/A&#39;}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;editParent(${parent.id})&quot; class=&quot;text-primary hover:text-blue-700 mr-2&quot;&gt;Edit&lt;/button&gt;
                            &lt;button onclick=&quot;deleteParent(${parent.id})&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Delete&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });
        } catch (error) {
            console.error(&quot;Error fetching parents:&quot;, error);
            tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }
    
    // --- Mock Functions for Students/Reports (Crucial to prevent crash) ---
    window.sendQuickSms = function(id, name) {
        alert(`[MOCK] SMS alert to ${name} (ID: ${id}) triggered.`);
        console.log(`MOCK SMS alert to student ID ${id}`);
    };
    window.sendQuickWhatsapp = function(id, name) {
        alert(`[MOCK] WhatsApp alert to ${name} (ID: ${id}) triggered.`);
        console.log(`MOCK WA alert to student ID ${id}`);
    };


    // --- REPORT &amp; DROPDOWN FUNCTIONS (Cont.) ---
    
    // Used to populate the parent dropdown in the student form
    async function populateParentDropdowns() {
        try {
            const response = await fetch(`${API_BASE_URL}/parents`, {credentials: &#39;include&#39;});
            const parents = await response.json();
            const selectElement = document.getElementById(&#39;student-parent-select&#39;);
            
            if (!selectElement) {
                 console.warn(&quot;Element &#39;student-parent-select&#39; not found.&quot;);
                 return;
            }

            selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;(None)&lt;/option&gt;&#39;;
            parents.forEach(p =&gt; { 
                selectElement.innerHTML += `&lt;option value=&quot;${p.id}&quot;&gt;${p.name} (${p.email})&lt;/option&gt;`; 
            });
        } catch (error) {
            console.error(&quot;Error fetching parents for dropdown:&quot;, error);
            const selectElement = document.getElementById(&#39;student-parent-select&#39;);
            if (selectElement) {
                selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Error loading parents&lt;/option&gt;&#39;;
            }
        }
    }

    async function fetchStudentsForPaymentDropdown() {
        try {
            const response = await fetch(`${API_BASE_URL}/users`, {credentials: &#39;include&#39;});
            const users = await response.json();
            const students = users.filter(u =&gt; u.role === &#39;student&#39;);
            const selectElement = document.getElementById(&#39;payment-student-select&#39;);
            selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Select a student...&lt;/option&gt;&#39;;
            students.forEach(s =&gt; { selectElement.innerHTML += `&lt;option value=&quot;${s.id}&quot;&gt;${s.name} (${s.email})&lt;/option&gt;`; });
        } catch (error) {
             console.error(&quot;Error fetching students for payment dropdown:&quot;, error);
             const selectElement = document.getElementById(&#39;payment-student-select&#39;);
             if(selectElement) selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Error loading students&lt;/option&gt;&#39;;
        }
    }

    async function fetchCoursesForEnrollment() {
         try {
            // Use cached courses
            const courses = allCoursesCache; 
            const selectElement = document.getElementById(&#39;student-course-select&#39;);
            selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Select Course&lt;/option&gt;&#39;;
            courses.forEach(c =&gt; {
                selectElement.innerHTML += `&lt;option value=&quot;${c.id}&quot;&gt;${c.name}&lt;/option&gt;`;
            });
        } catch (error) {
            console.error(&quot;Error fetching courses for enrollment dropdown:&quot;, error);
            const selectElement = document.getElementById(&#39;student-course-select&#39;);
            if(selectElement) selectElement.innerHTML = `&lt;option value=&quot;&quot;&gt;Error loading courses&lt;/option&gt;&lt;option value=&quot;&quot;&gt;(Check if courses are registered)&lt;/option&gt;`;
        }
    }
    
    // This function is used to populate the dropdown in the course management tab
    async function fetchTeachersForCourseDropdown() {
         try {
            // Use cached teachers (filter allUsersCache)
            const teachers = allUsersCache.filter(u =&gt; u.role === &#39;teacher&#39;); 
            const selectElement = document.getElementById(&#39;course-teacher&#39;);
            selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Select a teacher...&lt;/option&gt;&#39;;
            teachers.forEach(teacher =&gt; { selectElement.innerHTML += `&lt;option value=&quot;${teacher.id}&quot;&gt;${teacher.name}&lt;/option&gt;`; });
        } catch (error) {
            console.error(&quot;Error fetching teachers for course dropdown:&quot;, error);
            const selectElement = document.getElementById(&#39;course-teacher&#39;);
            if(selectElement) selectElement.innerHTML = &#39;&lt;option value=&quot;&quot;&gt;Error loading teachers&lt;/option&gt;&#39;;
        }
    }
    
    async function fetchCourses() {
        try {
            const response = await fetch(`${API_BASE_URL}/courses`, {credentials: &#39;include&#39;});
            const courses = await response.json();
            allCoursesCache = courses; // Update cache
            const tableBody = document.getElementById(&#39;course-table-body&#39;);
            
            tableBody.innerHTML = &#39;&#39;;
            if (courses.length === 0) {
                 tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No courses found.&lt;/td&gt;&lt;/tr&gt;`;
                 return;
            }

            courses.forEach(course =&gt; {
                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${course.name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 text-sm text-slate-500 dark:text-slate-400 max-w-xs truncate&quot;&gt;${course.subjects.join(&#39;, &#39;)}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${course.teacher_name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;editCourse(${course.id})&quot; class=&quot;text-primary hover:text-blue-700 mr-2&quot;&gt;Edit&lt;/button&gt;
                            &lt;button onclick=&quot;deleteCourse(${course.id})&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Delete&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });
        } catch(error) {
             console.error(&#39;Error fetching courses:&#39;, error);
             document.getElementById(&#39;course-table-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }

    async function fetchSessions() {
        try {
            const response = await fetch(`${API_BASE_URL}/sessions`, {credentials: &#39;include&#39;});
            const sessions = await response.json();
            allSessionsCache = sessions; // Update cache
            const tableBody = document.getElementById(&#39;session-table-body&#39;);
            
            tableBody.innerHTML = &#39;&#39;;
            if (sessions.length === 0) {
                 tableBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No academic sessions found.&lt;/td&gt;&lt;/tr&gt;`;
                 return;
            }

            sessions.forEach(session =&gt; {
                const statusClass = session.status === &#39;Active&#39; ? &#39;text-green-600&#39; : &#39;text-red-600&#39;;
                tableBody.innerHTML += `
                    &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${session.name}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${session.start_date}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${session.end_date}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium ${statusClass}&quot;&gt;${session.status}&lt;/td&gt;
                        &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-right text-sm font-medium&quot;&gt;
                            &lt;button onclick=&quot;editSession(${session.id})&quot; class=&quot;text-primary hover:text-blue-700 mr-2&quot;&gt;Edit&lt;/button&gt;
                            &lt;button onclick=&quot;deleteSession(${session.id})&quot; class=&quot;text-red-600 hover:text-red-900&quot;&gt;Delete&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            });
        } catch(error) {
             console.error(&#39;Error fetching sessions:&#39;, error);
             document.getElementById(&#39;session-table-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }

    function fetchAdmissionsReport() {
        try {
            const reportBody = document.getElementById(&#39;admissions-report-body&#39;);
            fetch(`${API_BASE_URL}/reports/admissions`, {credentials: &#39;include&#39;})
                .then(res =&gt; res.json())
                .then(admissions =&gt; {
                    reportBody.innerHTML = &#39;&#39;;
                    if (admissions.length === 0) {
                        reportBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;3&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No new admissions in the last 30 days.&lt;/td&gt;&lt;/tr&gt;`;
                        return;
                    }
                    admissions.forEach(admission =&gt; {
                        reportBody.innerHTML += `
                            &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${admission.name}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${admission.email}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${admission.created_at}&lt;/td&gt;
                            &lt;/tr&gt;`;
                    });
                }).catch(error =&gt; { throw error; });
        } catch (error) {
            console.error(&quot;Error fetching admissions report:&quot;, error);
            document.getElementById(&#39;admissions-report-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;3&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }

    function fetchAttendanceReport() {
        try {
            const reportBody = document.getElementById(&#39;attendance-report-body&#39;);
            fetch(`${API_BASE_URL}/reports/attendance`, {credentials: &#39;include&#39;})
                .then(res =&gt; res.json())
                .then(report =&gt; {
                    reportBody.innerHTML = &#39;&#39;;
                    if (report.length === 0) {
                        reportBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No attendance data available.&lt;/td&gt;&lt;/tr&gt;`;
                        return;
                    }
                    report.forEach(data =&gt; {
                        const percentClass = data.percentage &lt; 75 ? &#39;text-red-600 font-bold&#39; : &#39;text-green-600 font-bold&#39;;
                        reportBody.innerHTML += `
                            &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${data.student_name}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${data.total_classes}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-green-600 dark:text-green-400&quot;&gt;${data.present}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-red-600 dark:text-red-400&quot;&gt;${data.absent}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm ${percentClass}&quot;&gt;${data.percentage}%&lt;/td&gt;
                            &lt;/tr&gt;`;
                    });
                }).catch(error =&gt; { throw error; });
        } catch (error) {
            console.error(&quot;Error fetching attendance report:&quot;, error);
            document.getElementById(&#39;attendance-report-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }

    function fetchPerformanceReport() {
        try {
            const reportBody = document.getElementById(&#39;performance-report-body&#39;);
            fetch(`${API_BASE_URL}/reports/performance`, {credentials: &#39;include&#39;})
                .then(res =&gt; res.json())
                .then(report =&gt; {
                    reportBody.innerHTML = &#39;&#39;;
                    if (report.length === 0) {
                        reportBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center&quot;&gt;No performance data available.&lt;/td&gt;&lt;/tr&gt;`;
                        return;
                    }
                    report.forEach(data =&gt; {
                        reportBody.innerHTML += `
                            &lt;tr class=&quot;even:bg-slate-500/5 dark:even:bg-slate-800/50&quot;&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-medium&quot;&gt;${data.student_name}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${data.assessments_taken}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400&quot;&gt;${data.total_score}&lt;/td&gt;
                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm font-bold&quot;&gt;${data.overall_percentage}%&lt;/td&gt;
                            &lt;/tr&gt;`;
                    });
                }).catch(error =&gt; { throw error; });
        } catch (error) {
            console.error(&quot;Error fetching performance report:&quot;, error);
            document.getElementById(&#39;performance-report-body&#39;).innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;4&quot; class=&quot;px-6 py-4 text-center text-red-500&quot;&gt;Error loading data.&lt;/td&gt;&lt;/tr&gt;`;
        }
    }


    // --- FINAL INITIALIZATION CALLS ---
    
    try {
        checkAdminSession();
        // Initial call to load content (handled inside checkAdminSession success block now)

    } catch(globalError) {
        console.error(&quot;Critical Global Script Error:&quot;, globalError);
        alert(&quot;A critical error occurred during page initialization. Please refresh or contact support.&quot;);
    }
});



</script>
</body>
</html>
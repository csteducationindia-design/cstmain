<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal</title>
    <link rel="manifest" href="/static/manifest.json">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#1173d4" }, fontFamily: { "display": ["Inter"] } } } }</script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>.table-auto-layout { table-layout: auto; } .overdue { color: #ef4444; font-weight: 600; } .pending { color: #f59e0b; font-weight: 600; } .paid { color: #10b981; font-weight: 600; }</style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
        <div class="p-6"><h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Admin</h1></div>
        <nav class="flex-1 px-4 py-2 space-y-1">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 text-primary"><span class="material-symbols-outlined">dashboard</span><span class="text-sm font-medium">Dashboard</span></a>
            <a href="#teachers" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">person</span><span class="text-sm font-medium">Teachers</span></a>
            <a href="#students" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">school</span><span class="text-sm font-medium">Students</span></a>
            <a href="#parents" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">groups</span><span class="text-sm font-medium">Parents</span></a>
            <a href="#courses" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">book</span><span class="text-sm font-medium">Courses</span></a>
            <a href="#sessions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">calendar_month</span><span class="text-sm font-medium">Sessions</span></a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">campaign</span><span class="text-sm font-medium">Announcements</span></a>
            <a href="#fees" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">payments</span><span class="text-sm font-medium">Fees & Payments</span></a>
            <a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">receipt_long</span><span class="text-sm font-medium">Fee Reports</span></a>
            <a href="#admin-message" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">message</span><span class="text-sm font-medium">Bulk Message</span></a>
            <a href="#bulk-upload" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-slate-100"><span class="material-symbols-outlined">upload_file</span><span class="text-sm font-medium">Bulk Upload</span></a>
            
            <button id="install-app-btn" class="hidden w-full flex items-center gap-3 px-4 py-2 rounded-lg text-green-600 hover:bg-green-50 font-medium mt-4">
                <span class="material-symbols-outlined">download</span><span class="text-sm">Install App</span>
            </button>
        </nav>
        <div class="p-6 border-t border-slate-200"><button id="logout-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-700">Logout</button></div>
    </aside>

    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8"><h1 class="text-4xl font-bold text-slate-900 dark:text-white">Admin Dashboard</h1></header>
            
            <div id="content-dashboard" class="content-section">
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded shadow"><p>Teachers</p><h3 class="text-2xl font-bold" id="total-teachers">...</h3></div>
                    <div class="bg-white p-4 rounded shadow"><p>Students</p><h3 class="text-2xl font-bold" id="total-students">...</h3></div>
                </div>
                <div class="bg-white p-6 rounded shadow">
                    <h3 class="text-lg font-bold mb-4">Recent Announcements</h3>
                    <table class="w-full"><tbody id="recent-announcements-body"></tbody></table>
                </div>
            </div>

            <div id="content-fees" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4">Record Payment</h2>
                <div class="bg-white p-6 rounded shadow mb-8">
                    <form id="payment-form" class="grid grid-cols-2 gap-4">
                        <select id="payment-student-select" class="border p-2 rounded" required></select>
                        <select id="payment-fee-structure-select" class="border p-2 rounded" required></select>
                        <input type="number" id="payment-amount" placeholder="Amount" class="border p-2 rounded" required>
                        <select id="payment-method" class="border p-2 rounded"><option>Cash</option><option>Card</option><option>UPI</option></select>
                        <button type="submit" class="col-span-2 bg-primary text-white p-2 rounded">Record & Print Receipt</button>
                    </form>
                </div>
            </div>

            <div id="content-fee-pending-report" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4">Pending Fees</h2>
                <div class="bg-white p-6 rounded shadow">
                    <table class="w-full">
                        <thead><tr><th class="text-left p-2">Student</th><th class="text-left p-2">Pending</th><th class="text-left p-2">Due Date</th><th class="text-center p-2">Action</th></tr></thead>
                        <tbody id="fee-pending-report-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="content-announcements" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4">Manage Announcements</h2>
                <div class="bg-white p-6 rounded shadow">
                    <form id="announcement-form" class="mb-8">
                        <input type="text" id="announcement-title" placeholder="Title" class="border p-2 w-full mb-2 rounded" required>
                        <textarea id="announcement-content" placeholder="Content" class="border p-2 w-full mb-2 rounded" required></textarea>
                        <select id="announcement-target" class="border p-2 w-full mb-2 rounded">
                            <option value="all">All</option><option value="students">Students</option><option value="teachers">Teachers</option>
                        </select>
                        <button type="submit" class="bg-primary text-white p-2 rounded">Post Announcement</button>
                    </form>
                    <table class="w-full"><tbody id="announcements-table-body"></tbody></table>
                </div>
            </div>
            
            </div>
    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script>
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    
    // PWA
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
    installBtn.addEventListener('click', async () => { if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt = null; } });

    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('.content-section');
        const links = document.querySelectorAll('.nav-link');
        function showSection(hash) {
            sections.forEach(s => s.classList.add('hidden'));
            const id = hash.substring(1) || 'dashboard';
            const el = document.getElementById(`content-${id}`);
            if(el) {
                el.classList.remove('hidden');
                if(id === 'dashboard') fetchDashboard();
                if(id === 'fees') { fetchStudentsForPayment(); fetchFeeStructures(); }
                if(id === 'fee-pending-report') fetchFeeReport();
                if(id === 'announcements') fetchAnnouncements();
            }
        }
        window.addEventListener('hashchange', () => showSection(window.location.hash));
        showSection(window.location.hash);

        async function fetchDashboard() {
             const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
             if(res.ok) {
                 const users = await res.json();
                 document.getElementById('total-teachers').innerText = users.filter(u=>u.role==='teacher').length;
                 document.getElementById('total-students').innerText = users.filter(u=>u.role==='student').length;
             }
             fetchAnnouncements();
        }

        async function fetchStudentsForPayment() {
            const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
            const users = await res.json();
            const select = document.getElementById('payment-student-select');
            select.innerHTML = '<option value="">Select Student</option>';
            users.filter(u=>u.role==='student').forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`);
        }
        
        async function fetchFeeStructures() {
            const res = await fetch(`${API_BASE_URL}/fee_structures`, {credentials:'include'});
            const fees = await res.json();
            const select = document.getElementById('payment-fee-structure-select');
            select.innerHTML = '<option value="">Select Fee</option>';
            fees.forEach(f => select.innerHTML += `<option value="${f.id}">${f.name} (${f.total_amount})</option>`);
        }

        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                student_id: document.getElementById('payment-student-select').value,
                fee_structure_id: document.getElementById('payment-fee-structure-select').value,
                amount_paid: document.getElementById('payment-amount').value,
                payment_method: document.getElementById('payment-method').value
            };
            const res = await fetch(`${API_BASE_URL}/payments`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data), credentials:'include'});
            const result = await res.json();
            if(res.ok) {
                alert("Payment Recorded!");
                window.open(`${API_BASE_URL}/receipt/${result.payment_id}`, '_blank', 'width=600,height=600');
                document.getElementById('payment-form').reset();
            } else { alert(result.message); }
        });

        async function fetchFeeReport() {
            const res = await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials:'include'});
            const data = await res.json();
            const tbody = document.getElementById('fee-pending-report-body');
            tbody.innerHTML = '';
            data.forEach(r => {
                tbody.innerHTML += `<tr><td class="p-2">${r.student_name}</td><td class="p-2 text-red-600 font-bold">${r.balance}</td><td class="p-2">${r.due_date}</td>
                <td class="p-2 text-center"><button class="text-yellow-600" onclick="sendSms(${r.student_id})">SMS</button></td></tr>`;
            });
        }
        
        window.sendSms = async (id) => {
            if(confirm("Send SMS Alert?")) {
                await fetch(`${API_BASE_URL}/send_sms_alert`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({student_id:id}), credentials:'include'});
                alert("Alert Sent");
            }
        };

        async function fetchAnnouncements() {
            const res = await fetch(`${API_BASE_URL}/announcements`, {credentials:'include'});
            const data = await res.json();
            const tbody = document.getElementById('announcements-table-body');
            const recentBody = document.getElementById('recent-announcements-body');
            if(tbody) tbody.innerHTML = '';
            if(recentBody) recentBody.innerHTML = '';
            data.forEach((a, i) => {
                const row = `<tr><td class="p-2">${a.title}</td><td class="p-2">${a.created_at}</td><td class="p-2">${a.target_group}</td><td class="p-2"><button onclick="deleteAnnouncement(${a.id})">Del</button></td></tr>`;
                if(tbody) tbody.innerHTML += row;
                if(recentBody && i<5) recentBody.innerHTML += `<tr><td class="p-2">${a.title}</td><td class="p-2">${a.created_at}</td></tr>`;
            });
        }

        document.getElementById('announcement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('announcement-title').value,
                content: document.getElementById('announcement-content').value,
                target_group: document.getElementById('announcement-target').value
            };
            await fetch(`${API_BASE_URL}/announcements`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data), credentials:'include'});
            alert("Announcement Posted");
            fetchAnnouncements();
        });
        
        window.deleteAnnouncement = async (id) => {
            if(confirm("Delete?")) {
                await fetch(`${API_BASE_URL}/announcements/${id}`, {method:'DELETE', credentials:'include'});
                fetchAnnouncements();
            }
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch(`${API_BASE_URL}/logout`, {method:'POST', credentials:'include'});
            window.location.href = '/';
        });
    });

    function initFirebase() {
        try {
             const firebaseConfig = {
                apiKey: "AIzaSyBkZEHM9fXRoCYSgEW-hk_lN7sL_nSLDfU",
                authDomain: "cst-institute-app.firebaseapp.com",
                projectId: "cst-institute-app",
                storageBucket: "cst-institute-app.firebasestorage.app",
                messagingSenderId: "485166460200",
                appId: "1:485166460200:web:4eae20e2010ab92baeb41d"
            };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const messaging = firebase.messaging();
            if('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/firebase-messaging-sw.js').then(reg => {
                    Notification.requestPermission().then(perm => {
                        if(perm==='granted') messaging.getToken({vapidKey: "BBOMxvKvbEs_t9ykKBa2zIewzCzD6FCbm9rxc8a9eWl2kjjH5vyTSH6TeQMksZ_OGl5jZyQpU2wBcf-KsZN1uko", serviceWorkerRegistration: reg}).then(token => {
                            fetch('/api/save_fcm_token', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token}), credentials:'include'});
                        });
                    });
                });
            }
        } catch(e) {}
    }
    setTimeout(initFirebase, 2000);
</script>
</body>
</html>
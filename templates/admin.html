<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .table-auto-layout {
            table-layout: auto;
        }
        .overdue {
            color: #ef4444; /* text-red-500 */
            font-weight: 600;
        }
        .pending {
            color: #f59e0b; /* text-amber-500 */
            font-weight: 600;
        }
        .paid {
            color: #10b981; /* text-emerald-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Admin</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Admin Portal</p>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-1">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="text-sm font-medium">Dashboard</span>
            </a>
            <a href="#teachers" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">person</span>
                <span class="text-sm font-medium">Teachers</span>
            </a>
            <a href="#students" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">school</span>
                <span class="text-sm font-medium">Students</span>
            </a>
            <a href="#parents" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">groups</span>
                <span class="text-sm font-medium">Parents</span>
            </a>
            <a href="#courses" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">book</span>
                <span class="text-sm font-medium">Courses</span>
            </a>
            <a href="#sessions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-sm font-medium">Sessions</span>
            </a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">campaign</span>
                <span class="text-sm font-medium">Announcements</span>
            </a>
            <a href="#fees" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">payments</span>
                <span class="text-sm font-medium">Fees & Payments</span>
            </a>
            <a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">receipt_long</span>
                <span class="text-sm font-medium">Fee Pending Report</span>
            </a>
            <a href="#admin-message" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">message</span>
                <span class="text-sm font-medium">Bulk Message</span>
            </a>
            <a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">analytics</span>
                <span class="text-sm font-medium">Reports</span>
            </a>
            <a href="#bulk-upload" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">upload_file</span>
                <span class="text-sm font-medium">Bulk Upload</span>
            </a>
        </nav>
        <div class="p-6 border-t border-slate-200 dark:border-slate-800">
            <button id="logout-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-red-700 transition duration-150">
                Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-900 dark:text-white">Admin Dashboard</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2">Welcome back, Admin! Here's an overview of your institute.</p>
            </header>

            

<div id="content-dashboard" class="content-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Teachers</p>
                        <p id="total-teachers" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Students</p>
                        <p id="total-students" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Parents</p>
                        <p id="total-parents" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Total Courses</p>
                        <p id="total-courses" class="text-3xl font-bold text-slate-900 dark:text-white mt-1">...</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Quick Actions</h2>
                    <div class="flex gap-4">
                        <a href="#teachers" class="bg-primary text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Manage Teachers</a>
                        <a href="#students" class="bg-primary text-white font-medium py-2.5 px-6 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Manage Students</a>
                        

</div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Recent Announcements</h2>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target Group</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-announcements-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-teachers" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Teachers</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
	<h3 id="teacher-form-title" class="text-xl font-bold mb-4">Add/Edit Teacher</h3>
                    <form id="teacher-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="teacher-id" name="id">
                        <input type="hidden" id="teacher-role" name="role" value="teacher">
                        <div class="form-group"><label for="teacher-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="teacher-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="teacher-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="teacher-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="teacher-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="teacher-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="teacher-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="teacher-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="md:col-span-2">
                            <button type="submit" id="teacher-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Teacher</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Teachers</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-students" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Students</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 id="student-form-title" class="text-xl font-bold mb-4">Add/Edit Student</h3>
                    <form id="student-form" class="space-y-6" enctype="multipart/form-data">
                        <input type="hidden" id="student-id" name="id">
                        <input type="hidden" id="student-role" name="role" value="student">
                        
                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Enrollment Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group md:col-span-1">
                                    <label for="student-course-select" class="block text-sm font-medium mb-1">Course Enrollment *</label>
                                    <select id="student-course-select" name="course_ids" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                        <option value="">Select Course</option>
                                    </select>
                                    <p class="text-xs text-red-500 mt-1">Required for Attendance/Reports</p>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Basic Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group"><label for="student-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="student-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="student-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="student-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-dob-input" class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" id="student-dob-input" name="dob" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-gender-select" class="block text-sm font-medium mb-1">Gender</label>
                                    <select id="student-gender-select" name="gender" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                 <div class="form-group"><label for="student-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="student-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Parent/Guardian Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group"><label for="student-father-name-input" class="block text-sm font-medium mb-1">Father's Name</label><input type="text" id="student-father-name-input" name="father_name" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-mother-name-input" class="block text-sm font-medium mb-1">Mother's Name</label><input type="text" id="student-mother-name-input" name="mother_name" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-parent-select" class="block text-sm font-medium mb-1">Link Parent Account (Optional)</label><select id="student-parent-select" name="parent_id" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Address Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group md:col-span-3"><label for="student-address-input" class="block text-sm font-medium mb-1">Address Line 1</label><input type="text" id="student-address-input" name="address_line1" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-city-input" class="block text-sm font-medium mb-1">City</label><input type="text" id="student-city-input" name="city" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-state-input" class="block text-sm font-medium mb-1">State</label><input type="text" id="student-state-input" name="state" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                                <div class="form-group"><label for="student-pincode-input" class="block text-sm font-medium mb-1">Pincode</label><input type="text" id="student-pincode-input" name="pincode" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            </div>
                        </fieldset>
                        

                        <fieldset>
                            <legend class="text-lg font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-slate-700 pb-2 mb-4">Profile Photo</legend>
                            <div class="flex items-center gap-4">
                                <img id="student-photo-preview" src="https://placehold.co/100x100/f6f7f8/666?text=Preview" alt="Photo Preview" class="w-24 h-24 rounded-lg object-cover border border-slate-300 dark:border-slate-700">
                                <div class="form-group">
                                    <label for="student-photo-file-input" class="block text-sm font-medium mb-1">Upload Photo (Optional)</label>
                                    <input type="file" id="student-photo-file-input" name="profile_photo_file" accept="image/png, image/jpeg, image/gif" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary dark:file:bg-primary/20 dark:file:text-primary hover:file:bg-primary/20 dark:hover:file:bg-primary/30">
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Select a file to update. Leave blank to keep existing photo (if editing).</p>
                                </div>
                            </div>
                        </fieldset>

                        <div class="pt-4">
                            <button type="submit" id="student-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Student</button>
                        </div>
                    </form>
                </div>
                <div>
                    <div class="mb-4">
                        <label for="student-search-input" class="block text-sm font-medium mb-1">Search Students (by Name, Email, or Phone)</label>
                        <input type="text" id="student-search-input" placeholder="Start typing to search..." class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                    </div>

                    <h3 class="text-xl font-bold mb-4">Existing Students</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Parent</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">SMS</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">WhatsApp</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-parents" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Parents</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 id="parent-form-title" class="text-xl font-bold mb-4">Add/Edit Parent</h3>
                    <form id="parent-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="parent-id" name="id">
                        <input type="hidden" id="parent-role" name="role" value="parent">
                        <div class="form-group"><label for="parent-name-input" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="parent-name-input" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="parent-email-input" class="block text-sm font-medium mb-1">Email</label><input type="email" id="parent-email-input" name="email" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="parent-phone-input" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="parent-phone-input" name="phone_number" placeholder="e.g., 9876543210" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="parent-password-input" class="block text-sm font-medium mb-1">Password</label><input type="password" id="parent-password-input" name="password" placeholder="Required for new users, leave blank to keep old" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="md:col-span-2">
                            <button type="submit" id="parent-form-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Parent</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Parents</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="parent-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-courses" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Courses</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Add New Course</h3>
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="hidden" id="course-id" name="id">
                        <div class="form-group"><label for="course-name" class="block text-sm font-medium mb-1">Course Name</label><input type="text" id="course-name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="course-subjects" class="block text-sm font-medium mb-1">Subjects (comma-separated)</label><input type="text" id="course-subjects" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="course-teacher" class="block text-sm font-medium mb-1">Assign Teacher</label><select id="course-teacher" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                        <div class="md:col-span-2">
	      <button type="submit" id="save-course-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Course</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Courses</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Course Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjects</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Teacher</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="course-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-sessions" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Academic Sessions</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Add New Session</h3>
                    <form id="session-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="hidden" id="session-id" name="id">
                        <div class="form-group"><label for="session-name" class="block text-sm font-medium mb-1">Session Name</label><input type="text" id="session-name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="session-start-date" class="block text-sm font-medium mb-1">Start Date</label><input type="date" id="session-start-date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="session-end-date" class="block text-sm font-medium mb-1">End Date</label><input type="date" id="session-end-date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="form-group"><label for="session-status" class="block text-sm font-medium mb-1">Status</label><select id="session-status" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
                        <div class="md:col-span-2">
                            <button type="submit" id="save-session-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Session</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Sessions</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Start Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">End Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="session-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            

<div id="content-announcements" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Manage Announcements</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Create New Announcement</h3>
                    <form id="announcement-form">
                        <div class="mb-4"><label for="announcement-title" class="block text-sm font-medium mb-1">Title</label><input type="text" id="announcement-title" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="mb-4"><label for="announcement-content" class="block text-sm font-medium mb-1">Content</label><textarea id="announcement-content" rows="5" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea></div>
                        <div class="mb-4"><label for="announcement-target-group" class="block text-sm font-medium mb-1">Target Group</label><select id="announcement-target-group" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="all">All Users</option><option value="teachers">Teachers</option><option value="students">Students</option><option value="parents">Parents</option><option value="admin">Admin</option></select></div>
                        <button type="submit" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Publish Announcement</button>
                    </form>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Existing Announcements</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
        <thead>
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Content</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target Group</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody id="management-announcements-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
    </table>
</div>
                </div>
            </div>

            

<div id="content-fees" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Fees & Payments</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Manage Fee Structures</h3>
                        <form id="fee-structure-form" class="space-y-4">
                            <input type="hidden" id="fee-structure-id" name="id">
                            <div class="form-group"><label for="fee-structure-name" class="block text-sm font-medium mb-1">Structure Name</label><input type="text" id="fee-structure-name" name="name" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="fee-session-select" class="block text-sm font-medium mb-1">Academic Session</label><select id="fee-session-select" name="academic_session_id" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            <div class="form-group"><label for="fee-total-amount" class="block text-sm font-medium mb-1">Total Amount</label><input type="number" step="0.01" id="fee-total-amount" name="total_amount" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="fee-due-date" class="block text-sm font-medium mb-1">Due Date</label><input type="date" id="fee-due-date" name="due_date" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <button type="submit" id="save-fee-structure-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Save Fee Structure</button>
                        </form>
                        <h4 class="text-lg font-bold mt-8 mb-4">Existing Fee Structures</h4>
                        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Date</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                            <tbody id="fee-structure-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Record Payment</h3>
                        <form id="payment-form" class="space-y-4">
                            <div class="form-group"><label for="payment-student-select" class="block text-sm font-medium mb-1">Student</label><select id="payment-student-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            <div class="form-group"><label for="payment-fee-structure-select" class="block text-sm font-medium mb-1">Fee Structure</label><select id="payment-fee-structure-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select></div>
                            <div class="form-group"><label for="payment-amount" class="block text-sm font-medium mb-1">Amount Paid</label><input type="number" step="0.01" id="payment-amount" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                            <div class="form-group"><label for="payment-method" class="block text-sm font-medium mb-1">Payment Method</label><select id="payment-method" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"><option value="Cash">Cash</option><option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option></select></div>
                            <button type="submit" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">Record Payment & Print Receipt</button>
                        </form>
                        <h4 class="text-lg font-bold mt-8 mb-4">Fee Status Overview</h4>
                        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Balance</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Days</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Alerts</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Receipt</th>
                                    </tr>
                                </thead>
                            <tbody id="fee-status-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
             <div id="content-fee-pending-report" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Student Fee Pending Report</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Pending Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Days Status</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">SMS</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="fee-pending-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
            <div id="content-admin-message" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Send Bulk Notifications (SMS/WhatsApp Mock)</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <form id="admin-bulk-message-form">
                        <div class="mb-4">
                            <label for="message-target-role" class="block text-sm font-medium mb-1">Target Group</label>
                            <select id="message-target-role" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                <option value="all">All Users (Teachers, Students, Parents)</option>
                                <option value="teachers">Teachers Only</option>
                                <option value="students">Students Only</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="message-subject" class="block text-sm font-medium mb-1">Subject / Header</label><input type="text" id="message-subject" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></div>
                        <div class="mb-4">
                            <label for="message-body" class="block text-sm font-medium mb-1">Message Content (Max 160 Chars for SMS Mock)</label><textarea id="message-body" rows="4" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button type="button" data-type="sms" class="send-bulk-btn w-full bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-yellow-700 transition duration-150">
                                Send Bulk SMS
                            </button>
                            <button type="button" data-type="whatsapp" class="send-bulk-btn w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                                Send Bulk WhatsApp (Mock)
                            </button>
                        </div>
                    </form>
                    <p id="admin-message-status" class="mt-4 text-sm font-medium text-center text-slate-500 dark:text-slate-400 hidden"></p>
                </div>
            </div>
            <div id="content-reports" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">General Reports</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Recent Admissions Report (Last 30 Days)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Admission Date</th>
                                    </tr>
                                </thead>
                                <tbody id="admissions-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Student Attendance Report</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Classes</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Present</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Absent</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold mb-4">Student Performance Report</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 table-auto-layout">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Assessments Taken</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Score</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Overall Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="performance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-bulk-upload" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Bulk Data Upload</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Upload Users (Students, Teachers, Parents)</h3>
                    <p class="text-sm text-red-500 dark:text-red-400 mb-4">NOTE: File must be a **CSV** with columns: **name, email, password, role** (required), **phone_number, parent_email, dob, gender, father_name, mother_name, address_line1, city, state, pincode** (optional).</p>
                    
                    <form id="bulk-upload-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="bulk-file-input" class="block text-sm font-medium mb-1">Select CSV File</label>
                            <input type="file" id="bulk-file-input" name="file" accept=".csv" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 p-2">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                            Process Bulk Upload
                        </button>
                    </form>

                    <div id="bulk-upload-results" class="mt-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg hidden">
                        <h4 class="text-lg font-bold mb-2">Results:</h4>
                        <p id="bulk-upload-message" class="font-medium mb-2"></p>
                        <div id="bulk-upload-details"></div>
                    </div>
                </div>
            </div>
            </div>
    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script>
    // DEFINE: Define the base URL explicitly using the current location origin 
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';

    // Store all users in memory for searching
    let allUsersCache = [];
    let allCoursesCache = []; // NEW: Cache courses globally
    let allSessionsCache = []; // NEW: Cache sessions globally

    document.addEventListener('DOMContentLoaded', () => {
        
        // --- GLOBAL UI & NAVIGATION ---
        const logoutBtn = document.getElementById('logout-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        const sessionForm = document.getElementById('session-form');
        const courseForm = document.getElementById('course-form');
        const courseTeacherSelect = document.getElementById('course-teacher');
        const feeStructureForm = document.getElementById('fee-structure-form');
        const paymentForm = document.getElementById('payment-form');
        const announcementForm = document.getElementById('announcement-form'); 
        const searchInput = document.getElementById('student-search-input'); 
        const bulkUploadForm = document.getElementById('bulk-upload-form');
        const adminBulkMessageForm = document.getElementById('admin-bulk-message-form');

        let searchTimeout;
        // --- BULK UPLOAD USERS (CSV) ---
        if (bulkUploadForm) {
            bulkUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const fileInput = document.getElementById('bulk-file-input');
                const resultsBox = document.getElementById('bulk-upload-results');
                const messageEl = document.getElementById('bulk-upload-message');
                const detailsEl = document.getElementById('bulk-upload-details');

                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('Please select a CSV file first.');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                // Show loading message
                if (resultsBox) resultsBox.classList.remove('hidden');
                if (messageEl) {
                    messageEl.textContent = 'Uploading and processing CSV, please wait...';
                    messageEl.className = 'font-medium mb-2 text-blue-600';
                }
                if (detailsEl) detailsEl.innerHTML = '';

                try {
                    const response = await fetch(`${API_BASE_URL}/bulk_upload/users`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    const result = await response.json();

                    if (messageEl) {
                        messageEl.textContent = result.message || (response.ok ? 'Upload completed.' : 'Upload failed.');
                        messageEl.className = 'font-medium mb-2 ' + (response.ok ? 'text-green-600' : 'text-red-600');
                    }

                    if (detailsEl) {
                        const details = result.details || {};
                        const added = details.added || [];
                        const failed = details.failed || [];

                        let html = '';

                        if (added.length) {
                            html += `<p class="text-sm text-green-600 mb-1"><strong>Added (${added.length}):</strong> ${added.join(', ')}</p>`;
                        }
                        if (failed.length) {
                            html += `<p class="text-sm text-red-600 mb-1"><strong>Failed (${failed.length}):</strong></p>`;
                            html += '<ul class="list-disc ml-5 text-sm text-red-600">' +
                                    failed.map(err => `<li>${err}</li>`).join('') +
                                    '</ul>';
                        }
                        if (!html) {
                            html = '<p class="text-sm text-slate-600">No detailed info returned.</p>';
                        }

                        detailsEl.innerHTML = html;
                    }
                } catch (error) {
                    console.error('Bulk upload error:', error);
                    if (messageEl) {
                        messageEl.textContent = 'Network / server error while uploading CSV.';
                        messageEl.className = 'font-medium mb-2 text-red-600';
                    }
                    if (detailsEl) detailsEl.innerHTML = '';
                }
            });
        }

        function updateNavLink(hash) {
            navLinks.forEach(link => {
                link.classList.remove('bg-primary/10', 'dark:bg-primary/20', 'text-primary');
                link.classList.add('text-slate-700', 'dark:text-slate-300', 'hover:bg-primary/10', 'dark:hover:bg-primary/20');
            });
            const targetLink = document.querySelector(`.nav-link[href="${hash}"]`);
            if (targetLink) { 
                targetLink.classList.add('bg-primary/10', 'dark:bg-primary/20', 'text-primary');
                targetLink.classList.remove('text-slate-700', 'dark:text-slate-300', 'hover:bg-primary/10', 'dark:hover:bg-primary/20');
            }
        }

        function showSection(hash) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });

            let targetId = hash.substring(1) || 'dashboard'; // Default to dashboard
            let targetSection = document.getElementById(`content-${targetId}`);
            
            updateNavLink(hash); 

            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
        }
        
        function loadContentByHash() {
            const currentHash = window.location.hash.substring(1) || 'dashboard';
            
            try { // CRITICAL: This outer try/catch prevents the application freeze!
                switch (currentHash) {
                    case 'dashboard': 
                        fetchDashboardSummary(); 
                        break;
                    case 'teachers': 
                        fetchTeachers(); 
                        resetUserForm('teacher'); 
                        break; 
                    case 'students': 
                        fetchStudents(); 
                        populateParentDropdowns(); 
                        resetUserForm('student'); 
                        fetchCoursesForEnrollment(); 
                        break; 
                    case 'parents': 
                        fetchParents(); 
                        resetUserForm('parent'); 
                        break;
                    case 'courses': 
                        fetchCourses(); 
                        fetchTeachersForCourseDropdown(); 
                        resetCourseForm(); 
                        break; 
                    case 'sessions': 
                        fetchSessions(); 
                        resetSessionForm(); 
                        break;
                    case 'announcements': 
                        fetchAnnouncements(true); 
                        break;
                    case 'fees': 
                        fetchFeeStructures(); 
                        fetchStudentsForPaymentDropdown(); 
                        fetchFeeSessionDropdowns(); 
                        fetchFeeStatus(); 
                        resetFeeStructureForm();
                        break;
                    case 'fee-pending-report': 
                        fetchFeePendingReport(); 
                        break; 
                    case 'reports': 
                        fetchAdmissionsReport(); 
                        fetchAttendanceReport(); 
                        fetchPerformanceReport(); 
                        break;
                    case 'admin-message': 
                        break;
                    case 'bulk-upload': 
                        break;
                    default: 
                        console.warn(`Unknown hash: ${currentHash}`); 
                        break;
                }
            } catch(e) {
                console.error("Content Loading Error:", e);
                // Display the generic error caught here
                alert("An error occurred loading content. Please check the console.");
            }
        }

        window.addEventListener('hashchange', () => {
             try { // CRITICAL: Added try...catch for stability
                showSection(window.location.hash); 
                loadContentByHash();
             } catch(e) {
                 console.error("Navigation Error:", e);
                 alert("A critical navigation error occurred. See console for details.");
             }
        });

        // Initial load based on hash or default to dashboard
        showSection(window.location.hash);

        // --- AUTHENTICATION ---
        async function checkAdminSession() {
            try {
                const response = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: 'include'});
                if (!response.ok) throw new Error('Session check failed');
                const result = await response.json();
                if (!result.logged_in || result.user.role !== 'admin') { 
                    window.location.href = API_ORIGIN + '/'; 
                }
            } catch (error) {
                console.error("Could not verify session. Redirecting to login.", error);
                window.location.href = API_ORIGIN + '/';
            }
        }
        logoutBtn.addEventListener('click', async () => {
            try { // CRITICAL: Added try...catch for stability
                await fetch(`${API_BASE_URL}/logout`, { method: 'POST', credentials: 'include' });
                window.location.href = API_ORIGIN + '/';
            } catch (error) {
                console.error("Logout Error:", error);
                alert("Logout failed. Please try refreshing the page.");
            }
        });

        // --- DASHBOARD SUMMARY ---
        async function fetchDashboardSummary() {
             try {
                 await fetchAllUsers(); 
                 const coursesResponse = await fetch(`${API_BASE_URL}/courses`, {credentials: 'include'});
                 const courses = await coursesResponse.json();
                 allCoursesCache = courses; // Cache courses
                 
                 const sessionsResponse = await fetch(`${API_BASE_URL}/sessions`, {credentials: 'include'});
                 const sessions = await sessionsResponse.json();
                 allSessionsCache = sessions; // Cache sessions

                 document.getElementById('total-teachers').textContent = allUsersCache.filter(u => u.role === 'teacher').length;
                 document.getElementById('total-students').textContent = allUsersCache.filter(u => u.role === 'student').length;
                 document.getElementById('total-parents').textContent = allUsersCache.filter(u => u.role === 'parent').length;
                 document.getElementById('total-courses').textContent = courses.length;
                 
                 fetchAnnouncements(false); 
             } catch(error) {
                  console.error("Error loading dashboard summary:", error);
                  document.getElementById('total-teachers').textContent = 'Error';
                  document.getElementById('total-students').textContent = 'Error';
                  document.getElementById('total-parents').textContent = 'Error';
                  document.getElementById('total-courses').textContent = 'Error';
             }
        }

        // --- USER MANAGEMENT UTILITIES ---

        async function fetchAllUsers(searchTerm = '') {
            try {
                let endpoint = `${API_BASE_URL}/users`;
                if (searchTerm) {
                    endpoint += `?search=${encodeURIComponent(searchTerm)}`;
                }
                const response = await fetch(endpoint, { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to fetch users');
                
                const users = await response.json();
                if (!searchTerm) { allUsersCache = users; }
                return users;
            } catch (error) {
                console.error("Error fetching all users:", error);
                return [];
            }
        }

        function populateUserForm(user, role) {
            const form = document.getElementById(`${role}-form`);
            if (!form) return;

            form.querySelector('input[id$="-id"]').value = user.id;
            form.querySelector('input[id$="-name-input"]').value = user.name;
            form.querySelector('input[id$="-email-input"]').value = user.email;
            
            const phoneInput = form.querySelector('input[id$="-phone-input"]');
            if (phoneInput) phoneInput.value = user.phone_number || '';

            const passwordInput = form.querySelector('input[id$="-password-input"]');
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.placeholder = 'Leave blank to keep current password';
            }
            
            if (role === 'student') {
                document.getElementById('student-parent-select').value = user.parent_id || '';
                document.getElementById('student-dob-input').value = user.dob || '';
                document.getElementById('student-gender-select').value = user.gender || '';
                document.getElementById('student-father-name-input').value = user.father_name || '';
                document.getElementById('student-mother-name-input').value = user.mother_name || '';
                document.getElementById('student-address-input').value = user.address_line1 || '';
                document.getElementById('student-city-input').value = user.city || '';
                document.getElementById('student-state-input').value = user.state || '';
                document.getElementById('student-pincode-input').value = user.pincode || '';
                
                const courseSelect = document.getElementById('student-course-select');
                if (courseSelect) courseSelect.value = user.course_ids && user.course_ids.length > 0 ? user.course_ids[0] : ''; 

                const preview = document.getElementById('student-photo-preview');
                const defaultAvatar = `https://placehold.co/100x100/f6f7f8/666?text=${user.name.charAt(0) || '?'}`;
                const photoUrl = user.profile_photo_url ? `${API_ORIGIN}${user.profile_photo_url}?t=${new Date().getTime()}` : defaultAvatar;
                preview.src = photoUrl;
                document.getElementById('student-photo-file-input').value = ''; 
            }
            
            form.querySelector('button[type="submit"]').textContent = `Update ${role.charAt(0).toUpperCase() + role.slice(1)}`;
            document.querySelector(`#content-${role} h3`).textContent = `Edit Existing ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        }

        function resetUserForm(role) {
            const form = document.getElementById(`${role}-form`);
            if (form) {
                form.reset();
                form.querySelector('input[id$="-id"]').value = '';
                const passwordInput = form.querySelector('input[id$="-password-input"]');
                if(passwordInput) passwordInput.placeholder = 'Required for new users, leave blank to keep old';

                if (role === 'student') {
                    document.getElementById('student-form-title').textContent = 'Add/Edit Student';
                    document.getElementById('student-form-btn').textContent = 'Save Student';
                    document.getElementById('student-photo-preview').src = 'https://placehold.co/100x100/f6f7f8/666?text=Preview';
                    document.getElementById('student-photo-file-input').value = ''; 
                } else {
                    const btn = document.getElementById(`${role}-form-btn`);
                    const title = document.getElementById(`${role}-form-title`);
                    if (btn) btn.textContent = `Save ${role.charAt(0).toUpperCase() + role.slice(1)}`;
                    if (title) title.textContent = `Add/Edit ${role.charAt(0).toUpperCase() + role.slice(1)}`;
                }
            }
        }

        // Universal form handler (relies on FormData for file uploads, JSON not used here)
        async function manageUser(formId, role, specificFetchCallback = null) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const idInput = form.querySelector('input[id$="-id"]');
                const userId = idInput.value;
                const method = userId ? 'PUT' : 'POST';
                let endpoint = `${API_BASE_URL}/users`;
                
                const formData = new FormData(form);
                
                // --- Validation Logic ---
                if (role === 'student') {
                    const courseId = formData.get('course_ids');
                    if (!courseId) {
                        alert("Course Enrollment is mandatory for students.");
                        return;
                    }
                }
                
                const passwordInput = form.querySelector('input[id$="-password-input"]');
                if (method === 'PUT' && !passwordInput.value) {
                    formData.delete('password'); 
                } else if (method === 'POST' && !passwordInput.value) {
                    alert("Password is required for new users.");
                    return;
                }
                // --- End Validation Logic ---
                
                let photoUploadPromise = null;
                if (role === 'student' && method === 'PUT') {
                    const photoFile = document.getElementById('student-photo-file-input').files[0];
                    if (photoFile) {
                        formData.delete('profile_photo_file');
                        const photoFormData = new FormData();
                        photoFormData.append('profile_photo_file', photoFile);
                        photoUploadPromise = fetch(`${API_BASE_URL}/user/upload_photo/${userId}`, {
                            method: 'POST',
                            credentials: 'include',
                            body: photoFormData
                        });
                    } else {
                        formData.delete('profile_photo_file');
                    }
                } else if (role === 'student' && method === 'POST') {
                    // Ensure profile_photo_file is included if present, otherwise it's just FormData
                }
                
                try {
                    const userDataResponse = await fetch(endpoint, {
                        method: method,
                        credentials: 'include',
                        body: formData 
                    });

                    const userDataResult = await userDataResponse.json();
                    
                    if (!userDataResponse.ok) {
                        throw new Error(userDataResult.message || 'Failed to save details.');
                    }
                    
                    if (photoUploadPromise) {
                        const photoResponse = await photoUploadPromise;
                        if (!photoResponse.ok) {
                            throw new Error('Student details saved, but photo upload failed.');
                        }
                        const photoResult = await photoResponse.json();
                        populateUserForm(photoResult.user, 'student');
                    }
                    
                    alert(`User ${method === 'POST' ? 'added' : 'updated'} successfully!`);
                    resetUserForm(role);
                    
                    // Refresh data globally
                    await fetchAllUsers();
                    if (specificFetchCallback) specificFetchCallback();
                    fetchDashboardSummary();
                    if (role === 'parent') populateParentDropdowns(); 
                    if (role === 'teacher') fetchTeachersForCourseDropdown(); 
                    if (role === 'student') fetchStudentsForPaymentDropdown();
                    
                } catch (error) {
                    alert(`An error occurred: ${error.message}.`);
                    console.error('Error saving user:', error);
                }
            });
        }
        
        // Initialize user form handlers
        manageUser('teacher-form', 'teacher', fetchTeachers);
        manageUser('parent-form', 'parent', fetchParents);
        manageUser('student-form', 'student', fetchStudents); 

        
        // --- UNIVERSAL EDIT/DELETE FUNCTIONS ---
        window.editStudent = async function(id) {
            try { // CRITICAL: Added try...catch for stability
                let user = allUsersCache.find(u => u.id === id);
                if (user) {
                    populateUserForm(user, 'student');
                    window.location.hash = 'students'; 
                } else {
                    alert('Could not find user data. Refreshing...');
                    await fetchAllUsers();
                    user = allUsersCache.find(u => u.id === id);
                    if (user) populateUserForm(user, 'student');
                }
            } catch (error) {
                 console.error('Error during editStudent:', error);
                 alert('A critical error occurred during edit.');
            }
        };
        window.editTeacher = async function(id) {
            try { // CRITICAL: Added try...catch for stability
                let user = allUsersCache.find(u => u.id === id);
                if (user) {
                    populateUserForm(user, 'teacher');
                    window.location.hash = 'teachers';
                } else {
                    alert('Could not find user data. Refreshing...');
                    await fetchAllUsers();
                    user = allUsersCache.find(u => u.id === id);
                    if (user) populateUserForm(user, 'teacher');
                }
            } catch (error) {
                 console.error('Error during editTeacher:', error);
                 alert('A critical error occurred during edit.');
            }
        };
        window.editParent = async function(id) {
            try { // CRITICAL: Added try...catch for stability
                let user = allUsersCache.find(u => u.id === id);
                if (user) {
                    populateUserForm(user, 'parent');
                    window.location.hash = 'parents';
                } else {
                    alert('Could not find user data. Refreshing...');
                    await fetchAllUsers();
                    user = allUsersCache.find(u => u.id === id);
                    if (user) populateUserForm(user, 'parent');
                }
            } catch (error) {
                 console.error('Error during editParent:', error);
                 alert('A critical error occurred during edit.');
            }
        };

        window.deleteTeacher = async function(id) {
            if (!id) return alert('Invalid Teacher ID.');
            if (confirm(`Are you sure you want to delete Teacher ID ${id}?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${id}`, { method: 'DELETE', credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert(`Teacher deleted: ${result.message}`);
                        await fetchAllUsers(); 
                        fetchTeachers(); 
                    } else {
                        alert(`Delete failed: ${result.message || 'Server error'}`);
                        console.error('Delete User Failed:', result);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Network error during deletion.');
                }
            }
        };

        window.deleteStudent = async function(id) {
            if (!id) return alert('Invalid Student ID.');
            if (confirm(`Are you sure you want to delete Student ID ${id}?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${id}`, { method: 'DELETE', credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert(`Student deleted: ${result.message}`);
                        await fetchAllUsers(); 
                        fetchStudents(); 
                    } else {
                        alert(`Delete failed: ${result.message || 'Server error'}`);
                        console.error('Delete User Failed:', result);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Network error during deletion.');
                }
            }
        };

        window.deleteParent = async function(id) {
            if (!id) return alert('Invalid Parent ID.');
            if (confirm(`Are you sure you want to delete Parent ID ${id}?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${id}`, { method: 'DELETE', credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert(`Parent deleted: ${result.message}`);
                        await fetchAllUsers(); 
                        fetchParents(); 
                    } else {
                        alert(`Delete failed: ${result.message || 'Server error'}`);
                        console.error('Delete User Failed:', result);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Network error during deletion.');
                }
            }
        };


        // --- COURSE MANAGEMENT ---

        function resetCourseForm(course = null) {
            document.getElementById('course-id').value = course ? course.id : '';
            document.getElementById('course-name').value = course ? course.name : '';
            document.getElementById('course-subjects').value = course && course.subjects ? course.subjects.join(', ') : '';
            document.getElementById('course-teacher').value = course ? course.teacher_id : '';
            document.getElementById('save-course-btn').textContent = course ? 'Update Course' : 'Save Course';
            document.querySelector('#content-courses h3').textContent = course ? 'Edit Existing Course' : 'Add New Course';
        }

        courseForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const courseId = document.getElementById('course-id').value;
            const method = courseId ? 'PUT' : 'POST';
            const endpoint = `${API_BASE_URL}/courses`;

            const courseData = { 
                id: courseId || undefined,
                name: document.getElementById('course-name').value, 
                subjects: document.getElementById('course-subjects').value, // Sent as comma-separated string
                teacher_id: courseTeacherSelect.value ? parseInt(courseTeacherSelect.value) : null 
            };
            
            try {
                // MUST SEND JSON for Course management
                const response = await fetch(endpoint, { 
                    method: method, 
                    headers: {'Content-Type': 'application/json'}, 
                    credentials: 'include', 
                    body: JSON.stringify(courseData) 
                });
                const result = await response.json();

                if (response.ok) {
                    alert(`Course ${method === 'POST' ? 'added' : 'updated'} successfully!`);
                    resetCourseForm();
                    fetchCourses();
                    fetchCoursesForEnrollment(); 
                } else {
                    alert(`Save failed: ${result.message || 'An unknown error occurred.'}`);
                    console.error("Course Save Error:", result.message);
                }
            } catch (error) {
                alert(`Network error saving course: ${error.message}`);
                console.error('Error saving course:', error);
            }
        });
        
        window.editCourse = async function(id) {
            if (!id) return alert('Invalid Course ID.');
            try { // CRITICAL: Added try...catch for stability
                const course = allCoursesCache.find(c => c.id == id);
                if (course) {
                    resetCourseForm(course);
                    window.location.hash = 'courses'; 
                } else {
                    alert('Course not found in cache. Refreshing...');
                    await fetchCourses();
                    window.location.hash = 'courses';
                }
            } catch (error) {
                console.error('Error during editCourse:', error);
                alert('A critical error occurred during edit.');
            }
        }

        window.deleteCourse = async function(id) {
            if (!id) return alert('Invalid Course ID.');
            if (confirm('Are you sure you want to delete this course?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/courses/${id}`, { method: 'DELETE', credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Course deleted successfully!');
                        fetchCourses();
                        fetchCoursesForEnrollment(); 
                    } else {
                        alert(`Delete failed: ${result.message || 'An unknown error occurred.'}`);
                        console.error('Delete Course Failed:', result);
                    }
                } catch (error) {
                    alert(`Network error deleting course.`);
                    console.error('Error deleting course:', error);
                }
            }
        }


        // --- ACADEMIC SESSIONS ---

        function resetSessionForm(session = null) {
            const sessionForm = document.getElementById('session-form');
            if (sessionForm) sessionForm.reset();
            
            document.getElementById('session-id').value = session ? session.id : '';
            document.getElementById('session-name').value = session ? session.name : '';
            document.getElementById('session-start-date').value = session ? session.start_date : '';
            document.getElementById('session-end-date').value = session ? session.end_date : '';
            document.getElementById('session-status').value = session ? session.status : 'Active';
            document.getElementById('save-session-btn').textContent = session ? 'Update Session' : 'Save Session';
            document.querySelector('#content-sessions h3').textContent = session ? 'Edit Existing Academic Session' : 'Add New Session';
        }

        sessionForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const sessionId = document.getElementById('session-id').value;
            const method = sessionId ? 'PUT' : 'POST';
            const endpoint = `${API_BASE_URL}/sessions`;
            
            const sessionData = { 
                id: sessionId || undefined,
                name: document.getElementById('session-name').value, 
                start_date: document.getElementById('session-start-date').value,
                end_date: document.getElementById('session-end-date').value,
                status: document.getElementById('session-status').value
            };
            
            try {
                // MUST SEND JSON for Session management
                const response = await fetch(endpoint, { 
                    method: method, 
                    headers: {'Content-Type': 'application/json'}, 
                    credentials: 'include', 
                    body: JSON.stringify(sessionData) 
                });
                const result = await response.json();

                if (response.ok) {
                    alert(`Academic session ${method === 'POST' ? 'added' : 'updated'} successfully!`);
                    resetSessionForm();
                    fetchSessions();
                    fetchFeeSessionDropdowns();
                } else {
                    alert(`Save failed: ${result.message || 'An unknown error occurred.'}`);
                    console.error("Session Save Error:", result.message);
                }
            } catch (error) {
                alert(`Network error saving session: ${error.message}`);
                console.error('Error saving session:', error);
            }
        });
        
        window.editSession = async function(id) {
            if (!id) return alert('Invalid Session ID.');
            try { // CRITICAL: Added try...catch for stability
                const session = allSessionsCache.find(s => s.id == id);
                if (session) {
                    // FIX: Check if date values are valid before populating form
                    if (session.start_date && session.end_date) {
                        resetSessionForm(session);
                        window.location.hash = 'sessions'; 
                    } else {
                        alert("Session dates are invalid in the database. Cannot edit.");
                    }
                } else {
                    alert('Session not found in cache. Refreshing...');
                    await fetchSessions();
                    window.location.hash = 'sessions';
                }
            } catch (error) {
                console.error('Error during editSession:', error);
                alert('A critical error occurred during edit.');
            }
        }

        window.deleteSession = async function(id) {
            if (!id) return alert('Invalid Session ID.');
            if (confirm('Are you sure you want to delete this academic session?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/sessions/${id}`, { method: 'DELETE', credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Academic session deleted successfully!');
                        fetchSessions();
                        fetchFeeSessionDropdowns();
                    } else {
                        alert(`Delete failed: ${result.message || 'An unknown error occurred.'}`);
                        console.error('Delete Session Failed:', result);
                    }
                } catch (error) {
                    alert(`Network error deleting session.`);
                    console.error('Error deleting session:', error);
                }
            }
        }


        // --- ANNOUNCEMENT LOGIC ---
        
async function fetchAnnouncements(isManagementPage) {
    try {
        const response = await fetch(`${API_BASE_URL}/announcements`, { credentials: 'include' });
        const announcements = await response.json();

        // FIX 1: Determine which table to update based on the page
        // If isManagementPage is true, we look for the NEW ID we created above.
        // If false, we look for the Dashboard table ID.
        const targetId = isManagementPage ? 'management-announcements-body' : 'recent-announcements-body';
        const tableBody = document.getElementById(targetId);

        if (!tableBody) return; // Stop if table doesn't exist on this view

        tableBody.innerHTML = '';

        // FIX 2: Decide which data to show
        // Dashboard = Last 5 announcements only (Read only)
        // Management Page = All announcements (Editable)
        const dashboardAnnouncements = announcements.filter(a => a.target_group === 'all' || a.target_group === 'admin').slice(0, 5);
        const announcementsToShow = isManagementPage ? announcements : dashboardAnnouncements;

        if (announcementsToShow.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center">No announcements found.</td></tr>`;
            return;
        }

        announcementsToShow.forEach((announcement) => {
            // Shorten content for the table view
            const contentDisplay = isManagementPage 
                ? announcement.content 
                : announcement.content.substring(0, 50) + (announcement.content.length > 50 ? '...' : '');

            // FIX 3: Add the Delete Button HTML ONLY if we are on the management page
            const actionsHtml = isManagementPage ? `
                <button onclick="deleteAnnouncement(${announcement.id})" class="text-red-600 hover:text-red-900 font-bold border border-red-200 bg-red-50 px-3 py-1 rounded hover:bg-red-100 transition">
                    Delete
                </button>
            ` : '';

            const dateStr = announcement.created_at ? announcement.created_at.split(' ')[0] : 'N/A';

            const row = `
                <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${announcement.title}</td>
                    <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400 max-w-xs truncate">${contentDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${announcement.target_group.charAt(0).toUpperCase() + announcement.target_group.slice(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${dateStr}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${actionsHtml}</td>
                </tr>`;

            tableBody.innerHTML += row;
        });
    } catch (error) {
        console.error("Error fetching announcements:", error);
        // Fallback error message (tries to find the management body first)
        const errTable = document.getElementById('management-announcements-body') || document.getElementById('recent-announcements-body');
        if (errTable) errTable.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
    }
}
        
       window.deleteAnnouncement = async function(id) {
    if (confirm('Are you sure you want to delete this announcement?')) {
        try {
            const response = await fetch(`${API_BASE_URL}/announcements/${id}`, { method: 'DELETE', credentials: 'include' });
            if (response.ok) {
                alert('Announcement deleted successfully!');
                fetchAnnouncements(true); // Refresh the management table
            } else {
                const error = await response.json();
                alert(`Delete failed: ${error.message || 'An unknown error occurred.'}`);
            }
        } catch (error) {
            alert(`An error occurred: ${error.message}`);
        }
    }
}

        announcementForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const announcementData = { 
                title: document.getElementById('announcement-title').value, 
                content: document.getElementById('announcement-content').value,
                target_group: document.getElementById('announcement-target-group').value
            };
            try {
                const response = await fetch(API_BASE_URL + '/announcements', { method: 'POST', headers: {'Content-Type': 'application/json'}, credentials: 'include', body: JSON.stringify(announcementData) });
                const result = await response.json();

                if (response.ok) {
                    announcementForm.reset();
                    alert('Announcement published successfully!');
                    fetchAnnouncements(true);
                    fetchDashboardSummary(); // Refresh dashboard announcements
                } else {
                    alert(`Save failed: ${result.message || 'An unknown error occurred.'}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
                console.error('Error saving announcement:', error);
            }
        });


        // --- FEE & REPORT LOGIC ---

        async function fetchFeeSessionDropdowns() {
            try {
                // Uses cached sessions
                const feeSessionSelect = document.getElementById('fee-session-select');
                feeSessionSelect.innerHTML = '<option value="">Select a session...</option>';
                allSessionsCache.forEach(session => { feeSessionSelect.innerHTML += `<option value="${session.id}">${session.name}</option>`; });
            } catch (error) {
                 console.error("Error fetching sessions for fee dropdown:", error);
                 document.getElementById('fee-session-select').innerHTML = '<option value="">Error loading sessions</option>';
            }
        }
        
        async function fetchFeeStructures() {
            try {
                const response = await fetch(`${API_BASE_URL}/fee_structures`, {credentials: 'include'});
                const structures = await response.json();
                const tableBody = document.getElementById('fee-structure-table-body');
                const paymentFeeStructureSelect = document.getElementById('payment-fee-structure-select');
                
                tableBody.innerHTML = '';

                if (structures.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No fee structures found.</td></tr>`;
                    paymentFeeStructureSelect.innerHTML = '<option value="">No fee structures available</option>';
                    return;
                }

                paymentFeeStructureSelect.innerHTML = '<option value="">Select a fee structure...</option>';
                structures.forEach(s => {
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${s.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${s.total_amount.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${s.due_date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editFeeStructure(${s.id})" class="text-primary hover:text-blue-700 mr-2">Edit</button>
                                <button onclick="deleteFeeStructure(${s.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>`;
                    paymentFeeStructureSelect.innerHTML += `<option value="${s.id}">${s.name} (Due: ${s.due_date})</option>`;
                });
            } catch (error) {
                console.error("Error fetching fee structures:", error);
                document.getElementById('fee-structure-table-body').innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }

        // --- NEW: Fee structure delete/edit handlers ---
        function resetFeeStructureForm(structure = null) {
             const feeStructureForm = document.getElementById('fee-structure-form');
             if (feeStructureForm) feeStructureForm.reset();
             
             document.getElementById('fee-structure-id').value = structure ? structure.id : '';
             document.getElementById('save-fee-structure-btn').textContent = structure ? 'Update Fee Structure' : 'Save Fee Structure';
             
             if (structure) {
                 document.getElementById('fee-structure-name').value = structure.name;
                 document.getElementById('fee-session-select').value = structure.academic_session_id;
                 document.getElementById('fee-total-amount').value = structure.total_amount;
                 document.getElementById('fee-due-date').value = structure.due_date;
             }
         }

        window.editFeeStructure = async function(id) {
            if (!id) return alert('Invalid Fee Structure ID.');
            try {
                const response = await fetch(`${API_BASE_URL}/fee_structures`, { credentials: 'include' });
                const structures = await response.json();
                const structure = structures.find(s => s.id == id);
                if (structure) {
                    resetFeeStructureForm(structure);
                    window.location.hash = 'fees'; 
                }
            } catch (error) {
                console.error('Error fetching fee structure for edit:', error);
                alert('Failed to load fee structure details for edit.');
            }
        }
        
        window.deleteFeeStructure = async function(id) {
            if (!id) return alert('Invalid Fee Structure ID.');
            if (confirm('Are you sure you want to delete this fee structure?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/fee_structures/${id}`, { method: 'DELETE', credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Fee structure deleted successfully!');
                        fetchFeeStructures();
                        fetchFeeStatus();
                    } else {
                        alert(`Delete failed: ${result.message || 'An unknown error occurred.'}`);
                        console.error('Delete Fee Structure Failed:', result);
                    }
                } catch (error) {
                    alert(`Network error deleting fee structure.`);
                    console.error('Error deleting fee structure:', error);
                }
            }
        }
        // --- End Fee Structure Handlers ---


        async function fetchFeeStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/fee_status`, {credentials: 'include'});
                const statusList = await response.json();
                const tableBody = document.getElementById('fee-status-table-body');
                tableBody.innerHTML = '';

                if (statusList.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center">No student fee status found.</td></tr>`;
                    return;
                }

                statusList.forEach(status => {
                    const isOverdue = status.pending_days < 0;
                    const isPaid = status.balance <= 0;
                    const balanceClass = isPaid ? 'paid' : (isOverdue ? 'overdue' : 'pending');
                    const balanceText = status.balance.toFixed(2);
                    
                    let dueText;
                    if (isPaid) {
                        dueText = 'PAID';
                    } else if (isOverdue) {
                        dueText = `${Math.abs(status.pending_days)} Days OVERDUE`;
                    } else {
                        dueText = `${status.pending_days} Days Left`;
                    }

                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${status.student_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${balanceClass}">${balanceText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-600' : 'text-slate-500'}">${dueText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button onclick="sendFeeAlert(${status.student_id})" class="text-amber-500 hover:text-amber-700 disabled:text-slate-400" ${status.balance > 0 ? '' : 'disabled'}>
                                    <span class="material-symbols-outlined align-middle text-lg">sms</span>
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="printReceipt(${status.latest_payment_id})" class="text-primary hover:text-blue-700 disabled:text-slate-400" ${status.latest_payment_id ? '' : 'disabled'}>
                                    <span class="material-symbols-outlined align-middle text-lg">print</span>
                                </button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Error fetching fee status:", error);
                document.getElementById('fee-status-table-body').innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }
        
        async function fetchFeePendingReport() {
            const feePendingReportBody = document.getElementById('fee-pending-report-body');
            if (!feePendingReportBody) return; 

            feePendingReportBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center">Loading pending fees...</td></tr>`;
            try {
                const response = await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials: 'include'});
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.message || `Server error: ${response.status}`);
                }
                const pendingList = await response.json();

                feePendingReportBody.innerHTML = ''; 

                if (pendingList.length === 0) {
                    feePendingReportBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center">No students with pending fees found.</td></tr>`;
                    return;
                }

                pendingList.forEach(status => {
                    const isOverdue = status.pending_days < 0;
                    const balanceClass = isOverdue ? 'overdue' : 'pending';
                    const balanceText = status.balance.toFixed(2);
                    const isPhoneAvailable = !!status.phone_number;
                    
                    let dueText;
                    if (isOverdue) {
                        dueText = `${Math.abs(status.pending_days)} Days OVERDUE`;
                    } else {
                        dueText = `${status.pending_days} Days Left`;
                    }

                    feePendingReportBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${status.student_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${balanceClass}">${balanceText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${status.due_date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-600' : 'text-slate-500'}">${dueText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <button onclick="sendFeeReminderSms(${status.student_id}, '${status.student_name}', ${status.balance}, '${status.due_date}')" class="text-yellow-600 hover:text-yellow-700 disabled:text-slate-400" ${isPhoneAvailable ? '' : 'disabled'} title="Send Fee Reminder SMS">
                                    <span class="material-symbols-outlined align-middle text-lg">sms</span>
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <button onclick="sendFeeReminderWhatsapp(${status.student_id}, '${status.student_name}', ${status.balance}, '${status.due_date}')" class="text-green-600 hover:text-green-700 disabled:text-slate-400" ${isPhoneAvailable ? '' : 'disabled'} title="Send Fee Reminder WhatsApp">
                                    <span class="material-symbols-outlined align-middle text-lg">call</span>
                                </button>
                            </td>
                        </tr>`;
                });

            } catch (error) {
                console.error("Error fetching fee pending report:", error);
                feePendingReportBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading report data: ${error.message}</td></tr>`;
            }
        }
        
        window.sendFeeReminderSms = async function(studentId, studentName, balance, dueDate) {
            if (confirm(`Send SMS fee reminder to ${studentName}?`)) {
                try { // CRITICAL: Added try...catch for stability
                    const response = await fetch(`${API_BASE_URL}/send_sms_alert`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({ student_id: studentId })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                    } else {
                        alert(`Failed: ${result.message}`);
                    }
                } catch(error) {
                    console.error('SMS Alert Error:', error);
                    alert('Failed to send alert due to a server error.');
                }
            }
        }

        window.sendFeeReminderWhatsapp = function(studentId, studentName, balance, dueDate) {
            const subject = "Fee Reminder";
            const body = `Dear ${studentName}, your fee payment of INR ${balance.toFixed(2)} is pending. The due date is ${dueDate}. Please pay soon.`;
             if (confirm(`Send WhatsApp fee reminder to ${studentName}? (Mock)`)) {
                 // CRITICAL: Ensure sendQuickNotification function exists or use a mock logic.
                alert(`[MOCK] WhatsApp sent to ${studentName}: ${body}`);
            }
        }
        
        window.sendFeeAlert = async function(studentId) {
            if (confirm('Send fee pending alert via SMS? (Uses configured API)')) {
                try { // CRITICAL: Added try...catch for stability
                    const response = await fetch(`${API_BASE_URL}/send_sms_alert`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({ student_id: studentId })
                    });
                    const result = await response.json();
                    alert(result.message);
                } catch(error) {
                    console.error('SMS Alert Error:', error);
                    alert('Failed to send alert due to a server error.');
                }
            }
        }
        
        window.printReceipt = function(paymentId) {
            if (paymentId && paymentId !== 'N/A' && paymentId !== 'null' && paymentId !== null) {
                window.open(`${API_BASE_URL}/receipt/${paymentId}`, '_blank', 'width=700,height=600');
            } else {
                alert('No recent payment ID available to print.');
            }
        }

        feeStructureForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const feeId = document.getElementById('fee-structure-id').value;
            const method = feeId ? 'PUT' : 'POST';
            const endpoint = `${API_BASE_URL}/fee_structures`;

            const feeData = { 
                id: feeId || undefined,
                name: document.getElementById('fee-structure-name').value, 
                academic_session_id: parseInt(document.getElementById('fee-session-select').value),
                total_amount: parseFloat(document.getElementById('fee-total-amount').value),
                due_date: document.getElementById('fee-due-date').value
            };
            
            try {
                const response = await fetch(endpoint, { 
                    method: method, 
                    headers: {'Content-Type': 'application/json'}, 
                    credentials: 'include', 
                    body: JSON.stringify(feeData) 
                });
                const result = await response.json();

                if (response.ok) {
                    alert(`Fee structure ${method === 'POST' ? 'added' : 'updated'} successfully!`);
                    resetFeeStructureForm(null);
                    fetchFeeStructures();
                    fetchFeeStatus();
                } else {
                    alert(`Save failed: ${result.message || 'An unknown error occurred.'}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
                console.error('Error saving fee structure:', error);
            }
        });

        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const paymentData = {
                student_id: parseInt(document.getElementById('payment-student-select').value),
                fee_structure_id: parseInt(document.getElementById('payment-fee-structure-select').value),
                amount_paid: parseFloat(document.getElementById('payment-amount').value),
                payment_method: document.getElementById('payment-method').value
            };
            try {
                const response = await fetch(API_BASE_URL + '/payments', { method: 'POST', headers: {'Content-Type': 'application/json'}, credentials: 'include', body: JSON.stringify(paymentData) });
                const result = await response.json();

                if (response.ok) {
                    paymentForm.reset();
                    alert(result.message);
                    fetchFeeStatus(); // Refresh status table
                    fetchFeePendingReport(); // Refresh pending report table
                    
                    const paymentId = result.payment_id;
                    if (paymentId) {
                        window.open(`${API_BASE_URL}/receipt/${paymentId}`, '_blank', 'width=700,height=600');
                    }

                } else {
                    alert(`Record failed: ${result.message || 'An unknown error occurred.'}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
                console.error('Error recording payment:', error);
            }
        });
        
        // --- End Fee Fetch/Save Logic ---


        // --- USER MANAGEMENT FETCHING FUNCTIONS (Fixes the Data Loading Error) ---

        async function fetchTeachers() {
            const tableBody = document.getElementById('teacher-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">Loading teachers...</td></tr>';

            try {
                const users = await fetchAllUsers(); 
                const teachers = users.filter(u => u.role === 'teacher');
                
                tableBody.innerHTML = '';
                if (teachers.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No teachers found.</td></tr>`;
                    return;
                }

                teachers.forEach(teacher => {
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${teacher.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${teacher.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${teacher.phone_number || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editTeacher(${teacher.id})" class="text-primary hover:text-blue-700 mr-2">Edit</button>
                                <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Error fetching teachers:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }
        
        async function fetchStudents(searchTerm = '') {
            const tableBody = document.getElementById('student-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center">Loading students...</td></tr>';
            
            try {
                const users = await fetchAllUsers(searchTerm); 
                const students = users.filter(u => u.role === 'student');
                
                tableBody.innerHTML = '';
                if (students.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center">${searchTerm ? 'No students match your search.' : 'No students found.'}</td></tr>`;
                    return;
                }
                
                const parents = users.filter(u => u.role === 'parent');
                const parentMap = new Map(parents.map(p => [p.id, p.name]));
                
                students.forEach(student => {
                    const parentName = parentMap.get(student.parent_id) || 'Unlinked';
                    const isPhoneAvailable = !!student.phone_number;
                    
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${student.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${student.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${parentName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${student.phone_number || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <button onclick="sendQuickSms(${student.id}, '${student.name}')" class="text-yellow-600 hover:text-yellow-700 disabled:text-slate-400" ${isPhoneAvailable ? '' : 'disabled'}>SMS</button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <button onclick="sendQuickWhatsapp(${student.id}, '${student.name}')" class="text-green-600 hover:text-green-700 disabled:text-slate-400" ${isPhoneAvailable ? '' : 'disabled'}>WA</button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editStudent(${student.id})" class="text-primary hover:text-blue-700 mr-2">Edit</button>
                                <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Error fetching students:", error);
                tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }
        
        // --- Student Search Event Listener (Add this if missing) ---
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    fetchStudents(searchInput.value.trim());
                }, 300); // Debounce search
            });
        }
        
        async function fetchParents() {
            const tableBody = document.getElementById('parent-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">Loading parents...</td></tr>';

            try {
                const users = await fetchAllUsers(); 
                const parents = users.filter(u => u.role === 'parent');
                
                tableBody.innerHTML = '';
                if (parents.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No parents found.</td></tr>`;
                    return;
                }

                parents.forEach(parent => {
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${parent.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${parent.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${parent.phone_number || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editParent(${parent.id})" class="text-primary hover:text-blue-700 mr-2">Edit</button>
                                <button onclick="deleteParent(${parent.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Error fetching parents:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }
        
        // --- Mock Functions for Students/Reports (Crucial to prevent crash) ---
        window.sendQuickSms = function(id, name) {
            alert(`[MOCK] SMS alert to ${name} (ID: ${id}) triggered.`);
            console.log(`MOCK SMS alert to student ID ${id}`);
        };
        window.sendQuickWhatsapp = function(id, name) {
            alert(`[MOCK] WhatsApp alert to ${name} (ID: ${id}) triggered.`);
            console.log(`MOCK WA alert to student ID ${id}`);
        };


        // --- REPORT & DROPDOWN FUNCTIONS (Cont.) ---
        
        // Used to populate the parent dropdown in the student form
        async function populateParentDropdowns() {
            try {
                const response = await fetch(`${API_BASE_URL}/parents`, {credentials: 'include'});
                const parents = await response.json();
                const selectElement = document.getElementById('student-parent-select');
                
                if (!selectElement) {
                     console.warn("Element 'student-parent-select' not found.");
                     return;
                }

                selectElement.innerHTML = '<option value="">(None)</option>';
                parents.forEach(p => { 
                    selectElement.innerHTML += `<option value="${p.id}">${p.name} (${p.email})</option>`; 
                });
            } catch (error) {
                console.error("Error fetching parents for dropdown:", error);
                const selectElement = document.getElementById('student-parent-select');
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">Error loading parents</option>';
                }
            }
        }

        async function fetchStudentsForPaymentDropdown() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {credentials: 'include'});
                const users = await response.json();
                const students = users.filter(u => u.role === 'student');
                const selectElement = document.getElementById('payment-student-select');
                selectElement.innerHTML = '<option value="">Select a student...</option>';
                students.forEach(s => { selectElement.innerHTML += `<option value="${s.id}">${s.name} (${s.email})</option>`; });
            } catch (error) {
                 console.error("Error fetching students for payment dropdown:", error);
                 const selectElement = document.getElementById('payment-student-select');
                 if(selectElement) selectElement.innerHTML = '<option value="">Error loading students</option>';
            }
        }

        async function fetchCoursesForEnrollment() {
             try {
                // Use cached courses
                const courses = allCoursesCache; 
                const selectElement = document.getElementById('student-course-select');
                selectElement.innerHTML = '<option value="">Select Course</option>';
                courses.forEach(c => {
                    selectElement.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });
            } catch (error) {
                console.error("Error fetching courses for enrollment dropdown:", error);
                const selectElement = document.getElementById('student-course-select');
                if(selectElement) selectElement.innerHTML = `<option value="">Error loading courses</option><option value="">(Check if courses are registered)</option>`;
            }
        }
        
        // This function is used to populate the dropdown in the course management tab
        async function fetchTeachersForCourseDropdown() {
             try {
                // Use cached teachers (filter allUsersCache)
                const teachers = allUsersCache.filter(u => u.role === 'teacher'); 
                const selectElement = document.getElementById('course-teacher');
                selectElement.innerHTML = '<option value="">Select a teacher...</option>';
                teachers.forEach(teacher => { selectElement.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`; });
            } catch (error) {
                console.error("Error fetching teachers for course dropdown:", error);
                const selectElement = document.getElementById('course-teacher');
                if(selectElement) selectElement.innerHTML = '<option value="">Error loading teachers</option>';
            }
        }
        
        async function fetchCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/courses`, {credentials: 'include'});
                const courses = await response.json();
                allCoursesCache = courses; // Update cache
                const tableBody = document.getElementById('course-table-body');
                
                tableBody.innerHTML = '';
                if (courses.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No courses found.</td></tr>`;
                     return;
                }

                courses.forEach(course => {
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${course.name}</td>
                            <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400 max-w-xs truncate">${course.subjects.join(', ')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${course.teacher_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editCourse(${course.id})" class="text-primary hover:text-blue-700 mr-2">Edit</button>
                                <button onclick="deleteCourse(${course.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>`;
                });
            } catch(error) {
                 console.error('Error fetching courses:', error);
                 document.getElementById('course-table-body').innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }

        async function fetchSessions() {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions`, {credentials: 'include'});
                const sessions = await response.json();
                allSessionsCache = sessions; // Update cache
                const tableBody = document.getElementById('session-table-body');
                
                tableBody.innerHTML = '';
                if (sessions.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center">No academic sessions found.</td></tr>`;
                     return;
                }

                sessions.forEach(session => {
                    const statusClass = session.status === 'Active' ? 'text-green-600' : 'text-red-600';
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${session.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${session.start_date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${session.end_date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusClass}">${session.status}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editSession(${session.id})" class="text-primary hover:text-blue-700 mr-2">Edit</button>
                                <button onclick="deleteSession(${session.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>`;
                });
            } catch(error) {
                 console.error('Error fetching sessions:', error);
                 document.getElementById('session-table-body').innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }

        function fetchAdmissionsReport() {
            try {
                const reportBody = document.getElementById('admissions-report-body');
                fetch(`${API_BASE_URL}/reports/admissions`, {credentials: 'include'})
                    .then(res => res.json())
                    .then(admissions => {
                        reportBody.innerHTML = '';
                        if (admissions.length === 0) {
                            reportBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center">No new admissions in the last 30 days.</td></tr>`;
                            return;
                        }
                        admissions.forEach(admission => {
                            reportBody.innerHTML += `
                                <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${admission.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${admission.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${admission.created_at}</td>
                                </tr>`;
                        });
                    }).catch(error => { throw error; });
            } catch (error) {
                console.error("Error fetching admissions report:", error);
                document.getElementById('admissions-report-body').innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }

        function fetchAttendanceReport() {
            try {
                const reportBody = document.getElementById('attendance-report-body');
                fetch(`${API_BASE_URL}/reports/attendance`, {credentials: 'include'})
                    .then(res => res.json())
                    .then(report => {
                        reportBody.innerHTML = '';
                        if (report.length === 0) {
                            reportBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center">No attendance data available.</td></tr>`;
                            return;
                        }
                        report.forEach(data => {
                            const percentClass = data.percentage < 75 ? 'text-red-600 font-bold' : 'text-green-600 font-bold';
                            reportBody.innerHTML += `
                                <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${data.student_name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${data.total_classes}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 dark:text-green-400">${data.present}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 dark:text-red-400">${data.absent}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${percentClass}">${data.percentage}%</td>
                                </tr>`;
                        });
                    }).catch(error => { throw error; });
            } catch (error) {
                console.error("Error fetching attendance report:", error);
                document.getElementById('attendance-report-body').innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }

        function fetchPerformanceReport() {
            try {
                const reportBody = document.getElementById('performance-report-body');
                fetch(`${API_BASE_URL}/reports/performance`, {credentials: 'include'})
                    .then(res => res.json())
                    .then(report => {
                        reportBody.innerHTML = '';
                        if (report.length === 0) {
                            reportBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No performance data available.</td></tr>`;
                            return;
                        }
                        report.forEach(data => {
                            reportBody.innerHTML += `
                                <tr class="even:bg-slate-500/5 dark:even:bg-slate-800/50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${data.student_name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${data.assessments_taken}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${data.total_score}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${data.overall_percentage}%</td>
                                </tr>`;
                        });
                    }).catch(error => { throw error; });
            } catch (error) {
                console.error("Error fetching performance report:", error);
                document.getElementById('performance-report-body').innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        }


        // --- FINAL INITIALIZATION CALLS ---
        
        try {
            checkAdminSession();
            // loadContentByHash() is called immediately after checkAdminSession completes successfully (via promise chain or redirect)
            // Initial call to set up the dashboard state
            loadContentByHash();

        } catch(globalError) {
            console.error("Critical Global Script Error:", globalError);
            alert("A critical error occurred during page initialization. Please refresh or contact support.");
        }
    });
</script>
</body>
</html>
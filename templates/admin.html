<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institute Admin Portal</title>
    <script src="{{ url_for('static', filename='tailwind.js') }}"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#2563eb", "primary-dark": "#1e40af", "background-light": "#f8fafc" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Sidebar Link Styling */
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; 
            border-radius: 8px; color: #475569; font-weight: 500; transition: all 0.2s; 
            width: 100%; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background-color: #eff6ff; color: #2563eb; }
        
        /* Notepad-style Submenu Animation */
        .submenu { 
            transition: max-height 0.3s ease-out; overflow: hidden; 
            max-height: 0; background: #f8fafc; border-radius: 8px; margin-left: 12px; 
        }
        .submenu.open { max-height: 500px; padding: 4px 0; border: 1px solid #e2e8f0; }
        .submenu-link { 
            padding: 10px 16px 10px 40px; display: flex; align-items: center; 
            gap: 8px; font-size: 0.9rem; color: #64748b; border-radius: 6px; 
        }
        .submenu-link:hover { color: #2563eb; background: #fff; }

        /* Modern Form Styling - Big & Clear */
        input, select, textarea { 
            width: 100%; padding: 14px 16px; border: 1px solid #cbd5e1; 
            border-radius: 8px; background-color: #fff; font-size: 1rem; margin-top: 4px;
        }
        input:focus, select:focus { border-color: #2563eb; outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        label { font-weight: 600; color: #475569; font-size: 0.85rem; text-transform: uppercase; }

        /* Action Buttons - Spaced Out */
        .btn-edit { 
            color: #2563eb; font-weight: 700; border: 1px solid #dbeafe; 
            background: #eff6ff; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem;
        }
        .btn-edit:hover { background: #dbeafe; }
        .btn-delete { 
            color: #dc2626; font-weight: 700; border: 1px solid #fee2e2; 
            background: #fef2f2; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem;
        }
        .btn-delete:hover { background: #fee2e2; }

        .form-card { background: white; padding: 32px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); margin-bottom: 24px; }
        .section-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }

        @media print { aside, .no-print, button { display: none !important; } main { padding: 0; } }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl">
        <div class="p-6 border-b">
            <h1 class="text-2xl font-black text-slate-900 tracking-tight flex items-center gap-2">
                <span class="material-symbols-outlined text-primary" style="font-size: 32px;">school</span> Institute Admin
            </h1>
        </div>
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <a href="#dashboard" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">dashboard</span> Dashboard</a>
            
            <div class="space-y-1">
                <button onclick="toggleMenu('std')" class="nav-link w-full justify-between" id="nav-students">
                    <div class="flex items-center gap-3"><span class="material-symbols-outlined">group</span> Students</div>
                    <span id="std-arrow" class="material-symbols-outlined transition-transform">expand_more</span>
                </button>
                <div id="std-submenu" class="submenu">
                    <a href="#students-add" onclick="switchSubView('students', 'add')" class="submenu-link"><span class="material-symbols-outlined text-sm">person_add</span> Register New</a>
                    <a href="#students-list" onclick="switchSubView('students', 'list')" class="submenu-link"><span class="material-symbols-outlined text-sm">manage_accounts</span> View / Edit / Delete</a>
                    <a href="#students-reports" onclick="switchSubView('students', 'reports')" class="submenu-link"><span class="material-symbols-outlined text-sm">analytics</span> Reports & Fees</a>
                </div>
            </div>

            <a href="#teachers" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">person_apron</span> Teachers</a>
            <a href="#parents" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">family_restroom</span> Parents</a>
            <a href="#courses" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">menu_book</span> Courses</a>
            <a href="#sessions" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">calendar_month</span> Sessions</a>
            
            <div class="space-y-1">
                <button onclick="toggleMenu('fee')" class="nav-link w-full justify-between" id="nav-fees">
                    <div class="flex items-center gap-3"><span class="material-symbols-outlined">payments</span> Fees</div>
                    <span id="fee-arrow" class="material-symbols-outlined">expand_more</span>
                </button>
                <div id="fee-submenu" class="submenu">
                    <a href="#fees-struct" onclick="switchSubView('fees', 'struct')" class="submenu-link">Fee Structures</a>
                    <a href="#fees-pay" onclick="switchSubView('fees', 'pay')" class="submenu-link">Record Payment</a>
                </div>
            </div>

            <a href="#announcements" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">campaign</span> Announcements</a>
            <a href="#bulk-upload" onclick="closeAllMenus()" class="nav-link"><span class="material-symbols-outlined">upload_file</span> Bulk Upload</a>
        </nav>
        <div class="p-4 border-t border-slate-100">
            <button onclick="handleLogout()" class="w-full bg-red-50 text-red-600 font-bold py-3 rounded-lg hover:bg-red-100 transition flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">logout</span> Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto bg-slate-50">
        <div class="max-w-7xl mx-auto">
            
            <div id="content-dashboard" class="content-section">
                <h2 class="text-3xl font-bold mb-8 text-slate-800">Welcome, Admin</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-slate-500 font-bold text-xs uppercase">Total Teachers</p>
                        <p id="total-teachers" class="text-4xl font-bold text-primary mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-slate-500 font-bold text-xs uppercase">Total Students</p>
                        <p id="total-students" class="text-4xl font-bold text-primary mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-slate-500 font-bold text-xs uppercase">Total Parents</p>
                        <p id="total-parents" class="text-4xl font-bold text-primary mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-slate-500 font-bold text-xs uppercase">Active Courses</p>
                        <p id="total-courses" class="text-4xl font-bold text-primary mt-2">0</p>
                    </div>
                </div>
            </div>

            <div id="content-students" class="content-section hidden">
                <div id="students-view-add" class="hidden">
                    <div class="form-card">
                        <div class="flex justify-between items-center mb-8 border-b pb-4">
                            <h3 id="student-form-title" class="text-2xl font-bold text-primary">Student Registration</h3>
                            <button onclick="resetUserForm('student')" class="text-slate-400 hover:text-primary">Clear Form</button>
                        </div>
                        <form id="student-form" class="space-y-6">
                            <input type="hidden" id="student-id" name="id"><input type="hidden" name="role" value="student">
                            <div class="grid grid-cols-2 gap-6 bg-slate-50 p-6 rounded-xl border">
                                <div><label>Session (Batch) *</label><select id="student-session-select" name="session_id" required></select></div>
                                <div><label>Enroll Course *</label><select id="student-course-select" name="course_ids" required></select></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><label>Full Name *</label><input type="text" id="student-name-input" name="name" required></div>
                                <div><label>Email *</label><input type="email" id="student-email-input" name="email" required></div>
                                <div><label>Phone Number</label><input type="tel" id="student-phone-input" name="phone_number"></div>
                                <div><label>Date of Birth</label><input type="date" id="student-dob-input" name="dob"></div>
                                <div><label>Gender</label><select id="student-gender-select" name="gender"><option>Male</option><option>Female</option></select></div>
                                <div><label>Password</label><input type="password" name="password" placeholder="Leave blank to keep"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div><label>Father's Name</label><input type="text" id="student-father-name-input" name="father_name"></div>
                                <div><label>Mother's Name</label><input type="text" id="student-mother-name-input" name="mother_name"></div>
                            </div>
                             <div class="flex items-center gap-6 p-4 bg-white border border-dashed rounded-xl">
                                <img id="student-photo-preview" src="https://placehold.co/100" class="w-20 h-20 rounded-full border shadow-sm">
                                <div class="flex-1"><label>Upload Photo</label><input type="file" id="student-photo-file-input" name="profile_photo_file" accept="image/*"></div>
                            </div>
                            <button type="submit" id="student-form-btn" class="w-full bg-primary text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-primary-dark">Save Student</button>
                        </form>
                    </div>
                </div>

                <div id="students-view-list" class="hidden">
                    <div class="bg-white p-6 rounded-xl border mb-6 flex gap-4">
                        <select id="filterSession" onchange="loadUsers()" class="w-1/3"><option value="">All Batches</option></select>
                        <input type="text" id="userSearch" onkeyup="loadUsers()" placeholder="Search Name..." class="flex-1">
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <table>
                            <thead><tr><th>ID</th><th>Student Name</th><th>Batch</th><th>Actions</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="students-view-reports" class="hidden">
                    <div class="form-card">
                        <h3 class="text-xl font-bold mb-6">Fee Status Report</h3>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <select id="report-course-filter" onchange="fetchFeePendingReport()"><option value="">All Courses</option></select>
                            <button onclick="sendBulkFeeReminder()" class="bg-red-600 text-white font-bold rounded-lg">Send Bulk SMS Reminder</button>
                        </div>
                        <table>
                            <thead><tr><th>Student</th><th>Pending Bal</th><th>Due Date</th><th>Action</th></tr></thead>
                            <tbody id="fee-pending-report-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-teachers" class="content-section hidden">
                <div class="form-card">
                    <h3 class="section-header text-primary">Teachers Management</h3>
                    <form id="teacher-form" class="grid grid-cols-2 gap-6">
                        <input type="hidden" id="teacher-id" name="id"><input type="hidden" name="role" value="teacher">
                        <div><label>Name</label><input type="text" id="teacher-name-input" name="name" required></div>
                        <div><label>Email</label><input type="email" id="teacher-email-input" name="email" required></div>
                        <div><label>Phone</label><input type="tel" id="teacher-phone-input" name="phone_number"></div>
                        <div><label>Password</label><input type="password" name="password"></div>
                        <div class="col-span-2"><button type="submit" id="teacher-form-btn" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Save Teacher</button></div>
                    </form>
                </div>
                <div class="bg-white rounded-xl border overflow-hidden"><table class="w-full"><tbody id="teacher-table-body"></tbody></table></div>
            </div>

            <div id="content-parents" class="content-section hidden">
                <div class="form-card">
                    <h3 class="section-header text-primary">Parents Management</h3>
                    <form id="parent-form" class="grid grid-cols-2 gap-6">
                        <input type="hidden" id="parent-id" name="id"><input type="hidden" name="role" value="parent">
                        <div><label>Name</label><input type="text" id="parent-name-input" name="name" required></div>
                        <div><label>Email</label><input type="email" id="parent-email-input" name="email" required></div>
                        <div><label>Phone</label><input type="tel" id="parent-phone-input" name="phone_number"></div>
                        <div><label>Password</label><input type="password" name="password"></div>
                        <div class="col-span-2"><button type="submit" id="parent-form-btn" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Save Parent</button></div>
                    </form>
                </div>
                <div class="bg-white rounded-xl border overflow-hidden"><table class="w-full"><tbody id="parent-table-body"></tbody></table></div>
            </div>

            <div id="content-courses" class="content-section hidden">
                <div class="form-card">
                    <h3 class="section-header text-primary">Courses</h3>
                    <form id="course-form" class="grid grid-cols-2 gap-6">
                        <input type="hidden" id="course-id" name="id">
                        <div><label>Course Name</label><input type="text" id="course-name" required></div>
                        <div><label>Subjects</label><input type="text" id="course-subjects" required></div>
                        <div class="col-span-2"><label>Assign Teacher</label><select id="course-teacher"></select></div>
                        <div class="col-span-2"><button type="submit" id="save-course-btn" class="bg-primary text-white w-full py-3 rounded-lg font-bold">Save Course</button></div>
                    </form>
                </div>
                <div class="bg-white rounded-xl border overflow-hidden"><table class="w-full"><tbody id="course-table-body"></tbody></table></div>
            </div>

            <div id="content-sessions" class="content-section hidden">
                <div class="form-card">
                    <h3 class="section-header text-primary">Sessions</h3>
                    <form id="session-form" class="grid grid-cols-2 gap-6">
                        <input type="hidden" id="session-id" name="id">
                        <div><label>Session Name</label><input type="text" id="session-name" required></div>
                        <div><label>Status</label><select id="session-status"><option>Active</option><option>Inactive</option></select></div>
                        <div><label>Start Date</label><input type="date" id="session-start-date" required></div>
                        <div><label>End Date</label><input type="date" id="session-end-date" required></div>
                        <div class="col-span-2"><button type="submit" id="save-session-btn" class="bg-primary text-white w-full py-3 rounded-lg font-bold">Save Session</button></div>
                    </form>
                </div>
                <div class="bg-white rounded-xl border overflow-hidden"><table class="w-full"><tbody id="session-table-body"></tbody></table></div>
            </div>

            <div id="content-fees" class="content-section hidden">
                <div id="fees-view-struct" class="hidden">
                    <div class="form-card">
                        <h3 class="section-header text-primary">Manage Fee Structures</h3>
                        <form id="fee-structure-form" class="grid grid-cols-2 gap-6">
                            <input type="hidden" id="fee-structure-id" name="id">
                            <div class="col-span-2"><label>Name</label><input type="text" id="fee-structure-name" required></div>
                            <div><label>Session</label><select id="fee-session-select" name="academic_session_id" required></select></div>
                            <div><label>Amount (₹)</label><input type="number" id="fee-total-amount" required></div>
                            <div><label>Due Date</label><input type="date" id="fee-due-date" required></div>
                            <div class="col-span-2"><button type="submit" id="save-fee-structure-btn" class="bg-primary text-white w-full py-3 rounded-lg font-bold">Save Structure</button></div>
                        </form>
                        <div class="mt-8 border-t pt-4"><table class="w-full"><tbody id="fee-structure-table-body"></tbody></table></div>
                    </div>
                </div>

                <div id="fees-view-pay" class="hidden">
                    <div class="form-card">
                        <h3 class="section-header text-green-700">Record Fee Collection</h3>
                        <form id="payment-form" class="space-y-6">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <label class="text-blue-700">Quick Filter: Select Session to find students faster</label>
                                <select id="payment-session-filter" onchange="filterPaymentStudents()"><option value="">All Sessions</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div><label>Select Student</label><select id="payment-student-select" required></select></div>
                                <div><label>Select Fee Type</label><select id="payment-fee-structure-select" required></select></div>
                                <div><label>Amount Paid (₹)</label><input type="number" step="0.01" id="payment-amount" required></div>
                                <div><label>Method</label><select id="payment-method"><option>Cash</option><option>Online</option></select></div>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg">Record & Print Receipt</button>
                        </form>
                        <div class="mt-8 border-t pt-6"><table class="w-full"><tbody id="fee-status-table-body"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="content-announcements" class="content-section hidden">
                <div class="form-card">
                    <h3 class="section-header">Post Announcement</h3>
                     <form id="announcement-form" class="space-y-4">
                        <div><label>Title</label><input type="text" id="announcement-title" required></div>
                        <div><label>Content</label><textarea id="announcement-content" rows="3" required></textarea></div>
                        <div><label>Target</label><select id="announcement-target-group"><option value="all">All Users</option></select></div>
                        <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg font-bold">Submit</button>
                     </form>
                </div>
                <div class="bg-white rounded-xl border overflow-hidden"><table class="w-full"><tbody id="management-announcements-body"></tbody></table></div>
            </div>

            <div id="content-bulk-upload" class="content-section hidden">
                <div class="form-card">
                    <h3 class="section-header">Bulk Student/User Upload</h3>
                    <form id="bulk-upload-form" class="flex gap-4 items-end">
                        <div class="flex-1"><label>CSV File</label><input type="file" id="bulk-file-input" accept=".csv" class="w-full mt-1"></div>
                        <button type="submit" class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold">Start Upload</button>
                    </form>
                    <div id="bulk-upload-results" class="mt-6 hidden p-4 bg-slate-50 rounded border"></div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    const API_BASE_URL = window.location.origin + '/api';
    let allUsersCache = [], allCoursesCache = [], allSessionsCache = [];

    // --- 1. MENU & NAVIGATION ---
    function toggleMenu(type) {
        const submenu = document.getElementById(`${type}-submenu`);
        const arrow = document.getElementById(`${type}-arrow`);
        const isOpen = submenu.classList.contains('open');
        
        // Notepad style close others
        document.querySelectorAll('.submenu').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.material-symbols-outlined').forEach(a => a.style.transform = '');

        if(!isOpen) {
            submenu.classList.add('open');
            arrow.style.transform = 'rotate(180deg)';
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.submenu').forEach(m => m.classList.remove('open'));
    }

    function showSection(hash) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
        const targetId = hash.split('-')[0].substring(1) || 'dashboard';
        const target = document.getElementById(`content-${targetId}`);
        if(target) target.classList.remove('hidden');
        
        loadData(targetId);
    }

    function switchSubView(section, view) {
        document.querySelectorAll(`[id^="${section.substring(0,3)}-view-"]`).forEach(v => v.classList.add('hidden'));
        document.getElementById(`${section.substring(0,3)}-view-${view}`).classList.remove('hidden');
    }

    // --- 2. DATA LOADERS ---
    async function loadData(id) {
        if(id === 'dashboard') fetchStats();
        if(id === 'teachers') fetchTeachers();
        if(id === 'parents') fetchParents();
        if(id === 'courses') fetchCourses();
        if(id === 'sessions') fetchSessions();
        if(id === 'fees') { fetchFeeStructures(); fetchFeeSessionDropdowns(); fetchStudentsForPaymentDropdown(); fetchFeeStatus(); }
    }

    async function fetchStats() {
        const users = await fetchAllUsers();
        const cRes = await fetch(`${API_BASE_URL}/courses`, {credentials:'include'});
        const courses = await cRes.json();
        
        document.getElementById('total-teachers').innerText = users.filter(u=>u.role==='teacher').length;
        document.getElementById('total-students').innerText = users.filter(u=>u.role==='student').length;
        document.getElementById('total-parents').innerText = users.filter(u=>u.role==='parent').length;
        document.getElementById('total-courses').innerText = courses.length;
    }

    async function fetchAllUsers() {
        const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
        allUsersCache = await res.json();
        return allUsersCache;
    }

    // --- 3. FIX EDIT / NETWORK ERROR ---
    window.editStudent = async function(id) {
        try {
            // Load dropdowns first to prevent unassigned values
            await loadSessionsFilter(); 
            await fetchCoursesForEnrollment();
            
            const res = await fetch(`${API_BASE_URL}/admin/student/${id}`, {credentials:'include'});
            if(!res.ok) throw "error";
            const u = await res.json();
            
            switchSubView('students', 'add');
            populateUserForm(u, 'student');
            document.getElementById('student-form-btn').innerText = "Update Student";
            window.scrollTo(0,0);
        } catch(e) { alert("Network Error: Data unreachable."); }
    };

    window.editTeacher = (id) => editInline(id, 'teacher');
    window.editParent = (id) => editInline(id, 'parent');
    window.editSession = (id) => editInline(id, 'session');
    window.editCourse = (id) => editInline(id, 'course');
    window.editFeeStructure = (id) => editInline(id, 'fee_structure');

    function editInline(id, type) {
        const item = (type==='teacher'||type==='parent') ? allUsersCache.find(x=>x.id===id) : null;
        if(item) {
             populateUserForm(item, type);
             document.getElementById(`${type}-form-btn`).innerText = "Update Record";
        }
    }

    function populateUserForm(u, role) {
        const form = document.getElementById(`${role}-form`);
        form.querySelector(`input[name="id"]`).value = u.id;
        form.querySelector(`input[name="name"]`).value = u.name;
        form.querySelector(`input[name="email"]`).value = u.email;
        if(form.querySelector(`input[name="phone_number"]`)) form.querySelector(`input[name="phone_number"]`).value = u.phone_number || '';
        
        if(role === 'student') {
            document.getElementById('student-session-select').value = u.session_id || '';
            document.getElementById('student-course-select').value = u.course_ids ? u.course_ids[0] : '';
            document.getElementById('student-gender-select').value = u.gender || '';
            document.getElementById('student-photo-preview').src = u.profile_photo_url || 'https://placehold.co/100';
        }
    }

    // --- 4. SMS RESTORED ---
    window.sendFeeAlert = async function(id) {
        if(!confirm("Send SMS reminder to parent and student?")) return;
        const res = await fetch(`${API_BASE_URL}/send_sms_alert`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ student_id: id })
        });
        const data = await res.json();
        alert(data.message);
    };

    // --- 5. FEE FILTER LOGIC ---
    function filterPaymentStudents() {
        const sid = document.getElementById('payment-session-filter').value;
        const sel = document.getElementById('payment-student-select');
        const filtered = allUsersCache.filter(u => u.role === 'student' && (!sid || u.session_id == sid));
        sel.innerHTML = '<option value="">Select Student</option>' + filtered.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    // --- 6. TABLE RENDERERS (With Spaced Edit/Delete Buttons) ---
    async function loadUsers() {
        const sess = document.getElementById('filterSession').value;
        const search = document.getElementById('userSearch').value;
        const res = await fetch(`${API_BASE_URL}/users?session_id=${sess}&search=${search}`, {credentials:'include'});
        const users = await res.json();
        document.getElementById('usersTableBody').innerHTML = users.filter(u=>u.role==='student').map(u => `
            <tr><td>${u.admission_number||'-'}</td><td>${u.name}</td><td>${u.session_name}</td><td class="text-right">
                <button onclick="editStudent(${u.id})" class="btn-edit mr-4">Edit</button>
                <button onclick="deleteStudent(${u.id})" class="btn-delete">Delete</button>
            </td></tr>`).join('');
    }

    async function fetchTeachers() {
        const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
        const users = await res.json();
        document.getElementById('teacher-table-body').innerHTML = users.filter(u=>u.role==='teacher').map(t => `
            <tr><td>${t.name}</td><td>${t.email}</td><td>${t.phone_number||'-'}</td><td class="text-right">
                <button onclick="editTeacher(${t.id})" class="btn-edit mr-4">Edit</button>
                <button onclick="deleteTeacher(${t.id})" class="btn-delete">Delete</button>
            </td></tr>`).join('');
    }

    // --- 7. FORM SUBMISSIONS ---
    document.addEventListener('submit', async (e) => {
        if(e.target.tagName !== 'FORM') return;
        e.preventDefault();
        const form = e.target;
        const fd = new FormData(form);
        const id = form.querySelector('input[name="id"]')?.value;
        let url = `${API_BASE_URL}/users`;
        if(form.id === 'course-form') url = `${API_BASE_URL}/courses`;
        else if(form.id === 'session-form') url = `${API_BASE_URL}/sessions`;
        else if(form.id === 'fee-structure-form') url = `${API_BASE_URL}/fee_structures`;
        else if(form.id === 'payment-form') url = `${API_BASE_URL}/payments`;

        const res = await fetch(url, { method: (id && form.id !== 'payment-form')?'PUT':'POST', credentials:'include', body: fd });
        if(res.ok) { alert("Successfully Saved!"); form.reset(); loadData(window.location.hash.substring(1).split('-')[0]); }
        else { alert("Error saving."); }
    });

    // INIT
    window.addEventListener('hashchange', () => showSection(window.location.hash));
    document.addEventListener('DOMContentLoaded', () => showSection(window.location.hash || '#dashboard'));
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#1173d4", "background-light": "#f6f7f8", "background-dark": "#101922" },
                    fontFamily: { "display": ["Inter"] },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .table-auto-layout { table-layout: auto; }
        .overdue { color: #ef4444; font-weight: 600; }
        .pending { color: #f59e0b; font-weight: 600; }
        .paid { color: #10b981; font-weight: 600; }
        .tab-btn { border-bottom: 2px solid transparent; color: #64748b; padding-bottom: 0.75rem; transition: all 0.2s; }
        .tab-btn.active { border-bottom: 2px solid #1173d4; color: #1173d4; font-weight: 700; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Admin</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Admin Portal</p>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-1">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 text-primary"><span class="material-symbols-outlined">dashboard</span><span class="text-sm font-medium">Dashboard</span></a>
            <a href="#teachers" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">person</span><span class="text-sm font-medium">Teachers</span></a>
            <a href="#students" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">school</span><span class="text-sm font-medium">Students</span></a>
            <a href="#parents" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">groups</span><span class="text-sm font-medium">Parents</span></a>
            <a href="#courses" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">book</span><span class="text-sm font-medium">Courses</span></a>
            <a href="#sessions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">calendar_month</span><span class="text-sm font-medium">Sessions</span></a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">campaign</span><span class="text-sm font-medium">Announcements</span></a>
            <a href="#fees" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">payments</span><span class="text-sm font-medium">Fees & Payments</span></a>
            <a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">receipt_long</span><span class="text-sm font-medium">Fee Pending Report</span></a>
            <a href="#admin-message" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">message</span><span class="text-sm font-medium">Bulk Message</span></a>
            <a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">analytics</span><span class="text-sm font-medium">Reports</span></a>
            <a href="#bulk-upload" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10"><span class="material-symbols-outlined">upload_file</span><span class="text-sm font-medium">Bulk Upload</span></a>
        </nav>
        <div class="p-6 border-t border-slate-200">
            <button id="logout-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-red-700 transition">Logout</button>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto h-screen">
        <div class="max-w-7xl mx-auto pb-20">
            
            <div id="content-dashboard" class="content-section">
                <header class="mb-8"><h1 class="text-4xl font-bold text-slate-900 dark:text-white">Admin Dashboard</h1></header>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6"><p class="text-sm text-gray-500">Teachers</p><p id="total-teachers" class="text-3xl font-bold">-</p></div>
                    <div class="bg-white rounded-xl shadow-sm p-6"><p class="text-sm text-gray-500">Students</p><p id="total-students" class="text-3xl font-bold">-</p></div>
                    <div class="bg-white rounded-xl shadow-sm p-6"><p class="text-sm text-gray-500">Parents</p><p id="total-parents" class="text-3xl font-bold">-</p></div>
                    <div class="bg-white rounded-xl shadow-sm p-6"><p class="text-sm text-gray-500">Courses</p><p id="total-courses" class="text-3xl font-bold">-</p></div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold mb-4">Recent Announcements</h2>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="recent-announcements-body"></tbody></table></div>
                </div>
            </div>

            <div id="content-teachers" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Teachers</h2>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <form id="teacher-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="teacher-id" name="id"><input type="hidden" name="role" value="teacher">
                        <input type="text" id="teacher-name-input" name="name" required placeholder="Name" class="w-full rounded-lg border-gray-300">
                        <input type="email" id="teacher-email-input" name="email" required placeholder="Email" class="w-full rounded-lg border-gray-300">
                        <input type="tel" id="teacher-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-lg border-gray-300">
                        <input type="password" id="teacher-password-input" name="password" placeholder="Password" class="w-full rounded-lg border-gray-300">
                        <button type="submit" id="teacher-form-btn" class="w-full bg-primary text-white font-bold py-2 rounded-lg md:col-span-2">Save Teacher</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="teacher-table-body"></tbody></table></div>
            </div>

            <div id="content-students" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Students</h2>
                
                <div class="flex flex-col md:flex-row gap-4 mb-6">
    <div class="flex-1">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Search</label>
        <input type="text" id="student-search-input" placeholder="Search Name, Phone..." oninput="window.fetchStudents()" class="w-full rounded-xl border-gray-300 p-2.5">
    </div>
    
    <div class="w-full md:w-48">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Filter by Course</label>
        <select id="student-course-filter" onchange="window.fetchStudents()" class="w-full rounded-xl border-gray-300 p-2.5 font-bold text-slate-700">
            <option value="">All Courses</option>
            </select>
    </div>

    <div class="w-full md:w-48">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Filter by Session</label>
        <select id="student-session-filter" onchange="window.fetchStudents()" class="w-full rounded-xl border-gray-300 p-2.5 font-bold text-slate-700">
            <option value="">All Time</option>
            </select>
    </div>
</div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <h3 id="student-form-title" class="text-xl font-bold mb-4">Add/Edit Student</h3>
                    <form id="student-form" class="space-y-4">
                        <input type="hidden" id="student-id" name="id"><input type="hidden" name="role" value="student">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select id="student-course-select" name="course_ids" required class="w-full rounded-lg border-gray-300"></select>
                            <select id="student-parent-select" name="parent_id" class="w-full rounded-lg border-gray-300"></select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="student-name-input" name="name" required placeholder="Full Name" class="w-full rounded-lg border-gray-300">
                            <input type="email" id="student-email-input" name="email" required placeholder="Email" class="w-full rounded-lg border-gray-300">
                            <input type="tel" id="student-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-lg border-gray-300">
                            <input type="date" id="student-dob-input" name="dob" class="w-full rounded-lg border-gray-300">
                            <select id="student-gender-select" name="gender" class="w-full rounded-lg border-gray-300"><option value="">Gender</option><option>Male</option><option>Female</option></select>
                            <input type="password" id="student-password-input" name="password" placeholder="Password" class="w-full rounded-lg border-gray-300">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4">
                            <input type="text" id="student-address-input" name="address_line1" placeholder="Address" class="w-full rounded-lg border-gray-300 md:col-span-3">
                            <input type="text" id="student-city-input" name="city" placeholder="City" class="w-full rounded-lg border-gray-300">
                            <input type="text" id="student-pincode-input" name="pincode" placeholder="Pincode" class="w-full rounded-lg border-gray-300">
                        </div>
                        <div class="flex items-center gap-4 pt-2">
                            <img id="student-photo-preview" src="https://placehold.co/100" class="w-16 h-16 rounded-lg border">
                            <input type="file" id="student-photo-file-input" name="profile_photo_file" class="text-sm">
                        </div>
                        <button type="submit" id="student-form-btn" class="w-full bg-primary text-white font-bold py-3 rounded-lg">Save Student</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="student-table-body"></tbody></table></div>
            </div>

            <div id="content-parents" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Parents</h2>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <form id="parent-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="parent-id" name="id"><input type="hidden" name="role" value="parent">
                        <input type="text" id="parent-name-input" name="name" required placeholder="Name" class="w-full rounded-lg border-gray-300">
                        <input type="email" id="parent-email-input" name="email" required placeholder="Email" class="w-full rounded-lg border-gray-300">
                        <input type="tel" id="parent-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-lg border-gray-300">
                        <input type="password" id="parent-password-input" name="password" placeholder="Password" class="w-full rounded-lg border-gray-300">
                        <button type="submit" id="parent-form-btn" class="w-full bg-primary text-white font-bold py-2 rounded-lg md:col-span-2">Save Parent</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="parent-table-body"></tbody></table></div>
            </div>

            <div id="content-courses" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Courses</h2>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="course-id" name="id">
                        <input type="text" id="course-name" required placeholder="Course Name" class="w-full rounded-lg border-gray-300">
                        <input type="text" id="course-subjects" required placeholder="Subjects" class="w-full rounded-lg border-gray-300">
                        <select id="course-teacher" class="w-full rounded-lg border-gray-300 md:col-span-2"></select>
                        <button type="submit" id="save-course-btn" class="w-full bg-primary text-white font-bold py-2 rounded-lg md:col-span-2">Save Course</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="course-table-body"></tbody></table></div>
            </div>

            <div id="content-sessions" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Sessions</h2>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <form id="session-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="session-id" name="id">
                        <input type="text" id="session-name" required placeholder="Name (e.g. 2025-26)" class="w-full rounded-lg border-gray-300">
                        <select id="session-status" class="w-full rounded-lg border-gray-300"><option>Active</option><option>Inactive</option></select>
                        <input type="date" id="session-start-date" required class="w-full rounded-lg border-gray-300">
                        <input type="date" id="session-end-date" required class="w-full rounded-lg border-gray-300">
                        <button type="submit" id="save-session-btn" class="w-full bg-primary text-white font-bold py-2 rounded-lg md:col-span-2">Save Session</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="session-table-body"></tbody></table></div>
            </div>

            <div id="content-announcements" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Announcements</h2>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <form id="announcement-form" class="space-y-4">
                        <input type="text" id="announcement-title" required placeholder="Title" class="w-full rounded-lg border-gray-300">
                        <textarea id="announcement-content" required placeholder="Content" class="w-full rounded-lg border-gray-300"></textarea>
                        <select id="announcement-target-group" class="w-full rounded-lg border-gray-300"><option value="all">All</option><option value="students">Students</option></select>
                        <button type="submit" class="w-full bg-primary text-white font-bold py-2 rounded-lg">Publish</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="management-announcements-body"></tbody></table></div>
            </div>

            <div id="content-fees" class="content-section hidden">
                <div class="flex justify-between mb-6"><h2 class="text-3xl font-bold">Fees & Payments</h2></div>
                <div class="flex space-x-6 border-b mb-8">
                    <button onclick="window.switchFeeTab('structures')" id="tab-btn-structures" class="tab-btn active text-sm font-medium">Manage Fees</button>
                    <button onclick="window.switchFeeTab('payments')" id="tab-btn-payments" class="tab-btn text-sm font-medium">Record Payments</button>
                </div>

                <div id="tab-fees-structures" class="tab-content active">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                        <form id="fee-structure-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="fee-structure-id" name="id">
                            <input type="text" id="fee-structure-name" name="name" placeholder="Fee Name" required class="w-full rounded-lg border-gray-300">
                            <select id="fee-course-select" name="course_id" class="w-full rounded-lg border-gray-300"></select>
                            <select id="fee-session-select" name="academic_session_id" required class="w-full rounded-lg border-gray-300"></select>
                            <input type="number" id="fee-total-amount" name="total_amount" placeholder="Amount" required class="w-full rounded-lg border-gray-300">
                            <input type="date" id="fee-due-date" name="due_date" required class="w-full rounded-lg border-gray-300">
                            <button type="submit" id="save-fee-structure-btn" class="w-full bg-primary text-white font-bold py-2 rounded-lg md:col-span-2">Save Fee</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="fee-structure-table-body"></tbody></table></div>
                </div>

                <div id="tab-fees-payments" class="tab-content">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                        <form id="payment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select id="payment-student-select" required class="w-full rounded-lg border-gray-300 md:col-span-2"></select>
                            <select id="payment-fee-structure-select" required class="w-full rounded-lg border-gray-300"></select>
                            <select id="payment-method" required class="w-full rounded-lg border-gray-300"><option>Cash</option><option>Online</option></select>
                            <input type="number" id="payment-amount" placeholder="Amount Paid" required class="w-full rounded-lg border-green-500 font-bold text-green-700">
                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg">Record & Print</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="fee-status-table-body"></tbody></table></div>
                </div>
            </div>

            <div id="content-fee-pending-report" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Fee Pending Report</h2>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="min-w-full"><tbody id="fee-pending-report-body"></tbody></table></div>
            </div>

            <div id="content-reports" class="content-section hidden">
                <div class="flex justify-between mb-6">
                    <h2 class="text-3xl font-bold">Reports</h2>
                    <select id="report-session-filter" onchange="window.refreshReports()" class="border-gray-300 rounded-lg"><option value="">All Time</option></select>
                </div>
                <div class="flex space-x-2 bg-slate-100 p-1 rounded-lg w-fit mb-6">
                    <button onclick="window.switchReportTab('admissions')" id="tab-rep-admissions" class="px-4 py-2 rounded-md font-bold bg-white shadow-sm">Admissions</button>
                    <button onclick="window.switchReportTab('attendance')" id="tab-rep-attendance" class="px-4 py-2 rounded-md font-medium text-slate-500">Attendance</button>
                    <button onclick="window.switchReportTab('performance')" id="tab-rep-performance" class="px-4 py-2 rounded-md font-medium text-slate-500">Performance</button>
                </div>
                <div id="report-view-admissions" class="report-view"><div class="bg-white rounded-xl shadow-sm p-4"><table class="min-w-full"><tbody id="admissions-report-body"></tbody></table></div></div>
                <div id="report-view-attendance" class="report-view hidden"><div class="bg-white rounded-xl shadow-sm p-4"><table class="min-w-full"><tbody id="attendance-report-body"></tbody></table></div></div>
                <div id="report-view-performance" class="report-view hidden"><div class="bg-white rounded-xl shadow-sm p-4"><table class="min-w-full"><tbody id="performance-report-body"></tbody></table></div></div>
            </div>

            <div id="content-bulk-upload" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Bulk Upload</h2>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <form id="bulk-upload-form"><input type="file" id="bulk-file-input" name="file" class="block w-full border p-2 mb-4 rounded"><button type="submit" class="bg-primary text-white font-bold py-2 px-6 rounded-lg">Upload CSV</button></form>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    let allUsersCache = [], allCoursesCache = [], allSessionsCache = [];

    // --- GLOBAL FUNCTIONS (Attached to Window for HTML Access) ---
    
    window.switchFeeTab = function(tabName) {
        document.getElementById('tab-fees-structures').classList.remove('active');
        document.getElementById('tab-fees-payments').classList.remove('active');
        document.getElementById('tab-btn-structures').className = "tab-btn text-sm font-medium cursor-pointer";
        document.getElementById('tab-btn-payments').className = "tab-btn text-sm font-medium cursor-pointer";
        document.getElementById(`tab-fees-${tabName}`).classList.add('active');
        document.getElementById(`tab-btn-${tabName}`).className = "tab-btn active text-sm font-medium cursor-pointer";
    }

    window.switchReportTab = function(reportName) {
        document.querySelectorAll('.report-view').forEach(el => el.classList.add('hidden'));
        document.getElementById(`report-view-${reportName}`).classList.remove('hidden');
        ['admissions', 'attendance', 'performance'].forEach(r => document.getElementById(`tab-rep-${r}`).className = "px-4 py-2 rounded-md font-medium text-slate-500");
        document.getElementById(`tab-rep-${reportName}`).className = "px-4 py-2 rounded-md font-bold bg-white shadow-sm";
    }

    // --- STUDENT FETCHING & FILTERING ---
// --- 1. UPDATED: Fetch Students (Fixed Filtering & Added Photos) ---
// --- UPDATED: Fetch Students (With Photos in Name Column) ---
    window.fetchStudents = async function(term = '') {
        const tbody = document.getElementById('student-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">Loading...</td></tr>';
        
        term = term || document.getElementById('student-search-input')?.value || '';
        const sessionSelect = document.getElementById('student-session-filter');
        const courseSelect = document.getElementById('student-course-filter'); // If you added this
        
        const sessionId = sessionSelect ? sessionSelect.value : '';
        const courseId = courseSelect ? courseSelect.value : '';

        // Load users if not in cache
        if(!allUsersCache.length) {
             const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
             allUsersCache = await res.json();
        }
        
        // Session Date Logic
        let sessionStart = null, sessionEnd = null;
        if (sessionId && allSessionsCache.length) {
            const sess = allSessionsCache.find(s => s.id == sessionId);
            if(sess) { sessionStart = new Date(sess.start_date); sessionEnd = new Date(sess.end_date); }
        }

        const filtered = allUsersCache.filter(s => {
            if (s.role !== 'student') return false;

            // 1. Text Search
            const matchText = s.name.toLowerCase().includes(term.toLowerCase()) || 
                              (s.email||'').toLowerCase().includes(term.toLowerCase()) ||
                              (s.phone_number||'').includes(term);
            if (!matchText) return false;

            // 2. Session Filter
            if (sessionStart && sessionEnd) {
                const joined = new Date(s.created_at);
                if (joined < sessionStart || joined > sessionEnd) return false;
            }
            
            // 3. Course Filter
            if (courseId) {
                if (!s.course_ids || !s.course_ids.includes(parseInt(courseId))) return false;
            }
            
            return true;
        });

        if(!filtered.length) { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">No students found.</td></tr>'; return; }

        tbody.innerHTML = filtered.map(s => {
            const photoUrl = s.profile_photo_url ? `${API_ORIGIN}${s.profile_photo_url}` : `https://placehold.co/100x100/f6f7f8/666?text=${s.name.charAt(0)}`;
            const parentName = allUsersCache.find(u => u.id === s.parent_id)?.name || '-';
            
            return `
            <tr class="border-b border-gray-50 hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <img class="h-10 w-10 rounded-full object-cover border border-gray-200 mr-3" src="${photoUrl}" alt="">
                        <div>
                            <div class="font-bold text-slate-900">${s.name}</div>
                            <div class="text-xs text-gray-400">${s.email}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-500">${s.phone_number||'-'}</td>
                <td class="px-6 py-4 text-sm text-slate-500">${parentName}</td>
                <td class="px-6 py-4 text-sm text-slate-500">${s.created_at}</td>
                <td class="px-6 py-4 text-center"><button onclick="sendQuickSms(${s.id}, '${s.name}')" class="text-amber-500 hover:text-amber-700 material-symbols-outlined">sms</button></td>
                <td class="px-6 py-4 text-center"><button onclick="sendQuickWhatsapp(${s.id}, '${s.name}')" class="text-green-600 hover:text-green-800 material-symbols-outlined">chat</button></td>
                <td class="px-6 py-4 text-right">
                    <button onclick="editUser(${s.id}, 'student')" class="text-primary font-bold mr-2">Edit</button>
                    <button onclick="deleteUser(${s.id})" class="text-red-500 font-bold">Delete</button>
                </td>
            </tr>`;
        }).join('');
    }

    // --- 2. UPDATED: Fee Pending Report (Fixed Buttons & Added Photos) ---
// --- UPDATED: Fee Pending Report (Fixes Buttons & Adds Photos) ---
    async function fetchFeePendingReport() {
        const tbody = document.getElementById('fee-pending-report-body');
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Loading pending fees...</td></tr>';

        try {
            // 1. Fetch the Fee Report
            const list = await (await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials:'include'})).json();
            
            if(list.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">No pending fees found.</td></tr>'; 
                return; 
            }

            // 2. Ensure we have User Data (for Photos)
            // If the cache is empty, fetch all users so we can find their photos
            if(!allUsersCache.length) {
                const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
                allUsersCache = await res.json();
            }

            tbody.innerHTML = list.map(s => {
                // Find the full user object to get the photo URL
                const user = allUsersCache.find(u => u.id === s.student_id);
                // Create the photo URL or use a placeholder
                const photoUrl = user && user.profile_photo_url 
                    ? `${API_ORIGIN}${user.profile_photo_url}` 
                    : `https://placehold.co/100x100/f6f7f8/666?text=${s.student_name.charAt(0)}`;

                const isOverdue = s.pending_days < 0;
                const daysText = isOverdue ? `${Math.abs(s.pending_days)} Days OVERDUE` : `${s.pending_days} Days Left`;
                const daysClass = isOverdue ? 'text-red-500 font-bold' : 'text-slate-500';

                return `
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <img class="h-10 w-10 rounded-full object-cover border border-gray-200 mr-3" src="${photoUrl}" alt="">
                            <div class="font-bold text-slate-800">${s.student_name}</div>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-red-600 font-bold">₹${s.balance}</td>
                    
                    <td class="px-6 py-4 text-sm text-slate-500">${s.due_date}</td>
                    
                    <td class="px-6 py-4 text-xs ${daysClass}">${daysText}</td>
                    
                    <td class="px-6 py-4 text-center">
                        <button onclick="sendFeeAlert(${s.student_id})" class="text-amber-500 hover:text-amber-700 hover:bg-amber-50 p-2 rounded-full transition" title="Send SMS">
                            <span class="material-symbols-outlined align-middle">sms</span>
                        </button>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <button onclick="sendFeeReminderWhatsapp(${s.student_id}, '${s.student_name}')" class="text-green-600 hover:text-green-800 hover:bg-green-50 p-2 rounded-full transition" title="Send WhatsApp">
                            <span class="material-symbols-outlined align-middle">chat</span>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        } catch(e) { 
            console.error(e); 
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Error loading report.</td></tr>';
        }
    }   
    // --- 3. UPDATED: Admissions Report (Fixed Logic & Added Photos) ---
async function fetchAdmissionsReport() {
        const tbody = document.getElementById('admissions-report-body');
        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';

        // Get Session Filter
        const sessionSelect = document.getElementById('report-session-filter');
        let sessionStart = null, sessionEnd = null;
        if (sessionSelect && sessionSelect.value) {
            const sess = allSessionsCache.find(s => s.id == sessionSelect.value);
            if(sess) { sessionStart = new Date(sess.start_date); sessionEnd = new Date(sess.end_date); }
        }

        try {
            if(!allUsersCache.length) allUsersCache = await (await fetch(`${API_BASE_URL}/users`, {credentials: 'include'})).json();
            
            // Filter Logic
            const admissions = allUsersCache.filter(s => {
                if (s.role !== 'student') return false;
                
                // Date Filter (If a session is selected)
                if (sessionStart && sessionEnd) {
                    const joined = new Date(s.created_at);
                    if (joined < sessionStart || joined > sessionEnd) return false;
                }
                return true; 
            });

            if (admissions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center">No admissions found for this session.</td></tr>`;
                return;
            }
            
            tbody.innerHTML = admissions.map(a => {
                const photoUrl = a.profile_photo_url ? `${API_ORIGIN}${a.profile_photo_url}` : `https://placehold.co/100x100/f6f7f8/666?text=${a.name.charAt(0)}`;
                return `
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap w-16">
                        <img src="${photoUrl}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold text-slate-800">${a.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${a.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${a.created_at}</td>
                </tr>`;
            }).join('');
                
        } catch (error) {
            console.error("Error fetching admissions:", error);
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500">Error loading data.</td></tr>`;
        }
    }
    window.refreshReports = function() { fetchAdmissions(); fetchAttendance(); fetchPerformance(); }
    // --- MAIN INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Navigation Logic
        const sections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        
        function showSection(hash) {
            sections.forEach(s => s.classList.add('hidden'));
            const id = hash.substring(1) || 'dashboard';
            document.getElementById(`content-${id}`)?.classList.remove('hidden');
            loadContent(id);
        }
        window.addEventListener('hashchange', () => showSection(window.location.hash));

        // 2. Load Content Router
        async function loadContent(id) {
            if(id === 'dashboard') fetchDashboard();
            if(id === 'students') { await fetchStudents(); populateDropdowns(); }
            if(id === 'teachers') fetchTeachers();
            if(id === 'parents') fetchParents();
            if(id === 'courses') fetchCourses();
            if(id === 'sessions') fetchSessions();
            if(id === 'fees') { fetchFees(); fetchFeeStatus(); fetchSessions(); populateFeeCourseDropdown(); }
            if(id === 'fee-pending-report') fetchFeePending();
            if(id === 'reports') { populateSessionFilters(); window.refreshReports(); }
            if(id === 'announcements') fetchAnnouncements(true);
        }

        // 3. Auth Check
        try {
            const res = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: 'include'});
            const data = await res.json();
            if(!data.logged_in || data.user.role !== 'admin') window.location.href = '/';
            else {
                await fetchSessions(); // Load global data first
                await populateSessionFilters();
                showSection(window.location.hash); // Load initial page
            }
        } catch { window.location.href = '/'; }

        // 4. Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch(`${API_BASE_URL}/logout`, {method:'POST', credentials:'include'});
            window.location.href = '/';
        });

        // 5. Generic Form Handlers (Simplified for brevity)
        setupForms(); 
    });

    // --- HELPER FUNCTIONS ---
    
    async function fetchSessions() {
        const res = await fetch(`${API_BASE_URL}/sessions`, {credentials:'include'});
        allSessionsCache = await res.json();
        const tbody = document.getElementById('session-table-body');
        if(tbody) tbody.innerHTML = allSessionsCache.map(s => `<tr class="border-b"><td class="p-4 font-bold">${s.name}</td><td class="p-4">${s.start_date}</td><td class="p-4">${s.end_date}</td><td class="p-4">${s.status}</td><td class="p-4 text-right"><button onclick="deleteData('sessions', ${s.id})" class="text-red-500">Delete</button></td></tr>`).join('');
    }

    async function populateSessionFilters() {
        const filters = [document.getElementById('student-session-filter'), document.getElementById('report-session-filter')];
        const opts = '<option value="">All Time (History)</option>' + allSessionsCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        filters.forEach(f => { if(f) f.innerHTML = opts; });
    }

    async function fetchDashboard() {
        // Simple dashboard counts
        const users = await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json();
        allUsersCache = users;
        document.getElementById('total-students').textContent = users.filter(u=>u.role==='student').length;
        document.getElementById('total-teachers').textContent = users.filter(u=>u.role==='teacher').length;
        document.getElementById('total-parents').textContent = users.filter(u=>u.role==='parent').length;
        document.getElementById('total-courses').textContent = (await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json()).length;
        fetchAnnouncements(false);
    }

    async function populateDropdowns() {
        const courses = await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json();
        allCoursesCache = courses; // Ensure cache is updated
        
        // 1. Fill Student Form Dropdowns
        const parents = await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json();
        const parentList = parents.filter(u => u.role === 'parent');
        
        document.getElementById('student-course-select').innerHTML = '<option value="">Select Course</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        document.getElementById('student-parent-select').innerHTML = '<option value="">Link Parent</option>' + parentList.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

        // 2. NEW: Fill the Filter Dropdown
        const filterSelect = document.getElementById('student-course-filter');
        if(filterSelect) {
            filterSelect.innerHTML = '<option value="">All Courses</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
    }

    async function populateFeeCourseDropdown() {
        const courses = await (await fetch(`${API_BASE_URL}/courses`, {credentials: 'include'})).json();
        const select = document.getElementById('fee-course-select');
        select.innerHTML = '<option value="">Global (All Students)</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function fetchFees() {
        const list = await (await fetch(`${API_BASE_URL}/fee_structures`, {credentials:'include'})).json();
        document.getElementById('fee-structure-table-body').innerHTML = list.map(f => `<tr class="border-b"><td class="p-4 font-bold">${f.name}</td><td class="p-4">${f.course_name||'Global'}</td><td class="p-4">₹${f.total_amount}</td><td class="p-4">${f.due_date}</td><td class="p-4 text-right"><button onclick="deleteData('fee_structures', ${f.id})" class="text-red-500">Delete</button></td></tr>`).join('');
        
        document.getElementById('fee-session-select').innerHTML = allSessionsCache.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('payment-fee-structure-select').innerHTML = list.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
        
        // Populate student dropdown for payment
        const students = await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json();
        document.getElementById('payment-student-select').innerHTML = students.filter(u=>u.role==='student').map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function fetchFeeStatus() {
        const list = await (await fetch(`${API_BASE_URL}/fee_status`, {credentials:'include'})).json();
        document.getElementById('fee-status-table-body').innerHTML = list.map(s => `<tr class="border-b"><td class="p-4 font-bold">${s.student_name}</td><td class="p-4 ${s.balance>0?'text-red-500':'text-green-500'}">₹${s.balance}</td><td class="p-4">${s.balance>0?'Pending':'Paid'}</td><td class="p-4 text-right"><button onclick="window.open('${API_BASE_URL}/receipt/${s.latest_payment_id}', '_blank')" class="text-blue-600">Print</button></td></tr>`).join('');
    }

    async function fetchFeePending() {
        const list = await (await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials:'include'})).json();
        document.getElementById('fee-pending-report-body').innerHTML = list.map(s => `<tr class="border-b"><td class="p-4 font-bold">${s.student_name}</td><td class="p-4 text-red-600 font-bold">₹${s.balance}</td><td class="p-4">${s.due_date}</td><td class="p-4 text-red-500">${Math.abs(s.pending_days)} Days Overdue</td><td class="p-4 text-center">SMS</td><td class="p-4 text-center">WA</td></tr>`).join('');
    }

    // --- FORM SETUP ---
    function setupForms() {
        const forms = { 'student-form': '/users', 'teacher-form': '/users', 'parent-form': '/users', 'course-form': '/courses', 'session-form': '/sessions', 'announcement-form': '/announcements', 'fee-structure-form': '/fee_structures', 'payment-form': '/payments' };
        
        Object.keys(forms).forEach(id => {
            document.getElementById(id)?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                
                // Photo Upload Handling
                if(id==='student-form' && formData.get('id') && document.getElementById('student-photo-file-input').files.length) {
                   const pData = new FormData(); pData.append('profile_photo_file', formData.get('profile_photo_file'));
                   await fetch(`${API_BASE_URL}/user/upload_photo/${formData.get('id')}`, {method:'POST', credentials:'include', body:pData});
                   formData.delete('profile_photo_file');
                }

                if(!formData.get('password')) formData.delete('password'); // Don't send empty pass

                let body, headers={};
                if(id.includes('student') || id.includes('teacher') || id.includes('parent')) body = formData; // Send FormData for users
                else { body = JSON.stringify(Object.fromEntries(formData)); headers={'Content-Type':'application/json'}; }

                const method = formData.get('id') ? 'PUT' : 'POST';
                const res = await fetch(`${API_BASE_URL}${forms[id]}`, {method, headers, credentials:'include', body});
                
                if(res.ok) { 
                    alert('Saved!'); form.reset(); 
                    if(id==='payment-form') { const d=await res.json(); if(d.payment_id) window.open(`${API_BASE_URL}/receipt/${d.payment_id}`, '_blank'); }
                    loadContent(window.location.hash.substring(1)); // Refresh current view
                } else alert('Error saving data');
            });
        });
    }

    // --- GENERIC EDIT/DELETE ---
    window.editUser = async (id, role) => {
        const u = (await (await fetch(`${API_BASE_URL}/users`,{credentials:'include'})).json()).find(x=>x.id===id);
        const f = document.getElementById(`${role}-form`);
        f.querySelector('[name="id"]').value = u.id;
        f.querySelector('[name="name"]').value = u.name;
        f.querySelector('[name="email"]').value = u.email;
        if(role==='student') {
            f.querySelector('[name="phone_number"]').value = u.phone_number||'';
            if(u.course_ids?.length) document.getElementById('student-course-select').value=u.course_ids[0];
        }
        window.scrollTo({top:0, behavior:'smooth'});
    };

    window.deleteUser = async (id) => { if(confirm('Delete user?')) { await fetch(`${API_BASE_URL}/users/${id}`, {method:'DELETE', credentials:'include'}); window.fetchStudents(); } };
    window.deleteData = async (type, id) => { if(confirm('Delete?')) { await fetch(`${API_BASE_URL}/${type}/${id}`, {method:'DELETE', credentials:'include'}); loadContent(window.location.hash.substring(1)); } };

    // --- ADDITIONAL FETCHERS ---
    async function fetchTeachers() {
        const list = (await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json()).filter(u=>u.role==='teacher');
        document.getElementById('teacher-table-body').innerHTML = list.map(t => `<tr class="border-b"><td class="p-4 font-bold">${t.name}</td><td class="p-4">${t.email}</td><td class="p-4">${t.phone_number||'-'}</td><td class="p-4 text-right"><button onclick="editUser(${t.id}, 'teacher')" class="text-primary mr-2">Edit</button><button onclick="deleteUser(${t.id})" class="text-red-500">Delete</button></td></tr>`).join('');
    }
    async function fetchParents() {
        const list = (await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json()).filter(u=>u.role==='parent');
        document.getElementById('parent-table-body').innerHTML = list.map(p => `<tr class="border-b"><td class="p-4 font-bold">${p.name}</td><td class="p-4">${p.email}</td><td class="p-4">${p.phone_number||'-'}</td><td class="p-4 text-right"><button onclick="editUser(${p.id}, 'parent')" class="text-primary mr-2">Edit</button><button onclick="deleteUser(${p.id})" class="text-red-500">Delete</button></td></tr>`).join('');
    }
    async function fetchCourses() {
        const list = await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json();
        document.getElementById('course-table-body').innerHTML = list.map(c => `<tr class="border-b"><td class="p-4 font-bold">${c.name}</td><td class="p-4">${c.subjects}</td><td class="p-4">${c.teacher_name}</td><td class="p-4 text-right"><button onclick="deleteData('courses', ${c.id})" class="text-red-500">Delete</button></td></tr>`).join('');
    }
    async function fetchAnnouncements(isManage) {
        const list = await (await fetch(`${API_BASE_URL}/announcements`, {credentials:'include'})).json();
        const tbody = document.getElementById(isManage ? 'management-announcements-body' : 'recent-announcements-body');
        tbody.innerHTML = list.map(a => `<tr class="border-b"><td class="p-4 font-bold">${a.title}</td><td class="p-4 truncate max-w-xs">${a.content}</td><td class="p-4">${a.target_group}</td><td class="p-4">${a.created_at}</td><td class="p-4 text-right">${isManage ? `<button onclick="deleteData('announcements', ${a.id})" class="text-red-500">Delete</button>` : ''}</td></tr>`).join('');
    }
    
    // Reporting functions
    async function fetchAdmissions() {
        const list = await (await fetch(`${API_BASE_URL}/reports/admissions`, {credentials:'include'})).json();
        document.getElementById('admissions-report-body').innerHTML = list.map(a=>`<tr class="border-b"><td class="p-4 font-bold">${a.name}</td><td class="p-4">${a.email}</td><td class="p-4">${a.created_at}</td></tr>`).join('');
    }
    async function fetchAttendance() {
        const list = await (await fetch(`${API_BASE_URL}/reports/attendance`, {credentials:'include'})).json();
        document.getElementById('attendance-report-body').innerHTML = list.map(a=>`<tr class="border-b"><td class="p-4 font-bold">${a.student_name}</td><td class="p-4">${a.total_classes}</td><td class="p-4 text-green-600">${a.present}</td><td class="p-4 text-red-600">${a.absent}</td><td class="p-4 font-bold">${a.percentage}%</td></tr>`).join('');
    }
    async function fetchPerformance() {
        const list = await (await fetch(`${API_BASE_URL}/reports/performance`, {credentials:'include'})).json();
        document.getElementById('performance-report-body').innerHTML = list.map(a=>`<tr class="border-b"><td class="p-4 font-bold">${a.student_name}</td><td class="p-4">${a.assessments_taken}</td><td class="p-4">${a.total_score}</td><td class="p-4 font-bold">${a.overall_percentage}%</td></tr>`).join('');
    }

</script>
</body>
</html>
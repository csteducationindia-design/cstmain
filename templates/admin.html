<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - CST Institute</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&display=swap" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#2563EB", "primary-dark": "#1E40AF", "surface": "#F8FAFC" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { border-bottom: 2px solid transparent; color: #64748b; padding-bottom: 0.75rem; transition: all 0.2s; }
        .tab-btn.active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Smooth Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-surface text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shadow-xl z-10">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-primary text-white rounded-lg flex items-center justify-center font-bold text-xl">C</div>
            <div>
                <h1 class="font-bold text-slate-900 tracking-tight">CST Admin</h1>
                <p class="text-xs text-slate-500 font-medium">Management Portal</p>
            </div>
        </div>

        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">dashboard</span>
                <span class="text-sm font-medium">Dashboard</span>
            </a>
            
            <div class="pt-4 pb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider">Academics</div>
            <a href="#students" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">school</span>
                <span class="text-sm font-medium">Students</span>
            </a>
            <a href="#teachers" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">person</span>
                <span class="text-sm font-medium">Teachers</span>
            </a>
            <a href="#courses" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">book</span>
                <span class="text-sm font-medium">Courses</span>
            </a>
            <a href="#sessions" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">calendar_month</span>
                <span class="text-sm font-medium">Sessions</span>
            </a>

            <div class="pt-4 pb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider">Finance</div>
            <a href="#fees" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">payments</span>
                <span class="text-sm font-medium">Fees & Payments</span>
            </a>
            <a href="#fee-pending-report" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">receipt_long</span>
                <span class="text-sm font-medium">Fee Pending Report</span>
            </a>

            <div class="pt-4 pb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider">Communication</div>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">campaign</span>
                <span class="text-sm font-medium">Announcements</span>
            </a>
            <a href="#reports" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-primary transition-colors group">
                <span class="material-symbols-outlined text-[22px] group-hover:scale-110 transition-transform">analytics</span>
                <span class="text-sm font-medium">Reports</span>
            </a>
        </nav>

        <div class="p-4 border-t border-slate-200">
            <button id="logout-btn" class="w-full flex items-center justify-center gap-2 bg-slate-100 text-slate-600 font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-red-50 hover:text-red-600 transition-colors">
                <span class="material-symbols-outlined text-lg">logout</span>
                Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-slate-50/50 p-6 lg:p-10 scroll-smooth">
        <div class="max-w-7xl mx-auto space-y-8 pb-20">
            
            <div id="content-dashboard" class="content-section">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-slate-900">Dashboard</h1>
                    <p class="text-slate-500 mt-1">Overview of your institute's performance</p>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined">school</span></div>
                        <div><p class="text-sm font-medium text-slate-500">Total Students</p><p id="total-students" class="text-2xl font-bold text-slate-800">-</p></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined">person</span></div>
                        <div><p class="text-sm font-medium text-slate-500">Teachers</p><p id="total-teachers" class="text-2xl font-bold text-slate-800">-</p></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined">payments</span></div>
                        <div><p class="text-sm font-medium text-slate-500">Active Courses</p><p id="total-courses" class="text-2xl font-bold text-slate-800">-</p></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center"><span class="material-symbols-outlined">groups</span></div>
                        <div><p class="text-sm font-medium text-slate-500">Parents</p><p id="total-parents" class="text-2xl font-bold text-slate-800">-</p></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-50"><h2 class="text-lg font-bold text-slate-800">Recent Announcements</h2></div>
                    <table class="min-w-full"><tbody id="recent-announcements-body"></tbody></table>
                </div>
            </div>

            <div id="content-teachers" class="content-section hidden">
                <header class="mb-6"><h1 class="text-3xl font-bold text-slate-900">Teachers</h1></header>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                    <h3 id="teacher-form-title" class="text-lg font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary">add_circle</span> Add Teacher</h3>
                    <form id="teacher-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="teacher-id" name="id"><input type="hidden" name="role" value="teacher">
                        <input type="text" id="teacher-name-input" name="name" required placeholder="Full Name" class="form-input w-full rounded-xl border-slate-200 focus:border-primary focus:ring-primary">
                        <input type="email" id="teacher-email-input" name="email" required placeholder="Email Address" class="form-input w-full rounded-xl border-slate-200 focus:border-primary focus:ring-primary">
                        <input type="tel" id="teacher-phone-input" name="phone_number" placeholder="Phone Number" class="form-input w-full rounded-xl border-slate-200 focus:border-primary focus:ring-primary">
                        <input type="password" id="teacher-password-input" name="password" placeholder="Password (leave blank if editing)" class="form-input w-full rounded-xl border-slate-200 focus:border-primary focus:ring-primary">
                        <div class="md:col-span-2"><button type="submit" id="teacher-form-btn" class="bg-primary hover:bg-primary-dark text-white font-semibold py-2.5 px-6 rounded-xl transition w-full md:w-auto">Save Teacher</button></div>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-100">
                        <thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Contact</th><th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Actions</th></tr></thead>
                        <tbody id="teacher-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-students" class="content-section hidden">
                <header class="mb-6"><h1 class="text-3xl font-bold text-slate-900">Students</h1></header>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 mb-6 flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Search</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-3 text-slate-400">search</span>
                            <input type="text" id="student-search-input" placeholder="Name, Email or Phone..." oninput="window.fetchStudents()" class="w-full pl-10 rounded-xl border-slate-200 focus:border-primary focus:ring-primary py-2.5">
                        </div>
                    </div>
                    <div class="w-full md:w-56">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Filter by Course</label>
                        <select id="student-course-filter" onchange="window.fetchStudents()" class="w-full rounded-xl border-slate-200 focus:border-primary focus:ring-primary py-2.5 font-medium text-slate-700">
                            <option value="">All Courses</option>
                        </select>
                    </div>
                    <div class="w-full md:w-56">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Filter by Session</label>
                        <select id="student-session-filter" onchange="window.fetchStudents()" class="w-full rounded-xl border-slate-200 focus:border-primary focus:ring-primary py-2.5 font-medium text-slate-700">
                            <option value="">All Time</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                    <h3 id="student-form-title" class="text-lg font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary">person_add</span> Add / Edit Student</h3>
                    <form id="student-form" class="space-y-5">
                        <input type="hidden" id="student-id" name="id"><input type="hidden" name="role" value="student">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase ml-1">Enrolled Course</label><select id="student-course-select" name="course_ids" required class="w-full rounded-xl border-slate-200"></select></div>
                            <div class="space-y-1"><label class="text-xs font-bold text-slate-500 uppercase ml-1">Link Parent</label><select id="student-parent-select" name="parent_id" class="w-full rounded-xl border-slate-200"></select></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                            <input type="text" id="student-name-input" name="name" required placeholder="Full Name" class="w-full rounded-xl border-slate-200">
                            <input type="email" id="student-email-input" name="email" required placeholder="Email" class="w-full rounded-xl border-slate-200">
                            <input type="tel" id="student-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-xl border-slate-200">
                            <input type="date" id="student-dob-input" name="dob" class="w-full rounded-xl border-slate-200">
                            <select id="student-gender-select" name="gender" class="w-full rounded-xl border-slate-200"><option value="">Select Gender</option><option>Male</option><option>Female</option></select>
                            <input type="password" id="student-password-input" name="password" placeholder="Password" class="w-full rounded-xl border-slate-200">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 border-t border-slate-100 pt-5">
                            <input type="text" id="student-address-input" name="address_line1" placeholder="Street Address" class="w-full rounded-xl border-slate-200 md:col-span-3">
                            <input type="text" id="student-city-input" name="city" placeholder="City" class="w-full rounded-xl border-slate-200">
                            <input type="text" id="student-pincode-input" name="pincode" placeholder="Pincode" class="w-full rounded-xl border-slate-200">
                        </div>
                        <div class="flex items-center gap-4 pt-2">
                            <img id="student-photo-preview" src="https://placehold.co/100" class="w-16 h-16 rounded-xl object-cover border border-slate-200">
                            <input type="file" id="student-photo-file-input" name="profile_photo_file" class="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <button type="submit" id="student-form-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-8 rounded-xl w-full md:w-auto shadow-lg shadow-blue-200 transition">Save Student</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-100">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Student</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Contact</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Joined</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Message</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-parents" class="content-section hidden">
                <header class="mb-6"><h1 class="text-3xl font-bold text-slate-900">Parents</h1></header>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                    <form id="parent-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="parent-id" name="id"><input type="hidden" name="role" value="parent">
                        <input type="text" id="parent-name-input" name="name" required placeholder="Name" class="w-full rounded-xl border-slate-200">
                        <input type="email" id="parent-email-input" name="email" required placeholder="Email" class="w-full rounded-xl border-slate-200">
                        <input type="tel" id="parent-phone-input" name="phone_number" placeholder="Phone" class="w-full rounded-xl border-slate-200">
                        <input type="password" id="parent-password-input" name="password" placeholder="Password" class="w-full rounded-xl border-slate-200">
                        <button type="submit" id="parent-form-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2.5 rounded-xl md:col-span-2">Save Parent</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="parent-table-body"></tbody></table></div>
            </div>

            <div id="content-courses" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Courses</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="course-id" name="id">
                        <input type="text" id="course-name" name="name" required placeholder="Course Name" class="w-full rounded-xl border-slate-200">
                        <input type="text" id="course-subjects" name="subjects" required placeholder="Subjects" class="w-full rounded-xl border-slate-200">
                        <select id="course-teacher" name="teacher_id" class="w-full rounded-xl border-slate-200 md:col-span-2"></select>
                        <button type="submit" id="save-course-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2.5 rounded-xl md:col-span-2">Save Course</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="course-table-body"></tbody></table></div>
            </div>

            <div id="content-sessions" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Academic Sessions</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                    <form id="session-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="session-id" name="id">
                        <input type="text" id="session-name" name="name" required placeholder="Name (e.g. 2025-26)" class="w-full rounded-xl border-slate-200">
                        <select id="session-status" name="status" class="w-full rounded-xl border-slate-200"><option>Active</option><option>Inactive</option></select>
                        <input type="date" id="session-start-date" name="start_date" required class="w-full rounded-xl border-slate-200">
                        <input type="date" id="session-end-date" name="end_date" required class="w-full rounded-xl border-slate-200">
                        <button type="submit" id="save-session-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2.5 rounded-xl md:col-span-2">Save Session</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="session-table-body"></tbody></table></div>
            </div>

            <div id="content-announcements" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Announcements</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                    <form id="announcement-form" class="space-y-4">
                        <input type="text" id="announcement-title" name="title" required placeholder="Title" class="w-full rounded-xl border-slate-200">
                        <textarea id="announcement-content" name="content" required placeholder="Content" class="w-full rounded-xl border-slate-200 h-32"></textarea>
                        <select id="announcement-target-group" name="target_group" class="w-full rounded-xl border-slate-200"><option value="all">All</option><option value="students">Students</option></select>
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-2.5 px-6 rounded-xl">Publish Announcement</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="management-announcements-body"></tbody></table></div>
            </div>

            <div id="content-fees" class="content-section hidden">
                <header class="mb-6"><h1 class="text-3xl font-bold text-slate-900">Fees & Payments</h1></header>
                
                <div class="flex space-x-6 border-b border-slate-200 mb-8">
                    <button onclick="window.switchFeeTab('structures')" id="tab-btn-structures" class="tab-btn active text-sm font-medium">Manage Fees</button>
                    <button onclick="window.switchFeeTab('payments')" id="tab-btn-payments" class="tab-btn text-sm font-medium">Record Payments</button>
                </div>

                <div id="tab-fees-structures" class="tab-content active">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                        <h3 class="font-bold text-slate-800 mb-4">Create Fee Structure</h3>
                        <form id="fee-structure-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <input type="hidden" id="fee-structure-id" name="id">
                            <input type="text" id="fee-structure-name" name="name" placeholder="Fee Name (e.g. Tally Course Fee)" required class="w-full rounded-xl border-slate-200">
                            <select id="fee-course-select" name="course_id" class="w-full rounded-xl border-slate-200"></select>
                            <select id="fee-session-select" name="academic_session_id" required class="w-full rounded-xl border-slate-200"></select>
                            <input type="number" id="fee-total-amount" name="total_amount" placeholder="Amount (₹)" required class="w-full rounded-xl border-slate-200">
                            <input type="date" id="fee-due-date" name="due_date" required class="w-full rounded-xl border-slate-200">
                            <button type="submit" id="save-fee-structure-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2.5 rounded-xl md:col-span-2">Save Fee</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="fee-structure-table-body"></tbody></table></div>
                </div>

                <div id="tab-fees-payments" class="tab-content">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-8">
                        <h3 class="font-bold text-slate-800 mb-4">Receive Payment</h3>
                        <form id="payment-form" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <select id="payment-student-select" name="student_id" required class="w-full rounded-xl border-slate-200 md:col-span-2 font-medium p-3"></select>
                            <select id="payment-fee-structure-select" name="fee_structure_id" required class="w-full rounded-xl border-slate-200"></select>
                            <select id="payment-method" name="payment_method" required class="w-full rounded-xl border-slate-200"><option>Cash</option><option>Online</option></select>
                            <input type="number" id="payment-amount" name="amount_paid" placeholder="Amount Paid (₹)" required class="w-full rounded-xl border-emerald-500 text-emerald-700 font-bold">
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 rounded-xl md:col-span-2 shadow-lg shadow-emerald-100">Record & Print Receipt</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="fee-status-table-body"></tbody></table></div>
                </div>
            </div>

            <div id="content-fee-pending-report" class="content-section hidden">
                <header class="mb-6"><h1 class="text-3xl font-bold text-slate-900">Fee Pending Report</h1></header>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-100">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Student</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Balance</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Due Date</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Status</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Remind SMS</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Remind WA</th>
                            </tr>
                        </thead>
                        <tbody id="fee-pending-report-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-reports" class="content-section hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-slate-900">Reports</h2>
                    <select id="report-session-filter" onchange="window.refreshReports()" class="border-slate-200 rounded-xl py-2 px-4 font-medium"><option value="">All Time</option></select>
                </div>
                
                <div class="flex space-x-2 bg-white border border-slate-100 p-1.5 rounded-xl w-fit mb-6 shadow-sm">
                    <button onclick="window.switchReportTab('admissions')" id="tab-rep-admissions" class="px-5 py-2 rounded-lg font-bold bg-slate-100 text-slate-800 shadow-sm transition">Admissions</button>
                    <button onclick="window.switchReportTab('attendance')" id="tab-rep-attendance" class="px-5 py-2 rounded-lg font-medium text-slate-500 hover:text-slate-800 transition">Attendance</button>
                    <button onclick="window.switchReportTab('performance')" id="tab-rep-performance" class="px-5 py-2 rounded-lg font-medium text-slate-500 hover:text-slate-800 transition">Performance</button>
                </div>
                
                <div id="report-view-admissions" class="report-view"><div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="admissions-report-body"></tbody></table></div></div>
                <div id="report-view-attendance" class="report-view hidden"><div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="attendance-report-body"></tbody></table></div></div>
                <div id="report-view-performance" class="report-view hidden"><div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="min-w-full"><tbody id="performance-report-body"></tbody></table></div></div>
            </div>

            <div id="content-bulk-upload" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Bulk Upload</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 text-center">
                    <form id="bulk-upload-form" class="max-w-md mx-auto">
                        <div class="border-2 border-dashed border-slate-300 rounded-2xl p-8 mb-6">
                            <span class="material-symbols-outlined text-4xl text-slate-400 mb-2">cloud_upload</span>
                            <p class="text-slate-500 mb-4">Select CSV file to upload</p>
                            <input type="file" id="bulk-file-input" name="file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <button type="submit" class="bg-primary text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-200">Upload Data</button>
                    </form>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    let allUsersCache = [], allCoursesCache = [], allSessionsCache = [];

    // --- GLOBAL FUNCTIONS ---
    window.switchFeeTab = function(tabName) {
        document.getElementById('tab-fees-structures').classList.remove('active');
        document.getElementById('tab-fees-payments').classList.remove('active');
        document.getElementById('tab-btn-structures').className = "tab-btn text-sm font-medium cursor-pointer";
        document.getElementById('tab-btn-payments').className = "tab-btn text-sm font-medium cursor-pointer";
        document.getElementById(`tab-fees-${tabName}`).classList.add('active');
        document.getElementById(`tab-btn-${tabName}`).className = "tab-btn active text-sm font-medium cursor-pointer";
    }

    window.switchReportTab = function(reportName) {
        document.querySelectorAll('.report-view').forEach(el => el.classList.add('hidden'));
        document.getElementById(`report-view-${reportName}`).classList.remove('hidden');
        ['admissions', 'attendance', 'performance'].forEach(r => document.getElementById(`tab-rep-${r}`).className = "px-5 py-2 rounded-lg font-medium text-slate-500 hover:text-slate-800 transition");
        document.getElementById(`tab-rep-${reportName}`).className = "px-5 py-2 rounded-lg font-bold bg-slate-100 text-slate-800 shadow-sm transition";
    }

    // --- COMMUNICATION FUNCTIONS (RESTORED) ---
    window.sendQuickSms = async (id, name) => {
        if(!confirm(`Send SMS reminder to ${name}?`)) return;
        try {
            const res = await fetch(`${API_BASE_URL}/send_sms/${id}`, {method: 'POST', credentials: 'include'});
            if(res.ok) alert("SMS Sent Successfully!"); else alert("Failed to send SMS.");
        } catch(e) { console.error(e); alert("Error sending SMS"); }
    };

    window.sendQuickWhatsapp = async (id, name) => {
        if(!confirm(`Send WhatsApp reminder to ${name}?`)) return;
        try {
            const res = await fetch(`${API_BASE_URL}/send_whatsapp/${id}`, {method: 'POST', credentials: 'include'});
            if(res.ok) alert("WhatsApp Sent Successfully!"); else alert("Failed to send WhatsApp.");
        } catch(e) { console.error(e); alert("Error sending WhatsApp"); }
    };

    window.sendFeeAlert = async (id) => {
        if(!confirm("Send Fee Pending SMS?")) return;
        try {
            // Using a generic SMS endpoint. If you have a specific fee endpoint, update this path.
            const res = await fetch(`${API_BASE_URL}/send_sms/${id}?type=fee`, {method: 'POST', credentials: 'include'});
            if(res.ok) alert("Fee Reminder SMS Sent!"); else alert("Failed to send.");
        } catch(e) { console.error(e); alert("Error sending SMS"); }
    };

    window.sendFeeReminderWhatsapp = async (id, name) => {
        if(!confirm(`Send Fee Pending WhatsApp to ${name}?`)) return;
        try {
            const res = await fetch(`${API_BASE_URL}/send_whatsapp/${id}?type=fee`, {method: 'POST', credentials: 'include'});
            if(res.ok) alert("Fee Reminder WhatsApp Sent!"); else alert("Failed to send.");
        } catch(e) { console.error(e); alert("Error sending WhatsApp"); }
    };

    // --- FETCH STUDENTS (Fixed Filtering & Photo) ---
    window.fetchStudents = async function(term = '') {
        const tbody = document.getElementById('student-table-body');
        tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-400">Loading...</td></tr>';
        
        term = term || document.getElementById('student-search-input')?.value || '';
        const sessionSelect = document.getElementById('student-session-filter');
        const courseSelect = document.getElementById('student-course-filter');
        
        const sessionId = sessionSelect ? sessionSelect.value : '';
        const courseId = courseSelect ? courseSelect.value : '';

        if(!allUsersCache.length) {
             const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
             allUsersCache = await res.json();
        }
        
        let sessionStart = null, sessionEnd = null;
        if (sessionId && allSessionsCache.length) {
            const sess = allSessionsCache.find(s => s.id == sessionId);
            if(sess) { sessionStart = new Date(sess.start_date); sessionEnd = new Date(sess.end_date); }
        }

        const filtered = allUsersCache.filter(s => {
            if (s.role !== 'student') return false;
            
            const matchText = s.name.toLowerCase().includes(term.toLowerCase()) || 
                              (s.email||'').toLowerCase().includes(term.toLowerCase()) ||
                              (s.phone_number||'').includes(term);
            if (!matchText) return false;

            if (sessionStart && sessionEnd) {
                const joined = new Date(s.created_at);
                if (joined < sessionStart || joined > sessionEnd) return false;
            }
            
            if (courseId) {
                if (!s.course_ids || !s.course_ids.includes(parseInt(courseId))) return false;
            }
            return true;
        });

        if(!filtered.length) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-400">No students found matching filters.</td></tr>'; return; }

        tbody.innerHTML = filtered.map(s => {
            const photoUrl = s.profile_photo_url ? `${API_ORIGIN}${s.profile_photo_url}` : `https://placehold.co/100x100/f1f5f9/64748b?text=${s.name.charAt(0)}`;
            return `
            <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-4">
                        <img src="${photoUrl}" class="w-10 h-10 rounded-full object-cover border border-slate-200">
                        <div><div class="font-bold text-slate-900">${s.name}</div><div class="text-xs text-slate-500">${s.email}</div></div>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-600">${s.phone_number||'-'}</td>
                <td class="px-6 py-4 text-sm text-slate-500">${s.created_at.split(' ')[0]}</td>
                <td class="px-6 py-4 text-center flex justify-center gap-2">
                    <button onclick="sendQuickSms(${s.id}, '${s.name}')" class="w-8 h-8 rounded-full bg-amber-50 text-amber-500 hover:bg-amber-100 flex items-center justify-center transition" title="SMS"><span class="material-symbols-outlined text-lg">sms</span></button>
                    <button onclick="sendQuickWhatsapp(${s.id}, '${s.name}')" class="w-8 h-8 rounded-full bg-green-50 text-green-600 hover:bg-green-100 flex items-center justify-center transition" title="WhatsApp"><span class="material-symbols-outlined text-lg">chat</span></button>
                </td>
                <td class="px-6 py-4 text-right">
                    <button onclick="editUser(${s.id}, 'student')" class="text-primary hover:text-blue-700 font-medium text-sm mr-3">Edit</button>
                    <button onclick="deleteUser(${s.id})" class="text-rose-500 hover:text-rose-700 font-medium text-sm">Delete</button>
                </td>
            </tr>`;
        }).join('');
    }

    // --- FEE PENDING REPORT (Fixed Buttons) ---
    async function fetchFeePendingReport() {
        const tbody = document.getElementById('fee-pending-report-body');
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">Loading pending fees...</td></tr>';

        try {
            const list = await (await fetch(`${API_BASE_URL}/reports/fee_pending`, {credentials:'include'})).json();
            
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">No pending fees found.</td></tr>'; return; }
            
            if(!allUsersCache.length) {
                const res = await fetch(`${API_BASE_URL}/users`, {credentials:'include'});
                allUsersCache = await res.json();
            }

            tbody.innerHTML = list.map(s => {
                const user = allUsersCache.find(u => u.id === s.student_id);
                const photoUrl = user && user.profile_photo_url ? `${API_ORIGIN}${user.profile_photo_url}` : `https://placehold.co/100x100/f1f5f9/64748b?text=${s.student_name.charAt(0)}`;
                const isOverdue = s.pending_days < 0;
                
                return `
                <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                    <td class="px-6 py-4">
                         <div class="flex items-center gap-3">
                            <img src="${photoUrl}" class="w-10 h-10 rounded-full object-cover border border-slate-200">
                            <span class="font-bold text-slate-800">${s.student_name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-rose-600 font-bold">₹${s.balance}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${s.due_date}</td>
                    <td class="px-6 py-4 text-xs font-bold ${isOverdue ? 'text-rose-500' : 'text-slate-500'}">
                        ${isOverdue ? `${Math.abs(s.pending_days)} Days Overdue` : `${s.pending_days} Days Left`}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="sendFeeAlert(${s.student_id})" class="text-amber-500 hover:text-amber-600 hover:bg-amber-50 p-2 rounded-full transition"><span class="material-symbols-outlined">sms</span></button>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="sendFeeReminderWhatsapp(${s.student_id}, '${s.student_name}')" class="text-green-600 hover:text-green-700 hover:bg-green-50 p-2 rounded-full transition"><span class="material-symbols-outlined">chat</span></button>
                    </td>
                </tr>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    // --- MAIN INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        const sections = document.querySelectorAll('.content-section');
        
        function showSection(hash) {
            sections.forEach(s => s.classList.add('hidden'));
            const id = hash.substring(1) || 'dashboard';
            document.getElementById(`content-${id}`)?.classList.remove('hidden');
            loadContent(id);
        }
        window.addEventListener('hashchange', () => showSection(window.location.hash));

        async function loadContent(id) {
            if(id === 'dashboard') fetchDashboard();
            if(id === 'students') { await fetchStudents(); populateDropdowns(); }
            if(id === 'teachers') fetchTeachers();
            if(id === 'parents') fetchParents();
            if(id === 'courses') fetchCourses();
            if(id === 'sessions') fetchSessions();
            if(id === 'fees') { fetchFees(); fetchFeeStatus(); fetchSessions(); populateFeeCourseDropdown(); }
            if(id === 'fee-pending-report') fetchFeePendingReport();
            if(id === 'reports') { populateSessionFilters(); window.refreshReports(); }
            if(id === 'announcements') fetchAnnouncements(true);
        }

        try {
            const res = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: 'include'});
            const data = await res.json();
            if(!data.logged_in || data.user.role !== 'admin') window.location.href = '/';
            else {
                await fetchSessions();
                await populateSessionFilters();
                showSection(window.location.hash);
            }
        } catch { window.location.href = '/'; }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch(`${API_BASE_URL}/logout`, {method:'POST', credentials:'include'});
            window.location.href = '/';
        });

        setupForms(); 
    });

    // --- HELPER FUNCTIONS ---
    async function fetchSessions() {
        const res = await fetch(`${API_BASE_URL}/sessions`, {credentials:'include'});
        allSessionsCache = await res.json();
        const tbody = document.getElementById('session-table-body');
        if(tbody) tbody.innerHTML = allSessionsCache.map(s => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${s.name}</td><td class="p-6 text-slate-600">${s.start_date}</td><td class="p-6 text-slate-600">${s.end_date}</td><td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${s.status==='Active'?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-500'}">${s.status}</span></td><td class="p-6 text-right"><button onclick="deleteData('sessions', ${s.id})" class="text-rose-500 hover:text-rose-700 font-medium">Delete</button></td></tr>`).join('');
    }

    async function populateSessionFilters() {
        const filters = [document.getElementById('student-session-filter'), document.getElementById('report-session-filter')];
        const opts = '<option value="">All Time (History)</option>' + allSessionsCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        filters.forEach(f => { if(f) f.innerHTML = opts; });
    }

    async function fetchDashboard() {
        const users = await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json();
        allUsersCache = users;
        document.getElementById('total-students').textContent = users.filter(u=>u.role==='student').length;
        document.getElementById('total-teachers').textContent = users.filter(u=>u.role==='teacher').length;
        document.getElementById('total-parents').textContent = users.filter(u=>u.role==='parent').length;
        document.getElementById('total-courses').textContent = (await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json()).length;
        fetchAnnouncements(false);
    }

    async function populateDropdowns() {
        const courses = await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json();
        allCoursesCache = courses;
        
        const parents = await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json();
        const parentList = parents.filter(u => u.role === 'parent');
        
        document.getElementById('student-course-select').innerHTML = '<option value="">Select Course</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        document.getElementById('student-parent-select').innerHTML = '<option value="">Link Parent (Optional)</option>' + parentList.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

        const filterSelect = document.getElementById('student-course-filter');
        if(filterSelect) filterSelect.innerHTML = '<option value="">All Courses</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function populateFeeCourseDropdown() {
        const courses = await (await fetch(`${API_BASE_URL}/courses`, {credentials: 'include'})).json();
        document.getElementById('fee-course-select').innerHTML = '<option value="">Global (All Students)</option>' + courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function fetchFees() {
        const list = await (await fetch(`${API_BASE_URL}/fee_structures`, {credentials:'include'})).json();
        document.getElementById('fee-structure-table-body').innerHTML = list.map(f => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${f.name}</td><td class="p-6 text-sm text-slate-600">${f.course_name||'Global'}</td><td class="p-6 font-bold text-slate-800">₹${f.total_amount}</td><td class="p-6 text-sm text-slate-500">${f.due_date}</td><td class="p-6 text-right"><button onclick="deleteData('fee_structures', ${f.id})" class="text-rose-500 hover:text-rose-700 font-medium">Delete</button></td></tr>`).join('');
        
        document.getElementById('fee-session-select').innerHTML = allSessionsCache.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('payment-fee-structure-select').innerHTML = list.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
        
        const students = await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json();
        document.getElementById('payment-student-select').innerHTML = students.filter(u=>u.role==='student').map(s=>`<option value="${s.id}">${s.name} (${s.email})</option>`).join('');
    }

    async function fetchFeeStatus() {
        const list = await (await fetch(`${API_BASE_URL}/fee_status`, {credentials:'include'})).json();
        document.getElementById('fee-status-table-body').innerHTML = list.map(s => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${s.student_name}</td><td class="p-6 font-bold ${s.balance>0?'text-rose-500':'text-emerald-500'}">₹${s.balance}</td><td class="p-6"><span class="px-3 py-1 rounded-full text-xs font-bold ${s.balance>0?'bg-rose-100 text-rose-600':'bg-emerald-100 text-emerald-600'}">${s.balance>0?'Pending':'Paid'}</span></td><td class="p-6 text-right"><button onclick="window.open('${API_BASE_URL}/receipt/${s.latest_payment_id}', '_blank')" class="text-primary hover:underline font-medium">Print Receipt</button></td></tr>`).join('');
    }

    async function fetchAdmissionsReport() {
        const tbody = document.getElementById('admissions-report-body');
        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">Loading...</td></tr>';
        
        const sessionSelect = document.getElementById('report-session-filter');
        let sessionStart = null, sessionEnd = null;
        if (sessionSelect && sessionSelect.value) {
            const sess = allSessionsCache.find(s => s.id == sessionSelect.value);
            if(sess) { sessionStart = new Date(sess.start_date); sessionEnd = new Date(sess.end_date); }
        }

        try {
            if(!allUsersCache.length) allUsersCache = await (await fetch(`${API_BASE_URL}/users`, {credentials: 'include'})).json();
            const admissions = allUsersCache.filter(s => {
                if (s.role !== 'student') return false;
                if (sessionStart && sessionEnd) {
                    const joined = new Date(s.created_at);
                    if (joined < sessionStart || joined > sessionEnd) return false;
                }
                return true; 
            });

            if (admissions.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-400">No admissions found for this session.</td></tr>`; return; }
            
            tbody.innerHTML = admissions.map(a => {
                const photoUrl = a.profile_photo_url ? `${API_ORIGIN}${a.profile_photo_url}` : `https://placehold.co/100x100/f1f5f9/64748b?text=${a.name.charAt(0)}`;
                return `
                <tr class="border-b border-slate-50 hover:bg-slate-50">
                    <td class="px-6 py-4 w-16"><img src="${photoUrl}" class="w-10 h-10 rounded-full object-cover border border-slate-200"></td>
                    <td class="px-6 py-4 font-bold text-slate-900">${a.name}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${a.email}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${a.created_at}</td>
                </tr>`;
            }).join('');
        } catch (error) { console.error(error); }
    }
    window.refreshReports = function() { fetchAdmissionsReport(); }

    // --- FORM SETUP (FIXED) ---
    function setupForms() {
        const forms = { 'student-form': '/users', 'teacher-form': '/users', 'parent-form': '/users', 'course-form': '/courses', 'session-form': '/sessions', 'announcement-form': '/announcements', 'fee-structure-form': '/fee_structures', 'payment-form': '/payments' };
        
        Object.keys(forms).forEach(id => {
            document.getElementById(id)?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                
                if(id==='student-form' && formData.get('id') && document.getElementById('student-photo-file-input').files.length) {
                   const pData = new FormData(); pData.append('profile_photo_file', formData.get('profile_photo_file'));
                   await fetch(`${API_BASE_URL}/user/upload_photo/${formData.get('id')}`, {method:'POST', credentials:'include', body:pData});
                   formData.delete('profile_photo_file');
                }
                if(!formData.get('password')) formData.delete('password');

                let body, headers={};
                if(id.includes('student') || id.includes('teacher') || id.includes('parent')) body = formData; 
                else { body = JSON.stringify(Object.fromEntries(formData)); headers={'Content-Type':'application/json'}; }

                const method = formData.get('id') ? 'PUT' : 'POST';
                const res = await fetch(`${API_BASE_URL}${forms[id]}`, {method, headers, credentials:'include', body});
                
                if(res.ok) { 
                    alert('Saved Successfully!'); form.reset(); 
                    if(id==='payment-form') { const d=await res.json(); if(d.payment_id) window.open(`${API_BASE_URL}/receipt/${d.payment_id}`, '_blank'); }
                    loadContent(window.location.hash.substring(1));
                } else alert('Error saving data');
            });
        });
    }

    // --- GENERIC EDIT/DELETE ---
    window.editUser = async (id, role) => {
        const u = (await (await fetch(`${API_BASE_URL}/users`,{credentials:'include'})).json()).find(x=>x.id===id);
        const f = document.getElementById(`${role}-form`);
        f.querySelector('[name="id"]').value = u.id;
        f.querySelector('[name="name"]').value = u.name;
        f.querySelector('[name="email"]').value = u.email;
        if(role==='student') {
            f.querySelector('[name="phone_number"]').value = u.phone_number||'';
            if(u.course_ids?.length) document.getElementById('student-course-select').value=u.course_ids[0];
        }
        window.scrollTo({top:0, behavior:'smooth'});
    };

    window.deleteUser = async (id) => { if(confirm('Are you sure you want to delete this user?')) { await fetch(`${API_BASE_URL}/users/${id}`, {method:'DELETE', credentials:'include'}); window.fetchStudents(); } };
    window.deleteData = async (type, id) => { if(confirm('Are you sure?')) { await fetch(`${API_BASE_URL}/${type}/${id}`, {method:'DELETE', credentials:'include'}); loadContent(window.location.hash.substring(1)); } };

    async function fetchTeachers() {
        const list = (await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json()).filter(u=>u.role==='teacher');
        document.getElementById('teacher-table-body').innerHTML = list.map(t => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${t.name}</td><td class="p-6 text-sm text-slate-600">${t.email}<br>${t.phone_number||''}</td><td class="p-6 text-right"><button onclick="editUser(${t.id}, 'teacher')" class="text-primary mr-3 font-medium text-sm">Edit</button><button onclick="deleteUser(${t.id})" class="text-rose-500 font-medium text-sm">Delete</button></td></tr>`).join('');
    }
    async function fetchParents() {
        const list = (await (await fetch(`${API_BASE_URL}/users`, {credentials:'include'})).json()).filter(u=>u.role==='parent');
        document.getElementById('parent-table-body').innerHTML = list.map(p => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${p.name}</td><td class="p-6 text-sm text-slate-600">${p.email}<br>${p.phone_number||''}</td><td class="p-6 text-right"><button onclick="editUser(${p.id}, 'parent')" class="text-primary mr-3 font-medium text-sm">Edit</button><button onclick="deleteUser(${p.id})" class="text-rose-500 font-medium text-sm">Delete</button></td></tr>`).join('');
    }
    async function fetchCourses() {
        const list = await (await fetch(`${API_BASE_URL}/courses`, {credentials:'include'})).json();
        document.getElementById('course-table-body').innerHTML = list.map(c => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${c.name}</td><td class="p-6 text-sm text-slate-600">${c.subjects}</td><td class="p-6 text-right"><button onclick="deleteData('courses', ${c.id})" class="text-rose-500 font-medium text-sm">Delete</button></td></tr>`).join('');
    }
    async function fetchAnnouncements(isManage) {
        const list = await (await fetch(`${API_BASE_URL}/announcements`, {credentials:'include'})).json();
        const tbody = document.getElementById(isManage ? 'management-announcements-body' : 'recent-announcements-body');
        tbody.innerHTML = list.map(a => `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-6 font-bold text-slate-800">${a.title}</td><td class="p-6 text-sm text-slate-600 truncate max-w-xs">${a.content}</td><td class="p-6 text-xs font-bold text-slate-400 uppercase">${a.target_group}</td><td class="p-6 text-sm text-slate-500">${a.created_at}</td><td class="p-6 text-right">${isManage ? `<button onclick="deleteData('announcements', ${a.id})" class="text-rose-500 font-medium text-sm">Delete</button>` : ''}</td></tr>`).join('');
    }

</script>
</body>
</html>
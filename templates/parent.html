<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#4F46E5' } } } }
    </script>
</head>
<body class="h-full text-slate-800">

<div class="flex h-full">
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col">
        <div class="h-16 flex items-center px-6 font-bold text-lg">Parent Portal</div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="#dashboard" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50"><span class="material-symbols-rounded mr-3">dashboard</span> Dashboard</a>
            <a href="#messages" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50"><span class="material-symbols-rounded mr-3">mail</span> Messages</a>
            <a href="#announcements" class="flex items-center px-4 py-3 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50"><span class="material-symbols-rounded mr-3">campaign</span> Announcements</a>
        </nav>
        <div class="p-4 border-t"><button id="logout-btn" class="w-full py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium">Logout</button></div>
    </aside>

    <main class="flex-1 overflow-auto p-8">
        <h1 class="text-2xl font-bold mb-2" id="parent-welcome">Welcome</h1>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-8 max-w-sm">
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Select Child</label>
            <select id="child-select" class="w-full p-2 border border-slate-300 rounded-lg"></select>
        </div>

        <div id="content-dashboard" class="content-section">
            <h2 id="child-dashboard-title" class="text-xl font-bold mb-4">Child Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                     <p class="text-sm text-slate-500">Fees Due</p>
                     <p id="fee-due" class="text-2xl font-bold text-slate-900 mt-1">₹0.00</p>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                     <p class="text-sm text-slate-500">Paid</p>
                     <p id="fee-paid" class="text-2xl font-bold text-green-600 mt-1">₹0.00</p>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                     <p class="text-sm text-slate-500">Balance</p>
                     <p id="fee-balance" class="text-2xl font-bold text-red-600 mt-1">₹0.00</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 bg-slate-50 font-bold text-sm">Attendance</div>
                    <table class="w-full text-sm"><tbody id="attendance-body"></tbody></table>
                </div>
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 bg-slate-50 font-bold text-sm">Recent Results</div>
                    <table class="w-full text-sm"><tbody id="grades-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="content-messages" class="content-section hidden">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-sm"><tbody id="messages-body"></tbody></table>
            </div>
        </div>
        
        <div id="content-announcements" class="content-section hidden">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-sm"><tbody id="announcements-table-body"></tbody></table>
            </div>
        </div>
    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script>
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';

    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('.content-section');
        
        function showSection(hash) {
            sections.forEach(s=>s.classList.add('hidden'));
            const id = hash.substring(1) || 'dashboard';
            document.getElementById(`content-${id}`).classList.remove('hidden');
            if(id === 'dashboard') { const sel = document.getElementById('child-select'); if(sel.value) fetchChildData(sel.value); }
            if(id === 'messages') loadMessages();
            if(id === 'announcements') fetchAnnouncements();
        }
        window.addEventListener('hashchange', () => showSection(window.location.hash));

        async function init() {
            try {
                const res = await fetch(`${API_ORIGIN}/api/check_session`, {credentials:'include'});
                const d = await res.json();
                if(!d.logged_in || d.user.role !== 'parent') window.location.href='/';
                
                document.getElementById('parent-welcome').textContent = `Welcome, ${d.user.name}`;
                
                // Load Children
                const cRes = await fetch(`${API_BASE_URL}/parent/children`, {credentials:'include'});
                const children = await cRes.json();
                const sel = document.getElementById('child-select');
                if(children.length) {
                    sel.innerHTML = children.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                    fetchChildData(children[0].id);
                } else {
                    sel.innerHTML = '<option>No children linked</option>';
                }
                
                sel.addEventListener('change', (e)=>fetchChildData(e.target.value));
                showSection(window.location.hash);
            } catch(e) { window.location.href='/'; }
        }
        
        async function fetchChildData(id) {
            const res = await fetch(`${API_BASE_URL}/parent/child_data/${id}`, {credentials:'include'});
            const d = await res.json();
            document.getElementById('child-dashboard-title').textContent = `${d.profile.name}'s Dashboard`;
            
            // Fees
            document.getElementById('fee-due').textContent = '₹' + (d.fees.total_due || 0);
            document.getElementById('fee-paid').textContent = '₹' + (d.fees.total_paid || 0);
            document.getElementById('fee-balance').textContent = '₹' + (d.fees.balance || 0);
            
            // Attendance
            document.getElementById('attendance-body').innerHTML = d.attendance.map(a=>`<tr><td class="px-6 py-4">${a.date}</td><td class="px-6 py-4">${a.status}</td></tr>`).join('') || '<tr><td class="px-6 py-4 text-center">No records</td></tr>';
            
            // Grades
            document.getElementById('grades-body').innerHTML = d.grades.map(g=>`<tr><td class="px-6 py-4">${g.course_name}</td><td class="px-6 py-4 font-bold">${g.marks_obtained}/${g.total_marks}</td></tr>`).join('') || '<tr><td class="px-6 py-4 text-center">No records</td></tr>';
        }
        
        async function loadMessages() {
             const res = await fetch(`${API_BASE_URL}/parent/messages`, {credentials:'include'});
             const d = await res.json();
             document.getElementById('messages-body').innerHTML = d.map(m=>`<tr><td class="px-6 py-4 font-bold">${m.sender_name}</td><td class="px-6 py-4">${m.content}</td></tr>`).join('');
        }
        
        async function fetchAnnouncements() {
             const res = await fetch(`${API_BASE_URL}/announcements`, {credentials:'include'});
             const d = await res.json();
             document.getElementById('announcements-table-body').innerHTML = d.filter(a=>['all','parents'].includes(a.target_group)).map(a=>`<tr><td class="px-6 py-4 font-bold">${a.title}</td><td class="px-6 py-4">${a.content}</td></tr>`).join('');
        }

        document.getElementById('logout-btn').onclick = async () => { await fetch(`${API_BASE_URL}/logout`, {method:'POST', credentials:'include'}); window.location.href='/'; };

        init();
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal</title>
    <link rel="manifest" href="/static/manifest.json">
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: { extend: { colors: { "primary": "#1173d4", "background-light": "#f6f7f8", "background-dark": "#101922" }, fontFamily: { "display": ["Inter"] } } },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Parent</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Parent Portal</p>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-1">
            <a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary">
                <span class="material-symbols-outlined">dashboard</span><span class="text-sm font-medium">Child Dashboard</span>
            </a>
            <a href="#messages" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">mail</span><span class="text-sm font-medium">Messages</span>
            </a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">campaign</span><span class="text-sm font-medium">Announcements</span>
            </a>
            <button id="install-app-btn" class="hidden w-full flex items-center gap-3 px-4 py-2 rounded-lg text-green-600 hover:bg-green-50 font-medium mt-4">
                <span class="material-symbols-outlined">download</span>
                <span class="text-sm">Install Mobile App</span>
            </button>
        </nav>
        <div class="p-6 border-t border-slate-200 dark:border-slate-800">
            <button id="logout-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-red-700 transition duration-150">Logout</button>
        </div>
    </aside>

    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8">
                <h1 id="parent-welcome" class="text-4xl font-bold text-slate-900 dark:text-white">Parent Dashboard</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2">Oversee your child's academic and financial status.</p>
            </header>

            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8 child-selector">
                <label for="child-select" class="text-lg font-bold mr-4">Select Child:</label>
                <select id="child-select" class="p-2 border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                    <option value="">Loading children...</option>
                </select>
            </div>

            <div id="content-dashboard" class="content-section">
                <h2 id="child-dashboard-title" class="text-3xl font-bold text-slate-900 dark:text-white mb-6"></h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 lg:col-span-1">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined">person</span> Profile</h2>
                        <p class="text-sm"><strong class="font-medium">Name:</strong> <span id="profile-name"></span></p>
                        <p class="text-sm"><strong class="font-medium">Email:</strong> <span id="profile-email"></span></p>
                        <p class="text-sm"><strong class="font-medium">Phone:</strong> <span id="profile-phone"></span></p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 lg:col-span-2">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><span class="material-symbols-outlined">payments</span> Fees</h2>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg"><p class="text-sm text-slate-500">Due</p><p id="fee-due" class="text-xl font-bold">₹0.00</p></div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg"><p class="text-sm text-slate-500">Paid</p><p id="fee-paid" class="text-xl font-bold text-green-600">₹0.00</p></div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg"><p class="text-sm text-slate-500">Balance</p><p id="fee-balance" class="text-xl font-bold text-red-600">₹0.00</p></div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-4">Recent Attendance</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <tbody id="attendance-body">
                                    <tr><td colspan="3" class="px-6 py-4 text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-4">Recent Results</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <tbody id="grades-body">
                                    <tr><td colspan="3" class="px-6 py-4 text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-messages" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Messages</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6"><table class="min-w-full"><tbody id="messages-body"></tbody></table></div>
            </div>
            
            <div id="content-announcements" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6">Announcements</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6"><table class="min-w-full"><tbody id="announcements-table-body"></tbody></table></div>
            </div>
        </div>
    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    
    // PWA Install Logic
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.classList.remove('hidden'); // Show button
    });
    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') installBtn.classList.add('hidden');
            deferredPrompt = null;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        // --- Navigation Logic ---
        const sections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        
        function showSection(hash) {
            sections.forEach(s => s.classList.add('hidden'));
            navLinks.forEach(l => l.classList.remove('bg-primary/10', 'text-primary'));
            
            let id = hash.substring(1) || 'dashboard';
            let el = document.getElementById(`content-${id}`);
            let link = document.querySelector(`.nav-link[href="#${id}"]`);
            
            if(el) el.classList.remove('hidden');
            if(link) link.classList.add('bg-primary/10', 'text-primary');
            
            // Trigger data fetch on navigation for the visible section
            if (id === 'messages') loadMessages();
            if (id === 'announcements') fetchAnnouncements();
            if (id === 'dashboard') {
                 const select = document.getElementById('child-select');
                 if (select.value) fetchChildData(select.value);
            }
        }
        
        window.addEventListener('hashchange', () => {
            showSection(window.location.hash);
        });
        showSection(window.location.hash);
        
        function resetTable(id, message = "No data available", cols = 3) {
            const tableBody = document.getElementById(id);
            // FIX: Ensure rows are visually reset to show status
            tableBody.innerHTML = `<tr><td colspan="${cols}" class="p-4 text-center text-red-500">${message}</td></tr>`;
        }

        // --- Auth & Data Loading ---
        async function checkParentSession() {
            try {
                const res = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: 'include'});
                const data = await res.json();
                if (!res.ok || !data.logged_in || data.user.role !== 'parent') {
                    window.location.href = API_ORIGIN + '/';
                } else {
                    document.getElementById('parent-welcome').textContent = `Welcome, ${data.user.name}!`;
                    // 1. Load Data First
                    await loadChildren();
                    
                    // 2. Then Initialize Firebase (Safe Mode)
                    setTimeout(initFirebase, 2000); 
                }
            } catch (error) {
                console.error("Parent session error:", error);
                // Fail safe: Redirect to login if initial check fails
                window.location.href = API_ORIGIN + '/';
            }
        }

        async function loadChildren() {
            try {
                const res = await fetch(`${API_BASE_URL}/parent/children`, {credentials: 'include'});
                
                if (!res.ok) {
                    // Expecting JSON error detail from backend (thanks to app.py robust handlers)
                    const err = await res.json();
                    throw new Error(err.message || `API Error: ${res.status}`);
                }
                
                const children = await res.json();
                const select = document.getElementById('child-select');
                select.innerHTML = '<option value="">Select your child...</option>';
                
                if (children.length === 0) {
                    select.innerHTML = '<option value="">No children linked to account.</option>';
                    resetTable('attendance-body', 'No children linked.');
                    resetTable('grades-body', 'No children linked.');
                    return;
                }
                
                children.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name}</option>`);
                
                // If only one child, auto-select and load data
                if (children.length === 1) {
                    select.value = children[0].id;
                    fetchChildData(children[0].id);
                }
                
                select.addEventListener('change', () => {
                    if(select.value) fetchChildData(select.value);
                });
            } catch (e) { 
                console.error("Load children error:", e);
                // FIX: Display red error message clearly for initial failure
                resetTable('attendance-body', `Error loading children list: ${e.message}`, 3);
                resetTable('grades-body', `Error loading children list: ${e.message}`, 3);
            }
        }

        async function fetchChildData(id) {
            // Display loading indicators
            resetTable('attendance-body', 'Loading attendance...');
            resetTable('grades-body', 'Loading results...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/parent/child_data/${id}`, {credentials: 'include'});
                
                if(!res.ok) {
                    // FIX: Ensure API error messages (like 500) are extracted and displayed
                    const err = await res.json();
                    throw new Error(err.message || `API Error: ${res.status}`);
                }
                
                const data = await res.json();
                
                // Update profile and title
                document.getElementById('child-dashboard-title').textContent = `${data.profile.name}'s Dashboard`;
                document.getElementById('profile-name').textContent = data.profile.name;
                document.getElementById('profile-email').textContent = data.profile.email;
                document.getElementById('profile-phone').textContent = data.profile.phone_number || 'N/A';
                
                // Update Fees
                document.getElementById('fee-due').textContent = `₹${data.fees.total_due.toFixed(2)}`;
                document.getElementById('fee-paid').textContent = `₹${data.fees.total_paid.toFixed(2)}`;
                document.getElementById('fee-balance').textContent = `₹${data.fees.balance.toFixed(2)}`;
                
                // Populate Attendance Table
                const attBody = document.getElementById('attendance-body');
                if (data.attendance.length === 0) {
                    resetTable('attendance-body', 'No attendance records.', 3);
                } else {
                    attBody.innerHTML = data.attendance.map(r => `
                        <tr>
                            <td class="p-2 border-b text-sm">${r.date}</td>
                            <td class="p-2 border-b text-sm">${r.time}</td>
                            <td class="p-2 border-b text-sm font-medium ${r.status === 'Present' ? 'text-green-600' : 'text-red-600'}">${r.status}</td>
                        </tr>
                    `).join('');
                }
                
                // Populate Grades Table
                const gradeBody = document.getElementById('grades-body');
                if (data.grades.length === 0) {
                    resetTable('grades-body', 'No assessment results.', 3);
                } else {
                    gradeBody.innerHTML = data.grades.map(g => {
                        const score = g.marks_obtained / g.total_marks;
                        const percentage = isNaN(score) ? 'N/A' : (score * 100).toFixed(0) + '%';
                        return `
                            <tr>
                                <td class="p-2 border-b text-sm">${g.course_name}</td>
                                <td class="p-2 border-b text-sm">${g.assessment_name}</td>
                                <td class="p-2 border-b text-sm">${g.marks_obtained} / ${g.total_marks} (${percentage})</td>
                            </tr>
                        `;
                    }).join('');
                }
                
            } catch (e) { 
                console.error("Fetch Child Data Error:", e);
                // FIX: If data load fails, display the API error message clearly
                resetTable('attendance-body', `Data loading failed: ${e.message}`, 3);
                resetTable('grades-body', `Data loading failed: ${e.message}`, 3);
            }
        }

        async function loadMessages() {
            const tableBody = document.getElementById('messages-body');
            resetTable('messages-body', 'Loading messages...', 4);
            try {
                 const res = await fetch(`${API_BASE_URL}/parent/messages`, {credentials: 'include'});
                 
                 if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || `API Error: ${res.status}`);
                 }
                 
                 const messages = await res.json();
                 
                 if (messages.length === 0) {
                     resetTable('messages-body', 'No messages found.', 4);
                     return;
                 }
                 
                 tableBody.innerHTML = messages.map(m => `
                    <tr>
                        <td class="p-2 border-b font-medium">${m.sender_name}</td>
                        <td class="p-2 border-b text-sm text-slate-500 max-w-md truncate">${m.content}</td>
                        <td class="p-2 border-b text-sm text-slate-500">${m.sent_at.split(' ')[0]}</td>
                    </tr>
                 `).join('');
                 
            } catch (e) {
                 console.error("Load messages error:", e);
                 resetTable('messages-body', `Error loading messages: ${e.message}`, 4);
            }
        }
        
        async function fetchAnnouncements() {
            const tableBody = document.getElementById('announcements-table-body');
            resetTable('announcements-table-body', 'Loading announcements...', 3);
            try {
                const response = await fetch(`${API_BASE_URL}/announcements`, {credentials: 'include'});
                
                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(errorDetails.message || `API Error: ${response.status}`);
                }
                
                const announcements = await response.json();
                
                const relevant = announcements.filter(a => a.target_group === 'all' || a.target_group === 'parents');
                
                if (relevant.length === 0) { 
                    resetTable('announcements-table-body', 'No announcements for parents.', 3);
                    return; 
                }
                
                tableBody.innerHTML = relevant.map(a => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${a.title}</td>
                        <td class="px-6 py-4 text-sm text-slate-500 max-w-lg truncate">${a.content}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${a.created_at.split(' ')[0]}</td>
                    </tr>
                `).join('');
                
            } catch(e) { 
                console.error("Announcements load error:", e); 
                resetTable('announcements-table-body', `Error loading announcements: ${e.message}`, 3);
            }
        }


        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch(`${API_BASE_URL}/logout`, {method: 'POST', credentials: 'include'});
            window.location.href = API_ORIGIN + '/';
        });

        checkParentSession();
    });

    // --- FIREBASE ---
    function initFirebase() {
        try {
            // PASTE YOUR CONFIG HERE
            const firebaseConfig = {
                apiKey: "AIzaSyBkZEHM9fXRoCYSgEW-hk_lN7sL_nSLDfU",
                authDomain: "cst-institute-app.firebaseapp.com",
                projectId: "cst-institute-app",
                storageBucket: "cst-institute-app.firebasestorage.app",
                messagingSenderId: "485166460200",
                appId: "1:485166460200:web:4eae20e2010ab92baeb41d"
            };
            firebase.initializeApp(firebaseConfig);
            const messaging = firebase.messaging();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/firebase-messaging-sw.js').then((reg) => {
                    Notification.requestPermission().then((perm) => {
                        if (perm === 'granted') {
                            // PASTE YOUR VAPID KEY HERE
                            return messaging.getToken({ vapidKey: 'BBOMxvKvbEs_t9ykKBa2zIewzCzD6FCbm9rxc8a9eWl2kjjH5vyTSH6TeQMksZ_OGl5jZyQpU2wBcf-KsZN1uko', serviceWorkerRegistration: reg });
                        }
                    }).then((token) => {
                        if(token) fetch('/api/save_fcm_token', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token})});
                    });
                });
            }
        } catch(e) { console.log("Firebase Error (Notifications disabled):", e); }
    }
</script>
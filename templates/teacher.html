<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - CST Institute</title>
    
    <link rel="manifest" href="/static/manifest.json">

    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "primary-hover": "#0e5ea8",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1173d4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 antialiased">

<div class="flex h-screen overflow-hidden">
    
    <aside class="w-64 bg-surface-light dark:bg-surface-dark border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg z-20">
        <div class="p-6 border-b border-slate-100 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-xl">T</div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">Teacher Portal</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400">CST Institute</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto scrollbar-thin">
            <a href="#dashboard" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">dashboard</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">Dashboard</span>
            </a>
            
            <a href="#courses" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">book</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">My Courses</span>
            </a>
            
            <a href="#attendance" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">fact_check</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">Mark Attendance</span>
            </a>

            <a href="#syllabus" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">menu_book</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">Syllabus Tracker</span>
            </a>

            <a href="#assignments" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">assignment</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">Assignments</span>
            </a>
            
            <a href="#notes" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">upload_file</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">Share Notes</span>
            </a>
            
            <a href="#reports" class="nav-link group flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-primary/5 dark:hover:bg-primary/10">
                <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">analytics</span>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-primary dark:group-hover:text-primary-400">Student Reports</span>
            </a>

            <button id="install-app-btn" class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-green-50 text-green-700 hover:bg-green-100 transition-colors mt-4">
                <span class="material-symbols-outlined">download</span>
                <span class="text-sm font-medium">Install App</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-200 dark:border-slate-800">
            <button id="logout-btn" class="flex items-center justify-center gap-2 w-full bg-red-50 text-red-600 hover:bg-red-100 font-medium py-2.5 px-4 rounded-lg text-sm transition duration-150">
                <span class="material-symbols-outlined text-lg">logout</span>
                Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark p-4 md:p-8">
        <div class="max-w-6xl mx-auto space-y-8">
            
            <header class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white" id="page-title">Dashboard</h1>
                    <p class="text-slate-500 dark:text-slate-400 mt-1" id="welcome-message">Welcome back, Teacher.</p>
                </div>
                <div class="hidden md:block">
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full dark:bg-blue-900 dark:text-blue-200">Instructor Account</span>
                </div>
            </header>

            <div id="content-dashboard" class="content-section animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-blue-50 text-blue-600 rounded-xl dark:bg-blue-900/30 dark:text-blue-400">
                                <span class="material-symbols-outlined">book</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Assigned Courses</p>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="total-my-courses">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-emerald-50 text-emerald-600 rounded-xl dark:bg-emerald-900/30 dark:text-emerald-400">
                                <span class="material-symbols-outlined">groups</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Students</p>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="total-my-students">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-purple-50 text-purple-600 rounded-xl dark:bg-purple-900/30 dark:text-purple-400">
                                <span class="material-symbols-outlined">description</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Shared Notes</p>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="total-shared-notes">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                        <h3 class="font-bold text-slate-900 dark:text-white">My Weekly Timetable</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Day</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">10:00 AM - 12:00 PM</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">02:00 PM - 04:00 PM</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-surface-dark divide-y divide-slate-200 dark:divide-slate-700 text-sm">
                                <tr><td class="px-6 py-4 font-medium">Monday</td><td class="px-6 py-4">Java Programming</td><td class="px-6 py-4">C++ Basics</td></tr>
                                <tr><td class="px-6 py-4 font-medium">Tuesday</td><td class="px-6 py-4">Python Advanced</td><td class="px-6 py-4">Java Programming</td></tr>
                                <tr><td class="px-6 py-4 font-medium">Wednesday</td><td class="px-6 py-4">C++ Basics</td><td class="px-6 py-4">Tally Prime</td></tr>
                                <tr><td class="px-6 py-4 font-medium">Thursday</td><td class="px-6 py-4">Tally Prime</td><td class="px-6 py-4">Python Advanced</td></tr>
                                <tr><td class="px-6 py-4 font-medium">Friday</td><td class="px-6 py-4">Java Lab</td><td class="px-6 py-4">C++ Lab</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-courses" class="content-section hidden animate-fade-in">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Assigned Subjects</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Course Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjects / Topics</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-courses-body" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-surface-dark">
                                <tr><td colspan="2" class="px-6 py-8 text-center text-slate-500">Loading courses...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-attendance" class="content-section hidden animate-fade-in">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700 mb-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Step 1: Select Class</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="attendance-course-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Course</label>
                            <select id="attendance-course-select" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-primary focus:border-primary">
                                <option value="">-- Choose Course --</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Only students in this course will appear.</p>
                        </div>
                        <div>
                            <label for="attendance-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Select Date</label>
                            <input type="date" id="attendance-date" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-primary focus:border-primary">
                        </div>
                        <div class="flex items-end">
                            <div class="text-sm text-slate-500 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg w-full">
                                <span class="font-bold text-blue-600">Tip:</span> Ensure you select the correct course to avoid mixing students.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm overflow-hidden border border-slate-100 dark:border-slate-700 mb-6">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200">Student List</h3>
                        <div class="space-x-2">
                            <button id="mark-present-btn" disabled class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200 disabled:opacity-50 disabled:cursor-not-allowed transition">Mark Selected Present</button>
                            <button id="mark-absent-btn" disabled class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition">Mark Selected Absent</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-800">
                                <tr>
                                    <th class="px-6 py-3 text-left w-16">
                                        <input type="checkbox" id="select-all-students" class="rounded border-slate-300 text-primary focus:ring-primary" disabled>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Current Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-surface-dark">
                                <tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">Please select a course to load students.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end pb-8">
                    <button id="submit-attendance-btn" disabled class="bg-primary text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-200 dark:shadow-none hover:bg-primary-hover transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span class="material-symbols-outlined">save</span>
                        Submit Attendance
                    </button>
                </div>
            </div>

            <div id="content-syllabus" class="content-section hidden animate-fade-in">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700">
                    <h3 class="text-xl font-bold mb-4">Daily Syllabus Log</h3>
                    <form class="space-y-4" onsubmit="event.preventDefault(); alert('Syllabus log saved (Mock)!');">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Course</label>
                                <select id="syllabus-course-select" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm">
                                    <option value="">-- Choose Course --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Date</label>
                                <input type="date" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Topics Covered Today</label>
                            <textarea rows="3" placeholder="e.g. Introduction to Loops, While Loop syntax..." class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm"></textarea>
                        </div>
                        <button class="bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-primary-hover">Save Log</button>
                    </form>
                </div>
            </div>

            <div id="content-assignments" class="content-section hidden animate-fade-in">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700 mb-6">
                    <div class="flex items-end gap-4">
                        <div class="w-full md:w-1/2">
                            <label class="block text-sm font-medium mb-2">Select Course to View Students</label>
                            <select id="assignment-course-select" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm">
                                <option value="">-- Choose Course --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm overflow-hidden border border-slate-100 dark:border-slate-700">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-800">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Student Name</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Assignment Status</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody id="assignment-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <tr><td colspan="3" class="px-6 py-8 text-center text-slate-500">Select a course to track assignments.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-notes" class="content-section hidden animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 border border-slate-100 dark:border-slate-700 sticky top-4">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Upload Material</h3>
                            <form id="upload-note-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Title</label>
                                    <input type="text" name="title" required class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-sm focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Course</label>
                                    <select id="note-course-select" name="course_id" required class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-sm focus:ring-primary"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Description</label>
                                    <textarea name="description" rows="3" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-sm focus:ring-primary"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">File</label>
                                    <input type="file" id="note-file" name="file" required accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                                    <p class="text-xs text-slate-400 mt-1">Max size: 16MB</p>
                                </div>
                                <button type="submit" id="upload-note-btn" class="w-full bg-primary text-white font-bold py-2.5 rounded-lg hover:bg-primary-hover transition shadow-md">Upload Note</button>
                            </form>
                            <div id="upload-progress" class="hidden mt-4">
                                <div class="w-full bg-slate-200 rounded-full h-1.5"><div id="upload-bar" class="bg-green-500 h-1.5 rounded-full" style="width: 0%"></div></div>
                                <p id="upload-status" class="text-xs text-center mt-1 text-slate-500">Uploading...</p>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                            <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                                <h3 class="font-bold text-slate-900 dark:text-white">My Uploaded Notes</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                    <thead class="bg-slate-50 dark:bg-slate-800">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Title</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Course</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Date</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacher-notes-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                                        <tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">No notes found.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-reports" class="content-section hidden animate-fade-in">
                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm p-6 mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white">Student Reports</h2>
                        <p class="text-sm text-slate-500">Filter by course to see reports.</p>
                    </div>
                    <div class="w-full md:w-64">
                        <label for="report-course-select" class="block text-xs font-bold uppercase text-slate-400 mb-1">Filter by Course</label>
                        <select id="report-course-select" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm">
                            <option value="">Show All Students</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm overflow-hidden border border-slate-100 dark:border-slate-700">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Photo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Attendance</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Quick Remarks & Message</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-reports-body" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-surface-dark">
                                <tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">Loading reports...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<div id="notify-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true" id="modal-backdrop"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white dark:bg-surface-dark rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="px-6 py-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2" id="notify-modal-title">Send Message</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Send a notification directly to this student.</p>
                
                <form class="space-y-4">
                    <input type="hidden" id="notify-student-id">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Subject</label>
                        <input type="text" id="notify-subject" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Message Body</label>
                        <textarea id="notify-body" rows="4" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-primary"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Channel</label>
                        <select id="notify-type" class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-primary">
                            <option value="portal">App Notification</option>
                            <option value="sms">SMS</option>
                            <option value="whatsapp">WhatsApp (Direct Link)</option>
                            <option value="email">Email</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex flex-row-reverse gap-3">
                <button type="button" id="send-notify-btn" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-hover sm:text-sm transition">Send Message</button>
                <button type="button" id="cancel-notify-btn" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 sm:text-sm dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600 dark:hover:bg-slate-600 transition">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
    // --- APP CONFIGURATION ---
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    
    // --- CACHE ---
    let allTeacherCourses = [];
    let allTeacherStudents = [];
    let currentAttendanceStatus = {};
    let reportData = []; 

    // --- PWA INSTALL ---
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(installBtn) installBtn.classList.remove('hidden');
    });
    if(installBtn) {
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') installBtn.classList.add('hidden');
                deferredPrompt = null;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const logoutBtn = document.getElementById('logout-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageTitle = document.getElementById('page-title');
        
        // Attendance Elements
        const attendanceCourseSelect = document.getElementById('attendance-course-select');
        const attendanceDateInput = document.getElementById('attendance-date');
        const markPresentBtn = document.getElementById('mark-present-btn');
        const markAbsentBtn = document.getElementById('mark-absent-btn');
        const submitAttendanceBtn = document.getElementById('submit-attendance-btn');
        const selectAllCheckbox = document.getElementById('select-all-students');
        
        // Note Elements
        const uploadNoteForm = document.getElementById('upload-note-form');
        const noteCourseSelect = document.getElementById('note-course-select');
        
        // Syllabus/Assignments/Report Elements
        const syllabusCourseSelect = document.getElementById('syllabus-course-select');
        const assignmentCourseSelect = document.getElementById('assignment-course-select');
        const reportCourseSelect = document.getElementById('report-course-select');
        
        // Modal Elements
        const notifyModal = document.getElementById('notify-modal');
        const notifyBackdrop = document.getElementById('modal-backdrop');
        const sendNotifyBtn = document.getElementById('send-notify-btn');
        const cancelNotifyBtn = document.getElementById('cancel-notify-btn');

        // --- NAVIGATION LOGIC ---
        function showSection(hash) {
            const targetId = hash.substring(1) || 'dashboard';
            contentSections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(`content-${targetId}`);
            if(targetSection) {
                targetSection.classList.remove('hidden');
                
                // Update Nav Styles
                navLinks.forEach(link => {
                    link.classList.remove('bg-primary/5', 'dark:bg-primary/10', 'text-primary');
                    const span = link.querySelector('span.text-sm');
                    if(span) span.classList.remove('text-primary');
                });
                
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`) || document.querySelector(`.nav-link[href="#dashboard"]`);
                if(activeLink) {
                    activeLink.classList.add('bg-primary/5', 'dark:bg-primary/10', 'text-primary');
                    activeLink.querySelector('span.text-sm')?.classList.add('text-primary');
                }

                // Update Title
                const titles = {'dashboard': 'Dashboard', 'courses': 'My Courses', 'attendance': 'Mark Attendance', 'syllabus': 'Syllabus Tracker', 'assignments': 'Assignments', 'notes': 'Share Notes', 'reports': 'Student Reports'};
                pageTitle.textContent = titles[targetId] || 'Dashboard';
            }
        }

        async function loadContent() {
            const hash = window.location.hash || '#dashboard';
            showSection(hash);
            
            // Ensure core data is loaded
            if(allTeacherCourses.length === 0) await fetchTeacherCourses();
            
            // Populate dropdowns if needed
            if(['#attendance', '#syllabus', '#assignments', '#notes', '#reports'].includes(hash)) {
                populateDropdowns();
            }
            
            switch (hash) {
                case '#dashboard':
                    fetchDashboardData();
                    break;
                case '#courses':
                    renderCoursesTable();
                    break;
                case '#attendance':
                    if(allTeacherStudents.length === 0) await fetchAllTeacherStudents();
                    // Don't auto-render table, wait for selection
                    break;
                case '#notes':
                    fetchTeacherNotes();
                    break;
                case '#reports':
                    if(allTeacherStudents.length === 0) await fetchAllTeacherStudents(); 
                    fetchTeacherAttendanceReport();
                    break;
            }
        }

        window.addEventListener('hashchange', loadContent);

        // --- AUTH & INITIAL DATA ---
        async function checkSessionAndInit() {
            try {
                const response = await fetch(`${API_BASE_URL}/check_session`, {credentials: 'include'});
                const result = await response.json();
                if (!response.ok || !result.logged_in || result.user.role !== 'teacher') {
                    window.location.href = API_ORIGIN + '/';
                    return;
                }
                
                // Init
                document.getElementById('welcome-message').textContent = `Welcome back, ${result.user.name.split(' ')[0]}.`;
                loadContent();
                
                // Lazy load Firebase
                setTimeout(initFirebase, 2000);

            } catch (error) {
                console.error("Session Check Failed:", error);
                window.location.href = API_ORIGIN + '/';
            }
        }

        logoutBtn.addEventListener('click', async () => {
            await fetch(`${API_BASE_URL}/logout`, { method: 'POST', credentials: 'include' });
            window.location.href = API_ORIGIN + '/';
        });

        // --- DATA FETCHING ---
        async function fetchTeacherCourses() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/courses`, { credentials: 'include' });
                allTeacherCourses = await res.json();
            } catch (e) { console.error(e); }
        }

        async function fetchAllTeacherStudents() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/students`, { credentials: 'include' });
                allTeacherStudents = await res.json();
            } catch (e) { console.error(e); }
        }

        function populateDropdowns() {
            const selects = [attendanceCourseSelect, noteCourseSelect, syllabusCourseSelect, assignmentCourseSelect, reportCourseSelect];
            selects.forEach(select => {
                if(!select) return;
                const currentVal = select.value;
                const defaultOption = select.id === 'report-course-select' 
                    ? '<option value="">Show All Students</option>' 
                    : '<option value="">-- Select Course --</option>';
                
                select.innerHTML = defaultOption + allTeacherCourses.map(c => 
                    `<option value="${c.id}">${c.name}</option>`
                ).join('');
                
                if(currentVal) select.value = currentVal;
            });
        }

        async function fetchDashboardData() {
            document.getElementById('total-my-courses').textContent = allTeacherCourses.length;
            if(allTeacherStudents.length === 0) await fetchAllTeacherStudents();
            document.getElementById('total-my-students').textContent = allTeacherStudents.length;
            // Notes count fetched via separate call if needed, simple placeholder for now
        }

        function renderCoursesTable() {
            const tbody = document.getElementById('teacher-courses-body');
            tbody.innerHTML = allTeacherCourses.length ? allTeacherCourses.map(c => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${c.name}</td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400">${c.subjects.join(', ')}</td>
                </tr>
            `).join('') : '<tr><td colspan="2" class="px-6 py-8 text-center text-slate-500">No courses found.</td></tr>';
        }

        // --- ATTENDANCE LOGIC (Course-Wise Filter) ---
        
        function renderAttendanceTable(courseId) {
            const tbody = document.getElementById('attendance-table-body');
            tbody.innerHTML = '';
            currentAttendanceStatus = {};
            
            if(!courseId) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">Please select a course above to load student list.</td></tr>';
                updateAttendanceButtons();
                return;
            }

            // Filter students by Course ID using the cached 'course_ids' array in student objects
            const filteredStudents = allTeacherStudents.filter(s => s.course_ids && s.course_ids.includes(parseInt(courseId)));

            if(filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">No students found enrolled in this course.</td></tr>';
                updateAttendanceButtons();
                return;
            }

            filteredStudents.forEach(s => {
                currentAttendanceStatus[s.id] = 'Present'; // Default
                
                // FIXED COLUMN ORDER: ID then Name
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition group">
                        <td class="px-6 py-3">
                            <input type="checkbox" class="student-checkbox rounded border-slate-300 text-primary focus:ring-primary w-5 h-5 cursor-pointer" data-id="${s.id}">
                        </td>
                        <td class="px-6 py-3 text-xs text-slate-400 font-mono">#${s.id}</td>
                        <td class="px-6 py-3 text-sm font-medium text-slate-900 dark:text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary/10 text-primary flex items-center justify-center text-xs font-bold">${s.name.charAt(0)}</div>
                            ${s.name}
                        </td>
                        <td class="px-6 py-3 text-center">
                            <span id="status-${s.id}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Present</span>
                        </td>
                    </tr>
                `;
            });
            updateAttendanceButtons();
        }

        function updateAttendanceButtons() {
            const hasStudents = Object.keys(currentAttendanceStatus).length > 0;
            const dateSet = !!attendanceDateInput.value;
            const courseSet = !!attendanceCourseSelect.value;
            
            const enableActions = hasStudents;
            const enableSubmit = hasStudents && dateSet && courseSet;

            selectAllCheckbox.disabled = !hasStudents;
            markPresentBtn.disabled = !enableActions;
            markAbsentBtn.disabled = !enableActions;
            submitAttendanceBtn.disabled = !enableSubmit;
            
            if(enableSubmit) {
                submitAttendanceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitAttendanceBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        attendanceCourseSelect.addEventListener('change', (e) => {
            renderAttendanceTable(e.target.value);
        });
        
        attendanceDateInput.valueAsDate = new Date(); // Default today
        attendanceDateInput.addEventListener('change', updateAttendanceButtons);

        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = e.target.checked);
        });

        function bulkMark(status) {
            const selected = document.querySelectorAll('.student-checkbox:checked');
            if(selected.length === 0) return alert("Select at least one student.");
            
            selected.forEach(cb => {
                const id = cb.dataset.id;
                currentAttendanceStatus[id] = status;
                const badge = document.getElementById(`status-${id}`);
                badge.textContent = status;
                if(status === 'Present') {
                    badge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800";
                } else {
                    badge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800";
                }
                cb.checked = false; 
            });
            selectAllCheckbox.checked = false;
        }

        markPresentBtn.addEventListener('click', () => bulkMark('Present'));
        markAbsentBtn.addEventListener('click', () => bulkMark('Absent'));

        submitAttendanceBtn.addEventListener('click', async () => {
            submitAttendanceBtn.textContent = "Submitting...";
            submitAttendanceBtn.disabled = true;
            
            const payload = {
                date: attendanceDateInput.value,
                attendance_data: Object.entries(currentAttendanceStatus).map(([sid, stat]) => ({
                    student_id: parseInt(sid), status: stat
                }))
            };

            try {
                const res = await fetch(`${API_BASE_URL}/teacher/attendance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                alert(result.message);
            } catch(e) {
                alert("Submission error.");
            } finally {
                submitAttendanceBtn.textContent = "Submit Attendance";
                submitAttendanceBtn.disabled = false;
            }
        });

        // --- ASSIGNMENTS MOCK LOGIC ---
        assignmentCourseSelect.addEventListener('change', (e) => {
            const cid = e.target.value;
            const tbody = document.getElementById('assignment-table-body');
            tbody.innerHTML = '';
            if(!cid) { tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-slate-500">Select a course.</td></tr>'; return; }
            
            const filtered = allTeacherStudents.filter(s => s.course_ids && s.course_ids.includes(parseInt(cid)));
            if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-slate-500">No students.</td></tr>'; return; }

            filtered.forEach(s => {
                tbody.innerHTML += `<tr>
                    <td class="px-6 py-4 font-medium">${s.name}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-bold">Pending</span></td>
                    <td class="px-6 py-4 text-right"><button class="text-blue-600 hover:underline text-xs" onclick="alert('Marked submitted for ${s.name} (Mock)')">Mark Submitted</button></td>
                </tr>`;
            });
        });

        // --- NOTES LOGIC ---
        uploadNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('upload-note-btn');
            const progress = document.getElementById('upload-progress');
            const bar = document.getElementById('upload-bar');
            const status = document.getElementById('upload-status');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            bar.style.width = '0%';
            
            const formData = new FormData(uploadNoteForm);
            
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_BASE_URL}/teacher/upload_note`, true);
                xhr.withCredentials = true;
                
                xhr.upload.onprogress = (evt) => {
                    if (evt.lengthComputable) {
                        const percent = (evt.loaded / evt.total) * 100;
                        bar.style.width = percent + '%';
                    }
                };
                
                xhr.onload = () => {
                    if (xhr.status === 201) {
                        status.textContent = "Uploaded Successfully!";
                        status.className = "text-xs text-center mt-1 text-green-600";
                        uploadNoteForm.reset();
                        fetchTeacherNotes();
                    } else {
                        status.textContent = "Upload Failed.";
                        status.className = "text-xs text-center mt-1 text-red-600";
                    }
                    setTimeout(() => { progress.classList.add('hidden'); btn.disabled = false; }, 2000);
                };
                
                xhr.send(formData);
            } catch(e) {
                btn.disabled = false;
                alert("Upload error.");
            }
        });

        async function fetchTeacherNotes() {
            const tbody = document.getElementById('teacher-notes-body');
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/notes`, { credentials: 'include' });
                const notes = await res.json();
                
                tbody.innerHTML = notes.length ? notes.map(n => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                        <td class="px-6 py-4 font-medium">${n.title}</td>
                        <td class="px-6 py-4 text-slate-500">${n.course_name}</td>
                        <td class="px-6 py-4"><a href="${API_ORIGIN}/uploads/${n.filename}" class="text-primary hover:underline text-sm flex items-center gap-1"><span class="material-symbols-outlined text-sm">attachment</span> ${n.original_filename}</a></td>
                        <td class="px-6 py-4 text-xs text-slate-400">${n.created_at.split(' ')[0]}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="deleteNote(${n.id})" class="text-red-500 hover:text-red-700 text-sm font-medium">Delete</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No notes found.</td></tr>';
            } catch(e) { tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error loading notes.</td></tr>'; }
        }

        window.deleteNote = async (id) => {
            if(!confirm("Delete this note?")) return;
            try {
                await fetch(`${API_BASE_URL}/teacher/notes?id=${id}`, { method: 'DELETE', credentials: 'include' });
                fetchTeacherNotes();
            } catch(e) { alert("Deletion failed."); }
        };


        // --- REPORTS LOGIC (Updated with Photo & Messaging) ---
        async function fetchTeacherAttendanceReport() {
            const tbody = document.getElementById('teacher-reports-body');
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/reports/attendance`, { credentials: 'include' });
                reportData = await res.json(); // Cache data for filtering
                renderReportTable(reportData);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error loading report.</td></tr>';
            }
        }

        function renderReportTable(data) {
            const tbody = document.getElementById('teacher-reports-body');
            
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No student data found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(row => {
                // Get Full Student Object from cache to get photo url properly
                const studentDetails = allTeacherStudents.find(s => s.id === row.student_id);
                // Use photo from student details, fallback to generic
                const photoUrl = (studentDetails && studentDetails.profile_photo_url) 
                                 ? `${API_ORIGIN}${studentDetails.profile_photo_url}` 
                                 : `https://placehold.co/40x40/e2e8f0/475569?text=${row.student_name.charAt(0)}`;

                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="px-6 py-4">
                        <img src="${photoUrl}" alt="${row.student_name}" class="w-10 h-10 rounded-full object-cover border border-slate-200 shadow-sm">
                    </td>
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">
                        ${row.student_name}
                        <div class="text-xs text-slate-400 font-normal">ID: ${row.student_id}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300 mb-1">${row.present}/${row.total_classes}</span>
                            <div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                <div class="bg-green-500 h-full" style="width: ${(row.present/row.total_classes)*100 || 0}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button onclick="sendRemark(${row.student_id}, '${row.student_name.replace(/'/g, "\\'")}', 'star')" class="p-1.5 bg-yellow-100 text-yellow-600 rounded-lg hover:bg-yellow-200" title="Send Praise"></button>
                        <button onclick="sendRemark(${row.student_id}, '${row.student_name.replace(/'/g, "\\'")}', 'warn')" class="p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200" title="Send Warning"></button>
                        <button onclick="openMessageModal(${row.student_id}, '${row.student_name.replace(/'/g, "\\'")}')" class="inline-flex items-center gap-1 px-3 py-1.5 bg-primary/10 text-primary text-xs font-bold rounded-lg hover:bg-primary hover:text-white transition">
                            <span class="material-symbols-outlined text-sm">mail</span> Message
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        // Report Filter Logic
        reportCourseSelect.addEventListener('change', (e) => {
            const courseId = e.target.value;
            if (!courseId) {
                renderReportTable(reportData); // Show all
            } else {
                const enrolledStudentIds = allTeacherStudents
                    .filter(s => s.course_ids && s.course_ids.includes(parseInt(courseId)))
                    .map(s => s.id);
                const filteredData = reportData.filter(row => enrolledStudentIds.includes(row.student_id));
                renderReportTable(filteredData);
            }
        });


        // --- MESSAGING MODAL LOGIC ---
        window.openMessageModal = function(id, name) {
            document.getElementById('notify-student-id').value = id;
            document.getElementById('notify-modal-title').textContent = `Message ${name}`;
            notifyModal.classList.remove('hidden');
        };
        
        window.sendRemark = (id, name, type) => {
            const msg = type === 'star' ? `Great job in class today, ${name}!` : `Please pay more attention in class, ${name}.`;
            if(confirm(`Send '${msg}' to parent?`)) alert("Remark sent (Mock)!");
        };

        const closeModal = () => notifyModal.classList.add('hidden');
        cancelNotifyBtn.addEventListener('click', closeModal);
        notifyBackdrop.addEventListener('click', closeModal);

        sendNotifyBtn.addEventListener('click', async () => {
            const btn = sendNotifyBtn;
            const sid = document.getElementById('notify-student-id').value;
            const sub = document.getElementById('notify-subject').value;
            const body = document.getElementById('notify-body').value;
            const type = document.getElementById('notify-type').value;

            if(!sub || !body) return alert("Subject and message are required.");

            // WhatsApp Direct Link (Client Side)
            if (type === 'whatsapp') {
                const student = allTeacherStudents.find(s => s.id == sid);
                if (student && student.phone_number) {
                    window.open(`https://wa.me/${student.phone_number}?text=${encodeURIComponent(sub + ": " + body)}`, '_blank');
                    closeModal();
                } else {
                    alert("Student phone number not found.");
                }
                return;
            }

            // Server Side Sending (Email/SMS/Portal)
            btn.disabled = true;
            btn.textContent = "Sending...";
            
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/notify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ student_id: sid, subject: sub, body: body, type: type })
                });
                const result = await res.json();
                alert(result.message);
                if(res.ok) closeModal();
            } catch(e) {
                alert("Failed to send message.");
            } finally {
                btn.disabled = false;
                btn.textContent = "Send Message";
            }
        });

        // --- INIT FIREBASE ---
       
function initFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBkzEHM9fXRoCYSgEW-hk_lN7sL_nSLDfU",
                authDomain: "cst-institute-app.firebaseapp.com",
                projectId: "cst-institute-app",
                storageBucket: "cst-institute-app.firebasestorage.app",
                messagingSenderId: "485166460200",
                appId: "1:485166460200:web:4eae20e2010ab92baeb41d"
            };

            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                const messaging = firebase.messaging();

                // 1. Foreground Message Handler (Shows Toast if teacher is looking at the screen)
                messaging.onMessage((payload) => {
                    console.log('Message received. ', payload);
                    // Optional: You can add a toast/alert here if you want teachers to see incoming messages too
                    alert(`Notification: ${payload.notification.title}\n${payload.notification.body}`);
                });

                // 2. Token Registration
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/firebase-messaging-sw.js').then((reg) => {
                        return Notification.requestPermission().then((permission) => {
                            if (permission === 'granted') {
                                // REPLACE VAPID KEY HERE
                                return messaging.getToken({ 
                                    vapidKey: 'BBOMxvKvbEs_t9ykKBa2zIewzCzD6FCbm9rxc8a9eWl2kjjH5vyTSH6TeQMksZ_OGl5jZyQpU2wBcf-KsZN1uko', 
                                    serviceWorkerRegistration: reg 
                                });
                            }
                        });
                    }).then((token) => {
                        if (token) {
                            console.log('FCM Token:', token);
                            // Send token to backend
                            fetch('/api/save_fcm_token', { 
                                method: 'POST', 
                                headers: {'Content-Type': 'application/json'}, 
                                credentials: 'include', 
                                body: JSON.stringify({token}) 
                            });
                        }
                    }).catch(err => console.log('Firebase error', err));
                }
            }
        } catch (e) { console.log('Firebase init skipped or error', e); }
    }
    
    // Start the app
    checkSessionAndInit();
</script>
</body>
</html>
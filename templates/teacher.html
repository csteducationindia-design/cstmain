<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        /* Ensures table is readable and fits content */
        .table-auto-layout {
            table-layout: auto;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-lg">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Institute Teacher</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Teacher Portal</p>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-1">
            <a href="#courses" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary">
                <span class="material-symbols-outlined">book</span>
                <span class="text-sm font-medium">My Courses</span>
            </a>
            <a href="#attendance" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">how_to_reg</span>
                <span class="text-sm font-medium">Mark Attendance</span>
            </a>
            <a href="#notifications" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">notifications_active</span>
                <span class="text-sm font-medium">Notifications</span>
            </a>
            <!-- NEW: Share Notes Link -->
            <a href="#share-notes" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">upload_file</span>
                <span class="text-sm font-medium">Share Notes</span>
            </a>
            <a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">analytics</span>
                <span class="text-sm font-medium">View Reports</span>
            </a>
            <a href="#announcements" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-primary/10 dark:hover:bg-primary/20">
                <span class="material-symbols-outlined">campaign</span>
                <span class="text-sm font-medium">Announcements</span>
            </a>
        </nav>
        <div class="p-6 border-t border-slate-200 dark:border-slate-800">
            <button id="logout-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-red-700 transition duration-150">
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8">
                <h1 id="teacher-welcome" class="text-4xl font-bold text-slate-900 dark:text-white">Welcome, Teacher!</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2">Manage your courses, students, and communication.</p>
            </header>

            <!-- COURSES SECTION -->
            <div id="content-courses" class="content-section">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">My Courses</h2>
                <div id="courses-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Dynamic course cards will be inserted here -->
                    <div id="no-courses" class="col-span-2 bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                        <p class="text-slate-500">You are not currently assigned to any courses.</p>
                    </div>
                </div>
            </div>

            <!-- ATTENDANCE SECTION -->
            <div id="content-attendance" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Mark Attendance</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label for="course-select" class="block text-sm font-medium mb-1">Select Course</label>
                            <select id="course-select" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select>
                        </div>
                        <div class="form-group">
                            <label for="attendance-date" class="block text-sm font-medium mb-1">Select Date</label>
                            <input type="date" id="attendance-date" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                        </div>
                        <div class="form-group self-end">
                            <button id="fetch-students-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">
                                Fetch Students
                            </button>
                        </div>
                    </div>
                </div>

                <form id="attendance-form" class="hidden">
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                                <!-- Dynamic student rows go here -->
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" id="submit-attendance-btn" class="mt-4 w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                        Submit Attendance
                    </button>
                </form>
            </div>

            <!-- NOTIFICATIONS SECTION -->
            <div id="content-notifications" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Send Notification to Student(s)</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6">
                    <form id="notification-form">
                        <div class="mb-4">
                            <label for="student-select" class="block text-sm font-medium mb-1">Select Target Student(s)</label>
                            <select id="student-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                                <option value="all">Send to ALL Students</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="notification-subject" class="block text-sm font-medium mb-1">Subject</label>
                            <input type="text" id="notification-subject" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                        </div>
                        <div class="mb-4">
                            <label for="notification-body" class="block text-sm font-medium mb-1">Message</label>
                            <textarea id="notification-body" rows="5" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <button type="button" data-type="email" class="send-notification-btn w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">
                                Send Email
                            </button>
                            <button type="button" data-type="sms" class="send-notification-btn w-full bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-yellow-700 transition duration-150">
                                Send SMS
                            </button>
                            <button type="button" data-type="whatsapp" class="send-notification-btn w-full bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-green-700 transition duration-150">
                                Send WhatsApp (Mock)
                            </button>
                        </div>
                        <p id="notification-status" class="mt-4 text-sm font-medium text-center text-slate-500 dark:text-slate-400 hidden"></p>
                    </form>
                </div>
            </div>
            
            <!-- SHARE NOTES SECTION (NEW) -->
            <div id="content-share-notes" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Share Course Notes</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-6 mb-8">
                    <form id="notes-upload-form">
                        <div class="mb-4">
                            <label for="note-course-select" class="block text-sm font-medium mb-1">Select Course</label>
                            <select id="note-course-select" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></select>
                        </div>
                        <div class="mb-4">
                            <label for="note-title" class="block text-sm font-medium mb-1">Note Title / Subject</label>
                            <input type="text" id="note-title" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800">
                        </div>
                        <div class="mb-4">
                            <label for="note-description" class="block text-sm font-medium mb-1">Description (Optional)</label>
                            <textarea id="note-description" rows="2" class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="note-file-input" class="block text-sm font-medium mb-1">Select File (PDF, DOCX, TXT, JPG, PNG)</label>
                            <input type="file" id="note-file-input" required class="w-full border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 p-2">
                        </div>
                        <button type="submit" id="upload-note-btn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg text-sm hover:bg-opacity-90 transition duration-150">
                            Upload & Share Note
                        </button>
                        <p id="upload-status" class="mt-4 text-sm font-medium text-center text-slate-500 dark:text-slate-400 hidden"></p>
                    </form>
                </div>
                
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">My Uploaded Notes</h3>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Course</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Filename</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="my-notes-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <!-- My uploaded notes will appear here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END SHARE NOTES SECTION -->

            <!-- REPORTS SECTION -->
            <div id="content-reports" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Student Attendance Report</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total Classes</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-green-600 uppercase tracking-wider">Present</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Absent</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">SMS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-report-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                             <tr><td colspan="6" class="px-6 py-4 text-center">Loading student data...</td></tr>
                        </tbody>
                    </table>
                    <p id="report-status" class="p-4 text-sm text-red-500 hidden">Error loading attendance data.</p>
                </div>
            </div>
            <!-- END REPORTS SECTION -->

            <!-- ANNOUNCEMENTS SECTION -->
            <div id="content-announcements" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">Institute Announcements</h2>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Content</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody id="announcements-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <!-- Announcements loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    // Define the base URL explicitly using the current location origin 
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    let allStudents = []; // Global variable to store all students

    document.addEventListener('DOMContentLoaded', () => {
        
        // --- GLOBAL UI & NAVIGATION ---
        const logoutBtn = document.getElementById('logout-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        const courseSelect = document.getElementById('course-select');
        const attendanceReportBody = document.getElementById('attendance-report-body');
        // NEW: Note upload elements
        const noteCourseSelect = document.getElementById('note-course-select');
        const notesUploadForm = document.getElementById('notes-upload-form');
        const myNotesTableBody = document.getElementById('my-notes-table-body');
        const uploadStatus = document.getElementById('upload-status');


        function showSection(hash) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            navLinks.forEach(link => {
                link.classList.remove('bg-primary/10', 'dark:bg-primary/20', 'text-primary');
                link.classList.add('text-slate-700', 'dark:text-slate-300', 'hover:bg-primary/10', 'dark:hover:bg-primary/20');
            });

            // Handle navigation hash change
            let targetId = hash.substring(1) || 'courses';
            if (targetId === 'email') targetId = 'notifications'; 
            
            let targetSection = document.getElementById(`content-${targetId}`);
            let targetLink = document.querySelector(`.nav-link[href="#${targetId}"]`);
            if (!targetLink) { 
                 targetLink = document.querySelector(`.nav-link[href="#notifications"]`);
            }


            if (targetSection) {
                targetSection.classList.remove('hidden');
                if (targetLink) {
                    targetLink.classList.add('bg-primary/10', 'dark:bg-primary/20', 'text-primary');
                    targetLink.classList.remove('text-slate-700', 'dark:text-slate-300', 'hover:bg-primary/10', 'dark:hover:bg-primary/20');
                }
            }
        }

        window.addEventListener('hashchange', () => {
            showSection(window.location.hash);
            const currentHash = window.location.hash.substring(1) || 'courses';
            if (currentHash === 'courses') loadTeacherCourses();
            if (currentHash === 'announcements') fetchAnnouncements();
            if (currentHash === 'notifications') populateStudentDropdown(); 
            if (currentHash === 'reports') fetchAttendanceReportData(); 
            if (currentHash === 'share-notes') {
                // We call loadTeacherCourses() because it populates the dropdowns
                loadTeacherCourses();
                fetchMyUploadedNotes();
            }
        });
        
        // Initial load based on hash or default to courses
        showSection(window.location.hash);


        // --- AUTHENTICATION ---
        async function checkTeacherSession() {
            try {
                // FIX: Check response.status explicitly before proceeding
                const response = await fetch(`${API_ORIGIN}/api/check_session`, {credentials: 'include'});
                
                if (response.status === 401 || !response.ok) { 
                    throw new Error('Session check failed');
                }
                
                const result = await response.json();
                if (!result.logged_in || result.user.role !== 'teacher') {
                    // FIX: Use absolute URL for navigation
                    window.location.href = API_ORIGIN + '/'; 
                } else {
                    document.getElementById('teacher-welcome').textContent = `Welcome, ${result.user.name}!`;
                    loadTeacherCourses();
                    populateStudentDropdown(); 
                }
            } catch (error) { 
                console.error("Session check failed:", error);
                // FIX: Use absolute URL for navigation
                window.location.href = API_ORIGIN + '/'; 
            }
        }
        logoutBtn.addEventListener('click', async () => {
            await fetch(`${API_BASE_URL}/logout`, { method: 'POST', credentials: 'include' });
            window.location.href = API_ORIGIN + '/';
        });

        // --- COURSES LOGIC ---
        async function loadTeacherCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/teacher/courses`, {credentials: 'include'});
                const courses = await response.json();
                
                const coursesList = document.getElementById('courses-list');
                const noCoursesMessage = document.getElementById('no-courses');
                
                coursesList.innerHTML = '';
                
                if (courses.length === 0) {
                    coursesList.appendChild(noCoursesMessage);
                    noCoursesMessage.classList.remove('hidden');
                } else {
                    noCoursesMessage.classList.add('hidden');
                    
                    const colors = ['bg-blue-600', 'bg-green-600', 'bg-purple-600'];
                    
                    courses.forEach((course, index) => {
                        const subjects = course.subjects.join(', ');
                        const firstSubject = course.subjects[0];
                        const colorClass = colors[index % colors.length];

                        const cardHtml = `
                            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm overflow-hidden flex">
                                <div class="w-24 flex items-center justify-center ${colorClass} text-white text-xl font-bold">${firstSubject.substring(0, 3).toUpperCase()}</div>
                                <div class="p-4 flex flex-col justify-between flex-1">
                                    <div>
                                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">${course.name}</h3>
                                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">${subjects}</p>
                                    </div>
                                    <a href="#course-details-${course.id}" class="mt-3 w-fit self-start bg-primary text-white font-medium py-1.5 px-3 rounded-lg text-xs hover:bg-opacity-90">
                                        Manage
                                    </a>
                                </div>
                            </div>
                        `;
                        coursesList.innerHTML += cardHtml;
                    });
                }
                
                // MODIFIED: Populate both dropdowns
                const courseOptions = courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('') || '<option value="">No Courses Assigned</option>';
                courseSelect.innerHTML = courseOptions;
                noteCourseSelect.innerHTML = courseOptions;

            } catch (error) {
                console.error("Failed to load teacher courses:", error);
                document.getElementById('courses-list').innerHTML = `<div class="col-span-2 bg-red-100 dark:bg-red-900 rounded-xl shadow-sm p-6"><p class="text-red-500">Error loading courses.</p></div>`;
            }
        }


        // --- ATTENDANCE MARKING LOGIC ---
        const attendanceDate = document.getElementById('attendance-date');
        const fetchStudentsBtn = document.getElementById('fetch-students-btn');
        const studentListBody = document.getElementById('student-list-body');
        const attendanceForm = document.getElementById('attendance-form');
        const studentsTable = attendanceForm; 

        fetchStudentsBtn.addEventListener('click', async () => {
            const date = attendanceDate.value;
            const courseId = courseSelect.value;
            if (!courseId || !date) {
                alert("Please select a course and a date.");
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/teacher/students`, {credentials: 'include'});
                if (!response.ok) throw new Error(`Server status: ${response.status}`);
                const students = await response.json();
                
                studentListBody.innerHTML = '';
                if (students.length === 0) {
                    studentListBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center">No students found. Please add students in the admin portal first.</td></tr>';
                } else {
                    students.forEach(student => {
                        studentListBody.innerHTML += `
                            <tr class="even:bg-slate-50 dark:even:bg-slate-800">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${student.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <div class="flex gap-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" class="form-radio text-green-600" name="status_${student.id}" value="Present" required> 
                                            <span class="ml-2">Present</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" class="form-radio text-red-600" name="status_${student.id}" value="Absent"> 
                                            <span class="ml-2">Absent</span>
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }

                studentsTable.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to fetch students:", error);
                alert("An error occurred while fetching students.");
                studentsTable.classList.add('hidden');
            }
        });

        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const attendanceData = Array.from(studentListBody.querySelectorAll('input[type="radio"]:checked')).map(radio => {
                return {
                    student_id: parseInt(radio.name.split('_')[1]),
                    status: radio.value
                }
            });

            if (attendanceData.length === 0) {
                alert("Please mark the status for at least one student.");
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/teacher/attendance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        date: attendanceDate.value,
                        attendance_data: attendanceData
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    studentsTable.classList.add('hidden');
                    attendanceForm.reset();
                    attendanceDate.valueAsDate = new Date();
                } else {
                    alert(`Attendance submission failed: ${result.message || 'Server Error'}`);
                }
            } catch (error) {
                console.error("Attendance submission error:", error);
                alert("An unexpected error occurred during attendance submission.");
            }
        });
        
        // --- NOTIFICATION LOGIC (Email, SMS, WhatsApp) ---
        const notificationForm = document.getElementById('notification-form');
        const studentSelect = document.getElementById('student-select');
        const notificationButtons = document.querySelectorAll('.send-notification-btn');
        const notificationStatus = document.getElementById('notification-status');


        async function populateStudentDropdown() {
            try {
                const response = await fetch(`${API_BASE_URL}/teacher/students`, {credentials: 'include'});
                allStudents = await response.json();
                
                // Keep the 'Send to ALL Students' option
                studentSelect.innerHTML = '<option value="all">Send to ALL Students (' + allStudents.length + ')</option>';
                
                allStudents.forEach(student => {
                    studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.email})</option>`;
                });
            } catch (error) {
                console.error("Failed to load students for notification dropdown:", error);
                studentSelect.innerHTML = '<option value="">Error loading students</option>';
            }
        }
        
        notificationButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                notificationStatus.classList.add('hidden');
                
                const targetId = studentSelect.value;
                const subject = document.getElementById('notification-subject').value;
                const body = document.getElementById('notification-body').value;
                const notificationType = button.getAttribute('data-type');
                
                if (!targetId || !subject || !body) {
                    alert('Please fill out the student selection, subject, and message fields.');
                    return;
                }
                
                let studentsToSendTo = [];
                if (targetId === 'all') {
                    studentsToSendTo = allStudents;
                } else {
                    const singleStudent = allStudents.find(s => s.id == targetId);
                    if (singleStudent) studentsToSendTo.push(singleStudent);
                }

                if (studentsToSendTo.length === 0) {
                     alert("No students selected or found to send the notification.");
                     return;
                }

                try {
                    // Disable buttons while sending
                    notificationButtons.forEach(btn => btn.disabled = true);
                    notificationStatus.textContent = `Preparing to send ${studentsToSendTo.length} message(s) via ${notificationType.toUpperCase()}...`;
                    notificationStatus.classList.remove('hidden');
                    
                    const totalRecipients = studentsToSendTo.length;
                    let successCount = 0;
                    let failureCount = 0;
                    let finalMessage = "";

                    // For bulk, iterate and call the API for each student
                    for (const student of studentsToSendTo) {
                        notificationStatus.textContent = `Sending message ${successCount + failureCount + 1} of ${totalRecipients} to ${student.name}...`;

                        // Reuse the centralized notification endpoint
                        const response = await fetch(`${API_BASE_URL}/teacher/notify`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            credentials: 'include',
                            body: JSON.stringify({ 
                                student_id: student.id, 
                                subject: subject, 
                                body: body,
                                type: notificationType
                            })
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            failureCount++;
                        }
                    }
                    
                    finalMessage = `Notification sent via ${notificationType.toUpperCase()} to ${successCount} recipient(s). ${failureCount} failed (Check console and student phone numbers).`;
                    
                    alert(finalMessage);
                    notificationStatus.textContent = finalMessage;
                    
                    if (successCount > 0) {
                        notificationForm.reset();
                    }
                } catch (error) {
                    console.error("Notification submission error:", error);
                    alert("An unexpected error occurred during message submission.");
                    notificationStatus.textContent = "Error sending message(s). Check console.";
                    notificationStatus.classList.add('text-red-500');
                } finally {
                    // Re-enable buttons and reset status styling
                    notificationButtons.forEach(btn => btn.disabled = false);
                    notificationStatus.classList.remove('text-red-500');
                }
            });
        });


        // --- REPORTS LOGIC ---

        // Centralized Quick Notification function for reports buttons
        window.sendQuickReportNotification = async function(studentId, studentName, status, type) {
            
            // If the user chooses WhatsApp from the report table, use the direct link method
            if (type === 'whatsapp') {
                const student = allStudents.find(s => s.id === studentId);
                const phoneNumber = student ? student.phone_number : null;
                
                if (!phoneNumber) {
                    alert(`WhatsApp failed: No phone number available for ${studentName}.`);
                    return;
                }
                const encodedMessage = encodeURIComponent(`Dear ${studentName}, your current attendance summary is: ${status}. Please ensure timely attendance.`);
                
                // Use the wa.me deep link to open WhatsApp
                window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
                return;
            }

            // Fallback for SMS (uses the API)
            const subject = `${status} Attendance Alert`;
            const body = `Dear ${studentName}, your current attendance status is marked as ${status}. Please ensure timely attendance.`;
            
            try {
                if (confirm(`Send quick ${type.toUpperCase()} notification to ${studentName}?`)) {
                    const response = await fetch(`${API_BASE_URL}/teacher/notify`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({ 
                            student_id: studentId, 
                            subject: subject, 
                            body: body,
                            type: type
                        })
                    });
                    const result = await response.json();
                    alert(result.message);
                }
            } catch (error) {
                console.error(`Quick ${type} error:`, error);
                alert(`Failed to send quick ${type} notification.`);
            }
        }
        
        // Function to fetch attendance report data
        async function fetchAttendanceReportData() {
             attendanceReportBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center">Fetching attendance data...</td></tr>`;
             const reportStatus = document.getElementById('report-status');
             reportStatus.classList.add('hidden');
             
             try {
                // Call the new, teacher-accessible endpoint
                const response = await fetch(`${API_BASE_URL}/teacher/reports/attendance`, {credentials: 'include'});
                
                if (response.status === 403) {
                     throw new Error("Access Denied. You are not authorized to view this report.");
                }
                
                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.message || `Server Error (${response.status})`);
                }
                
                const report = await response.json();
                
                // Store student data globally if not already fetched
                if (allStudents.length === 0) {
                    allStudents = report.map(r => ({ id: r.student_id, name: r.student_name, phone_number: r.phone_number }));
                }

                attendanceReportBody.innerHTML = '';

                if (report.length === 0) {
                    attendanceReportBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center">No student attendance records found.</td></tr>`;
                    return;
                }

                report.forEach(data => {
                    const isPhoneAvailable = !!data.phone_number;
                    const attendanceSummary = `Present: ${data.present} / ${data.total_classes}`;
                    const quickStatusText = `Attendance ${data.present}/${data.total_classes}`;


                    attendanceReportBody.innerHTML += `
                        <tr class="even:bg-slate-50 dark:even:bg-slate-800">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${data.student_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${data.total_classes}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${data.present}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${data.absent}</td>
                            
                            <!-- SMS Button (Calls API) -->
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <button onclick="sendQuickReportNotification(${data.student_id}, '${data.student_name}', '${quickStatusText}', 'sms')" class="text-yellow-600 hover:text-yellow-700 disabled:text-slate-400" ${isPhoneAvailable ? '' : 'disabled'}>
                                    <span class="material-symbols-outlined align-middle text-lg">sms</span>
                                </button>
                            </td>
                            <!-- WhatsApp Button (Calls deep link) -->
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <button onclick="sendQuickReportNotification(${data.student_id}, '${data.student_name}', '${quickStatusText}', 'whatsapp')" class="text-green-600 hover:text-green-700 disabled:text-slate-400" ${isPhoneAvailable ? '' : 'disabled'}>
                                    <span class="material-symbols-outlined align-middle text-lg">call</span>
                                </button>
                            </td>
                        </tr>`;
                });

             } catch (error) {
                 console.error("Error fetching attendance report:", error);
                 reportStatus.textContent = `Failed to load report data. Reason: ${error.message}`;
                 reportStatus.classList.remove('hidden');
                 attendanceReportBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load report. Check console for details.</td></tr>`;
             }
        }


        // --- ANNOUNCEMENTS LOGIC ---
        async function fetchAnnouncements() {
            try {
                const response = await fetch(`${API_BASE_URL}/announcements`, {credentials: 'include'});
                const announcements = await response.json();
                const tableBody = document.getElementById('announcements-table-body');
                tableBody.innerHTML = '';
                
                const relevantAnnouncements = announcements.filter(a => a.target_group === 'all' || a.target_group === 'teachers');

                if (relevantAnnouncements.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center">No announcements for teachers.</td></tr>`;
                    return;
                }

                relevantAnnouncements.forEach(announcement => {
                    tableBody.innerHTML += `
                        <tr class="even:bg-slate-50 dark:even:bg-slate-800">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${announcement.title}</td>
                            <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400 max-w-lg truncate">${announcement.content}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${announcement.created_at.split(' ')[0]}</td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Error loading announcements:", error);
                document.getElementById('announcements-table-body').innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error loading announcements.</td></tr>`;
            }
        }
        
        // --- NEW: SHARE NOTES LOGIC ---
        async function fetchMyUploadedNotes() {
            try {
                const response = await fetch(`${API_BASE_URL}/teacher/notes`, {credentials: 'include'});
                if (!response.ok) throw new Error('Failed to fetch notes');
                
                const notes = await response.json();
                myNotesTableBody.innerHTML = '';
                
                if (notes.length === 0) {
                    myNotesTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center">You have not uploaded any notes yet.</td></tr>`;
                    return;
                }
                
                notes.forEach(note => {
                    myNotesTableBody.innerHTML += `
                        <tr class="even:bg-slate-50 dark:even:bg-slate-800">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${note.title}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${note.course_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 truncate" style="max-width: 200px;">${note.original_filename}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${note.created_at.split(' ')[0]}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="deleteNote(${note.id})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                 console.error("Error fetching uploaded notes:", error);
                 myNotesTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading your notes.</td></tr>`;
            }
        }

        window.deleteNote = async function(noteId) {
            if (!confirm("Are you sure you want to delete this note? This will remove the file permanently.")) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/teacher/notes?id=${noteId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) {
                    fetchMyUploadedNotes(); // Refresh the list
                }
            } catch (error) {
                console.error("Error deleting note:", error);
                alert("An error occurred while deleting the note.");
            }
        }

        notesUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadStatus.classList.remove('hidden');
            uploadStatus.textContent = "Uploading file, please wait...";
            uploadStatus.classList.remove('text-red-500', 'text-green-600');
            
            const formData = new FormData();
            formData.append('file', document.getElementById('note-file-input').files[0]);
            formData.append('title', document.getElementById('note-title').value);
            formData.append('course_id', document.getElementById('note-course-select').value);
            formData.append('description', document.getElementById('note-description').value);
            
            try {
                const response = await fetch(`${API_BASE_URL}/teacher/upload_note`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData // No 'Content-Type' header needed for FormData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    uploadStatus.textContent = result.message;
                    uploadStatus.classList.add('text-green-600');
                    notesUploadForm.reset();
                    fetchMyUploadedNotes(); // Refresh the list
                } else {
                    uploadStatus.textContent = `Error: ${result.message}`;
                    uploadStatus.classList.add('text-red-500');
                }
            } catch (error) {
                console.error("File upload error:", error);
                uploadStatus.textContent = "A network error occurred. Please try again.";
                uploadStatus.classList.add('text-red-500');
            }
        });


        // --- INITIAL PAGE LOAD ---
        checkTeacherSession();
        attendanceDate.valueAsDate = new Date();
    });
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .content-section.hidden { display: none; }
        .digital-card {
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
            border-left: 5px solid #1173d4;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .digital-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

<div class="min-h-screen flex flex-col">
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600 text-3xl">school</span>
                <h1 class="text-xl font-bold text-slate-800">Teacher Portal</h1>
            </div>
            <button id="logout-btn" class="text-sm font-medium text-red-600 hover:text-red-800">Logout</button>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6 lg:p-8">
        
        <div class="flex space-x-4 border-b border-gray-200 mb-6 overflow-x-auto">
            <button onclick="showSection('dashboard')" class="tab-link px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">Dashboard</button>
            <button onclick="showSection('attendance')" class="tab-link px-4 py-2 font-medium text-gray-500 hover:text-gray-700">Attendance</button>
            <button onclick="showSection('reports')" class="tab-link px-4 py-2 font-medium text-gray-500 hover:text-gray-700">Reports</button>
            <button onclick="showSection('notes')" class="tab-link px-4 py-2 font-medium text-gray-500 hover:text-gray-700">Notes</button>
            <button onclick="showSection('syllabus')" class="tab-link px-4 py-2 font-medium text-gray-500 hover:text-gray-700">Syllabus</button>
        </div>

        <div id="content-dashboard" class="content-section">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-bold mb-4">Send Digital Notification</h2>
                <form id="announcement-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Title</label>
                        <input id="ann-title" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm border p-2" placeholder="e.g. Science Fair Tomorrow" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Message Content</label>
                        <textarea id="ann-content" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm border p-2" placeholder="Details..." required></textarea>
                    </div>
                    <div class="flex items-center gap-4">
                        <select id="ann-category" class="border-gray-300 rounded-lg shadow-sm border p-2">
                            <option value="General">General</option>
                            <option value="Homework">Homework</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 w-full md:w-auto">
                        Send Digital Notice
                    </button>
                </form>
            </div>

            <h3 class="font-bold text-gray-700 mb-3">Recent Notices</h3>
            <div id="notices-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>

        <div id="content-attendance" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex flex-wrap gap-4 mb-6 items-end">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-bold mb-1">Select Batch/Session</label>
                        <select id="att-session" class="w-full border p-2 rounded-lg" onchange="loadAttendanceList()">
                            <option value="">Loading Batches...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Date</label>
                        <input type="date" id="att-date" class="border p-2 rounded-lg">
                    </div>
                    <button onclick="loadAttendanceList()" class="bg-gray-800 text-white px-4 py-2 rounded-lg">Fetch Students</button>
                </div>

                <form id="attendance-form">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3">Photo</th>
                                    <th class="p-3">Name</th>
                                    <th class="p-3">Adm No</th>
                                    <th class="p-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list-body"></tbody>
                        </table>
                    </div>
                    <button type="submit" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg w-full font-bold shadow-lg hover:bg-green-700">
                        Submit Attendance
                    </button>
                </form>
            </div>
        </div>

        <div id="content-reports" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-bold mb-4">Student Reports</h2>
                <div class="flex gap-4 mb-4">
                    <select id="report-session" class="border p-2 rounded-lg" onchange="loadReport()"></select>
                    <input type="date" id="report-date" class="border p-2 rounded-lg" onchange="loadReport()">
                </div>
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr><th class="p-3">Profile</th><th class="p-3">Student Details</th><th class="p-3">Attendance Status</th></tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
            </div>
        </div>

        <div id="content-notes" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="font-bold mb-4">Upload Study Material</h3>
                <form id="notes-form" class="space-y-4">
                    <input name="title" placeholder="Note Title" class="w-full border p-2 rounded" required>
                    <textarea name="description" placeholder="Description" class="w-full border p-2 rounded"></textarea>
                    <select name="course_id" id="notes-course" class="w-full border p-2 rounded"></select>
                    <input type="file" name="file" class="w-full text-sm text-gray-500">
                    <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Upload Note</button>
                </form>
            </div>
        </div>

        <div id="content-syllabus" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-6 max-w-lg mx-auto mt-10">
                <h3 class="text-xl font-bold mb-4 text-center">Daily Topic Update</h3>
                <p class="text-sm text-gray-500 text-center mb-6">Send updates via App Notification & WhatsApp (No SMS DLT)</p>
                <form id="syllabus-form" class="space-y-4">
                    <div>
                        <label class="font-bold text-sm">Select Course</label>
                        <select id="syllabus-course" class="w-full border p-2 rounded-lg mt-1"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm">Topic Taught Today</label>
                        <textarea id="syllabus-topic" rows="4" class="w-full border p-2 rounded-lg mt-1" placeholder="e.g. Chapter 4: Photosynthesis diagrams..." required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow hover:bg-indigo-700">
                        Send via App & WhatsApp
                    </button>
                </form>
            </div>
        </div>

    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script>
    const API = '/api';
    let sessions = [], courses = [];

    // --- NAVIGATION ---
    function showSection(id) {
        document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600'));
        
        document.getElementById('content-' + id).classList.remove('hidden');
        // Simple active tab highlight logic (can be refined)
    }

    // --- INITIALIZATION ---
    async function init() {
        document.getElementById('att-date').valueAsDate = new Date();
        document.getElementById('report-date').valueAsDate = new Date();
        
        // Load Sessions & Courses
        try {
            const [sRes, cRes] = await Promise.all([
                fetch(API + '/teacher/sessions'),
                fetch(API + '/teacher/courses')
            ]);
            sessions = await sRes.json();
            courses = await cRes.json();

            // Populate Dropdowns
            const fill = (id, list) => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = '<option value="">Select...</option>' + list.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            };
            
            fill('att-session', sessions);
            fill('report-session', sessions);
            fill('notes-course', courses);
            fill('syllabus-course', courses);
            
            loadNotices();
        } catch(e) { console.error("Init Error", e); }
    }

    // --- ATTENDANCE ---
    async function loadAttendanceList() {
        const sid = document.getElementById('att-session').value;
        const tbody = document.getElementById('attendance-list-body');
        
        if(!sid) return alert("Please select a batch first.");
        
        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
        
        const res = await fetch(`${API}/teacher/students?session_id=${sid}`);
        const students = await res.json();
        
        if(students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">No students found in this batch.</td></tr>';
            return;
        }

        tbody.innerHTML = students.map(s => `
            <tr class="border-b">
                <td class="p-3">
                    <img src="${s.profile_photo_url || 'https://placehold.co/50'}" class="w-10 h-10 rounded-full object-cover border">
                </td>
                <td class="p-3 font-bold">${s.name}</td>
                <td class="p-3 text-sm text-gray-500">${s.admission_number || '-'}</td>
                <td class="p-3 text-center">
                    <div class="flex justify-center gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="att-${s.id}" value="Present" checked class="peer sr-only">
                            <div class="px-3 py-1 rounded bg-gray-200 peer-checked:bg-green-500 peer-checked:text-white transition">P</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="att-${s.id}" value="Absent" class="peer sr-only">
                            <div class="px-3 py-1 rounded bg-gray-200 peer-checked:bg-red-500 peer-checked:text-white transition">A</div>
                        </label>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    document.getElementById('attendance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const rows = document.getElementById('attendance-list-body').querySelectorAll('tr');
        const data = [];
        rows.forEach(r => {
            const input = r.querySelector('input[type="radio"]:checked');
            if(input) {
                const id = input.name.split('-')[1];
                data.push({ student_id: id, status: input.value });
            }
        });
        
        await fetch(API + '/teacher/attendance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                date: document.getElementById('att-date').value,
                attendance_data: data
            })
        });
        alert("Attendance Submitted Successfully!");
    });

    // --- NOTIFICATIONS (Digital Card Style) ---
    async function loadNotices() {
        const res = await fetch(API + '/teacher/announcements');
        const data = await res.json();
        document.getElementById('notices-list').innerHTML = data.map(a => `
            <div class="digital-card p-4 rounded-lg">
                <div class="flex justify-between items-start">
                    <h4 class="font-bold text-lg text-blue-900">${a.title}</h4>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${a.category}</span>
                </div>
                <p class="text-gray-600 mt-2 text-sm">${a.content}</p>
                <div class="mt-3 flex justify-between items-center text-xs text-gray-400">
                    <span>${a.created_at}</span>
                    <span>To: ${a.target_group}</span>
                </div>
            </div>
        `).join('');
    }

    document.getElementById('announcement-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            title: document.getElementById('ann-title').value,
            content: document.getElementById('ann-content').value,
            category: document.getElementById('ann-category').value,
            target_group: 'students'
        };
        await fetch(API + '/teacher/announcements', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        alert("Digital Notice Sent!");
        e.target.reset();
        loadNotices();
    });

    // --- REPORTS ---
    async function loadReport() {
        const sid = document.getElementById('report-session').value;
        const date = document.getElementById('report-date').value;
        if(!sid) return;

        const res = await fetch(`${API}/teacher/reports/attendance?session_id=${sid}&date=${date}`);
        const data = await res.json();
        
        document.getElementById('report-body').innerHTML = data.map(r => `
            <tr class="border-b">
                <td class="p-3"><img src="${r.photo_url || 'https://placehold.co/50'}" class="w-10 h-10 rounded-full object-cover"></td>
                <td class="p-3">
                    <div class="font-bold">${r.student_name}</div>
                    <div class="text-xs text-gray-500">Adm: ${r.admission_number}</div>
                </td>
                <td class="p-3">
                    <span class="px-2 py-1 rounded text-sm font-bold ${r.status==='Present'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">
                        ${r.status}
                    </span>
                </td>
            </tr>
        `).join('');
    }

    // --- SYLLABUS ---
    document.getElementById('syllabus-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const cid = document.getElementById('syllabus-course').value;
        const topic = document.getElementById('syllabus-topic').value;
        
        await fetch(API + '/teacher/daily_topic', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({course_id: cid, topic: topic})
        });
        alert("Parents Notified Successfully!");
        e.target.reset();
    });

    document.getElementById('logout-btn').onclick = async () => {
        await fetch(API + '/logout', {method: 'POST'});
        window.location.href = '/';
    };

    // Run Init
    init();
</script>
</body>
</html>
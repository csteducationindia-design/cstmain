<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - CST Institute</title>
    
    <link rel="manifest" href="/static/manifest.json">

    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    
<script src="{{ url_for('static', filename='tailwind.js') }}"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "primary-hover": "#0e5ea8",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <style>
        /* Custom Scrollbar for Sidebar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
        
        /* Animation Utilities */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Table Responsive Helpers */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 antialiased h-screen overflow-hidden flex">

    <aside class="w-64 bg-surface-light dark:bg-surface-dark border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-xl z-20 transition-all duration-300">
        
        <div class="p-6 border-b border-slate-100 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-500/30">
                    T
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">Teacher Portal</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">CST Institute</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
            <a href="#" onclick="switchSection('dashboard')" id="nav-dashboard" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-500/30 transition-all group">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium">Dashboard</span>
            </a>
            
            <a href="#" onclick="switchSection('students')" id="nav-students" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">school</span>
                <span class="font-medium">My Students</span>
            </a>

            <a href="#" onclick="switchSection('attendance')" id="nav-attendance" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">checklist_rtl</span>
                <span class="font-medium">Attendance</span>
            </a>

            <a href="#" onclick="switchSection('reports')" id="nav-reports" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">analytics</span>
                <span class="font-medium">Reports</span>
            </a>

            <a href="#" onclick="switchSection('announcements')" id="nav-announcements" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">campaign</span>
                <span class="font-medium">Notices</span>
            </a>

            <a href="#" onclick="switchSection('notes')" id="nav-notes" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">description</span>
                <span class="font-medium">Notes</span>
            </a>

            <a href="#" onclick="switchSection('doubts')" id="nav-doubts" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">help</span>
                <span class="font-medium">Doubts</span>
            </a>

            <a href="#" onclick="switchSection('profile')" id="nav-profile" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">account_circle</span>
                <span class="font-medium">Profile</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50">
            <button id="logout-btn" class="flex items-center justify-center gap-2 w-full bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 px-4 rounded-xl text-sm transition duration-150 border border-red-100">
                <span class="material-symbols-outlined text-lg">logout</span>
                Logout
            </button>
        </div>
    </aside>

<main class="flex-1 h-screen overflow-y-auto bg-background-light dark:bg-background-dark relative p-8">
        
        <div id="content-dashboard" class="content-section animate-fade">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Welcome, Teacher</h1>
                    <p class="text-slate-500 mt-1">Here is your daily overview</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold text-sm" id="current-date">...</span>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                            <span class="material-symbols-outlined">group</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Total Students</p>
                            <h3 class="text-2xl font-bold text-slate-800 dark:text-white" id="stat-total-students">--</h3>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                            <span class="material-symbols-outlined">check_circle</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Present Today</p>
                            <h3 class="text-2xl font-bold text-slate-800 dark:text-white" id="stat-present">--</h3>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center">
                            <span class="material-symbols-outlined">class</span>
                        </div>
                        <div>
                            <p class="text-slate-500 text-sm font-medium">My Courses</p>
                            <h3 class="text-2xl font-bold text-slate-800 dark:text-white" id="stat-courses">--</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button onclick="switchSection('attendance')" class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 hover:border-blue-500 hover:shadow-md transition-all text-left group">
                    <span class="material-symbols-outlined text-blue-500 mb-2 group-hover:scale-110 transition-transform">checklist</span>
                    <h4 class="font-bold text-slate-700 dark:text-white">Mark Attendance</h4>
                </button>
                <button onclick="switchSection('announcements')" class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 hover:border-orange-500 hover:shadow-md transition-all text-left group">
                    <span class="material-symbols-outlined text-orange-500 mb-2 group-hover:scale-110 transition-transform">campaign</span>
                    <h4 class="font-bold text-slate-700 dark:text-white">Post Notice</h4>
                </button>
                <button onclick="switchSection('notes')" class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 hover:border-emerald-500 hover:shadow-md transition-all text-left group">
                    <span class="material-symbols-outlined text-emerald-500 mb-2 group-hover:scale-110 transition-transform">upload_file</span>
                    <h4 class="font-bold text-slate-700 dark:text-white">Upload Notes</h4>
                </button>
                <button onclick="switchSection('doubts')" class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 hover:border-purple-500 hover:shadow-md transition-all text-left group">
                    <span class="material-symbols-outlined text-purple-500 mb-2 group-hover:scale-110 transition-transform">quiz</span>
                    <h4 class="font-bold text-slate-700 dark:text-white">Check Doubts</h4>
                </button>
            </div>
        </div> 
        <div id="content-students" class="content-section hidden animate-fade">
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">My Students</h1>
            
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 mb-6 flex gap-4">
                <select id="filter-students-course" class="bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">All Courses</option>
                </select>
                <select id="filter-students-session" class="bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">All Batches</option>
                </select>
                <button onclick="loadStudents()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">Filter</button>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">Student</th>
                            <th class="p-4">Admission No</th>
                            <th class="p-4">Batch</th>
                            <th class="p-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                        <tr><td colspan="4" class="p-8 text-center text-slate-400">Loading students...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="content-attendance" class="content-section hidden animate-fade">
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">Mark Attendance</h1>
            
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Select Date</label>
                        <input type="date" id="att-date" class="w-full border rounded-lg p-2.5 bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Select Course</label>
                        <select id="att-course" class="w-full border rounded-lg p-2.5 bg-slate-50" onchange="loadStudentsForAttendance()"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Select Batch</label>
                        <select id="att-session" class="w-full border rounded-lg p-2.5 bg-slate-50" onchange="loadStudentsForAttendance()"></select>
                    </div>
                    <button onclick="loadStudentsForAttendance()" class="bg-blue-600 text-white p-2.5 rounded-lg font-bold hover:bg-blue-700">Load List</button>
                </div>
            </div>

            <div id="attendance-list-container" class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                    <h3 class="font-bold text-slate-700">Student List</h3>
                    <button onclick="markAllPresent()" class="text-xs font-bold text-emerald-600 hover:bg-emerald-50 px-3 py-1 rounded-lg border border-emerald-200">Mark All Present</button>
                </div>
                <div id="attendance-grid" class="divide-y divide-slate-100"></div>
                <div class="p-4 bg-slate-50 border-t">
                    <button onclick="submitAttendance()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700">Save Attendance</button>
                </div>
            </div>
        </div>

        <div id="content-reports" class="content-section hidden animate-fade">
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">Reports</h1>
            <div class="bg-white p-8 rounded-2xl text-center text-slate-400">
                <p>Select a report type to view detailed analytics.</p>
                </div>
        </div>

        <div id="content-announcements" class="content-section hidden animate-fade">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Announcements</h1>
                <button onclick="document.getElementById('new-announcement-modal').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined">add</span> New
                </button>
            </div>
            <div id="announcements-list" class="space-y-4"></div>
        </div>

        <div id="content-notes" class="content-section hidden animate-fade">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Study Material</h1>
                <button onclick="document.getElementById('upload-note-modal').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined">cloud_upload</span> Upload
                </button>
            </div>
            <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="content-doubts" class="content-section hidden animate-fade">
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">Student Doubts</h1>
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div id="doubts-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                    <div class="p-8 text-center text-slate-400">Loading doubts...</div>
                </div>
            </div>
        </div>

        <div id="content-profile" class="content-section hidden animate-fade">
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">My Profile</h1>
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-8 max-w-lg mx-auto">
                <div class="flex flex-col items-center">
                    <div class="w-32 h-32 rounded-full border-4 border-slate-100 overflow-hidden mb-4 relative bg-gray-200">
                        <img id="my-photo-preview" src="" class="w-full h-full object-cover">
                    </div>
                    
                    <h2 id="my-name-display" class="text-xl font-bold mb-1">Teacher Name</h2>
                    <p class="text-sm text-slate-500 mb-6">Upload a clear photo for students to see.</p>

                    <label class="cursor-pointer bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 font-bold py-3 px-6 rounded-xl flex items-center gap-2 transition-all">
                        <span class="material-symbols-outlined">cloud_upload</span>
                        <span>Choose New Photo</span>
                        <input type="file" id="profile-upload-input" accept="image/*" class="hidden" onchange="uploadProfilePhoto(this)">
                    </label>
                </div>
            </div>
        </div>

    </main>    
<div id="notify-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity backdrop-blur-sm" id="modal-backdrop"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white dark:bg-surface-dark rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-slate-200 dark:border-slate-700">
            <div class="px-6 py-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><span class="material-symbols-outlined">send</span></div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="notify-modal-title">Send Message</h3>
                </div>
                
                <form class="space-y-4">
                    <input type="hidden" id="notify-student-id">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Subject</label>
                        <input type="text" id="notify-subject" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-primary p-3" placeholder="Important Update...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Message Body</label>
                        <textarea id="notify-body" rows="4" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-primary p-3" placeholder="Type your message here..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Communication Channel</label>
                        <select id="notify-type" class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-primary p-3">
                            <option value="portal">ðŸ“± App Notification (Push)</option>
                            <option value="sms">ðŸ’¬ SMS</option>
                            <option value="whatsapp">ðŸ’š WhatsApp</option>
                            <option value="email">ðŸ“§ Email</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100 dark:border-slate-700">
                <button type="button" id="send-notify-btn" class="w-full sm:w-auto px-6 py-2.5 bg-primary text-white rounded-xl font-bold hover:bg-primary-hover shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">send</span> Send Message
                </button>
                <button type="button" id="cancel-notify-btn" class="w-full sm:w-auto px-6 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition transform active:scale-95">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
    // --- APP CONFIGURATION ---
    const API_ORIGIN = window.location.origin;
    const API_BASE_URL = API_ORIGIN + '/api';
    
    // --- CACHE VARIABLES ---
    let allTeacherCourses = [];
    let allTeacherStudents = [];
    let currentAttendanceStatus = {};
    let reportData = []; 

    // --- PWA INSTALL LOGIC ---
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(installBtn) installBtn.classList.remove('hidden');
    });
    if(installBtn) {
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') installBtn.classList.add('hidden');
                deferredPrompt = null;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENT REFERENCES ---
        const logoutBtn = document.getElementById('logout-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageTitle = document.getElementById('page-title');
        
        // Attendance View Elements
        const attendanceCourseSelect = document.getElementById('attendance-course-select');
        const attendanceDateInput = document.getElementById('attendance-date');
        const markPresentBtn = document.getElementById('mark-present-btn');
        const markAbsentBtn = document.getElementById('mark-absent-btn');
        const submitAttendanceBtn = document.getElementById('submit-attendance-btn');
        const selectAllCheckbox = document.getElementById('select-all-students');
        
        // Other Select Elements
        const noteCourseSelect = document.getElementById('note-course-select');
        const syllabusCourseSelect = document.getElementById('syllabus-course-select');
        const assignmentCourseSelect = document.getElementById('assignment-course-select');
        const reportCourseSelect = document.getElementById('report-course-select');
        const uploadNoteForm = document.getElementById('upload-note-form');

        // Modal Elements
        const notifyModal = document.getElementById('notify-modal');
        const notifyBackdrop = document.getElementById('modal-backdrop');
        const sendNotifyBtn = document.getElementById('send-notify-btn');
        const cancelNotifyBtn = document.getElementById('cancel-notify-btn');

        
// --- NAVIGATION HANDLER (Fixed) ---
    window.switchSection = function(input) {
        // 1. Clean the input (handle both 'dashboard' and '#dashboard')
        const id = input.startsWith('#') ? input.substring(1) : input;

        // 2. Hide all sections
        document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
        
        // 3. Show target section
        const target = document.getElementById('content-' + id);
        if(target) {
            target.classList.remove('hidden');
        }

        // 4. Update Sidebar Active State
        document.querySelectorAll('.nav-link').forEach(el => {
            el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
            el.classList.add('text-slate-400');
        });
        
        const activeLink = document.getElementById('nav-' + id);
        if(activeLink) {
            activeLink.classList.remove('text-slate-400');
            activeLink.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
        }

        // 5. Update Page Title
        const titles = {
            'dashboard': 'Dashboard',
            'students': 'My Students',
            'attendance': 'Mark Attendance',
            'reports': 'Reports',
            'announcements': 'Announcements',
            'notes': 'Study Material',
            'doubts': 'Student Doubts',
            'profile': 'My Profile'
        };
        // Safety check if page-title element exists (optional)
        const titleEl = document.getElementById('page-title');
        if(titleEl) titleEl.textContent = titles[id] || 'Dashboard';

        // 6. AUTO-LOAD DATA (CRITICAL)
        if (id === 'students' && allTeacherStudents.length === 0) fetchAllTeacherStudents();
        if (id === 'attendance') populateDropdowns(); 
        if (id === 'announcements') fetchTeacherAnnouncements();
        if (id === 'notes') fetchTeacherNotes();
        if (id === 'doubts') loadDoubts();     
        if (id === 'profile') loadMyProfile(); 
        if (id === 'dashboard') fetchDashboardData();
    }

    // --- PAGE LOAD HANDLER ---
    async function loadContent() {
        const hash = window.location.hash || '#dashboard';
        window.switchSection(hash); 
    }

    // --- PROFILE LOADER (You were missing this!) ---
    async function loadMyProfile() {
        try {
            const res = await fetch(`${API_BASE_URL}/check_session`, { credentials: 'include' });
            const data = await res.json();
            if(data.user && data.user.profile_photo_url) {
                document.getElementById('my-photo-preview').src = data.user.profile_photo_url;
            }
        } catch(e) { console.error("Profile load error", e); }
    }    
        window.addEventListener('hashchange', loadContent);

        // --- AUTH & SESSION CHECK ---
        // Add a global variable for sessions
    let allSessions = []; 

    async function checkSessionAndInit() {
        try {
            const response = await fetch(`${API_BASE_URL}/check_session`, {credentials: 'include'});
            const result = await response.json();
            if (!response.ok || !result.logged_in || result.user.role !== 'teacher') {
                window.location.href = API_ORIGIN + '/';
                return;
            }
            
            // WELCOME MESSAGE
            document.getElementById('welcome-message').textContent = `Welcome back, ${result.user.name}.`;
            
            // LOAD DATA (Now fetching Sessions too)
            await Promise.all([
                fetchTeacherCourses(),
                fetchSessions() // <--- NEW FUNCTION CALL
            ]);
            
            populateDropdowns();
            loadContent();
            setTimeout(initFirebase, 2000);

        } catch (error) { console.error("Init Failed:", error); }
    }
// --- 1. LOAD DOUBTS ---
    async function loadDoubts() {
        const container = document.getElementById('doubts-list');
        container.innerHTML = '<div class="p-8 text-center text-slate-400">Loading...</div>';
        
        try {
            const res = await fetch(`${API_BASE_URL}/teacher/doubts`, { credentials: 'include' });
            const doubts = await res.json();
            
            if (doubts.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400">No questions from students yet.</div>';
                return;
            }
            
            container.innerHTML = doubts.map(d => `
                <div class="p-6 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-500 text-sm">person</span>
                            ${d.student_name}
                        </h4>
                        <span class="text-xs text-slate-400">${d.date}</span>
                    </div>
                    <p class="text-slate-600 dark:text-slate-300 mb-4 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-100 dark:border-slate-700 italic">"${d.question}"</p>
                    
                    ${d.answer ? 
                        `<div class="ml-4 pl-4 border-l-2 border-green-500">
                            <p class="text-xs font-bold text-green-600 mb-1">You Replied:</p>
                            <p class="text-sm text-slate-700 dark:text-slate-300">${d.answer}</p>
                         </div>` 
                        : 
                        `<div class="flex gap-2 mt-3">
                            <input type="text" id="reply-${d.id}" placeholder="Type your answer here..." class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="sendReply(${d.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Reply</button>
                         </div>`
                    }
                </div>
            `).join('');
            
        } catch(e) { console.error(e); }
    }

    // --- 2. SEND REPLY ---
    async function sendReply(doubtId) {
        const input = document.getElementById(`reply-${doubtId}`);
        const answer = input.value;
        if(!answer) return alert("Please type an answer.");
        
        try {
            await fetch(`${API_BASE_URL}/teacher/reply_doubt`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ doubt_id: doubtId, answer: answer })
            });
            alert("Reply sent!");
            loadDoubts(); // Refresh list
        } catch(e) { alert("Error sending reply"); }
    }

    // --- 3. UPLOAD PHOTO ---
    async function uploadProfilePhoto(input) {
        if (!input.files || !input.files[0]) return;
        
        const fd = new FormData();
        fd.append('photo', input.files[0]);
        
        try {
            const res = await fetch(`${API_BASE_URL}/teacher/update_photo`, {
                method: 'POST',
                credentials: 'include',
                body: fd
            });
            const data = await res.json();
            if(res.ok) {
                alert("Profile Photo Updated!");
                document.getElementById('my-photo-preview').src = data.url; // Update preview
            } else {
                alert("Upload failed");
            }
        } catch(e) { alert("Error uploading photo"); }
    }

    // UPDATE SWITCH VIEW TO LOAD DOUBTS
    // Find your existing switchSection or showSection function and add:
    // if (id === 'doubts') loadDoubts();

    // NEW FUNCTION TO FETCH SESSIONS
    async function fetchSessions() {
        try {
            const res = await fetch(`${API_BASE_URL}/teacher/sessions`, { credentials: 'include' });
            allSessions = await res.json();
        } catch (e) { console.error(e); }
    }

        // --- DATA FETCHING FUNCTIONS ---
        async function fetchTeacherCourses() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/courses`, { credentials: 'include' });
                allTeacherCourses = await res.json();
                document.getElementById('total-my-courses').textContent = allTeacherCourses.length;
            } catch (e) { console.error(e); }
        }

        async function fetchAllTeacherStudents() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/students`, { credentials: 'include' });
                allTeacherStudents = await res.json();
                document.getElementById('total-my-students').textContent = allTeacherStudents.length;
            } catch (e) { console.error(e); }
        }


        function populateDropdowns() {
        // 1. Populate COURSE Dropdowns
        const courseSelects = [
            document.getElementById('attendance-course-select'), 
            document.getElementById('note-course-select'), 
            document.getElementById('report-course-select'),
            document.getElementById('syllabus-course-select'),
            document.getElementById('assign-course-select') // <--- FIXED: Added correct ID for Assignment Form
        ];
        
        courseSelects.forEach(select => {
            if(!select) return;
            // Keep existing options (like "Select Course") and append courses
            const defaultOption = select.querySelector('option')?.outerHTML || '<option value="">-- Select Course --</option>';
            
            select.innerHTML = defaultOption + 
                allTeacherCourses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        });

        // 2. Populate BATCH/SESSION Dropdowns
        const sessionSelects = [
            document.getElementById('attendance-session-select'),
            document.getElementById('syllabus-session-select'),
            document.getElementById('assignment-session-select')
        ];

        sessionSelects.forEach(select => {
            if(!select) return;
            const defaultOption = select.querySelector('option')?.outerHTML || '<option value="">All Batches</option>';
            
            select.innerHTML = defaultOption + 
                allSessions.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        });
    }

        async function fetchDashboardData() {
            document.getElementById('total-my-courses').textContent = allTeacherCourses.length;
            if(allTeacherStudents.length === 0) await fetchAllTeacherStudents();
            document.getElementById('total-my-students').textContent = allTeacherStudents.length;
            
            // Fetch note count for dashboard
             try {
                 const notesResp = await fetch(`${API_BASE_URL}/teacher/notes`, {credentials: 'include'});
                 const notes = await notesResp.json();
                 document.getElementById('total-shared-notes').textContent = notes.length;
             } catch(e) {
                 document.getElementById('total-shared-notes').textContent = '-';
             }
        }

        function renderCoursesTable() {
            const tbody = document.getElementById('teacher-courses-body');
            tbody.innerHTML = allTeacherCourses.length ? allTeacherCourses.map(c => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${c.name}</td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400">${c.subjects.join(', ')}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-xs font-bold text-primary bg-primary/10 px-3 py-1 rounded-full">View Details</button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="3" class="px-6 py-12 text-center text-slate-500">No courses assigned to you.</td></tr>';
        }

        // --- ATTENDANCE LOGIC (Course-Wise Filter) ---
        
// ============================================================
        // FIXED ATTENDANCE LOGIC (Batch + Course Filtering)
        // ============================================================

        // 1. Get Elements
        const attSessionSelect = document.getElementById('attendance-session-select');
        const attCourseSelect = document.getElementById('attendance-course-select');
        const attBody = document.getElementById('attendance-table-body');

        // 2. Attach Listeners (Remove nesting)
        if (attSessionSelect) attSessionSelect.addEventListener('change', loadAttendanceStudents);
        if (attCourseSelect) attCourseSelect.addEventListener('change', loadAttendanceStudents);
        
        // Also update buttons when date changes
        if (attendanceDateInput) {
            attendanceDateInput.valueAsDate = new Date(); // Default to today
            attendanceDateInput.addEventListener('change', updateAttendanceButtons);
        }

        // 3. Main Data Loading Function
        async function loadAttendanceStudents() {
            const sid = attSessionSelect.value; // Batch ID
            const cid = attCourseSelect.value;  // Course ID
            
            // Reset UI
            currentAttendanceStatus = {};
            attBody.innerHTML = '';

            // Requirement: Course must be selected
            if(!cid) {
                attBody.innerHTML = '<tr><td colspan="4" class="px-6 py-16 text-center text-slate-400"><div class="flex flex-col items-center"><span class="material-symbols-outlined text-4xl mb-2">arrow_upward</span>Please select a Course to view students.</div></td></tr>';
                updateAttendanceButtons();
                return;
            }

            attBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-500">Loading students...</td></tr>';

            try {
                // Build URL: Send BOTH course_id and session_id
                let url = `${API_BASE_URL}/teacher/students?course_id=${cid}`;
                if(sid && sid !== "") {
                    url += `&session_id=${sid}`;
                }

                const res = await fetch(url, { credentials: 'include' });
                const students = await res.json();

                // Handle "No Data"
                if (students.length === 0) {
                    attBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-16 text-center text-red-500">
                                <div class="font-bold">No students found.</div>
                                <div class="text-xs text-slate-400 mt-1">
                                    No students in this specific Batch & Course combination.<br>
                                    Try selecting "All Batches" to see everyone.
                                </div>
                            </td>
                        </tr>`;
                    updateAttendanceButtons();
                    return;
                }

                // Render Rows
                attBody.innerHTML = students.map(s => {
                    currentAttendanceStatus[s.id] = 'Present'; // Default
                    const photo = s.profile_photo_url ? `${API_ORIGIN}${s.profile_photo_url}` : `https://placehold.co/40x40/e2e8f0/475569?text=${s.name.charAt(0)}`;
                    
                    return `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-100 dark:border-slate-800">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="student-checkbox w-5 h-5 text-primary rounded border-slate-300 focus:ring-primary cursor-pointer" data-id="${s.id}">
                        </td>
                        <td class="px-6 py-4 text-xs text-slate-400 font-mono">#${s.admission_number || s.id}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img src="${photo}" class="w-9 h-9 rounded-full object-cover border border-slate-200 shadow-sm">
                                <div>
                                    <div class="font-bold text-slate-900 dark:text-white text-sm">${s.name}</div>
                                    <div class="text-xs text-blue-600 font-medium bg-blue-50 inline-block px-1.5 rounded mt-0.5">
                                        ${s.session_name || 'No Batch'}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span id="status-${s.id}" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200 shadow-sm">Present</span>
                        </td>
                    </tr>`;
                }).join('');
                
                updateAttendanceButtons();

            } catch (e) {
                console.error("Load Error:", e);
                attBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-red-500">System Error. Check Console.</td></tr>';
            }
        }

        // 4. Update Button States
        function updateAttendanceButtons() {
            const hasStudents = Object.keys(currentAttendanceStatus).length > 0;
            const dateSet = !!attendanceDateInput.value;
            const enableSubmit = hasStudents && dateSet;

            selectAllCheckbox.disabled = !hasStudents;
            markPresentBtn.disabled = !hasStudents;
            markAbsentBtn.disabled = !hasStudents;
            submitAttendanceBtn.disabled = !enableSubmit;
            
            if(enableSubmit) {
                submitAttendanceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitAttendanceBtn.classList.add('transform', 'active:scale-95');
            } else {
                submitAttendanceBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitAttendanceBtn.classList.remove('transform', 'active:scale-95');
            }
        }


        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = e.target.checked);
        });

        function bulkMark(status) {
            const selected = document.querySelectorAll('.student-checkbox:checked');
            if(selected.length === 0) return alert("Select at least one student.");
            
            selected.forEach(cb => {
                const id = cb.dataset.id;
                currentAttendanceStatus[id] = status;
                const badge = document.getElementById(`status-${id}`);
                badge.textContent = status;
                if(status === 'Present') {
                    badge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 shadow-sm border border-green-200";
                } else {
                    badge.className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 shadow-sm border border-red-200";
                }
                cb.checked = false; 
            });
            selectAllCheckbox.checked = false;
        }

        markPresentBtn.addEventListener('click', () => bulkMark('Present'));
        markAbsentBtn.addEventListener('click', () => bulkMark('Absent'));

        submitAttendanceBtn.addEventListener('click', async () => {
            submitAttendanceBtn.textContent = "Submitting...";
            submitAttendanceBtn.disabled = true;
            
            const payload = {
                date: attendanceDateInput.value,
                attendance_data: Object.entries(currentAttendanceStatus).map(([sid, stat]) => ({
                    student_id: parseInt(sid), status: stat
                }))
            };

            try {
                const res = await fetch(`${API_BASE_URL}/teacher/attendance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                alert(result.message);
            } catch(e) {
                alert("Submission error. Check console.");
            } finally {
                submitAttendanceBtn.textContent = "Submit Attendance Log";
                submitAttendanceBtn.disabled = false;
            }
        });
// --- CREATE ASSIGNMENT LOGIC ---
const assignForm = document.getElementById('create-assignment-form');
if(assignForm) {
    // Populate Course Dropdown
    const sel = document.getElementById('assign-course-select');
    // Ensure allTeacherCourses is loaded, then:
    // sel.innerHTML = allTeacherCourses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    assignForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            title: document.getElementById('assign-title').value,
            course_id: document.getElementById('assign-course-select').value,
            due_date: document.getElementById('assign-date').value,
            description: document.getElementById('assign-desc').value
        };

        try {
            const res = await fetch(`${API_BASE_URL}/teacher/assignments/create`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            alert(data.msg);
            assignForm.reset();
        } catch(e) {
            alert("Error creating assignment");
        }
    });
}

// --- SYLLABUS SUBMIT LOGIC (Fixed: Sends Batch ID) ---
const syllabusForm = document.getElementById('syllabus-form');
if(syllabusForm) {
    syllabusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const cid = document.getElementById('syllabus-course-select').value;
        const sid = document.getElementById('syllabus-session-select').value;
        const date = document.getElementById('syllabus-date').value;
        const topic = document.getElementById('syllabus-topic').value;
        
        // Get Names for nicer alert
        const sessionName = allSessions.find(s => s.id == sid)?.name || 'All Batches';
        
        // Prepare Payload with Session ID
        const payload = {
            course_id: parseInt(cid),
            session_id: sid ? parseInt(sid) : null, // <--- SENDING SESSION ID NOW
            topic: topic, 
            date: date
        };

        const btn = syllabusForm.querySelector('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Sending...';
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE_URL}/teacher/daily_topic`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            alert(result.msg); // Show Backend Response
            syllabusForm.reset();
        } catch(e) {
            console.error(e);
            alert("Error saving syllabus.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}   

        
        // --- ASSIGNMENTS LOGIC (With Batch Filtering) ---
    const assignCourseSelect = document.getElementById('assignment-course-select');
    const assignSessionSelect = document.getElementById('assignment-session-select');

    function loadAssignments() {
        const cid = assignCourseSelect.value;
        const sid = assignSessionSelect.value;
        const tbody = document.getElementById('assignment-table-body');
        
        tbody.innerHTML = '';
        
        if(!cid) { 
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-500">Please select a course to view students.</td></tr>'; 
            return; 
        }
        
        // Filter by Course AND Batch
        const filtered = allTeacherStudents.filter(s => {
            const courseMatch = s.course_ids && s.course_ids.includes(parseInt(cid));
            const sessionMatch = !sid || s.session_id == sid; // Match batch if selected
            return courseMatch && sessionMatch;
        });

        if(filtered.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-500">No students found for this Batch/Course.</td></tr>'; 
            return; 
        }

        filtered.forEach(s => {
            tbody.innerHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800">
                    <td class="px-6 py-4 font-medium text-slate-900 dark:text-white flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold">${s.name.charAt(0)}</div>
                        ${s.name}
                    </td>
                    <td class="px-6 py-4 text-xs text-blue-600 font-bold">${s.session_name || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-amber-50 text-amber-600 rounded-lg text-xs font-bold border border-amber-100">
                            <span class="w-2 h-2 rounded-full bg-amber-500"></span> Pending
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-primary hover:text-blue-700 text-xs font-bold border border-primary/20 hover:bg-primary/5 px-3 py-1.5 rounded-lg transition" onclick="alert('Marked as submitted for ${s.name}')">
                            Mark Done
                        </button>
                    </td>
                </tr>`;
        });
    }

    if(assignCourseSelect) assignCourseSelect.addEventListener('change', loadAssignments);
    if(assignSessionSelect) assignSessionSelect.addEventListener('change', loadAssignments);

// --- ANNOUNCEMENT LOGIC ---
const annForm = document.getElementById('teacher-announcement-form');

annForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = annForm.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Broadcasting...";

    const payload = {
        title: document.getElementById('ann-title').value,
        content: document.getElementById('ann-content').value,
        category: document.getElementById('ann-category').value,
        target_group: document.getElementById('ann-target').value
    };

    try {
        const res = await fetch(`${API_BASE_URL}/teacher/announcements`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(payload)
        });
        if(res.ok) {
            alert("Broadcast sent successfully to mobile devices!");
            annForm.reset();
            fetchTeacherAnnouncements();
        }
    } catch(e) {
        alert("Broadcast failed.");
    } finally {
        btn.disabled = false;
        btn.textContent = "Broadcast Notification";
    }
});

async function fetchTeacherAnnouncements() {
    const tbody = document.getElementById('announcement-history-body');
    try {
        const res = await fetch(`${API_BASE_URL}/teacher/announcements`, { credentials: 'include' });
        const data = await res.json();
        tbody.innerHTML = data.map(ann => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">${ann.category}</span>
                        <span class="font-bold">${ann.title}</span>
                    </div>
                    <p class="text-sm text-slate-500 mt-1">${ann.content}</p>
                </td>
                <td class="p-4 text-xs text-slate-400">${ann.created_at}</td>
                <td class="p-4 text-right">
                    <button onclick="deleteAnnouncement(${ann.id})" class="text-red-500 hover:text-red-700">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr><td class="p-6 text-center">Failed to load history.</td></tr>';
    }
}

window.deleteAnnouncement = async (id) => {
    if(!confirm("Delete this announcement? It will be removed from all student/parent portals.")) return;
    await fetch(`${API_BASE_URL}/teacher/announcements?id=${id}`, { method: 'DELETE', credentials: 'include' });
    fetchTeacherAnnouncements();
};
        // --- NOTES LOGIC ---
        uploadNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('upload-note-btn');
            const progress = document.getElementById('upload-progress');
            const bar = document.getElementById('upload-bar');
            const status = document.getElementById('upload-status');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            bar.style.width = '0%';
            
            const formData = new FormData(uploadNoteForm);
            
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_BASE_URL}/teacher/notes`, true);
                xhr.withCredentials = true;
                
                xhr.upload.onprogress = (evt) => {
                    if (evt.lengthComputable) {
                        const percent = (evt.loaded / evt.total) * 100;
                        bar.style.width = percent + '%';
                    }
                };
                
                xhr.onload = () => {
                    if (xhr.status === 201) {
                        status.textContent = "Uploaded Successfully! Notification sent to students.";
                        status.className = "text-xs text-center mt-2 text-green-600 font-bold";
                        uploadNoteForm.reset();
                        fetchTeacherNotes();
                    } else {
                        status.textContent = "Upload Failed.";
                        status.className = "text-xs text-center mt-2 text-red-600 font-bold";
                    }
                    setTimeout(() => { progress.classList.add('hidden'); btn.disabled = false; }, 3000);
                };
                
                xhr.send(formData);
            } catch(e) {
                btn.disabled = false;
                alert("Upload error.");
            }
        });

        async function fetchTeacherNotes() {
            const tbody = document.getElementById('teacher-notes-body');
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/notes`, { credentials: 'include' });
                const notes = await res.json();
                
                tbody.innerHTML = notes.length ? notes.map(n => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800">
                        <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${n.title}</td>
                        <td class="px-6 py-4 text-sm text-slate-500">${n.course_name}</td>
                        <td class="px-6 py-4 text-sm text-slate-500">${n.created_at.split(' ')[0]}</td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                             <a href="${API_ORIGIN}/uploads/${n.filename}" target="_blank" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition"><span class="material-symbols-outlined text-sm">visibility</span></a>
                             <button onclick="deleteNote(${n.id})" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition"><span class="material-symbols-outlined text-sm">delete</span></button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-500">No notes found. Upload your first material above.</td></tr>';
            } catch(e) { tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-red-500">Error loading notes.</td></tr>'; }
        }

        window.deleteNote = async (id) => {
            if(!confirm("Are you sure? This will remove the file permanently.")) return;
            try {
                await fetch(`${API_BASE_URL}/teacher/notes?id=${id}`, { method: 'DELETE', credentials: 'include' });
                fetchTeacherNotes();
            } catch(e) { alert("Deletion failed."); }
        };


        // --- REPORTS LOGIC (Updated with Photo & Messaging) ---
        async function fetchTeacherAttendanceReport() {
            const tbody = document.getElementById('teacher-reports-body');
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/reports/attendance`, { credentials: 'include' });
                reportData = await res.json(); // Cache data for filtering
                renderReportTable(reportData);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error loading report.</td></tr>';
            }
        }

        function renderReportTable(data) {
            const tbody = document.getElementById('teacher-reports-body');
            
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No student data found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(row => {
                // Get Full Student Object from cache to get photo url properly
                const studentDetails = allTeacherStudents.find(s => s.id === row.student_id);
                // Use photo from student details, fallback to generic
                const photoUrl = (studentDetails && studentDetails.profile_photo_url) 
                                 ? `${API_ORIGIN}${studentDetails.profile_photo_url}` 
                                 : `https://placehold.co/40x40/e2e8f0/475569?text=${row.student_name.charAt(0)}`;

                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-slate-50 dark:border-slate-800">
                    <td class="px-6 py-4">
                        <img src="${photoUrl}" alt="${row.student_name}" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm">
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-900 dark:text-white">${row.student_name}</div>
                        <div class="text-xs text-slate-400 font-normal mt-0.5">ID: #${row.student_id} | Phone: ${row.phone_number || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300 mb-1">${row.present} / ${row.total_classes} Classes</span>
                            <div class="w-20 h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div class="bg-green-500 h-full rounded-full" style="width: ${(row.present/row.total_classes)*100 || 0}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="sendRemark(${row.student_id}, '${row.student_name.replace(/'/g, "\\'")}', 'star')" class="p-2 bg-yellow-50 text-yellow-600 rounded-xl hover:bg-yellow-100 transition border border-yellow-100" title="Send Praise">
                                <span class="material-symbols-outlined text-lg">star</span>
                            </button>
                            <button onclick="sendRemark(${row.student_id}, '${row.student_name.replace(/'/g, "\\'")}', 'warn')" class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition border border-red-100" title="Send Warning">
                                <span class="material-symbols-outlined text-lg">warning</span>
                            </button>
                            <button onclick="openMessageModal(${row.student_id}, '${row.student_name.replace(/'/g, "\\'")}')" class="px-4 py-2 bg-primary text-white rounded-xl text-xs font-bold hover:bg-primary-hover transition shadow-sm flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">chat</span> Message
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // Report Filter Logic
        reportCourseSelect.addEventListener('change', (e) => {
            const courseId = e.target.value;
            if (!courseId) {
                renderReportTable(reportData); // Show all
            } else {
                const enrolledStudentIds = allTeacherStudents
                    .filter(s => s.course_ids && s.course_ids.includes(parseInt(courseId)))
                    .map(s => s.id);
                const filteredData = reportData.filter(row => enrolledStudentIds.includes(row.student_id));
                renderReportTable(filteredData);
            }
        });


        // --- MESSAGING MODAL LOGIC ---

        window.openMessageModal = function(id, name) {
            document.getElementById('notify-student-id').value = id;
            document.getElementById('notify-modal-title').textContent = `Message ${name}`;
            document.getElementById('notify-modal').classList.remove('hidden');
        };

        // 1. REAL REMARK LOGIC (Praise/Warn)
        window.sendRemark = async (id, name, type) => {
            const subject = type === 'star' ? "ðŸŒŸ Praise from Teacher" : "âš ï¸ Class Warning";
            const body = type === 'star' 
                ? `Great job in class today, ${name}! Keep it up.` 
                : `Please pay more attention in class, ${name}. Improvement needed.`;
            
            if(!confirm(`Send this ${type === 'star' ? 'Praise' : 'Warning'} to ${name} and their parent?`)) return;

            try {
                const res = await fetch(`${API_BASE_URL}/teacher/notify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ 
                        student_id: id, 
                        subject: subject, 
                        body: body, 
                        type: 'portal' // Default to Push Notification
                    })
                });
                
                const data = await res.json();
                if(res.ok) alert("Remark sent successfully!");
                else alert("Error: " + data.message);
                
            } catch(e) {
                console.error(e);
                alert("Failed to send remark. Check connection.");
            }
        };

        // 2. MODAL SEND LOGIC
        const closeModal = () => document.getElementById('notify-modal').classList.add('hidden');
        if(document.getElementById('cancel-notify-btn')) document.getElementById('cancel-notify-btn').addEventListener('click', closeModal);
        if(document.getElementById('modal-backdrop')) document.getElementById('modal-backdrop').addEventListener('click', closeModal);

        const sendBtn = document.getElementById('send-notify-btn');
        if(sendBtn) {
            sendBtn.addEventListener('click', async () => {
                const sid = document.getElementById('notify-student-id').value;
                const sub = document.getElementById('notify-subject').value;
                const body = document.getElementById('notify-body').value;
                const type = document.getElementById('notify-type').value;

                if(!sub || !body) return alert("Subject and message are required.");

                // WhatsApp Logic (Client Side)
                if (type === 'whatsapp') {
                    const student = allTeacherStudents.find(s => s.id == sid);
                    const phone = student?.phone_number; 
                    
                    if (phone) {
                        const url = `https://wa.me/91${phone.replace(/\D/g,'')}?text=${encodeURIComponent(`*${sub}*\n${body}`)}`;
                        window.open(url, '_blank');
                        closeModal();
                    } else {
                        alert("Student phone number not found.");
                    }
                    return;
                }

                // Server Side Sending
                sendBtn.disabled = true;
                const originalText = sendBtn.innerHTML;
                sendBtn.textContent = "Sending...";
                
                try {
                    const res = await fetch(`${API_BASE_URL}/teacher/notify`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({ student_id: sid, subject: sub, body: body, type: type })
                    });
                    const result = await res.json();
                    
                    if(res.ok) {
                        alert(result.message);
                        closeModal();
                    } else {
                        alert("Error: " + result.message);
                    }
                } catch(e) {
                    console.error(e);
                    alert("Failed to send message. Please check connection.");
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                }
            });
        }

       
	// --- INIT FIREBASE (Final Corrected Version) ---
        function initFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBkzEHM9fXRoCYSgEW-hk_lN7sL_nSLDfU",
                    authDomain: "cst-institute-app.firebaseapp.com",
                    projectId: "cst-institute-app",
                    storageBucket: "cst-institute-app.firebasestorage.app",
                    messagingSenderId: "485166460200",
                    appId: "1:485166460200:web:4eae20e2010ab92baeb41d"
                };

                if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    const messaging = firebase.messaging();

                    // Service Worker Registration
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/firebase-messaging-sw.js').then((reg) => {
                            console.log('Service Worker Registered');
                            
                            // Get Token for Notifications
                            return messaging.getToken({ 
                                vapidKey: 'BBOMxvKvbEs_t9ykKBa2zIewzCzD6FCbm9rxc8a9eWl2kjjH5vyTSH6TeQMksZ_OGl5jZyQpU2wBcf-KsZN1uko', 
                                serviceWorkerRegistration: reg 
                            });
                        }).then((token) => {
                            if (token) {
                                fetch('/api/save_fcm_token', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    credentials: 'include',
                                    body: JSON.stringify({token})
                                });
                            }
                        }).catch(err => console.log("Firebase Token Error:", err));
                    }

                    messaging.onMessage((payload) => {
                        console.log('Message received: ', payload);
                        alert(`${payload.notification.title}: ${payload.notification.body}`);
                    });
                }
            } catch (e) { 
                console.log('Firebase init error:', e); 
            }
        }
// --- LOGOUT LOGIC ---
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    // We must include 'credentials' so the server knows which cookie to delete
                    await fetch(`${API_BASE_URL}/logout`, { 
                        method: 'POST',
                        credentials: 'include' 
                    });
                } catch (e) {
                    console.error("Logout failed", e);
                } finally {
                    // Redirect to login page regardless of server response
                    window.location.href = '/'; 
                }
            });
        }
        // Initialize Page
        checkSessionAndInit();
    }); // This closes the document.addEventListener('DOMContentLoaded')
</script>
</body>
</html>